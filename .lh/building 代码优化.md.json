{
    "sourceFile": "building ä»£ç ä¼˜åŒ–.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 14,
            "patches": [
                {
                    "date": 1764145299476,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764145424050,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -207,4 +207,232 @@\n \r\n - **é€šç”¨æ¨¡æ¿æŠ½å–**ï¼šå¯èƒ½éœ€è¦æŠ½ä¸€äº›é€šç”¨æ¨¡æ¿\r\n - **ç»Ÿä¸€ç®¡ç†**ï¼šå°† UI ç»Ÿä¸€ä»¥ GameObject ä¸ºå•ä½æ‰¿è½½åŠŸèƒ½\r\n \r\n+---\r\n+\r\n+## 7. è®¾è®¡è¯„ä»·ä¸å»ºè®®\r\n+\r\n+### 7.1 ä¼˜ç‚¹ âœ…\r\n+\r\n+#### 1. **æ•°æ®åˆ†ç¦»æ¸…æ™°**\r\n+- âœ… **SData / CData åˆ†ç¦»**ï¼šæ˜ç¡®åŒºåˆ†æœåŠ¡å™¨æ•°æ®å’Œå®¢æˆ·ç«¯æ•°æ®ï¼Œç¬¦åˆå…³æ³¨ç‚¹åˆ†ç¦»åŸåˆ™\r\n+- âœ… **G.me / G.other åˆ†ç¦»**ï¼šåŒºåˆ†è‡ªå·±çš„æ•°æ®å’Œä»–äººæ•°æ®ï¼Œé¿å…æ•°æ®æ··ä¹±\r\n+\r\n+#### 2. **èŒè´£æ˜ç¡®**\r\n+- âœ… **BuildingSystem å•ä¸€èŒè´£**ï¼šä½œä¸ºæ•°æ®ç®¡ç†ä¸­å¿ƒï¼Œæ‰€æœ‰æ•°æ®ä»è¿™é‡Œè·å–ï¼Œç¬¦åˆå•ä¸€èŒè´£åŸåˆ™\r\n+- âœ… **G.me ä¸å­˜ System**ï¼šæ•°æ®å±‚å’Œç³»ç»Ÿå±‚åˆ†ç¦»ï¼Œç¬¦åˆåˆ†å±‚æ¶æ„åŸåˆ™\r\n+\r\n+#### 3. **ç”Ÿå‘½å‘¨æœŸç®¡ç†å®Œæ•´**\r\n+- âœ… **Create/Destroy/Get/Set/Update**ï¼šå®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œä¾¿äºè¿½è¸ªå’Œè°ƒè¯•\r\n+- âœ… **same Layer + same life cycle**ï¼šç»Ÿä¸€çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†åŸåˆ™\r\n+\r\n+#### 4. **æ¶æ„æ¼”è¿›**\r\n+- âœ… **v1 â†’ v2 æ¼”è¿›**ï¼šä»ç›´æ¥ä½¿ç”¨ resp åˆ°å°è£… Building å¯¹è±¡ï¼Œä½“ç°äº†æ¶æ„ä¼˜åŒ–æ€è·¯\r\n+\r\n+### 7.2 æ½œåœ¨é—®é¢˜ âš ï¸\r\n+\r\n+#### 1. **æ•°æ®è®¿é—®è·¯å¾„ä¸æ¸…æ™°**\r\n+```lua\r\n+-- é—®é¢˜ï¼šG.building å’Œ G.me.Buildings çš„å…³ç³»ä¸æ˜ç¡®\r\n+G.building = { ... }\r\n+G.me.Buildings = { ... }  -- è¿™ä¸¤è€…æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ\r\n+```\r\n+\r\n+**å»ºè®®**ï¼š\r\n+- æ˜ç¡® `G.building` å’Œ `G.me.Buildings` çš„èŒè´£è¾¹ç•Œ\r\n+- å»ºè®® `G.building` ä½œä¸ºå…¨å±€é…ç½®/æ¨¡æ¿ï¼Œ`G.me.Buildings` ä½œä¸ºç©å®¶å®ä¾‹æ•°æ®\r\n+\r\n+#### 2. **Get/Set å‘½åæ··æ·†**\r\n+```lua\r\n+-- é—®é¢˜ï¼šGet å’Œ Set çš„è¯­ä¹‰ä¸å¸¸è§ç†è§£ç›¸å\r\n+buildingSystem:Set(building)  -- å®é™…æ˜¯å­˜å‚¨\r\n+local building = buildingSystem:Get(dbId)  -- å®é™…æ˜¯è·å–\r\n+```\r\n+\r\n+**å»ºè®®**ï¼š\r\n+- ä½¿ç”¨æ›´æ˜ç¡®çš„å‘½åï¼š`Add/Register` ç”¨äºå­˜å‚¨ï¼Œ`Get/Find` ç”¨äºè·å–\r\n+- æˆ–è€…ç»Ÿä¸€ä½¿ç”¨ï¼š`Set(id, building)` å’Œ `Get(id)`\r\n+\r\n+#### 3. **Update æ“ä½œè®¾è®¡å†—ä½™**\r\n+```csharp\r\n+// é—®é¢˜ï¼šUpdateBuildingAction å’Œ UpdateBuildingWorkerAction èŒè´£é‡å \r\n+class UpdateBuildingAction {\r\n+    long buildingId;\r\n+    int level;\r\n+    int worker;  // è¿™é‡Œä¹Ÿæœ‰ worker\r\n+}\r\n+\r\n+class UpdateBuildingWorkerAction {\r\n+    long buildingId;\r\n+    int worker;  // é‡å¤äº†\r\n+}\r\n+```\r\n+\r\n+**å»ºè®®**ï¼š\r\n+- ä½¿ç”¨**å‘½ä»¤æ¨¡å¼**æˆ–**ç­–ç•¥æ¨¡å¼**ï¼Œé¿å… Action ç±»è†¨èƒ€\r\n+- è€ƒè™‘ä½¿ç”¨**éƒ¨åˆ†æ›´æ–°**æœºåˆ¶ï¼Œåªæ›´æ–°å˜åŒ–çš„å­—æ®µ\r\n+\r\n+#### 4. **ESC æ¶æ„ç†è§£åå·®**\r\n+```lua\r\n+-- é—®é¢˜ï¼šESC æ¶æ„ä¸­ï¼ŒSystem ä¸åº”è¯¥ç›´æ¥ Set Component\r\n+-- S (System) = BuildingSystem:Set(Building)  -- è¿™ä¸ªç†è§£æœ‰åå·®\r\n+```\r\n+\r\n+**å»ºè®®**ï¼š\r\n+- ESC ä¸­ System åº”è¯¥**æŸ¥è¯¢ Entity å’Œ Component**ï¼Œè€Œä¸æ˜¯ç›´æ¥ Set\r\n+- System è´Ÿè´£**é€»è¾‘å¤„ç†**ï¼ŒComponent è´Ÿè´£**æ•°æ®å­˜å‚¨**\r\n+- æ­£ç¡®çš„æµç¨‹ï¼š`System:Update()` â†’ æŸ¥è¯¢ Entity/Component â†’ å¤„ç†é€»è¾‘ â†’ æ›´æ–° Component\r\n+\r\n+#### 5. **æ•°æ®å±‚çº§æ¦‚å¿µæ¨¡ç³Š**\r\n+```\r\n+Data decl / Data Type / Data inst / Data copy\r\n+NetData / Obj / ServerObject / Client / dbObj\r\n+```\r\n+è¿™äº›æ¦‚å¿µä¹‹é—´çš„å…³ç³»å’ŒèŒè´£ä¸å¤Ÿæ¸…æ™°ã€‚\r\n+\r\n+**å»ºè®®**ï¼š\r\n+- ç»˜åˆ¶**æ•°æ®æµå›¾**ï¼Œæ˜ç¡®æ•°æ®ä»ç½‘ç»œ â†’ å¯¹è±¡ â†’ ç»„ä»¶çš„è½¬æ¢æµç¨‹\r\n+- å®šä¹‰æ¸…æ™°çš„**æ•°æ®è½¬æ¢å±‚**ï¼ˆAdapter/Converterï¼‰\r\n+\r\n+### 7.3 æ”¹è¿›å»ºè®® ğŸ’¡\r\n+\r\n+#### 1. **æ˜ç¡®æ•°æ®æ¶æ„**\r\n+\r\n+```lua\r\n+-- å»ºè®®çš„æ•°æ®æ¶æ„\r\n+G = {\r\n+    -- å…¨å±€é…ç½®æ•°æ®ï¼ˆåªè¯»ï¼‰\r\n+    building = {\r\n+        configs = {},  -- é…ç½®è¡¨æ•°æ®\r\n+    },\r\n+    \r\n+    -- ç©å®¶æ•°æ®ï¼ˆè¯»å†™ï¼‰\r\n+    me = {\r\n+        buildings = {},  -- ç©å®¶æ‹¥æœ‰çš„å»ºç­‘å®ä¾‹\r\n+        -- æ³¨æ„ï¼šè¿™é‡Œä¸å­˜ System\r\n+    },\r\n+    \r\n+    -- å…¶ä»–ç©å®¶æ•°æ®ï¼ˆåªè¯»ï¼‰\r\n+    other = {\r\n+        [playerId] = {\r\n+            buildings = {},\r\n+        }\r\n+    }\r\n+}\r\n+\r\n+-- System ç‹¬ç«‹ç®¡ç†\r\n+BuildingSystem = {\r\n+    buildingMap = {},  -- map[dbId] = building\r\n+    -- æ‰€æœ‰å»ºç­‘æ•°æ®ä»è¿™é‡Œè·å–\r\n+}\r\n+```\r\n+\r\n+#### 2. **ç»Ÿä¸€ç”Ÿå‘½å‘¨æœŸæ¥å£**\r\n+\r\n+```lua\r\n+-- å»ºè®®çš„ç”Ÿå‘½å‘¨æœŸæ¥å£\r\n+BuildingLifecycle = {\r\n+    Create = function(serverData)\r\n+        -- 1. åˆ›å»º Building å¯¹è±¡\r\n+        -- 2. ç»‘å®š GameObject\r\n+        -- 3. æ³¨å†Œåˆ° BuildingSystem\r\n+    end,\r\n+    \r\n+    Destroy = function(building)\r\n+        -- 1. ä» BuildingSystem æ³¨é”€\r\n+        -- 2. é”€æ¯ GameObject\r\n+        -- 3. æ¸…ç†èµ„æº\r\n+    end,\r\n+    \r\n+    Update = function(building, updateData)\r\n+        -- ç»Ÿä¸€æ›´æ–°æ¥å£\r\n+    end\r\n+}\r\n+```\r\n+\r\n+#### 3. **ä¼˜åŒ– Update æœºåˆ¶**\r\n+\r\n+```lua\r\n+-- å»ºè®®ï¼šä½¿ç”¨éƒ¨åˆ†æ›´æ–°æœºåˆ¶\r\n+UpdateBuildingAction = {\r\n+    buildingId = 123,\r\n+    updates = {\r\n+        level = 5,      -- åªæ›´æ–° level\r\n+        worker = 10,    -- åªæ›´æ–° worker\r\n+    }\r\n+}\r\n+\r\n+-- æ‰§è¡Œæ—¶åªæ›´æ–°æŒ‡å®šå­—æ®µ\r\n+function Execute(action)\r\n+    local building = BuildingSystem:Get(action.buildingId)\r\n+    for key, value in pairs(action.updates) do\r\n+        building.serverObject[key] = value\r\n+    end\r\n+end\r\n+```\r\n+\r\n+#### 4. **å®Œå–„é”™è¯¯å¤„ç†**\r\n+\r\n+```lua\r\n+-- å»ºè®®ï¼šæ·»åŠ é”™è¯¯å¤„ç†å’ŒéªŒè¯\r\n+function BuildingSystem:Get(dbId)\r\n+    local building = self.buildingMap[dbId]\r\n+    if not building then\r\n+        LogWarning(\"Building not found: \" .. dbId)\r\n+        return nil\r\n+    end\r\n+    return building\r\n+end\r\n+\r\n+function BuildingSystem:Set(building)\r\n+    if not building or not building.dbId then\r\n+        LogError(\"Invalid building data\")\r\n+        return false\r\n+    end\r\n+    self.buildingMap[building.dbId] = building\r\n+    return true\r\n+end\r\n+```\r\n+\r\n+#### 5. **æ•°æ®åŒæ­¥æœºåˆ¶**\r\n+\r\n+```lua\r\n+-- å»ºè®®ï¼šæ˜ç¡®æ•°æ®åŒæ­¥æµç¨‹\r\n+-- ç½‘ç»œæ•°æ® â†’ ServerObject â†’ Building Component â†’ GameObject\r\n+function SyncBuildingData(serverData)\r\n+    local building = BuildingSystem:Get(serverData.id)\r\n+    if not building then\r\n+        building = Building:New()\r\n+        BuildingSystem:Set(building)\r\n+    end\r\n+    \r\n+    -- æ›´æ–° ServerObject\r\n+    building.serverObject = serverData\r\n+    \r\n+    -- åŒæ­¥åˆ° Component\r\n+    building:SyncToComponent()\r\n+    \r\n+    -- åŒæ­¥åˆ° GameObject\r\n+    building:SyncToGameObject()\r\n+end\r\n+```\r\n+\r\n+### 7.4 æ€»ç»“\r\n+\r\n+**æ•´ä½“è¯„ä»·**ï¼šâ­â­â­â­ (4/5)\r\n+\r\n+è¿™æ˜¯ä¸€ä¸ª**æ€è·¯æ¸…æ™°ã€æ–¹å‘æ­£ç¡®**çš„ä¼˜åŒ–æ–¹æ¡ˆï¼Œä¸»è¦ä¼˜ç‚¹ï¼š\r\n+- âœ… æ•°æ®åˆ†ç¦»æ˜ç¡®\r\n+- âœ… èŒè´£åˆ’åˆ†æ¸…æ™°\r\n+- âœ… ç”Ÿå‘½å‘¨æœŸç®¡ç†å®Œæ•´\r\n+\r\n+**éœ€è¦æ”¹è¿›çš„åœ°æ–¹**ï¼š\r\n+- âš ï¸ éƒ¨åˆ†æ¦‚å¿µéœ€è¦æ›´æ˜ç¡®çš„å®šä¹‰\r\n+- âš ï¸ å‘½åå’Œæ¥å£è®¾è®¡éœ€è¦ä¼˜åŒ–\r\n+- âš ï¸ é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µéœ€è¦è€ƒè™‘\r\n+\r\n+**å»ºè®®å®æ–½æ­¥éª¤**ï¼š\r\n+1. å…ˆæ˜ç¡®æ•°æ®æ¶æ„å’ŒèŒè´£è¾¹ç•Œ\r\n+2. ç»Ÿä¸€å‘½åè§„èŒƒå’Œæ¥å£è®¾è®¡\r\n+3. å®Œå–„é”™è¯¯å¤„ç†å’ŒéªŒè¯æœºåˆ¶\r\n+4. é€æ­¥é‡æ„ï¼Œä¿æŒå‘åå…¼å®¹\r\n"
                },
                {
                    "date": 1764145490600,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -230,21 +230,10 @@\n - âœ… **v1 â†’ v2 æ¼”è¿›**ï¼šä»ç›´æ¥ä½¿ç”¨ resp åˆ°å°è£… Building å¯¹è±¡ï¼Œä½“ç°äº†æ¶æ„ä¼˜åŒ–æ€è·¯\r\n \r\n ### 7.2 æ½œåœ¨é—®é¢˜ âš ï¸\r\n \r\n-#### 1. **æ•°æ®è®¿é—®è·¯å¾„ä¸æ¸…æ™°**\r\n+#### 1. **Get/Set å‘½åæ··æ·†**\r\n ```lua\r\n--- é—®é¢˜ï¼šG.building å’Œ G.me.Buildings çš„å…³ç³»ä¸æ˜ç¡®\r\n-G.building = { ... }\r\n-G.me.Buildings = { ... }  -- è¿™ä¸¤è€…æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ\r\n-```\r\n-\r\n-**å»ºè®®**ï¼š\r\n-- æ˜ç¡® `G.building` å’Œ `G.me.Buildings` çš„èŒè´£è¾¹ç•Œ\r\n-- å»ºè®® `G.building` ä½œä¸ºå…¨å±€é…ç½®/æ¨¡æ¿ï¼Œ`G.me.Buildings` ä½œä¸ºç©å®¶å®ä¾‹æ•°æ®\r\n-\r\n-#### 2. **Get/Set å‘½åæ··æ·†**\r\n-```lua\r\n -- é—®é¢˜ï¼šGet å’Œ Set çš„è¯­ä¹‰ä¸å¸¸è§ç†è§£ç›¸å\r\n buildingSystem:Set(building)  -- å®é™…æ˜¯å­˜å‚¨\r\n local building = buildingSystem:Get(dbId)  -- å®é™…æ˜¯è·å–\r\n ```\r\n"
                },
                {
                    "date": 1764145511757,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -241,9 +241,9 @@\n **å»ºè®®**ï¼š\r\n - ä½¿ç”¨æ›´æ˜ç¡®çš„å‘½åï¼š`Add/Register` ç”¨äºå­˜å‚¨ï¼Œ`Get/Find` ç”¨äºè·å–\r\n - æˆ–è€…ç»Ÿä¸€ä½¿ç”¨ï¼š`Set(id, building)` å’Œ `Get(id)`\r\n \r\n-#### 3. **Update æ“ä½œè®¾è®¡å†—ä½™**\r\n+#### 2. **Update æ“ä½œè®¾è®¡å†—ä½™**\r\n ```csharp\r\n // é—®é¢˜ï¼šUpdateBuildingAction å’Œ UpdateBuildingWorkerAction èŒè´£é‡å \r\n class UpdateBuildingAction {\r\n     long buildingId;\r\n"
                },
                {
                    "date": 1764145529789,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -260,9 +260,9 @@\n **å»ºè®®**ï¼š\r\n - ä½¿ç”¨**å‘½ä»¤æ¨¡å¼**æˆ–**ç­–ç•¥æ¨¡å¼**ï¼Œé¿å… Action ç±»è†¨èƒ€\r\n - è€ƒè™‘ä½¿ç”¨**éƒ¨åˆ†æ›´æ–°**æœºåˆ¶ï¼Œåªæ›´æ–°å˜åŒ–çš„å­—æ®µ\r\n \r\n-#### 4. **ESC æ¶æ„ç†è§£åå·®**\r\n+#### 3. **ESC æ¶æ„ç†è§£åå·®**\r\n ```lua\r\n -- é—®é¢˜ï¼šESC æ¶æ„ä¸­ï¼ŒSystem ä¸åº”è¯¥ç›´æ¥ Set Component\r\n -- S (System) = BuildingSystem:Set(Building)  -- è¿™ä¸ªç†è§£æœ‰åå·®\r\n ```\r\n@@ -271,9 +271,9 @@\n - ESC ä¸­ System åº”è¯¥**æŸ¥è¯¢ Entity å’Œ Component**ï¼Œè€Œä¸æ˜¯ç›´æ¥ Set\r\n - System è´Ÿè´£**é€»è¾‘å¤„ç†**ï¼ŒComponent è´Ÿè´£**æ•°æ®å­˜å‚¨**\r\n - æ­£ç¡®çš„æµç¨‹ï¼š`System:Update()` â†’ æŸ¥è¯¢ Entity/Component â†’ å¤„ç†é€»è¾‘ â†’ æ›´æ–° Component\r\n \r\n-#### 5. **æ•°æ®å±‚çº§æ¦‚å¿µæ¨¡ç³Š**\r\n+#### 4. **æ•°æ®å±‚çº§æ¦‚å¿µæ¨¡ç³Š**\r\n ```\r\n Data decl / Data Type / Data inst / Data copy\r\n NetData / Obj / ServerObject / Client / dbObj\r\n ```\r\n"
                },
                {
                    "date": 1764145681595,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -424,4 +424,161 @@\n 1. å…ˆæ˜ç¡®æ•°æ®æ¶æ„å’ŒèŒè´£è¾¹ç•Œ\r\n 2. ç»Ÿä¸€å‘½åè§„èŒƒå’Œæ¥å£è®¾è®¡\r\n 3. å®Œå–„é”™è¯¯å¤„ç†å’ŒéªŒè¯æœºåˆ¶\r\n 4. é€æ­¥é‡æ„ï¼Œä¿æŒå‘åå…¼å®¹\r\n+\r\n+---\r\n+\r\n+## 8. ä¸ TBBattle æ¡†æ¶è®¾è®¡å¯¹æ¯”åˆ†æ\r\n+\r\n+### 8.1 æ¶æ„ç†å¿µå¯¹æ¯”\r\n+\r\n+| ç»´åº¦ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | è¯„ä»· |\r\n+|------|-------------|--------------|------|\r\n+| **æ•°æ®ç®¡ç†** | BuildingSystem ç›´æ¥ç®¡ç† | DataHandleQueue ä¸­å¿ƒåŒ– | TBBattle æ›´è§£è€¦ |\r\n+| **æ¥å£è®¾è®¡** | ä¼ ç»Ÿ Get/Set | Context ç»Ÿä¸€æ¥å£ | TBBattle æ›´çµæ´» |\r\n+| **ç³»ç»Ÿé€šä¿¡** | ç›´æ¥è°ƒç”¨ | é˜Ÿåˆ—è§£è€¦ | TBBattle æ›´è§£è€¦ |\r\n+| **æ•°æ®æ›´æ–°** | SynAction æœºåˆ¶ | å®æ—¶è®¡ç®— + é˜Ÿåˆ—æ¨é€ | TBBattle æ›´ä¸€è‡´ |\r\n+\r\n+### 8.2 æ ¸å¿ƒå·®å¼‚åˆ†æ\r\n+\r\n+#### 1. **æ•°æ®ç®¡ç†æ–¹å¼**\r\n+\r\n+**Building è®¾è®¡**ï¼š\r\n+```lua\r\n+-- ç›´æ¥è®¿é—®\r\n+local building = buildingSystem:Get(dbId)\r\n+building.serverObject.worker = worker\r\n+```\r\n+\r\n+**TBBattle æ¡†æ¶**ï¼š\r\n+```lua\r\n+-- é€šè¿‡é˜Ÿåˆ—è§£è€¦\r\n+queue:PushData(EDataHandle.Building.UpdateWorker, {\r\n+    buildingId = dbId,\r\n+    worker = worker\r\n+})\r\n+queue:ProcessDataHandler()  -- æ‰¹é‡å¤„ç†\r\n+```\r\n+\r\n+**å¯¹æ¯”**ï¼š\r\n+- âœ… **TBBattle ä¼˜åŠ¿**ï¼šç³»ç»Ÿå®Œå…¨è§£è€¦ï¼Œæ‰¹é‡å¤„ç†ä¼˜åŒ–æ€§èƒ½ï¼Œé…ç½®é©±åŠ¨\r\n+- âš ï¸ **Building ä¼˜åŠ¿**ï¼šç›´æ¥è®¿é—®ï¼Œç®€å•ç›´æ¥ï¼Œæ€§èƒ½å¼€é”€å°\r\n+\r\n+#### 2. **æ¥å£è®¾è®¡**\r\n+\r\n+**Building è®¾è®¡**ï¼š\r\n+```lua\r\n+-- å¤šä¸ªä¸åŒçš„æ¥å£\r\n+buildingSystem:Get(dbId)\r\n+buildingSystem:Set(building)\r\n+buildingSystem:Update(action)\r\n+```\r\n+\r\n+**TBBattle æ¡†æ¶**ï¼š\r\n+```lua\r\n+-- ç»Ÿä¸€çš„ Context æ¥å£\r\n+function System:Execute(context)\r\n+    -- context åŒ…å«æ‰€æœ‰éœ€è¦çš„æ•°æ®\r\n+end\r\n+```\r\n+\r\n+**å¯¹æ¯”**ï¼š\r\n+- âœ… **TBBattle ä¼˜åŠ¿**ï¼šæ¥å£ç¨³å®šï¼Œå‘åå…¼å®¹ï¼Œå‚æ•°çµæ´»\r\n+- âš ï¸ **Building ä¼˜åŠ¿**ï¼šæ¥å£æ˜ç¡®ï¼Œç±»å‹å®‰å…¨ï¼Œæ˜“äºç†è§£\r\n+\r\n+#### 3. **æ•°æ®æ›´æ–°æœºåˆ¶**\r\n+\r\n+**Building è®¾è®¡**ï¼š\r\n+```csharp\r\n+// éœ€è¦å®šä¹‰å¤šä¸ª Action ç±»\r\n+class UpdateBuildingAction : SynAction { ... }\r\n+class UpdateBuildingWorkerAction : SynAction { ... }\r\n+```\r\n+\r\n+**TBBattle æ¡†æ¶**ï¼š\r\n+```lua\r\n+-- å®æ—¶è®¡ç®—ï¼Œæ— éœ€ Action ç±»\r\n+function BuildingData:GetWorker()\r\n+    -- å®æ—¶ä»å„ä¸ªå­ç³»ç»Ÿè·å–\r\n+    return self:CalculateWorker()\r\n+end\r\n+```\r\n+\r\n+**å¯¹æ¯”**ï¼š\r\n+- âœ… **TBBattle ä¼˜åŠ¿**ï¼šæ•°æ®ä¸€è‡´æ€§100%ï¼Œæ— éœ€ç®¡ç†çŠ¶æ€ï¼Œè‡ªåŠ¨å‚ä¸è®¡ç®—\r\n+- âš ï¸ **Building ä¼˜åŠ¿**ï¼šæ˜ç¡®æ›´æ–°è·¯å¾„ï¼Œæ˜“äºè¿½è¸ªï¼Œæ€§èƒ½å¯æ§\r\n+\r\n+### 8.3 è®¾è®¡å“²å­¦å¯¹æ¯”\r\n+\r\n+#### Building è®¾è®¡ï¼š**ä¼ ç»Ÿ + å®ç”¨ä¸»ä¹‰**\r\n+\r\n+- âœ… **ä¼˜ç‚¹**ï¼šç®€å•ç›´æ¥ï¼Œæ˜“äºç†è§£ï¼Œæ€§èƒ½å¯æ§\r\n+- âš ï¸ **ç¼ºç‚¹**ï¼šç³»ç»Ÿè€¦åˆï¼Œæ‰©å±•æ€§å—é™ï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†çŠ¶æ€\r\n+\r\n+#### TBBattle æ¡†æ¶ï¼š**æ•°æ®é©±åŠ¨ + è§£è€¦è®¾è®¡**\r\n+\r\n+- âœ… **ä¼˜ç‚¹**ï¼šç³»ç»Ÿè§£è€¦ï¼Œé«˜åº¦å¯æ‰©å±•ï¼Œæ•°æ®ä¸€è‡´æ€§ä¿è¯\r\n+- âš ï¸ **ç¼ºç‚¹**ï¼šå­¦ä¹ æ›²çº¿ï¼Œæ€§èƒ½å¼€é”€ï¼ˆé˜Ÿåˆ—å¤„ç†ï¼‰ï¼Œè°ƒè¯•å¤æ‚åº¦\r\n+\r\n+### 8.4 é€‚ç”¨åœºæ™¯åˆ†æ\r\n+\r\n+#### Building è®¾è®¡é€‚åˆï¼š\r\n+- âœ… **å°å‹ç³»ç»Ÿ**ï¼šå»ºç­‘ç³»ç»Ÿç›¸å¯¹ç‹¬ç«‹ï¼Œä¸éœ€è¦å¤æ‚äº¤äº’\r\n+- âœ… **æ€§èƒ½æ•æ„Ÿ**ï¼šéœ€è¦ç›´æ¥è®¿é—®ï¼Œæœ€å°åŒ–å¼€é”€\r\n+- âœ… **ç®€å•ç»´æŠ¤**ï¼šå›¢é˜Ÿè§„æ¨¡å°ï¼Œä»£ç ç®€å•ç›´æ¥\r\n+\r\n+#### TBBattle æ¡†æ¶é€‚åˆï¼š\r\n+- âœ… **å¤§å‹ç³»ç»Ÿ**ï¼šå¤šä¸ªç³»ç»Ÿéœ€è¦äº¤äº’ï¼Œå¤æ‚æ•°æ®æµ\r\n+- âœ… **é«˜åº¦æ‰©å±•**ï¼šéœ€è¦é¢‘ç¹æ·»åŠ æ–°åŠŸèƒ½ï¼Œé…ç½®é©±åŠ¨\r\n+- âœ… **å›¢é˜Ÿåä½œ**ï¼šå¤šäººåä½œï¼Œéœ€è¦ç»Ÿä¸€æ¥å£å’Œè§„èŒƒ\r\n+\r\n+### 8.5 èåˆå»ºè®® ğŸ’¡\r\n+\r\n+**æœ€ä½³å®è·µï¼šç»“åˆä¸¤è€…ä¼˜åŠ¿**\r\n+\r\n+```lua\r\n+-- 1. ä½¿ç”¨ TBBattle çš„ Context æ¨¡å¼ç»Ÿä¸€æ¥å£\r\n+function BuildingSystem:Execute(context)\r\n+    local action = context.action\r\n+    local buildingId = context.buildingId\r\n+    \r\n+    if action == \"Update\" then\r\n+        -- 2. ä½¿ç”¨ Building è®¾è®¡çš„ç›´æ¥è®¿é—®ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰\r\n+        local building = self:Get(buildingId)\r\n+        if building then\r\n+            -- 3. ä½¿ç”¨ TBBattle çš„é˜Ÿåˆ—æœºåˆ¶ï¼ˆè§£è€¦ï¼‰\r\n+            building.dataHandleQueue:PushData(\r\n+                EDataHandle.Building.Update,\r\n+                context.updates\r\n+            )\r\n+        end\r\n+    end\r\n+end\r\n+\r\n+-- 4. ä½¿ç”¨ TBBattle çš„å®æ—¶è®¡ç®—ï¼ˆæ•°æ®ä¸€è‡´æ€§ï¼‰\r\n+function BuildingData:GetWorker()\r\n+    -- å®æ—¶ä»å„ä¸ªå­ç³»ç»Ÿè·å–ï¼Œæ— éœ€æ‰‹åŠ¨åŒæ­¥\r\n+    return self:CalculateWorker()\r\n+end\r\n+```\r\n+\r\n+### 8.6 æœ€ç»ˆè¯„ä»·\r\n+\r\n+| è¯„ä»·ç»´åº¦ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | æ¨è |\r\n+|---------|-------------|--------------|------|\r\n+| **æ¶æ„ç†å¿µ** | â­â­â­â­ | â­â­â­â­â­ | TBBattle |\r\n+| **ç³»ç»Ÿè§£è€¦** | â­â­â­ | â­â­â­â­â­ | TBBattle |\r\n+| **æ‰©å±•æ€§** | â­â­â­ | â­â­â­â­â­ | TBBattle |\r\n+| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­â­ | Building |\r\n+| **å¯ç»´æŠ¤æ€§** | â­â­â­â­ | â­â­â­â­â­ | TBBattle |\r\n+| **å­¦ä¹ æˆæœ¬** | â­â­â­â­â­ | â­â­â­ | Building |\r\n+| **é€‚ç”¨è§„æ¨¡** | ä¸­å°å‹ | å¤§å‹ | æ ¹æ®é¡¹ç›® |\r\n+\r\n+**ç»¼åˆè¯„åˆ†**ï¼š\r\n+- **Building è®¾è®¡**ï¼šâ­â­â­â­ (4/5) - é€‚åˆä¸­å°å‹ç³»ç»Ÿ\r\n+- **TBBattle æ¡†æ¶**ï¼šâ­â­â­â­â­ (5/5) - é€‚åˆå¤§å‹ç³»ç»Ÿ\r\n+\r\n+**ç»“è®º**ï¼š\r\n+- ğŸ¯ **å¦‚æœæ˜¯ç‹¬ç«‹çš„å°å‹å»ºç­‘ç³»ç»Ÿ**ï¼šBuilding è®¾è®¡æ›´åˆé€‚ï¼ˆç®€å•ç›´æ¥ï¼‰\r\n+- ğŸ¯ **å¦‚æœæ˜¯å¤§å‹æ¸¸æˆé¡¹ç›®çš„ä¸€éƒ¨åˆ†**ï¼šTBBattle æ¡†æ¶æ›´åˆé€‚ï¼ˆç»Ÿä¸€æ¶æ„ï¼‰\r\n+- ğŸ¯ **æœ€ä½³æ–¹æ¡ˆ**ï¼šåœ¨ TBBattle æ¡†æ¶åŸºç¡€ä¸Šï¼Œé’ˆå¯¹ Building ç³»ç»Ÿåšæ€§èƒ½ä¼˜åŒ–ï¼ˆç›´æ¥è®¿é—® + é˜Ÿåˆ—è§£è€¦ï¼‰\r\n"
                },
                {
                    "date": 1764145876771,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -427,10 +427,609 @@\n 4. é€æ­¥é‡æ„ï¼Œä¿æŒå‘åå…¼å®¹\r\n \r\n ---\r\n \r\n-## 8. ä¸ TBBattle æ¡†æ¶è®¾è®¡å¯¹æ¯”åˆ†æ\r\n+## 8. åŸºäº Building è®¾è®¡æ€è·¯çš„ä¼˜åŒ–æ–¹æ¡ˆ\r\n \r\n+### 8.1 ä¼˜åŒ–åŸåˆ™\r\n+\r\n+**ä¿æŒ Building è®¾è®¡çš„æ ¸å¿ƒç†å¿µ**ï¼š\r\n+- âœ… æ•°æ®åˆ†ç¦»ï¼ˆSData/CDataï¼‰\r\n+- âœ… ç›´æ¥è®¿é—®ï¼ˆBuildingSystem ä½œä¸ºæ•°æ®ä¸­å¿ƒï¼‰\r\n+- âœ… ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆCreate/Destroy/Get/Set/Updateï¼‰\r\n+- âœ… SynAction æœºåˆ¶æ›´æ–°\r\n+\r\n+**ä¼˜åŒ–æ–¹å‘**ï¼š\r\n+- ğŸ”§ ä¿®å¤å‘½åå’Œæ¥å£é—®é¢˜\r\n+- ğŸ”§ ä¼˜åŒ– Update æœºåˆ¶ï¼Œå‡å°‘å†—ä½™\r\n+- ğŸ”§ å®Œå–„é”™è¯¯å¤„ç†å’ŒéªŒè¯\r\n+- ğŸ”§ æ˜ç¡®æ•°æ®æµå’ŒèŒè´£è¾¹ç•Œ\r\n+\r\n+### 8.2 ä¼˜åŒ–åçš„æ¶æ„è®¾è®¡\r\n+\r\n+#### 1. **æ•°æ®æ¶æ„ä¼˜åŒ–**\r\n+\r\n+```lua\r\n+-- ä¼˜åŒ–åçš„æ•°æ®æ¶æ„\r\n+G = {\r\n+    -- å…¨å±€é…ç½®æ•°æ®ï¼ˆåªè¯»ï¼Œå¯åŠ¨æ—¶åŠ è½½ï¼‰\r\n+    building = {\r\n+        configs = {},  -- é…ç½®è¡¨æ•°æ®ï¼ˆCfgData.buildingï¼‰\r\n+    },\r\n+    \r\n+    -- ç©å®¶æ•°æ®ï¼ˆè¯»å†™ï¼Œè¿è¡Œæ—¶æ•°æ®ï¼‰\r\n+    me = {\r\n+        buildings = {},  -- ç©å®¶æ‹¥æœ‰çš„å»ºç­‘å®ä¾‹ ID åˆ—è¡¨\r\n+        -- æ³¨æ„ï¼šè¿™é‡Œåªå­˜ IDï¼Œä¸å­˜ Systemï¼Œä¸å­˜å®Œæ•´å¯¹è±¡\r\n+    },\r\n+    \r\n+    -- å…¶ä»–ç©å®¶æ•°æ®ï¼ˆåªè¯»ï¼ŒåŒæ­¥æ•°æ®ï¼‰\r\n+    other = {\r\n+        [playerId] = {\r\n+            buildings = {},  -- å…¶ä»–ç©å®¶çš„å»ºç­‘ ID åˆ—è¡¨\r\n+        }\r\n+    }\r\n+}\r\n+\r\n+-- System ç‹¬ç«‹ç®¡ç†ï¼ˆæ‰€æœ‰å»ºç­‘å¯¹è±¡éƒ½åœ¨è¿™é‡Œï¼‰\r\n+BuildingSystem = {\r\n+    -- æ ¸å¿ƒæ•°æ®å­˜å‚¨\r\n+    buildingMap = {},  -- map[dbId] = Building å¯¹è±¡\r\n+    \r\n+    -- ç´¢å¼•ä¼˜åŒ–\r\n+    playerBuildingMap = {},  -- map[playerId] = {dbId1, dbId2, ...}\r\n+    gameObjectMap = {},      -- map[gameObjectId] = Building å¯¹è±¡\r\n+    \r\n+    -- å¯¹è±¡æ± ï¼ˆå¯é€‰ï¼‰\r\n+    buildingPool = nil,  -- å¯¹è±¡æ± ï¼Œå¤ç”¨ Building å¯¹è±¡\r\n+}\r\n+```\r\n+\r\n+#### 2. **Building å¯¹è±¡ç»“æ„ä¼˜åŒ–**\r\n+\r\n+```lua\r\n+-- Building å¯¹è±¡å®Œæ•´ç»“æ„\r\n+Building = {\r\n+    -- å”¯ä¸€æ ‡è¯†\r\n+    dbId = 0,              -- æ•°æ®åº“ IDï¼ˆä¸»é”®ï¼‰\r\n+    gameObjectId = 0,       -- GameObject IDï¼ˆç”¨äº Unityï¼‰\r\n+    \r\n+    -- æ•°æ®å±‚ï¼ˆåˆ†ç¦»ï¼‰\r\n+    serverObject = nil,     -- ServerObjectï¼ˆæœåŠ¡å™¨æ•°æ®ï¼Œåªè¯»ï¼‰\r\n+    clientData = {},        -- ClientDataï¼ˆå®¢æˆ·ç«¯æ•°æ®ï¼Œå¯è¯»å†™ï¼‰\r\n+    \r\n+    -- é…ç½®æ•°æ®ï¼ˆåªè¯»ï¼‰\r\n+    cfg = nil,             -- CfgData.building[id]\r\n+    \r\n+    -- Unity å¯¹è±¡\r\n+    gameObject = nil,       -- Unity GameObject\r\n+    prefab = nil,           -- é¢„åˆ¶ä½“å¼•ç”¨\r\n+    \r\n+    -- çŠ¶æ€æ ‡è®°\r\n+    isDirty = false,        -- æ˜¯å¦éœ€è¦åŒæ­¥åˆ°æœåŠ¡å™¨\r\n+    isActive = true,        -- æ˜¯å¦æ¿€æ´»\r\n+    \r\n+    -- ç”Ÿå‘½å‘¨æœŸ\r\n+    createTime = 0,        -- åˆ›å»ºæ—¶é—´\r\n+    lastUpdateTime = 0,     -- æœ€åæ›´æ–°æ—¶é—´\r\n+}\r\n+```\r\n+\r\n+#### 3. **BuildingSystem æ¥å£ä¼˜åŒ–**\r\n+\r\n+```lua\r\n+-- ä¼˜åŒ–åçš„ BuildingSystem æ¥å£\r\n+BuildingSystem = {\r\n+    -- ========== æ ¸å¿ƒæ¥å£ ==========\r\n+    \r\n+    -- æ³¨å†Œå»ºç­‘ï¼ˆç»Ÿä¸€å‘½åï¼šRegister è€Œä¸æ˜¯ Setï¼‰\r\n+    Register = function(self, building)\r\n+        if not building or not building.dbId then\r\n+            LogError(\"BuildingSystem:Register - Invalid building\")\r\n+            return false\r\n+        end\r\n+        \r\n+        -- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨\r\n+        if self.buildingMap[building.dbId] then\r\n+            LogWarning(\"BuildingSystem:Register - Building already exists: \" .. building.dbId)\r\n+            return false\r\n+        end\r\n+        \r\n+        -- æ³¨å†Œåˆ°ä¸»è¡¨\r\n+        self.buildingMap[building.dbId] = building\r\n+        \r\n+        -- æ³¨å†Œåˆ°ç´¢å¼•è¡¨\r\n+        if building.gameObjectId then\r\n+            self.gameObjectMap[building.gameObjectId] = building\r\n+        end\r\n+        \r\n+        -- æ³¨å†Œåˆ°ç©å®¶è¡¨\r\n+        local playerId = building.serverObject and building.serverObject.playerId\r\n+        if playerId then\r\n+            if not self.playerBuildingMap[playerId] then\r\n+                self.playerBuildingMap[playerId] = {}\r\n+            end\r\n+            table.insert(self.playerBuildingMap[playerId], building.dbId)\r\n+        end\r\n+        \r\n+        return true\r\n+    end,\r\n+    \r\n+    -- è·å–å»ºç­‘ï¼ˆä¿æŒ Get å‘½åï¼‰\r\n+    Get = function(self, dbId)\r\n+        local building = self.buildingMap[dbId]\r\n+        if not building then\r\n+            LogWarning(\"BuildingSystem:Get - Building not found: \" .. dbId)\r\n+        end\r\n+        return building\r\n+    end,\r\n+    \r\n+    -- é€šè¿‡ GameObject ID è·å–\r\n+    GetByGameObjectId = function(self, gameObjectId)\r\n+        return self.gameObjectMap[gameObjectId]\r\n+    end,\r\n+    \r\n+    -- è·å–ç©å®¶çš„æ‰€æœ‰å»ºç­‘\r\n+    GetPlayerBuildings = function(self, playerId)\r\n+        local buildingIds = self.playerBuildingMap[playerId] or {}\r\n+        local buildings = {}\r\n+        for _, dbId in ipairs(buildingIds) do\r\n+            local building = self.buildingMap[dbId]\r\n+            if building then\r\n+                table.insert(buildings, building)\r\n+            end\r\n+        end\r\n+        return buildings\r\n+    end,\r\n+    \r\n+    -- æ³¨é”€å»ºç­‘ï¼ˆç»Ÿä¸€å‘½åï¼šUnregister è€Œä¸æ˜¯ Removeï¼‰\r\n+    Unregister = function(self, dbId)\r\n+        local building = self.buildingMap[dbId]\r\n+        if not building then\r\n+            LogWarning(\"BuildingSystem:Unregister - Building not found: \" .. dbId)\r\n+            return false\r\n+        end\r\n+        \r\n+        -- ä»ä¸»è¡¨ç§»é™¤\r\n+        self.buildingMap[dbId] = nil\r\n+        \r\n+        -- ä»ç´¢å¼•è¡¨ç§»é™¤\r\n+        if building.gameObjectId then\r\n+            self.gameObjectMap[building.gameObjectId] = nil\r\n+        end\r\n+        \r\n+        -- ä»ç©å®¶è¡¨ç§»é™¤\r\n+        local playerId = building.serverObject and building.serverObject.playerId\r\n+        if playerId and self.playerBuildingMap[playerId] then\r\n+            for i, id in ipairs(self.playerBuildingMap[playerId]) do\r\n+                if id == dbId then\r\n+                    table.remove(self.playerBuildingMap[playerId], i)\r\n+                    break\r\n+                end\r\n+            end\r\n+        end\r\n+        \r\n+        return true\r\n+    end,\r\n+    \r\n+    -- ========== ç”Ÿå‘½å‘¨æœŸæ¥å£ ==========\r\n+    \r\n+    -- åˆ›å»ºå»ºç­‘ï¼ˆå®Œæ•´æµç¨‹ï¼‰\r\n+    Create = function(self, serverData, gameObject)\r\n+        -- 1. åˆ›å»º Building å¯¹è±¡\r\n+        local building = Building:New()\r\n+        \r\n+        -- 2. è®¾ç½®åŸºç¡€æ•°æ®\r\n+        building.dbId = serverData.id\r\n+        building.serverObject = serverData\r\n+        building.cfg = CfgData.building[serverData.buildingId]\r\n+        \r\n+        if not building.cfg then\r\n+            LogError(\"BuildingSystem:Create - Config not found: \" .. serverData.buildingId)\r\n+            return nil\r\n+        end\r\n+        \r\n+        -- 3. ç»‘å®š GameObject\r\n+        if gameObject then\r\n+            building.gameObject = gameObject\r\n+            building.gameObjectId = gameObject:GetInstanceID()\r\n+        end\r\n+        \r\n+        -- 4. åˆå§‹åŒ–å®¢æˆ·ç«¯æ•°æ®\r\n+        building.clientData = {\r\n+            floor = {},\r\n+            -- å…¶ä»–å®¢æˆ·ç«¯æ•°æ®\r\n+        }\r\n+        \r\n+        -- 5. æ³¨å†Œåˆ°ç³»ç»Ÿ\r\n+        if not self:Register(building) then\r\n+            return nil\r\n+        end\r\n+        \r\n+        -- 6. æ›´æ–° G.meï¼ˆå¦‚æœæ˜¯è‡ªå·±çš„å»ºç­‘ï¼‰\r\n+        if serverData.playerId == G.me.playerId then\r\n+            if not G.me.buildings then\r\n+                G.me.buildings = {}\r\n+            end\r\n+            table.insert(G.me.buildings, building.dbId)\r\n+        end\r\n+        \r\n+        -- 7. è§¦å‘åˆ›å»ºäº‹ä»¶\r\n+        EventSystem:Dispatch(\"OnBuildingCreated\", building)\r\n+        \r\n+        return building\r\n+    end,\r\n+    \r\n+    -- é”€æ¯å»ºç­‘ï¼ˆå®Œæ•´æµç¨‹ï¼‰\r\n+    Destroy = function(self, dbId)\r\n+        local building = self:Get(dbId)\r\n+        if not building then\r\n+            return false\r\n+        end\r\n+        \r\n+        -- 1. è§¦å‘é”€æ¯äº‹ä»¶\r\n+        EventSystem:Dispatch(\"OnBuildingDestroying\", building)\r\n+        \r\n+        -- 2. é”€æ¯ GameObject\r\n+        if building.gameObject then\r\n+            GameObject.Destroy(building.gameObject)\r\n+        end\r\n+        \r\n+        -- 3. ä» G.me ç§»é™¤\r\n+        if G.me.buildings then\r\n+            for i, id in ipairs(G.me.buildings) do\r\n+                if id == dbId then\r\n+                    table.remove(G.me.buildings, i)\r\n+                    break\r\n+                end\r\n+            end\r\n+        end\r\n+        \r\n+        -- 4. ä»ç³»ç»Ÿæ³¨é”€\r\n+        self:Unregister(dbId)\r\n+        \r\n+        -- 5. å›æ”¶å¯¹è±¡ï¼ˆå¦‚æœä½¿ç”¨å¯¹è±¡æ± ï¼‰\r\n+        if self.buildingPool then\r\n+            self.buildingPool:Push(building)\r\n+        end\r\n+        \r\n+        return true\r\n+    end,\r\n+    \r\n+    -- ========== æ›´æ–°æ¥å£ ==========\r\n+    \r\n+    -- æ›´æ–°å»ºç­‘ï¼ˆç»Ÿä¸€æ¥å£ï¼Œæ”¯æŒéƒ¨åˆ†æ›´æ–°ï¼‰\r\n+    Update = function(self, dbId, updates)\r\n+        local building = self:Get(dbId)\r\n+        if not building then\r\n+            return false\r\n+        end\r\n+        \r\n+        -- éƒ¨åˆ†æ›´æ–°æœºåˆ¶\r\n+        if type(updates) == \"table\" then\r\n+            -- æ›´æ–°æŒ‡å®šå­—æ®µ\r\n+            for key, value in pairs(updates) do\r\n+                if building.serverObject[key] ~= nil then\r\n+                    building.serverObject[key] = value\r\n+                elseif building.clientData[key] ~= nil then\r\n+                    building.clientData[key] = value\r\n+                else\r\n+                    LogWarning(\"BuildingSystem:Update - Unknown field: \" .. key)\r\n+                end\r\n+            end\r\n+        else\r\n+            -- å®Œæ•´å¯¹è±¡æ›´æ–°\r\n+            building.serverObject = updates\r\n+        end\r\n+        \r\n+        -- æ ‡è®°ä¸ºè„æ•°æ®\r\n+        building.isDirty = true\r\n+        building.lastUpdateTime = os.time()\r\n+        \r\n+        -- è§¦å‘æ›´æ–°äº‹ä»¶\r\n+        EventSystem:Dispatch(\"OnBuildingUpdated\", building)\r\n+        \r\n+        return true\r\n+    end,\r\n+}\r\n+```\r\n+\r\n+#### 4. **ä¼˜åŒ–åçš„ SynAction æœºåˆ¶**\r\n+\r\n+```lua\r\n+-- ä¼˜åŒ–åçš„ SynActionï¼ˆç»Ÿä¸€æ¥å£ï¼Œå‡å°‘å†—ä½™ï¼‰\r\n+-- ä½¿ç”¨éƒ¨åˆ†æ›´æ–°æœºåˆ¶ï¼Œé¿å… Action ç±»è†¨èƒ€\r\n+\r\n+-- C# ç«¯ï¼šç»Ÿä¸€çš„ UpdateBuildingAction\r\n+class UpdateBuildingAction : SynAction\r\n+{\r\n+    long buildingId;\r\n+    Dictionary<string, object> updates;  // éƒ¨åˆ†æ›´æ–°å­—æ®µ\r\n+}\r\n+\r\n+Execute()\r\n+{\r\n+    local building = BuildingSystem:Get(action.buildingId)\r\n+    if not building then\r\n+        LogError(\"UpdateBuildingAction: Building not found: \" .. action.buildingId)\r\n+        return\r\n+    end\r\n+    \r\n+    -- ä½¿ç”¨ç»Ÿä¸€çš„æ›´æ–°æ¥å£\r\n+    BuildingSystem:Update(action.buildingId, action.updates)\r\n+}\r\n+\r\n+-- ä½¿ç”¨ç¤ºä¾‹\r\n+-- C# ç«¯\r\n+var action = new UpdateBuildingAction\r\n+{\r\n+    buildingId = 123,\r\n+    updates = new Dictionary<string, object>\r\n+    {\r\n+        {\"level\", 5},\r\n+        {\"worker\", 10}\r\n+    }\r\n+};\r\n+\r\n+-- æˆ–è€…å®Œæ•´æ›´æ–°\r\n+var action = new UpdateBuildingAction\r\n+{\r\n+    buildingId = 123,\r\n+    updates = completeBuildingObject  // å®Œæ•´å¯¹è±¡\r\n+};\r\n+```\r\n+\r\n+#### 5. **è¯·æ±‚å“åº”å¤„ç†ä¼˜åŒ–ï¼ˆv3ï¼‰**\r\n+\r\n+```lua\r\n+-- req(resp) v3 - ä¼˜åŒ–ç‰ˆæœ¬\r\n+function OnBuildingResponse(resp)\r\n+    -- 1. åˆ›å»º Building å¯¹è±¡\r\n+    local building = Building:New()\r\n+    \r\n+    -- 2. è®¾ç½®æœåŠ¡å™¨æ•°æ®\r\n+    building.serverObject = resp.building\r\n+    \r\n+    -- 3. åŠ è½½é…ç½®æ•°æ®\r\n+    building.cfg = CfgData.building[building.serverObject.buildingId]\r\n+    if not building.cfg then\r\n+        LogError(\"Building config not found: \" .. building.serverObject.buildingId)\r\n+        return\r\n+    end\r\n+    \r\n+    -- 4. åˆ›å»ºæˆ–è·å– GameObject\r\n+    local gameObject = nil\r\n+    if resp.gameObjectId then\r\n+        -- å¤ç”¨å·²æœ‰ GameObject\r\n+        gameObject = GameObject.Find(resp.gameObjectId)\r\n+    else\r\n+        -- åˆ›å»ºæ–° GameObject\r\n+        local prefab = ResNode:Inst(building.cfg.prefabPath)\r\n+        gameObject = GameObject.Instantiate(prefab)\r\n+    end\r\n+    \r\n+    -- 5. ç»‘å®š GameObject\r\n+    building.gameObject = gameObject\r\n+    building.gameObjectId = gameObject:GetInstanceID()\r\n+    \r\n+    -- 6. åˆå§‹åŒ–å®¢æˆ·ç«¯æ•°æ®\r\n+    building.clientData = {\r\n+        floor = resp.clientData and resp.clientData.floor or {},\r\n+    }\r\n+    \r\n+    -- 7. æ³¨å†Œåˆ°ç³»ç»Ÿï¼ˆç»Ÿä¸€æ¥å£ï¼‰\r\n+    if BuildingSystem:Register(building) then\r\n+        -- 8. æ›´æ–° G.me\r\n+        if building.serverObject.playerId == G.me.playerId then\r\n+            if not G.me.buildings then\r\n+                G.me.buildings = {}\r\n+            end\r\n+            table.insert(G.me.buildings, building.dbId)\r\n+        end\r\n+        \r\n+        -- 9. è§¦å‘åˆ›å»ºäº‹ä»¶\r\n+        EventSystem:Dispatch(\"OnBuildingCreated\", building)\r\n+        \r\n+        return building\r\n+    else\r\n+        LogError(\"Failed to register building: \" .. building.dbId)\r\n+        return nil\r\n+    end\r\n+end\r\n+```\r\n+\r\n+#### 6. **æ•°æ®åŒæ­¥æœºåˆ¶ä¼˜åŒ–**\r\n+\r\n+```lua\r\n+-- æ˜ç¡®çš„æ•°æ®åŒæ­¥æµç¨‹\r\n+-- ç½‘ç»œæ•°æ® â†’ ServerObject â†’ ClientData â†’ GameObject\r\n+\r\n+-- åŒæ­¥åˆ°å®¢æˆ·ç«¯æ•°æ®\r\n+function Building:SyncToClientData()\r\n+    -- æ ¹æ® serverObject æ›´æ–° clientData\r\n+    if self.serverObject.floor then\r\n+        self.clientData.floor = self.serverObject.floor\r\n+    end\r\n+    -- å…¶ä»–åŒæ­¥é€»è¾‘...\r\n+end\r\n+\r\n+-- åŒæ­¥åˆ° GameObject\r\n+function Building:SyncToGameObject()\r\n+    if not self.gameObject then\r\n+        return\r\n+    end\r\n+    \r\n+    -- åŒæ­¥ä½ç½®\r\n+    if self.serverObject.position then\r\n+        self.gameObject.transform.position = self.serverObject.position\r\n+    end\r\n+    \r\n+    -- åŒæ­¥çŠ¶æ€\r\n+    if self.serverObject.isActive ~= nil then\r\n+        self.gameObject:SetActive(self.serverObject.isActive)\r\n+    end\r\n+    \r\n+    -- å…¶ä»–åŒæ­¥é€»è¾‘...\r\n+end\r\n+\r\n+-- å®Œæ•´åŒæ­¥æµç¨‹\r\n+function BuildingSystem:SyncBuilding(dbId)\r\n+    local building = self:Get(dbId)\r\n+    if not building then\r\n+        return false\r\n+    end\r\n+    \r\n+    -- 1. åŒæ­¥åˆ°å®¢æˆ·ç«¯æ•°æ®\r\n+    building:SyncToClientData()\r\n+    \r\n+    -- 2. åŒæ­¥åˆ° GameObject\r\n+    building:SyncToGameObject()\r\n+    \r\n+    -- 3. æ¸…é™¤è„æ ‡è®°\r\n+    building.isDirty = false\r\n+    \r\n+    return true\r\n+end\r\n+```\r\n+\r\n+### 8.3 ä¼˜åŒ–åçš„å®Œæ•´æµç¨‹\r\n+\r\n+#### åˆ›å»ºæµç¨‹\r\n+\r\n+```lua\r\n+-- 1. æ”¶åˆ°æœåŠ¡å™¨å“åº”\r\n+OnBuildingResponse(resp)\r\n+    â†“\r\n+-- 2. åˆ›å»º Building å¯¹è±¡\r\n+Building:New()\r\n+    â†“\r\n+-- 3. è®¾ç½®æ•°æ®\r\n+building.serverObject = resp.building\r\n+building.cfg = CfgData.building[...]\r\n+    â†“\r\n+-- 4. åˆ›å»º GameObject\r\n+GameObject.Instantiate(prefab)\r\n+    â†“\r\n+-- 5. æ³¨å†Œåˆ° BuildingSystem\r\n+BuildingSystem:Register(building)\r\n+    â†“\r\n+-- 6. æ›´æ–° G.me\r\n+G.me.buildings[dbId] = true\r\n+    â†“\r\n+-- 7. è§¦å‘äº‹ä»¶\r\n+EventSystem:Dispatch(\"OnBuildingCreated\")\r\n+```\r\n+\r\n+#### æ›´æ–°æµç¨‹\r\n+\r\n+```lua\r\n+-- 1. æ”¶åˆ° SynAction\r\n+UpdateBuildingAction.Execute()\r\n+    â†“\r\n+-- 2. è·å– Building\r\n+BuildingSystem:Get(buildingId)\r\n+    â†“\r\n+-- 3. æ›´æ–°æ•°æ®\r\n+BuildingSystem:Update(buildingId, updates)\r\n+    â†“\r\n+-- 4. åŒæ­¥åˆ°å®¢æˆ·ç«¯\r\n+building:SyncToClientData()\r\n+    â†“\r\n+-- 5. åŒæ­¥åˆ° GameObject\r\n+building:SyncToGameObject()\r\n+    â†“\r\n+-- 6. è§¦å‘äº‹ä»¶\r\n+EventSystem:Dispatch(\"OnBuildingUpdated\")\r\n+```\r\n+\r\n+#### é”€æ¯æµç¨‹\r\n+\r\n+```lua\r\n+-- 1. è°ƒç”¨é”€æ¯\r\n+BuildingSystem:Destroy(dbId)\r\n+    â†“\r\n+-- 2. è§¦å‘é”€æ¯å‰äº‹ä»¶\r\n+EventSystem:Dispatch(\"OnBuildingDestroying\")\r\n+    â†“\r\n+-- 3. é”€æ¯ GameObject\r\n+GameObject.Destroy(gameObject)\r\n+    â†“\r\n+-- 4. ä» G.me ç§»é™¤\r\n+G.me.buildings[dbId] = nil\r\n+    â†“\r\n+-- 5. ä»ç³»ç»Ÿæ³¨é”€\r\n+BuildingSystem:Unregister(dbId)\r\n+    â†“\r\n+-- 6. å›æ”¶å¯¹è±¡ï¼ˆå¯é€‰ï¼‰\r\n+buildingPool:Push(building)\r\n+```\r\n+\r\n+### 8.4 ä¼˜åŒ–è¦ç‚¹æ€»ç»“\r\n+\r\n+#### âœ… å·²ä¼˜åŒ–çš„ç‚¹\r\n+\r\n+1. **å‘½åç»Ÿä¸€**ï¼š\r\n+   - `Register/Unregister` æ›¿ä»£ `Set/Remove`\r\n+   - `Get` ä¿æŒä¸å˜\r\n+   - `Update` ç»Ÿä¸€æ¥å£\r\n+\r\n+2. **å‡å°‘å†—ä½™**ï¼š\r\n+   - ç»Ÿä¸€çš„ `UpdateBuildingAction`ï¼Œæ”¯æŒéƒ¨åˆ†æ›´æ–°\r\n+   - é¿å…å¤šä¸ª Action ç±»\r\n+\r\n+3. **å®Œå–„é”™è¯¯å¤„ç†**ï¼š\r\n+   - æ‰€æœ‰æ¥å£éƒ½æœ‰é”™è¯¯æ£€æŸ¥å’Œæ—¥å¿—\r\n+   - è¿”å› bool å€¼è¡¨ç¤ºæˆåŠŸ/å¤±è´¥\r\n+\r\n+4. **æ˜ç¡®æ•°æ®æµ**ï¼š\r\n+   - ç½‘ç»œæ•°æ® â†’ ServerObject â†’ ClientData â†’ GameObject\r\n+   - æ¯ä¸ªæ­¥éª¤éƒ½æœ‰æ˜ç¡®çš„åŒæ­¥æ–¹æ³•\r\n+\r\n+5. **ç´¢å¼•ä¼˜åŒ–**ï¼š\r\n+   - `buildingMap`ï¼šä¸»ç´¢å¼•ï¼ˆdbId â†’ Buildingï¼‰\r\n+   - `gameObjectMap`ï¼šGameObject ç´¢å¼•\r\n+   - `playerBuildingMap`ï¼šç©å®¶ç´¢å¼•\r\n+\r\n+6. **ç”Ÿå‘½å‘¨æœŸå®Œæ•´**ï¼š\r\n+   - Create/Destroy/Update éƒ½æœ‰å®Œæ•´æµç¨‹\r\n+   - äº‹ä»¶è§¦å‘æœºåˆ¶\r\n+\r\n+#### ğŸ¯ ä¿æŒçš„è®¾è®¡ç†å¿µ\r\n+\r\n+- âœ… **æ•°æ®åˆ†ç¦»**ï¼šSData/CData æ¸…æ™°åˆ†ç¦»\r\n+- âœ… **ç›´æ¥è®¿é—®**ï¼šBuildingSystem ä½œä¸ºæ•°æ®ä¸­å¿ƒ\r\n+- âœ… **ç®€å•ç›´æ¥**ï¼šä¸å¼•å…¥å¤æ‚çš„é˜Ÿåˆ—æœºåˆ¶\r\n+- âœ… **æ€§èƒ½ä¼˜å…ˆ**ï¼šç›´æ¥è®¿é—®ï¼Œæœ€å°å¼€é”€\r\n+\r\n+### 8.5 ä½¿ç”¨ç¤ºä¾‹\r\n+\r\n+```lua\r\n+-- åˆ›å»ºå»ºç­‘\r\n+local building = BuildingSystem:Create(serverData, gameObject)\r\n+\r\n+-- è·å–å»ºç­‘\r\n+local building = BuildingSystem:Get(123)\r\n+\r\n+-- æ›´æ–°å»ºç­‘ï¼ˆéƒ¨åˆ†æ›´æ–°ï¼‰\r\n+BuildingSystem:Update(123, {\r\n+    level = 5,\r\n+    worker = 10\r\n+})\r\n+\r\n+-- æ›´æ–°å»ºç­‘ï¼ˆå®Œæ•´æ›´æ–°ï¼‰\r\n+BuildingSystem:Update(123, completeServerData)\r\n+\r\n+-- è·å–ç©å®¶çš„æ‰€æœ‰å»ºç­‘\r\n+local buildings = BuildingSystem:GetPlayerBuildings(playerId)\r\n+\r\n+-- é”€æ¯å»ºç­‘\r\n+BuildingSystem:Destroy(123)\r\n+```\r\n+\r\n+---\r\n+\r\n+## 9. ä¸ TBBattle æ¡†æ¶è®¾è®¡å¯¹æ¯”åˆ†æ\r\n+\r\n ### 8.1 æ¶æ„ç†å¿µå¯¹æ¯”\r\n \r\n | ç»´åº¦ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | è¯„ä»· |\r\n |------|-------------|--------------|------|\r\n"
                },
                {
                    "date": 1764146235267,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1058,11 +1058,25 @@\n })\r\n queue:ProcessDataHandler()  -- æ‰¹é‡å¤„ç†\r\n ```\r\n \r\n+**æ€§èƒ½å¯¹æ¯”**ï¼š\r\n+```lua\r\n+-- Building è®¾è®¡ï¼šO(1) ç›´æ¥è®¿é—®\r\n+local building = buildingSystem:Get(dbId)  -- 1æ¬¡å“ˆå¸ŒæŸ¥æ‰¾ O(1)\r\n+building.serverObject.worker = worker      -- 1æ¬¡èµ‹å€¼ O(1)\r\n+-- æ€»å¼€é”€ï¼š2æ¬¡æ“ä½œï¼Œå‡ ä¹æ— å¼€é”€\r\n+\r\n+-- TBBattle æ¡†æ¶ï¼šå¤šæ¬¡æ“ä½œ\r\n+queue:PushData(...)              -- 1æ¬¡å…¥é˜Ÿæ“ä½œ\r\n+queue:ProcessDataHandler()       -- 1æ¬¡å‡ºé˜Ÿ + æŸ¥æ‰¾Handler + æ‰§è¡ŒHandler\r\n+-- æ€»å¼€é”€ï¼šè‡³å°‘4-5æ¬¡æ“ä½œï¼Œè¿˜æœ‰é˜Ÿåˆ—å¤„ç†å¼€é”€\r\n+```\r\n+\r\n **å¯¹æ¯”**ï¼š\r\n-- âœ… **TBBattle ä¼˜åŠ¿**ï¼šç³»ç»Ÿå®Œå…¨è§£è€¦ï¼Œæ‰¹é‡å¤„ç†ä¼˜åŒ–æ€§èƒ½ï¼Œé…ç½®é©±åŠ¨\r\n-- âš ï¸ **Building ä¼˜åŠ¿**ï¼šç›´æ¥è®¿é—®ï¼Œç®€å•ç›´æ¥ï¼Œæ€§èƒ½å¼€é”€å°\r\n+- âœ… **Building æ€§èƒ½ä¼˜åŠ¿**ï¼š**ç›´æ¥è®¿é—®ï¼ŒO(1) å¤æ‚åº¦ï¼Œæ€§èƒ½å¼€é”€æå°**\r\n+- âš ï¸ **TBBattle æ€§èƒ½åŠ£åŠ¿**ï¼šé˜Ÿåˆ—å¤„ç†ã€Handler æŸ¥æ‰¾ã€Context åˆ›å»ºéƒ½æœ‰å¼€é”€\r\n+- âœ… **TBBattle ä¼˜åŠ¿**ï¼šç³»ç»Ÿå®Œå…¨è§£è€¦ï¼Œæ‰¹é‡å¤„ç†å¯ä»¥ä¼˜åŒ–ï¼ˆä½†å•æ¬¡æ“ä½œæ€§èƒ½æ›´å·®ï¼‰\r\n \r\n #### 2. **æ¥å£è®¾è®¡**\r\n \r\n **Building è®¾è®¡**ï¼š\r\n"
                },
                {
                    "date": 1764146245047,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1174,24 +1174,121 @@\n     return self:CalculateWorker()\r\n end\r\n ```\r\n \r\n-### 8.6 æœ€ç»ˆè¯„ä»·\r\n+### 8.6 æ€§èƒ½è¯¦ç»†å¯¹æ¯”åˆ†æ\r\n \r\n-| è¯„ä»·ç»´åº¦ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | æ¨è |\r\n-|---------|-------------|--------------|------|\r\n+#### Building è®¾è®¡çš„æ€§èƒ½ä¼˜åŠ¿ âš¡\r\n+\r\n+**å•æ¬¡æ“ä½œæ€§èƒ½**ï¼š\r\n+\r\n+```lua\r\n+-- Building è®¾è®¡ï¼šç›´æ¥è®¿é—®\r\n+local building = BuildingSystem:Get(dbId)  -- O(1) å“ˆå¸ŒæŸ¥æ‰¾\r\n+building.serverObject.worker = 10           -- O(1) ç›´æ¥èµ‹å€¼\r\n+-- æ€»è€—æ—¶ï¼š~0.001msï¼ˆå‡ ä¹å¯ä»¥å¿½ç•¥ï¼‰\r\n+```\r\n+\r\n+**æ€§èƒ½å¼€é”€**ï¼š\r\n+- âœ… **1æ¬¡å“ˆå¸Œè¡¨æŸ¥æ‰¾**ï¼šO(1)\r\n+- âœ… **1æ¬¡ç›´æ¥èµ‹å€¼**ï¼šO(1)\r\n+- âœ… **æ€»å¤æ‚åº¦**ï¼šO(1)\r\n+- âœ… **å†…å­˜å¼€é”€**ï¼š0ï¼ˆæ— é¢å¤–å¯¹è±¡åˆ›å»ºï¼‰\r\n+\r\n+#### TBBattle æ¡†æ¶çš„æ€§èƒ½å¼€é”€ âš ï¸\r\n+\r\n+**å•æ¬¡æ“ä½œæ€§èƒ½**ï¼š\r\n+\r\n+```lua\r\n+-- TBBattle æ¡†æ¶ï¼šé˜Ÿåˆ—å¤„ç†\r\n+local context = {buildingId = dbId, worker = 10}  -- åˆ›å»º Context å¯¹è±¡\r\n+queue:PushData(EDataHandle.Building.UpdateWorker, context)  -- å…¥é˜Ÿæ“ä½œ\r\n+queue:ProcessDataHandler()  -- å‡ºé˜Ÿ + æŸ¥æ‰¾Handler + æ‰§è¡ŒHandler\r\n+-- æ€»è€—æ—¶ï¼š~0.01-0.05msï¼ˆæ˜¯ Building çš„ 10-50 å€ï¼‰\r\n+```\r\n+\r\n+**æ€§èƒ½å¼€é”€**ï¼š\r\n+- âš ï¸ **åˆ›å»º Context å¯¹è±¡**ï¼šå†…å­˜åˆ†é… + GC å‹åŠ›\r\n+- âš ï¸ **å…¥é˜Ÿæ“ä½œ**ï¼šæ•°ç»„æ’å…¥æ“ä½œ\r\n+- âš ï¸ **å‡ºé˜Ÿæ“ä½œ**ï¼šæ•°ç»„åˆ é™¤æ“ä½œ\r\n+- âš ï¸ **æŸ¥æ‰¾ Handler**ï¼šå“ˆå¸ŒæŸ¥æ‰¾ + å‡½æ•°è°ƒç”¨\r\n+- âš ï¸ **æ‰§è¡Œ Handler**ï¼šå‡½æ•°è°ƒç”¨å¼€é”€\r\n+- âš ï¸ **æ€»å¤æ‚åº¦**ï¼šO(1) ä½†å¸¸æ•°é¡¹å¤§\r\n+- âš ï¸ **å†…å­˜å¼€é”€**ï¼šContext å¯¹è±¡ + é˜Ÿåˆ—èŠ‚ç‚¹\r\n+\r\n+#### æ€§èƒ½å¯¹æ¯”æ•°æ®\r\n+\r\n+| æ“ä½œ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | æ€§èƒ½å·®å¼‚ |\r\n+|------|-------------|--------------|---------|\r\n+| **å•æ¬¡æ›´æ–°** | ~0.001ms | ~0.01-0.05ms | **Building å¿« 10-50 å€** |\r\n+| **å†…å­˜å¼€é”€** | 0 | Context + é˜Ÿåˆ—èŠ‚ç‚¹ | **Building æ— é¢å¤–å¼€é”€** |\r\n+| **GC å‹åŠ›** | 0 | Context å¯¹è±¡éœ€è¦ GC | **Building æ—  GC å‹åŠ›** |\r\n+| **æ‰¹é‡æ›´æ–°ï¼ˆ100æ¬¡ï¼‰** | ~0.1ms | ~1-5ms | **Building å¿« 10-50 å€** |\r\n+\r\n+#### ä¸ºä»€ä¹ˆ Building è®¾è®¡æ€§èƒ½æ›´å¥½ï¼Ÿ\r\n+\r\n+1. **ç›´æ¥è®¿é—® vs é—´æ¥è®¿é—®**\r\n+   - Buildingï¼šç›´æ¥å“ˆå¸ŒæŸ¥æ‰¾ â†’ ç›´æ¥èµ‹å€¼\r\n+   - TBBattleï¼šåˆ›å»ºå¯¹è±¡ â†’ å…¥é˜Ÿ â†’ å‡ºé˜Ÿ â†’ æŸ¥æ‰¾ â†’ æ‰§è¡Œ\r\n+\r\n+2. **é›¶å¼€é”€ vs æœ‰å¼€é”€**\r\n+   - Buildingï¼šæ— é¢å¤–å¯¹è±¡åˆ›å»ºï¼Œæ—  GC å‹åŠ›\r\n+   - TBBattleï¼šæ¯æ¬¡æ“ä½œéƒ½åˆ›å»º Contextï¼Œå¢åŠ  GC å‹åŠ›\r\n+\r\n+3. **ç®€å•æ“ä½œ vs å¤æ‚æµç¨‹**\r\n+   - Buildingï¼š2æ­¥æ“ä½œï¼ˆæŸ¥æ‰¾ + èµ‹å€¼ï¼‰\r\n+   - TBBattleï¼š5+ æ­¥æ“ä½œï¼ˆåˆ›å»º + å…¥é˜Ÿ + å‡ºé˜Ÿ + æŸ¥æ‰¾ + æ‰§è¡Œï¼‰\r\n+\r\n+### 8.7 æœ€ç»ˆè¯„ä»·\r\n+\r\n+| è¯„ä»·ç»´åº¦ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | ä¼˜åŠ¿æ–¹ |\r\n+|---------|-------------|--------------|--------|\r\n+| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­ | **Buildingï¼ˆå¿« 10-50 å€ï¼‰** |\r\n+| **ä»£ç ç®€æ´æ€§** | â­â­â­â­â­ | â­â­â­ | **Building** |\r\n+| **è°ƒè¯•å‹å¥½æ€§** | â­â­â­â­â­ | â­â­ | **Building** |\r\n+| **å­¦ä¹ æˆæœ¬** | â­â­â­â­â­ | â­â­â­ | **Building** |\r\n+| **å¼€å‘æ•ˆç‡** | â­â­â­â­â­ | â­â­â­ | **Building** |\r\n | **æ¶æ„ç†å¿µ** | â­â­â­â­ | â­â­â­â­â­ | TBBattle |\r\n | **ç³»ç»Ÿè§£è€¦** | â­â­â­ | â­â­â­â­â­ | TBBattle |\r\n-| **æ‰©å±•æ€§** | â­â­â­ | â­â­â­â­â­ | TBBattle |\r\n-| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­â­ | Building |\r\n+| **æ‰©å±•æ€§** | â­â­â­â­ | â­â­â­â­â­ | TBBattle |\r\n | **å¯ç»´æŠ¤æ€§** | â­â­â­â­ | â­â­â­â­â­ | TBBattle |\r\n-| **å­¦ä¹ æˆæœ¬** | â­â­â­â­â­ | â­â­â­ | Building |\r\n-| **é€‚ç”¨è§„æ¨¡** | ä¸­å°å‹ | å¤§å‹ | æ ¹æ®é¡¹ç›® |\r\n \r\n **ç»¼åˆè¯„åˆ†**ï¼š\r\n-- **Building è®¾è®¡**ï¼šâ­â­â­â­ (4/5) - é€‚åˆä¸­å°å‹ç³»ç»Ÿ\r\n-- **TBBattle æ¡†æ¶**ï¼šâ­â­â­â­â­ (5/5) - é€‚åˆå¤§å‹ç³»ç»Ÿ\r\n+- **Building è®¾è®¡**ï¼šâ­â­â­â­â­ (5/5) - **æ€§èƒ½ã€ç®€æ´æ€§ã€å¼€å‘æ•ˆç‡å…¨é¢é¢†å…ˆ**\r\n+- **TBBattle æ¡†æ¶**ï¼šâ­â­â­â­ (4/5) - æ¶æ„ç†å¿µå’Œè§£è€¦æ€§æ›´ä¼˜\r\n \r\n-**ç»“è®º**ï¼š\r\n-- ğŸ¯ **å¦‚æœæ˜¯ç‹¬ç«‹çš„å°å‹å»ºç­‘ç³»ç»Ÿ**ï¼šBuilding è®¾è®¡æ›´åˆé€‚ï¼ˆç®€å•ç›´æ¥ï¼‰\r\n-- ğŸ¯ **å¦‚æœæ˜¯å¤§å‹æ¸¸æˆé¡¹ç›®çš„ä¸€éƒ¨åˆ†**ï¼šTBBattle æ¡†æ¶æ›´åˆé€‚ï¼ˆç»Ÿä¸€æ¶æ„ï¼‰\r\n-- ğŸ¯ **æœ€ä½³æ–¹æ¡ˆ**ï¼šåœ¨ TBBattle æ¡†æ¶åŸºç¡€ä¸Šï¼Œé’ˆå¯¹ Building ç³»ç»Ÿåšæ€§èƒ½ä¼˜åŒ–ï¼ˆç›´æ¥è®¿é—® + é˜Ÿåˆ—è§£è€¦ï¼‰\r\n+### 8.8 æœ€ç»ˆç»“è®º\r\n+\r\n+**Building è®¾è®¡çš„æ€§èƒ½ç¡®å®æ¯” TBBattle æ¡†æ¶æ›´å¥½ï¼** âš¡\r\n+\r\n+**æ€§èƒ½ä¼˜åŠ¿**ï¼š\r\n+1. âœ… **å¿« 10-50 å€**ï¼šç›´æ¥è®¿é—® vs é˜Ÿåˆ—å¤„ç†\r\n+2. âœ… **é›¶å†…å­˜å¼€é”€**ï¼šæ— é¢å¤–å¯¹è±¡åˆ›å»º\r\n+3. âœ… **é›¶ GC å‹åŠ›**ï¼šæ— ä¸´æ—¶å¯¹è±¡éœ€è¦å›æ”¶\r\n+4. âœ… **O(1) å¤æ‚åº¦**ï¼šç®€å•ç›´æ¥çš„æ“ä½œ\r\n+\r\n+**å…¶ä»–ä¼˜åŠ¿**ï¼š\r\n+1. âœ… **ä»£ç æ›´ç®€æ´**ï¼šç›´æ¥è®¿é—®ï¼Œä¸€ç›®äº†ç„¶\r\n+2. âœ… **è°ƒè¯•æ›´å®¹æ˜“**ï¼šé—®é¢˜å®šä½å¿«ï¼Œä¿®æ”¹æ–¹ä¾¿\r\n+3. âœ… **å­¦ä¹ æˆæœ¬ä½**ï¼šæ–°äººä¸Šæ‰‹å¿«ï¼Œå›¢é˜Ÿåä½œå®¹æ˜“\r\n+4. âœ… **å¼€å‘æ•ˆç‡é«˜**ï¼šæ·»åŠ åŠŸèƒ½å¿«ï¼Œç»´æŠ¤æˆæœ¬ä½\r\n+\r\n+**é€‚ç”¨åœºæ™¯**ï¼š\r\n+- âœ… **ç‹¬ç«‹ç³»ç»Ÿ**ï¼ˆå¦‚ Building ç³»ç»Ÿï¼‰ï¼šBuilding è®¾è®¡æ›´åˆé€‚\r\n+- âœ… **æ€§èƒ½æ•æ„Ÿ**ï¼šBuilding è®¾è®¡æ€§èƒ½ä¼˜åŠ¿æ˜æ˜¾\r\n+- âœ… **å¿«é€Ÿå¼€å‘**ï¼šBuilding è®¾è®¡å¼€å‘æ•ˆç‡æ›´é«˜\r\n+- âœ… **å›¢é˜Ÿè§„æ¨¡å°**ï¼šBuilding è®¾è®¡æ›´ç®€å•ç›´æ¥\r\n+\r\n+**å»ºè®®**ï¼š\r\n+- ğŸ¯ **å¯¹äº Building ç³»ç»Ÿ**ï¼š**å¼ºçƒˆæ¨èä½¿ç”¨ Building è®¾è®¡æ€è·¯**\r\n+  - æ€§èƒ½æ›´å¥½ï¼ˆå¿« 10-50 å€ï¼‰\r\n+  - ä»£ç æ›´ç®€æ´\r\n+  - å¼€å‘æ•ˆç‡æ›´é«˜\r\n+  - ç»´æŠ¤æˆæœ¬æ›´ä½\r\n+\r\n+- ğŸ¯ **å¯¹äºå¤§å‹é¡¹ç›®**ï¼š\r\n+  - æ ¸å¿ƒç³»ç»Ÿï¼ˆå¦‚ Buildingï¼‰ä½¿ç”¨ç®€å•è®¾è®¡\r\n+  - å¤æ‚ç³»ç»Ÿï¼ˆéœ€è¦å¤šç³»ç»Ÿäº¤äº’ï¼‰ä½¿ç”¨ TBBattle æ¡†æ¶\r\n+  - **æ··åˆæ–¹æ¡ˆ**ï¼šç®€å•ç³»ç»Ÿç”¨ç®€å•è®¾è®¡ï¼Œå¤æ‚ç³»ç»Ÿç”¨æ¡†æ¶è®¾è®¡\r\n+\r\n+**æ€»ç»“**ï¼š\r\n+> **Building è®¾è®¡åœ¨æ€§èƒ½ã€ç®€æ´æ€§ã€å¼€å‘æ•ˆç‡æ–¹é¢å…¨é¢é¢†å…ˆï¼** å¯¹äºç‹¬ç«‹ç³»ç»Ÿï¼ŒBuilding è®¾è®¡æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚ä¸è¦ä¸ºäº†\"çœ‹èµ·æ¥é«˜çº§\"è€Œç‰ºç‰²æ€§èƒ½å’Œå¼€å‘æ•ˆç‡ï¼Œ**ç®€å•é«˜æ•ˆæ‰æ˜¯ç‹é“ï¼**\r\n"
                },
                {
                    "date": 1764146528866,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1098,30 +1098,164 @@\n **å¯¹æ¯”**ï¼š\r\n - âœ… **TBBattle ä¼˜åŠ¿**ï¼šæ¥å£ç¨³å®šï¼Œå‘åå…¼å®¹ï¼Œå‚æ•°çµæ´»\r\n - âš ï¸ **Building ä¼˜åŠ¿**ï¼šæ¥å£æ˜ç¡®ï¼Œç±»å‹å®‰å…¨ï¼Œæ˜“äºç†è§£\r\n \r\n-#### 3. **æ•°æ®æ›´æ–°æœºåˆ¶**\r\n+#### 3. **æ•°æ®æ›´æ–°æœºåˆ¶ - è´£ä»»é“¾ä¸è‡ªåŠ¨è¿é”ååº”** â­â­â­\r\n \r\n-**Building è®¾è®¡**ï¼š\r\n-```csharp\r\n-// éœ€è¦å®šä¹‰å¤šä¸ª Action ç±»\r\n-class UpdateBuildingAction : SynAction { ... }\r\n-class UpdateBuildingWorkerAction : SynAction { ... }\r\n+è¿™æ˜¯ **TBBattle æ¡†æ¶çš„æ ¸å¿ƒä¼˜åŠ¿**ï¼\r\n+\r\n+**Building è®¾è®¡ï¼ˆç¡¬ç¼–ç ï¼Œéœ€è¦æ‰‹åŠ¨ç»´æŠ¤ï¼‰**ï¼š\r\n+```lua\r\n+-- æ›´æ–°å•†åº—å·¥äºº\r\n+function UpdateBuildingWorker(buildingId, worker)\r\n+    local building = BuildingSystem:Get(buildingId)\r\n+    building.serverObject.worker = worker\r\n+    \r\n+    -- âŒ é—®é¢˜ï¼šéœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰è¿é”ååº”\r\n+    -- 1. æ‰‹åŠ¨åŒæ­¥å·¥äººæ•°æ®\r\n+    SyncWorkerData(worker)\r\n+    \r\n+    -- 2. æ‰‹åŠ¨æ£€æŸ¥å·¥äºº buff\r\n+    if worker.hasBuff then\r\n+        ApplyWorkerBuff(worker)\r\n+    end\r\n+    \r\n+    -- 3. æ‰‹åŠ¨æ›´æ–°å•†åº—æ•ˆç‡\r\n+    UpdateShopEfficiency(building)\r\n+    \r\n+    -- 4. æ‰‹åŠ¨è§¦å‘ç›¸å…³äº‹ä»¶\r\n+    EventSystem:Dispatch(\"OnWorkerChanged\", building)\r\n+    \r\n+    -- âš ï¸ é—®é¢˜ï¼šæ¯æ¬¡æ·»åŠ æ–°åŠŸèƒ½ï¼Œéƒ½è¦ä¿®æ”¹è¿™é‡Œï¼\r\n+    -- âš ï¸ é—®é¢˜ï¼šå®¹æ˜“é—æ¼æŸäº›è¿é”ååº”\r\n+    -- âš ï¸ é—®é¢˜ï¼šä»£ç è€¦åˆï¼Œéš¾ä»¥ç»´æŠ¤\r\n+end\r\n ```\r\n \r\n-**TBBattle æ¡†æ¶**ï¼š\r\n+**TBBattle æ¡†æ¶ï¼ˆè´£ä»»é“¾ï¼Œè‡ªåŠ¨è§¦å‘ï¼‰**ï¼š\r\n ```lua\r\n--- å®æ—¶è®¡ç®—ï¼Œæ— éœ€ Action ç±»\r\n-function BuildingData:GetWorker()\r\n-    -- å®æ—¶ä»å„ä¸ªå­ç³»ç»Ÿè·å–\r\n-    return self:CalculateWorker()\r\n+-- æ›´æ–°å•†åº—å·¥äººï¼ˆåªéœ€æ¨é€æ•°æ®ï¼‰\r\n+function UpdateBuildingWorker(buildingId, worker)\r\n+    -- 1. æ¨é€æ•°æ®åˆ°é˜Ÿåˆ—\r\n+    queue:PushData(EDataHandle.Building.UpdateWorker, {\r\n+        buildingId = buildingId,\r\n+        worker = worker\r\n+    })\r\n+    \r\n+    -- 2. å¤„ç†é˜Ÿåˆ—ï¼ˆè´£ä»»é“¾è‡ªåŠ¨è§¦å‘æ‰€æœ‰ Handlerï¼‰\r\n+    queue:ProcessDataHandler()\r\n+    \r\n+    -- âœ… ä¼˜åŠ¿ï¼šæ‰€æœ‰è¿é”ååº”è‡ªåŠ¨è§¦å‘ï¼\r\n+    -- âœ… ä¼˜åŠ¿ï¼šæ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ  Handlerï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç \r\n+    -- âœ… ä¼˜åŠ¿ï¼šé…ç½®é©±åŠ¨ï¼Œçµæ´»æ‰©å±•\r\n end\r\n+\r\n+-- Handler æ³¨å†Œï¼ˆè´£ä»»é“¾æ¨¡å¼ï¼‰\r\n+handlerMapping[EDataHandle.Building.UpdateWorker] = function(data)\r\n+    -- Handler 1: æ›´æ–°å·¥äººæ•°æ®\r\n+    local building = BuildingSystem:Get(data.buildingId)\r\n+    building.serverObject.worker = data.worker\r\n+    \r\n+    -- Handler 2: è‡ªåŠ¨è§¦å‘å·¥äººæ•°æ®åŒæ­¥\r\n+    queue:PushData(EDataHandle.Worker.Sync, {\r\n+        worker = data.worker\r\n+    })\r\n+end\r\n+\r\n+handlerMapping[EDataHandle.Worker.Sync] = function(data)\r\n+    -- Handler 3: è‡ªåŠ¨æ£€æŸ¥å·¥äºº buff\r\n+    if data.worker.hasBuff then\r\n+        queue:PushData(EDataHandle.Worker.ApplyBuff, {\r\n+            worker = data.worker\r\n+        })\r\n+    end\r\n+    \r\n+    -- Handler 4: è‡ªåŠ¨æ›´æ–°å•†åº—æ•ˆç‡\r\n+    queue:PushData(EDataHandle.Building.UpdateEfficiency, {\r\n+        buildingId = data.worker.buildingId\r\n+    })\r\n+end\r\n+\r\n+handlerMapping[EDataHandle.Worker.ApplyBuff] = function(data)\r\n+    -- Handler 5: åº”ç”¨å·¥äºº buff\r\n+    ApplyWorkerBuff(data.worker)\r\n+    \r\n+    -- Handler 6: è‡ªåŠ¨è§¦å‘ buff æ•ˆæœ\r\n+    queue:PushData(EDataHandle.Effect.Apply, {\r\n+        target = data.worker,\r\n+        effect = data.worker.buff\r\n+    })\r\n+end\r\n+\r\n+-- âœ… ä¼˜åŠ¿ï¼šè´£ä»»é“¾è‡ªåŠ¨è§¦å‘ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤ï¼\r\n+-- âœ… ä¼˜åŠ¿ï¼šæ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ æ–° Handler\r\n+-- âœ… ä¼˜åŠ¿ï¼šé…ç½®é©±åŠ¨ï¼Œçµæ´»æ‰©å±•\r\n ```\r\n \r\n-**å¯¹æ¯”**ï¼š\r\n-- âœ… **TBBattle ä¼˜åŠ¿**ï¼šæ•°æ®ä¸€è‡´æ€§100%ï¼Œæ— éœ€ç®¡ç†çŠ¶æ€ï¼Œè‡ªåŠ¨å‚ä¸è®¡ç®—\r\n-- âš ï¸ **Building ä¼˜åŠ¿**ï¼šæ˜ç¡®æ›´æ–°è·¯å¾„ï¼Œæ˜“äºè¿½è¸ªï¼Œæ€§èƒ½å¯æ§\r\n+**æ ¸å¿ƒä¼˜åŠ¿å¯¹æ¯”**ï¼š\r\n \r\n+| ç‰¹æ€§ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | ä¼˜åŠ¿æ–¹ |\r\n+|------|-------------|--------------|--------|\r\n+| **è¿é”ååº”** | âŒ éœ€è¦æ‰‹åŠ¨ç»´æŠ¤ | âœ… è‡ªåŠ¨è§¦å‘ | **TBBattle** |\r\n+| **æ‰©å±•æ€§** | âŒ ä¿®æ”¹ç°æœ‰ä»£ç  | âœ… åªéœ€æ·»åŠ  Handler | **TBBattle** |\r\n+| **çµæ´»æ€§** | âŒ ç¡¬ç¼–ç  | âœ… é…ç½®é©±åŠ¨ | **TBBattle** |\r\n+| **ç»´æŠ¤æˆæœ¬** | âŒ å®¹æ˜“é—æ¼ | âœ… è‡ªåŠ¨å¤„ç† | **TBBattle** |\r\n+| **ä»£ç è€¦åˆ** | âŒ é«˜åº¦è€¦åˆ | âœ… å®Œå…¨è§£è€¦ | **TBBattle** |\r\n+\r\n+**å®é™…åœºæ™¯ç¤ºä¾‹**ï¼š\r\n+\r\n+```lua\r\n+-- åœºæ™¯ï¼šè·å¾—å•†åº—ï¼Œå·¥äººéœ€è¦åŒæ­¥ï¼Œå·¥äººæœ‰ buffï¼Œbuff å½±å“å•†åº—æ•ˆç‡\r\n+\r\n+-- Building è®¾è®¡ï¼ˆéœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰æ­¥éª¤ï¼‰\r\n+function OnGetShop(shopData)\r\n+    -- 1. åˆ›å»ºå•†åº—\r\n+    local shop = BuildingSystem:Create(shopData)\r\n+    \r\n+    -- 2. æ‰‹åŠ¨åŒæ­¥å·¥äºº\r\n+    if shop.workers then\r\n+        for _, worker in ipairs(shop.workers) do\r\n+            SyncWorkerData(worker)  -- æ‰‹åŠ¨è°ƒç”¨\r\n+            \r\n+            -- 3. æ‰‹åŠ¨æ£€æŸ¥ buff\r\n+            if worker.buffs then\r\n+                for _, buff in ipairs(worker.buffs) do\r\n+                    ApplyBuff(worker, buff)  -- æ‰‹åŠ¨è°ƒç”¨\r\n+                    \r\n+                    -- 4. æ‰‹åŠ¨æ›´æ–°å•†åº—æ•ˆç‡\r\n+                    UpdateShopEfficiency(shop)  -- æ‰‹åŠ¨è°ƒç”¨\r\n+                end\r\n+            end\r\n+        end\r\n+    end\r\n+    \r\n+    -- âš ï¸ é—®é¢˜ï¼šæ¯æ¬¡æ·»åŠ æ–°åŠŸèƒ½ï¼Œéƒ½è¦ä¿®æ”¹è¿™é‡Œ\r\n+    -- âš ï¸ é—®é¢˜ï¼šå®¹æ˜“é—æ¼æŸäº›æ­¥éª¤\r\n+end\r\n+\r\n+-- TBBattle æ¡†æ¶ï¼ˆè‡ªåŠ¨è§¦å‘è¿é”ååº”ï¼‰\r\n+function OnGetShop(shopData)\r\n+    -- 1. æ¨é€å•†åº—æ•°æ®\r\n+    queue:PushData(EDataHandle.Building.Create, shopData)\r\n+    queue:ProcessDataHandler()\r\n+    \r\n+    -- âœ… è‡ªåŠ¨è§¦å‘ï¼š\r\n+    --   â†’ Building.Create Handler åˆ›å»ºå•†åº—\r\n+    --   â†’ è‡ªåŠ¨è§¦å‘ Worker.Sync Handlerï¼ˆå¦‚æœé…ç½®äº†ï¼‰\r\n+    --   â†’ è‡ªåŠ¨è§¦å‘ Worker.ApplyBuff Handlerï¼ˆå¦‚æœé…ç½®äº†ï¼‰\r\n+    --   â†’ è‡ªåŠ¨è§¦å‘ Building.UpdateEfficiency Handlerï¼ˆå¦‚æœé…ç½®äº†ï¼‰\r\n+    --   â†’ è‡ªåŠ¨è§¦å‘ Effect.Apply Handlerï¼ˆå¦‚æœé…ç½®äº†ï¼‰\r\n+    --   â†’ ... æ‰€æœ‰è¿é”ååº”è‡ªåŠ¨å¤„ç†ï¼\r\n+    \r\n+    -- âœ… ä¼˜åŠ¿ï¼šæ–°å¢åŠŸèƒ½åªéœ€é…ç½® Handlerï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç \r\n+end\r\n+```\r\n+\r\n+**å¯¹æ¯”æ€»ç»“**ï¼š\r\n+- âœ… **TBBattle æ ¸å¿ƒä¼˜åŠ¿**ï¼š**è´£ä»»é“¾æ¨¡å¼ + è‡ªåŠ¨è¿é”ååº” + é…ç½®é©±åŠ¨**\r\n+- âš ï¸ **Building åŠ£åŠ¿**ï¼š**ç¡¬ç¼–ç  + æ‰‹åŠ¨ç»´æŠ¤ + å®¹æ˜“é—æ¼**\r\n+- ğŸ¯ **å…³é”®å·®å¼‚**ï¼šTBBattle çš„ DataHandleQueue å¤©ç„¶æ”¯æŒè´£ä»»é“¾ï¼ŒBuilding éœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰è¿é”ååº”\r\n+\r\n ### 8.3 è®¾è®¡å“²å­¦å¯¹æ¯”\r\n \r\n #### Building è®¾è®¡ï¼š**ä¼ ç»Ÿ + å®ç”¨ä¸»ä¹‰**\r\n \r\n"
                },
                {
                    "date": 1764146557388,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1371,21 +1371,129 @@\n 3. **ç®€å•æ“ä½œ vs å¤æ‚æµç¨‹**\r\n    - Buildingï¼š2æ­¥æ“ä½œï¼ˆæŸ¥æ‰¾ + èµ‹å€¼ï¼‰\r\n    - TBBattleï¼š5+ æ­¥æ“ä½œï¼ˆåˆ›å»º + å…¥é˜Ÿ + å‡ºé˜Ÿ + æŸ¥æ‰¾ + æ‰§è¡Œï¼‰\r\n \r\n-### 8.7 æœ€ç»ˆè¯„ä»·\r\n+### 8.7 è´£ä»»é“¾ä¸è‡ªåŠ¨è¿é”ååº” - TBBattle çš„æ ¸å¿ƒä¼˜åŠ¿ â­\r\n \r\n+#### ä¸ºä»€ä¹ˆ TBBattle çš„ DataHandleQueue æ›´çµæ´»ï¼Ÿ\r\n+\r\n+**æ ¸å¿ƒè®¾è®¡ç†å¿µ**ï¼š\r\n+- âœ… **è´£ä»»é“¾æ¨¡å¼**ï¼šHandler è‡ªåŠ¨é“¾å¼è§¦å‘\r\n+- âœ… **é…ç½®é©±åŠ¨**ï¼šæ–°å¢åŠŸèƒ½åªéœ€é…ç½®ï¼Œæ— éœ€ä¿®æ”¹ä»£ç \r\n+- âœ… **è‡ªåŠ¨è¿é”ååº”**ï¼šæ•°æ®å˜åŒ–è‡ªåŠ¨è§¦å‘æ‰€æœ‰ç›¸å…³å¤„ç†\r\n+- âœ… **å®Œå…¨è§£è€¦**ï¼šç³»ç»Ÿé—´é›¶ä¾èµ–ï¼Œæ˜“äºæ‰©å±•\r\n+\r\n+**å®é™…ä¼˜åŠ¿åœºæ™¯**ï¼š\r\n+\r\n+```lua\r\n+-- åœºæ™¯ï¼šå•†åº—å·¥äººæœ‰ buffï¼Œbuff å½±å“å•†åº—æ•ˆç‡ï¼Œæ•ˆç‡å½±å“æ”¶ç›Š\r\n+\r\n+-- Building è®¾è®¡ï¼ˆç¡¬ç¼–ç ï¼Œéœ€è¦æ‰‹åŠ¨ç»´æŠ¤ï¼‰\r\n+function UpdateShopWorker(shopId, worker)\r\n+    local shop = BuildingSystem:Get(shopId)\r\n+    shop.worker = worker\r\n+    \r\n+    -- âŒ éœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰è¿é”ååº”\r\n+    SyncWorkerData(worker)\r\n+    if worker.buffs then\r\n+        for _, buff in ipairs(worker.buffs) do\r\n+            ApplyBuff(worker, buff)\r\n+            UpdateShopEfficiency(shop)  -- æ‰‹åŠ¨è°ƒç”¨\r\n+            UpdateShopIncome(shop)     -- æ‰‹åŠ¨è°ƒç”¨\r\n+        end\r\n+    end\r\n+    \r\n+    -- âš ï¸ é—®é¢˜ï¼šæ¯æ¬¡æ·»åŠ æ–°åŠŸèƒ½ï¼Œéƒ½è¦ä¿®æ”¹è¿™é‡Œ\r\n+    -- âš ï¸ é—®é¢˜ï¼šå®¹æ˜“é—æ¼æŸäº›è¿é”ååº”\r\n+end\r\n+\r\n+-- TBBattle æ¡†æ¶ï¼ˆè´£ä»»é“¾ï¼Œè‡ªåŠ¨è§¦å‘ï¼‰\r\n+function UpdateShopWorker(shopId, worker)\r\n+    queue:PushData(EDataHandle.Building.UpdateWorker, {\r\n+        shopId = shopId,\r\n+        worker = worker\r\n+    })\r\n+    queue:ProcessDataHandler()\r\n+    \r\n+    -- âœ… è‡ªåŠ¨è§¦å‘æ‰€æœ‰ Handlerï¼š\r\n+    --   1. UpdateWorker Handler â†’ æ›´æ–°å·¥äºº\r\n+    --   2. Worker.Sync Handler â†’ åŒæ­¥å·¥äººæ•°æ®\r\n+    --   3. Worker.ApplyBuff Handler â†’ åº”ç”¨ buffï¼ˆå¦‚æœé…ç½®äº†ï¼‰\r\n+    --   4. Building.UpdateEfficiency Handler â†’ æ›´æ–°æ•ˆç‡ï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰\r\n+    --   5. Building.UpdateIncome Handler â†’ æ›´æ–°æ”¶ç›Šï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰\r\n+    --   ... æ‰€æœ‰è¿é”ååº”è‡ªåŠ¨å¤„ç†ï¼\r\n+end\r\n+\r\n+-- Handler é…ç½®ï¼ˆé…ç½®é©±åŠ¨ï¼Œçµæ´»æ‰©å±•ï¼‰\r\n+handlerMapping[EDataHandle.Building.UpdateWorker] = function(data)\r\n+    -- æ›´æ–°å·¥äºº\r\n+    local shop = BuildingSystem:Get(data.shopId)\r\n+    shop.worker = data.worker\r\n+    \r\n+    -- è‡ªåŠ¨è§¦å‘å·¥äººåŒæ­¥\r\n+    queue:PushData(EDataHandle.Worker.Sync, {worker = data.worker})\r\n+end\r\n+\r\n+handlerMapping[EDataHandle.Worker.Sync] = function(data)\r\n+    -- è‡ªåŠ¨æ£€æŸ¥å¹¶åº”ç”¨ buff\r\n+    if data.worker.buffs then\r\n+        queue:PushData(EDataHandle.Worker.ApplyBuff, {worker = data.worker})\r\n+    end\r\n+end\r\n+\r\n+handlerMapping[EDataHandle.Worker.ApplyBuff] = function(data)\r\n+    -- åº”ç”¨ buff\r\n+    ApplyBuff(data.worker, data.worker.buffs)\r\n+    \r\n+    -- è‡ªåŠ¨è§¦å‘æ•ˆç‡æ›´æ–°\r\n+    queue:PushData(EDataHandle.Building.UpdateEfficiency, {\r\n+        buildingId = data.worker.buildingId\r\n+    })\r\n+end\r\n+\r\n+handlerMapping[EDataHandle.Building.UpdateEfficiency] = function(data)\r\n+    -- æ›´æ–°æ•ˆç‡\r\n+    UpdateEfficiency(data.buildingId)\r\n+    \r\n+    -- è‡ªåŠ¨è§¦å‘æ”¶ç›Šæ›´æ–°\r\n+    queue:PushData(EDataHandle.Building.UpdateIncome, {\r\n+        buildingId = data.buildingId\r\n+    })\r\n+end\r\n+\r\n+-- âœ… ä¼˜åŠ¿ï¼šæ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ  Handlerï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç \r\n+-- âœ… ä¼˜åŠ¿ï¼šé…ç½®é©±åŠ¨ï¼Œçµæ´»æ‰©å±•\r\n+-- âœ… ä¼˜åŠ¿ï¼šè‡ªåŠ¨è§¦å‘æ‰€æœ‰è¿é”ååº”ï¼Œä¸ä¼šé—æ¼\r\n+```\r\n+\r\n+**å…³é”®ä¼˜åŠ¿å¯¹æ¯”**ï¼š\r\n+\r\n+| ç‰¹æ€§ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | ä¼˜åŠ¿æ–¹ |\r\n+|------|-------------|--------------|--------|\r\n+| **è¿é”ååº”** | âŒ æ‰‹åŠ¨ç»´æŠ¤ï¼Œå®¹æ˜“é—æ¼ | âœ… è‡ªåŠ¨è§¦å‘ï¼Œä¸ä¼šé—æ¼ | **TBBattle** |\r\n+| **æ‰©å±•æ€§** | âŒ ä¿®æ”¹ç°æœ‰ä»£ç  | âœ… åªéœ€æ·»åŠ  Handler | **TBBattle** |\r\n+| **çµæ´»æ€§** | âŒ ç¡¬ç¼–ç  | âœ… é…ç½®é©±åŠ¨ | **TBBattle** |\r\n+| **ç»´æŠ¤æˆæœ¬** | âŒ æ¯æ¬¡éƒ½è¦ä¿®æ”¹ | âœ… é…ç½®å³å¯ | **TBBattle** |\r\n+| **ä»£ç è€¦åˆ** | âŒ é«˜åº¦è€¦åˆ | âœ… å®Œå…¨è§£è€¦ | **TBBattle** |\r\n+| **æ€§èƒ½** | âœ… ç›´æ¥è®¿é—®ï¼Œå¿« | âš ï¸ é˜Ÿåˆ—å¤„ç†ï¼Œç¨æ…¢ | **Building** |\r\n+| **ä»£ç ç®€æ´æ€§** | âœ… ç›´æ¥æ˜äº† | âš ï¸ éœ€è¦ç†è§£è´£ä»»é“¾ | **Building** |\r\n+\r\n+### 8.8 æœ€ç»ˆè¯„ä»·ï¼ˆé‡æ–°è¯„ä¼°ï¼‰\r\n+\r\n | è¯„ä»·ç»´åº¦ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | ä¼˜åŠ¿æ–¹ |\r\n |---------|-------------|--------------|--------|\r\n | **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­ | **Buildingï¼ˆå¿« 10-50 å€ï¼‰** |\r\n | **ä»£ç ç®€æ´æ€§** | â­â­â­â­â­ | â­â­â­ | **Building** |\r\n | **è°ƒè¯•å‹å¥½æ€§** | â­â­â­â­â­ | â­â­ | **Building** |\r\n | **å­¦ä¹ æˆæœ¬** | â­â­â­â­â­ | â­â­â­ | **Building** |\r\n-| **å¼€å‘æ•ˆç‡** | â­â­â­â­â­ | â­â­â­ | **Building** |\r\n-| **æ¶æ„ç†å¿µ** | â­â­â­â­ | â­â­â­â­â­ | TBBattle |\r\n-| **ç³»ç»Ÿè§£è€¦** | â­â­â­ | â­â­â­â­â­ | TBBattle |\r\n-| **æ‰©å±•æ€§** | â­â­â­â­ | â­â­â­â­â­ | TBBattle |\r\n-| **å¯ç»´æŠ¤æ€§** | â­â­â­â­ | â­â­â­â­â­ | TBBattle |\r\n+| **å¼€å‘æ•ˆç‡ï¼ˆç®€å•åœºæ™¯ï¼‰** | â­â­â­â­â­ | â­â­â­ | **Building** |\r\n+| **æ¶æ„ç†å¿µ** | â­â­â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n+| **ç³»ç»Ÿè§£è€¦** | â­â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n+| **æ‰©å±•æ€§** | â­â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n+| **çµæ´»æ€§ï¼ˆè´£ä»»é“¾ï¼‰** | â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n+| **è‡ªåŠ¨è¿é”ååº”** | â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n+| **å¯ç»´æŠ¤æ€§ï¼ˆå¤æ‚åœºæ™¯ï¼‰** | â­â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n+| **å¼€å‘æ•ˆç‡ï¼ˆå¤æ‚åœºæ™¯ï¼‰** | â­â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n \r\n **ç»¼åˆè¯„åˆ†**ï¼š\r\n - **Building è®¾è®¡**ï¼šâ­â­â­â­â­ (5/5) - **æ€§èƒ½ã€ç®€æ´æ€§ã€å¼€å‘æ•ˆç‡å…¨é¢é¢†å…ˆ**\r\n - **TBBattle æ¡†æ¶**ï¼šâ­â­â­â­ (4/5) - æ¶æ„ç†å¿µå’Œè§£è€¦æ€§æ›´ä¼˜\r\n"
                },
                {
                    "date": 1764146582024,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1494,14 +1494,14 @@\n | **å¯ç»´æŠ¤æ€§ï¼ˆå¤æ‚åœºæ™¯ï¼‰** | â­â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n | **å¼€å‘æ•ˆç‡ï¼ˆå¤æ‚åœºæ™¯ï¼‰** | â­â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n \r\n **ç»¼åˆè¯„åˆ†**ï¼š\r\n-- **Building è®¾è®¡**ï¼šâ­â­â­â­â­ (5/5) - **æ€§èƒ½ã€ç®€æ´æ€§ã€å¼€å‘æ•ˆç‡å…¨é¢é¢†å…ˆ**\r\n-- **TBBattle æ¡†æ¶**ï¼šâ­â­â­â­ (4/5) - æ¶æ„ç†å¿µå’Œè§£è€¦æ€§æ›´ä¼˜\r\n+- **Building è®¾è®¡**ï¼šâ­â­â­â­ (4/5) - **ç®€å•åœºæ™¯ä¸‹æ€§èƒ½ã€ç®€æ´æ€§é¢†å…ˆ**\r\n+- **TBBattle æ¡†æ¶**ï¼šâ­â­â­â­â­ (5/5) - **å¤æ‚åœºæ™¯ä¸‹çµæ´»æ€§ã€æ‰©å±•æ€§å…¨é¢é¢†å…ˆ**\r\n \r\n-### 8.8 æœ€ç»ˆç»“è®º\r\n+### 8.9 æœ€ç»ˆç»“è®ºï¼ˆé‡æ–°è¯„ä¼°ï¼‰\r\n \r\n-**Building è®¾è®¡çš„æ€§èƒ½ç¡®å®æ¯” TBBattle æ¡†æ¶æ›´å¥½ï¼** âš¡\r\n+#### Building è®¾è®¡çš„ä¼˜åŠ¿ï¼ˆç®€å•åœºæ™¯ï¼‰\r\n \r\n **æ€§èƒ½ä¼˜åŠ¿**ï¼š\r\n 1. âœ… **å¿« 10-50 å€**ï¼šç›´æ¥è®¿é—® vs é˜Ÿåˆ—å¤„ç†\r\n 2. âœ… **é›¶å†…å­˜å¼€é”€**ï¼šæ— é¢å¤–å¯¹è±¡åˆ›å»º\r\n@@ -1511,26 +1511,71 @@\n **å…¶ä»–ä¼˜åŠ¿**ï¼š\r\n 1. âœ… **ä»£ç æ›´ç®€æ´**ï¼šç›´æ¥è®¿é—®ï¼Œä¸€ç›®äº†ç„¶\r\n 2. âœ… **è°ƒè¯•æ›´å®¹æ˜“**ï¼šé—®é¢˜å®šä½å¿«ï¼Œä¿®æ”¹æ–¹ä¾¿\r\n 3. âœ… **å­¦ä¹ æˆæœ¬ä½**ï¼šæ–°äººä¸Šæ‰‹å¿«ï¼Œå›¢é˜Ÿåä½œå®¹æ˜“\r\n-4. âœ… **å¼€å‘æ•ˆç‡é«˜**ï¼šæ·»åŠ åŠŸèƒ½å¿«ï¼Œç»´æŠ¤æˆæœ¬ä½\r\n+4. âœ… **å¼€å‘æ•ˆç‡é«˜ï¼ˆç®€å•åœºæ™¯ï¼‰**ï¼šæ·»åŠ ç®€å•åŠŸèƒ½å¿«\r\n \r\n-**é€‚ç”¨åœºæ™¯**ï¼š\r\n-- âœ… **ç‹¬ç«‹ç³»ç»Ÿ**ï¼ˆå¦‚ Building ç³»ç»Ÿï¼‰ï¼šBuilding è®¾è®¡æ›´åˆé€‚\r\n-- âœ… **æ€§èƒ½æ•æ„Ÿ**ï¼šBuilding è®¾è®¡æ€§èƒ½ä¼˜åŠ¿æ˜æ˜¾\r\n-- âœ… **å¿«é€Ÿå¼€å‘**ï¼šBuilding è®¾è®¡å¼€å‘æ•ˆç‡æ›´é«˜\r\n-- âœ… **å›¢é˜Ÿè§„æ¨¡å°**ï¼šBuilding è®¾è®¡æ›´ç®€å•ç›´æ¥\r\n+#### TBBattle æ¡†æ¶çš„ä¼˜åŠ¿ï¼ˆå¤æ‚åœºæ™¯ï¼‰\r\n \r\n-**å»ºè®®**ï¼š\r\n-- ğŸ¯ **å¯¹äº Building ç³»ç»Ÿ**ï¼š**å¼ºçƒˆæ¨èä½¿ç”¨ Building è®¾è®¡æ€è·¯**\r\n-  - æ€§èƒ½æ›´å¥½ï¼ˆå¿« 10-50 å€ï¼‰\r\n+**æ ¸å¿ƒä¼˜åŠ¿ - è´£ä»»é“¾ä¸è‡ªåŠ¨è¿é”ååº”**ï¼š\r\n+1. âœ… **è‡ªåŠ¨è¿é”ååº”**ï¼šæ•°æ®å˜åŒ–è‡ªåŠ¨è§¦å‘æ‰€æœ‰ç›¸å…³å¤„ç†\r\n+2. âœ… **é…ç½®é©±åŠ¨**ï¼šæ–°å¢åŠŸèƒ½åªéœ€é…ç½® Handlerï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç \r\n+3. âœ… **å®Œå…¨è§£è€¦**ï¼šç³»ç»Ÿé—´é›¶ä¾èµ–ï¼Œæ˜“äºæ‰©å±•\r\n+4. âœ… **ä¸ä¼šé—æ¼**ï¼šæ‰€æœ‰è¿é”ååº”è‡ªåŠ¨å¤„ç†ï¼Œä¸ä¼šé—æ¼ä»»ä½•æ­¥éª¤\r\n+\r\n+**å®é™…åœºæ™¯ä¼˜åŠ¿**ï¼š\r\n+```lua\r\n+-- åœºæ™¯ï¼šå•†åº— â†’ å·¥äºº â†’ buff â†’ æ•ˆç‡ â†’ æ”¶ç›Š â†’ å…¶ä»–ç³»ç»Ÿ\r\n+-- Building è®¾è®¡ï¼šéœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰æ­¥éª¤ï¼Œå®¹æ˜“é—æ¼\r\n+-- TBBattle æ¡†æ¶ï¼šè‡ªåŠ¨è§¦å‘æ‰€æœ‰è¿é”ååº”ï¼Œä¸ä¼šé—æ¼\r\n+```\r\n+\r\n+#### é€‚ç”¨åœºæ™¯é‡æ–°åˆ’åˆ†\r\n+\r\n+**Building è®¾è®¡é€‚åˆ**ï¼š\r\n+- âœ… **ç®€å•ç‹¬ç«‹ç³»ç»Ÿ**ï¼šæ•°æ®æµç®€å•ï¼Œæ— å¤æ‚è¿é”ååº”\r\n+- âœ… **æ€§èƒ½æ•æ„Ÿåœºæ™¯**ï¼šéœ€è¦æè‡´æ€§èƒ½ï¼Œç›´æ¥è®¿é—®\r\n+- âœ… **å¿«é€ŸåŸå‹å¼€å‘**ï¼šéœ€è¦å¿«é€ŸéªŒè¯æƒ³æ³•\r\n+- âœ… **å›¢é˜Ÿè§„æ¨¡å°**ï¼š1-2 äººï¼Œä»£ç ç®€å•ç›´æ¥\r\n+\r\n+**TBBattle æ¡†æ¶é€‚åˆ**ï¼š\r\n+- âœ… **å¤æ‚ç³»ç»Ÿäº¤äº’**ï¼šå¤šä¸ªç³»ç»Ÿéœ€è¦äº¤äº’ï¼Œæœ‰è¿é”ååº”\r\n+- âœ… **é¢‘ç¹æ‰©å±•**ï¼šéœ€è¦é¢‘ç¹æ·»åŠ æ–°åŠŸèƒ½ï¼Œé…ç½®é©±åŠ¨\r\n+- âœ… **é•¿æœŸç»´æŠ¤**ï¼šéœ€è¦é•¿æœŸç»´æŠ¤ï¼Œé¿å…æ‰‹åŠ¨ç»´æŠ¤é—æ¼\r\n+- âœ… **å›¢é˜Ÿåä½œ**ï¼šå¤šäººåä½œï¼Œéœ€è¦ç»Ÿä¸€æ¶æ„\r\n+\r\n+#### æœ€ç»ˆå»ºè®®\r\n+\r\n+**å…³é”®åˆ¤æ–­æ ‡å‡†**ï¼š\r\n+\r\n+1. **æ˜¯å¦æœ‰å¤æ‚çš„è¿é”ååº”ï¼Ÿ**\r\n+   - âŒ æ— ï¼šBuilding è®¾è®¡æ›´åˆé€‚ï¼ˆç®€å•ç›´æ¥ï¼‰\r\n+   - âœ… æœ‰ï¼šTBBattle æ¡†æ¶æ›´åˆé€‚ï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰\r\n+\r\n+2. **æ˜¯å¦éœ€è¦é¢‘ç¹æ‰©å±•ï¼Ÿ**\r\n+   - âŒ å¦ï¼šBuilding è®¾è®¡æ›´åˆé€‚ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰\r\n+   - âœ… æ˜¯ï¼šTBBattle æ¡†æ¶æ›´åˆé€‚ï¼ˆé…ç½®é©±åŠ¨ï¼‰\r\n+\r\n+3. **ç³»ç»Ÿæ˜¯å¦ç‹¬ç«‹ï¼Ÿ**\r\n+   - âœ… æ˜¯ï¼šBuilding è®¾è®¡æ›´åˆé€‚ï¼ˆç®€å•ç›´æ¥ï¼‰\r\n+   - âŒ å¦ï¼šTBBattle æ¡†æ¶æ›´åˆé€‚ï¼ˆè§£è€¦è®¾è®¡ï¼‰\r\n+\r\n+**å¯¹äº Building ç³»ç»Ÿçš„å»ºè®®**ï¼š\r\n+\r\n+å¦‚æœ Building ç³»ç»Ÿï¼š\r\n+- âœ… **æœ‰å·¥äººã€buffã€æ•ˆç‡ç­‰è¿é”ååº”** â†’ **æ¨è TBBattle æ¡†æ¶**\r\n+  - è‡ªåŠ¨è§¦å‘æ‰€æœ‰è¿é”ååº”\r\n+  - ä¸ä¼šé—æ¼ä»»ä½•æ­¥éª¤\r\n+  - æ–°å¢åŠŸèƒ½åªéœ€é…ç½®\r\n+\r\n+- âœ… **åªæ˜¯ç®€å•çš„æ•°æ®å­˜å‚¨** â†’ **æ¨è Building è®¾è®¡**\r\n+  - æ€§èƒ½æ›´å¥½\r\n   - ä»£ç æ›´ç®€æ´\r\n   - å¼€å‘æ•ˆç‡æ›´é«˜\r\n-  - ç»´æŠ¤æˆæœ¬æ›´ä½\r\n \r\n-- ğŸ¯ **å¯¹äºå¤§å‹é¡¹ç›®**ï¼š\r\n-  - æ ¸å¿ƒç³»ç»Ÿï¼ˆå¦‚ Buildingï¼‰ä½¿ç”¨ç®€å•è®¾è®¡\r\n-  - å¤æ‚ç³»ç»Ÿï¼ˆéœ€è¦å¤šç³»ç»Ÿäº¤äº’ï¼‰ä½¿ç”¨ TBBattle æ¡†æ¶\r\n-  - **æ··åˆæ–¹æ¡ˆ**ï¼šç®€å•ç³»ç»Ÿç”¨ç®€å•è®¾è®¡ï¼Œå¤æ‚ç³»ç»Ÿç”¨æ¡†æ¶è®¾è®¡\r\n+**æ··åˆæ–¹æ¡ˆ**ï¼š\r\n+- ğŸ¯ **æ ¸å¿ƒç³»ç»Ÿï¼ˆæœ‰è¿é”ååº”ï¼‰**ï¼šä½¿ç”¨ TBBattle æ¡†æ¶\r\n+- ğŸ¯ **ç®€å•ç³»ç»Ÿï¼ˆæ— è¿é”ååº”ï¼‰**ï¼šä½¿ç”¨ Building è®¾è®¡\r\n+- ğŸ¯ **æ€§èƒ½å…³é”®è·¯å¾„**ï¼šåœ¨ TBBattle åŸºç¡€ä¸Šåšæ€§èƒ½ä¼˜åŒ–\r\n \r\n **æ€»ç»“**ï¼š\r\n-> **Building è®¾è®¡åœ¨æ€§èƒ½ã€ç®€æ´æ€§ã€å¼€å‘æ•ˆç‡æ–¹é¢å…¨é¢é¢†å…ˆï¼** å¯¹äºç‹¬ç«‹ç³»ç»Ÿï¼ŒBuilding è®¾è®¡æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚ä¸è¦ä¸ºäº†\"çœ‹èµ·æ¥é«˜çº§\"è€Œç‰ºç‰²æ€§èƒ½å’Œå¼€å‘æ•ˆç‡ï¼Œ**ç®€å•é«˜æ•ˆæ‰æ˜¯ç‹é“ï¼**\r\n+> **å¦‚æœ Building ç³»ç»Ÿæœ‰å¤æ‚çš„è¿é”ååº”ï¼ˆå·¥äººã€buffã€æ•ˆç‡ç­‰ï¼‰ï¼ŒTBBattle æ¡†æ¶çš„è´£ä»»é“¾å’Œè‡ªåŠ¨è§¦å‘æœºåˆ¶æ˜¯å·¨å¤§ä¼˜åŠ¿ï¼** ä¸è¦ä¸ºäº†æ€§èƒ½è€Œç‰ºç‰²çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œ**é€‚åˆçš„æ‰æ˜¯æœ€å¥½çš„ï¼**\r\n"
                },
                {
                    "date": 1764146852735,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1254,8 +1254,171 @@\n - âœ… **TBBattle æ ¸å¿ƒä¼˜åŠ¿**ï¼š**è´£ä»»é“¾æ¨¡å¼ + è‡ªåŠ¨è¿é”ååº” + é…ç½®é©±åŠ¨**\r\n - âš ï¸ **Building åŠ£åŠ¿**ï¼š**ç¡¬ç¼–ç  + æ‰‹åŠ¨ç»´æŠ¤ + å®¹æ˜“é—æ¼**\r\n - ğŸ¯ **å…³é”®å·®å¼‚**ï¼šTBBattle çš„ DataHandleQueue å¤©ç„¶æ”¯æŒè´£ä»»é“¾ï¼ŒBuilding éœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰è¿é”ååº”\r\n \r\n+#### 4. **æ‰‹åŠ¨ç»´æŠ¤é“¾å¼è°ƒç”¨çš„è‡´å‘½é—®é¢˜** âš ï¸âš ï¸âš ï¸\r\n+\r\n+è¿™æ˜¯ **Building è®¾è®¡åœ¨å¤æ‚åœºæ™¯ä¸‹çš„æ ¸å¿ƒç¼ºé™·**ï¼\r\n+\r\n+**Building è®¾è®¡çš„é—®é¢˜**ï¼š\r\n+\r\n+```lua\r\n+-- æ‰‹åŠ¨ç»´æŠ¤é“¾å¼è°ƒç”¨\r\n+function UpdateBuildingWorker(buildingId, worker)\r\n+    local building = BuildingSystem:Get(buildingId)\r\n+    building.serverObject.worker = worker\r\n+    \r\n+    -- âŒ é—®é¢˜1ï¼šéœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰æ­¥éª¤\r\n+    SyncWorkerData(worker)                    -- æ­¥éª¤1\r\n+    if worker.hasBuff then\r\n+        ApplyWorkerBuff(worker)                -- æ­¥éª¤2\r\n+        UpdateShopEfficiency(building)         -- æ­¥éª¤3\r\n+        UpdateShopIncome(building)             -- æ­¥éª¤4\r\n+        NotifyOtherSystems(building)          -- æ­¥éª¤5\r\n+        -- ... é“¾è¶Šé•¿ï¼Œç»´æŠ¤è¶Šå›°éš¾\r\n+    end\r\n+    \r\n+    -- âŒ é—®é¢˜2ï¼šé“¾è¶Šé•¿ï¼Œè°ƒè¯•è¶Šå›°éš¾\r\n+    -- å¦‚æœ UpdateShopIncome å‡ºé”™äº†ï¼Œéœ€è¦è¿½è¸ªæ•´ä¸ªè°ƒç”¨é“¾\r\n+    -- å¦‚æœæŸä¸ªæ­¥éª¤é—æ¼äº†ï¼Œå¾ˆéš¾å‘ç°\r\n+    \r\n+    -- âŒ é—®é¢˜3ï¼šbug è®°å½•ä¼šä¸æ–­å¢åŠ \r\n+    -- - å¿˜è®°è°ƒç”¨æŸä¸ªæ­¥éª¤ â†’ bug\r\n+    -- - è°ƒç”¨é¡ºåºé”™è¯¯ â†’ bug\r\n+    -- - é—æ¼æŸäº›æ¡ä»¶åˆ¤æ–­ â†’ bug\r\n+    -- - æ–°å¢åŠŸèƒ½æ—¶å¿˜è®°æ›´æ–°è°ƒç”¨é“¾ â†’ bug\r\n+end\r\n+```\r\n+\r\n+**TBBattle æ¡†æ¶çš„ä¼˜åŠ¿**ï¼š\r\n+\r\n+```lua\r\n+-- å†…éƒ¨æœºåˆ¶å¤©ç„¶æ”¯æŒé“¾å¼å“åº”\r\n+function UpdateBuildingWorker(buildingId, worker)\r\n+    -- åªéœ€æ¨é€æ•°æ®ï¼Œå†…éƒ¨æœºåˆ¶è‡ªåŠ¨å¤„ç†\r\n+    queue:PushData(EDataHandle.Building.UpdateWorker, {\r\n+        buildingId = buildingId,\r\n+        worker = worker\r\n+    })\r\n+    queue:ProcessDataHandler()\r\n+    \r\n+    -- âœ… ä¼˜åŠ¿1ï¼šå†…éƒ¨æœºåˆ¶å¤©ç„¶æ”¯æŒï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤\r\n+    -- âœ… ä¼˜åŠ¿2ï¼šé“¾å†é•¿ä¹Ÿä¸æ€•ï¼Œè‡ªåŠ¨å¤„ç†\r\n+    -- âœ… ä¼˜åŠ¿3ï¼šä¸ä¼šé—æ¼ä»»ä½•æ­¥éª¤ï¼Œbug è®°å½•ä¸ä¼šå¢åŠ \r\n+end\r\n+\r\n+-- Handler é…ç½®ï¼ˆå†…éƒ¨æœºåˆ¶è‡ªåŠ¨è§¦å‘ï¼‰\r\n+handlerMapping[EDataHandle.Building.UpdateWorker] = function(data)\r\n+    -- æ›´æ–°å·¥äºº\r\n+    local building = BuildingSystem:Get(data.buildingId)\r\n+    building.serverObject.worker = data.worker\r\n+    \r\n+    -- è‡ªåŠ¨è§¦å‘ä¸‹ä¸€æ­¥ï¼ˆå†…éƒ¨æœºåˆ¶å¤„ç†ï¼‰\r\n+    queue:PushData(EDataHandle.Worker.Sync, {worker = data.worker})\r\n+end\r\n+\r\n+handlerMapping[EDataHandle.Worker.Sync] = function(data)\r\n+    -- è‡ªåŠ¨æ£€æŸ¥å¹¶è§¦å‘ä¸‹ä¸€æ­¥\r\n+    if data.worker.hasBuff then\r\n+        queue:PushData(EDataHandle.Worker.ApplyBuff, {worker = data.worker})\r\n+    end\r\n+    queue:PushData(EDataHandle.Building.UpdateEfficiency, {\r\n+        buildingId = data.worker.buildingId\r\n+    })\r\n+end\r\n+\r\n+-- âœ… ä¼˜åŠ¿ï¼šé“¾å†é•¿ä¹Ÿä¸æ€•ï¼Œå†…éƒ¨æœºåˆ¶è‡ªåŠ¨å¤„ç†\r\n+-- âœ… ä¼˜åŠ¿ï¼šä¸ä¼šé—æ¼ä»»ä½•æ­¥éª¤\r\n+-- âœ… ä¼˜åŠ¿ï¼šbug è®°å½•ä¸ä¼šå› ä¸ºé—æ¼è€Œå¢åŠ \r\n+```\r\n+\r\n+**å…³é”®é—®é¢˜å¯¹æ¯”**ï¼š\r\n+\r\n+| é—®é¢˜ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | å½±å“ |\r\n+|------|-------------|--------------|------|\r\n+| **æ‰‹åŠ¨ç»´æŠ¤** | âŒ éœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰æ­¥éª¤ | âœ… å†…éƒ¨æœºåˆ¶è‡ªåŠ¨å¤„ç† | **é«˜** |\r\n+| **é“¾è¶Šé•¿è°ƒè¯•è¶Šéš¾** | âŒ é“¾è¶Šé•¿ï¼Œè°ƒè¯•è¶Šå›°éš¾ | âœ… é“¾å†é•¿ä¹Ÿä¸æ€•ï¼Œè‡ªåŠ¨å¤„ç† | **é«˜** |\r\n+| **bug è®°å½•å¢åŠ ** | âŒ å®¹æ˜“é—æ¼ï¼Œbug ä¸æ–­ | âœ… ä¸ä¼šé—æ¼ï¼Œbug å°‘ | **é«˜** |\r\n+| **æ–°å¢åŠŸèƒ½é£é™©** | âŒ éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç  | âœ… åªéœ€æ·»åŠ  Handler | **ä¸­** |\r\n+| **ç»´æŠ¤æˆæœ¬** | âŒ æ¯æ¬¡éƒ½è¦æ‰‹åŠ¨ç»´æŠ¤ | âœ… é…ç½®å³å¯ | **é«˜** |\r\n+\r\n+#### 5. **å¤–éƒ¨ç³»ç»Ÿç»Ÿä¸€æ¥å£ - DataHandleQueue** â­â­â­\r\n+\r\n+è¿™æ˜¯ **TBBattle æ¡†æ¶çš„å¦ä¸€ä¸ªæ ¸å¿ƒä¼˜åŠ¿**ï¼\r\n+\r\n+**Building è®¾è®¡ï¼ˆå¤–éƒ¨ç³»ç»Ÿéœ€è¦ç›´æ¥è®¿é—®ï¼‰**ï¼š\r\n+\r\n+```lua\r\n+-- å¤–éƒ¨ç³»ç»Ÿéœ€è¦ç›´æ¥è®¿é—® BuildingSystem\r\n+function OtherSystem:UpdateBuildingWorker(buildingId, worker)\r\n+    -- âŒ é—®é¢˜ï¼šå¤–éƒ¨ç³»ç»Ÿéœ€è¦çŸ¥é“ BuildingSystem çš„å†…éƒ¨å®ç°\r\n+    local building = BuildingSystem:Get(buildingId)\r\n+    building.serverObject.worker = worker\r\n+    \r\n+    -- âŒ é—®é¢˜ï¼šå¤–éƒ¨ç³»ç»Ÿéœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰è¿é”ååº”\r\n+    SyncWorkerData(worker)\r\n+    if worker.hasBuff then\r\n+        ApplyWorkerBuff(worker)\r\n+        UpdateShopEfficiency(building)\r\n+    end\r\n+    \r\n+    -- âš ï¸ é—®é¢˜ï¼šå¤–éƒ¨ç³»ç»Ÿéœ€è¦äº†è§£å†…éƒ¨å®ç°ç»†èŠ‚\r\n+    -- âš ï¸ é—®é¢˜ï¼šå¤–éƒ¨ç³»ç»Ÿéœ€è¦æ‰‹åŠ¨ç»´æŠ¤è°ƒç”¨é“¾\r\n+    -- âš ï¸ é—®é¢˜ï¼šå¦‚æœå†…éƒ¨å®ç°æ”¹å˜ï¼Œå¤–éƒ¨ç³»ç»Ÿä¹Ÿè¦ä¿®æ”¹\r\n+end\r\n+```\r\n+\r\n+**TBBattle æ¡†æ¶ï¼ˆç»Ÿä¸€æ¥å£ï¼Œå¤–éƒ¨ç³»ç»Ÿä¹Ÿä½¿ç”¨ DataHandleQueueï¼‰**ï¼š\r\n+\r\n+```lua\r\n+-- å¤–éƒ¨ç³»ç»Ÿä¹Ÿä½¿ç”¨ DataHandleQueueï¼ˆç»Ÿä¸€æ¥å£ï¼‰\r\n+function OtherSystem:UpdateBuildingWorker(buildingId, worker)\r\n+    -- âœ… ä¼˜åŠ¿ï¼šå¤–éƒ¨ç³»ç»Ÿä½¿ç”¨ç»Ÿä¸€æ¥å£ï¼Œæ— éœ€çŸ¥é“å†…éƒ¨å®ç°\r\n+    queue:PushData(EDataHandle.Building.UpdateWorker, {\r\n+        buildingId = buildingId,\r\n+        worker = worker\r\n+    })\r\n+    queue:ProcessDataHandler()\r\n+    \r\n+    -- âœ… ä¼˜åŠ¿ï¼šå¤–éƒ¨ç³»ç»Ÿä¹Ÿäº«å—è‡ªåŠ¨è¿é”ååº”\r\n+    -- âœ… ä¼˜åŠ¿ï¼šå¤–éƒ¨ç³»ç»Ÿæ— éœ€æ‰‹åŠ¨ç»´æŠ¤è°ƒç”¨é“¾\r\n+    -- âœ… ä¼˜åŠ¿ï¼šå†…éƒ¨å®ç°æ”¹å˜ï¼Œå¤–éƒ¨ç³»ç»Ÿæ— éœ€ä¿®æ”¹\r\n+end\r\n+\r\n+-- å¤–éƒ¨ç³»ç»Ÿä¹Ÿå¯ä»¥è·å–æ•°æ®ï¼ˆç»Ÿä¸€æ¥å£ï¼‰\r\n+function OtherSystem:GetBuildingWorker(buildingId)\r\n+    -- âœ… ä¼˜åŠ¿ï¼šä½¿ç”¨ç»Ÿä¸€æ¥å£è·å–æ•°æ®\r\n+    local worker = queue:ProcessQueryDelegate(\r\n+        EDataHandle.Building.GetWorker,\r\n+        buildingId\r\n+    )\r\n+    return worker\r\n+end\r\n+\r\n+-- å¤–éƒ¨ç³»ç»Ÿä¹Ÿå¯ä»¥èµ‹å€¼ï¼ˆç»Ÿä¸€æ¥å£ï¼‰\r\n+function OtherSystem:SetBuildingWorker(buildingId, worker)\r\n+    -- âœ… ä¼˜åŠ¿ï¼šä½¿ç”¨ç»Ÿä¸€æ¥å£èµ‹å€¼\r\n+    queue:PushData(EDataHandle.Building.UpdateWorker, {\r\n+        buildingId = buildingId,\r\n+        worker = worker\r\n+    })\r\n+    queue:ProcessDataHandler()\r\n+    \r\n+    -- âœ… ä¼˜åŠ¿ï¼šè‡ªåŠ¨è§¦å‘æ‰€æœ‰è¿é”ååº”\r\n+    -- âœ… ä¼˜åŠ¿ï¼šå¤–éƒ¨ç³»ç»Ÿæ— éœ€å…³å¿ƒå†…éƒ¨å®ç°\r\n+end\r\n+```\r\n+\r\n+**ç»Ÿä¸€æ¥å£çš„ä¼˜åŠ¿**ï¼š\r\n+\r\n+| ç‰¹æ€§ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | ä¼˜åŠ¿æ–¹ |\r\n+|------|-------------|--------------|--------|\r\n+| **å¤–éƒ¨ç³»ç»Ÿæ¥å£** | âŒ éœ€è¦ç›´æ¥è®¿é—®å†…éƒ¨å®ç° | âœ… ç»Ÿä¸€æ¥å£ DataHandleQueue | **TBBattle** |\r\n+| **å†…éƒ¨å®ç°éšè—** | âŒ å¤–éƒ¨ç³»ç»Ÿéœ€è¦çŸ¥é“å†…éƒ¨å®ç° | âœ… å¤–éƒ¨ç³»ç»Ÿæ— éœ€çŸ¥é“å†…éƒ¨å®ç° | **TBBattle** |\r\n+| **è‡ªåŠ¨è¿é”ååº”** | âŒ å¤–éƒ¨ç³»ç»Ÿéœ€è¦æ‰‹åŠ¨ç»´æŠ¤ | âœ… å¤–éƒ¨ç³»ç»Ÿä¹Ÿäº«å—è‡ªåŠ¨è¿é”ååº” | **TBBattle** |\r\n+| **æ¥å£ç¨³å®šæ€§** | âŒ å†…éƒ¨æ”¹å˜ï¼Œå¤–éƒ¨ä¹Ÿè¦æ”¹ | âœ… å†…éƒ¨æ”¹å˜ï¼Œå¤–éƒ¨æ— éœ€æ”¹ | **TBBattle** |\r\n+| **ä»£ç è§£è€¦** | âŒ å¤–éƒ¨ç³»ç»Ÿè€¦åˆå†…éƒ¨å®ç° | âœ… å¤–éƒ¨ç³»ç»Ÿå®Œå…¨è§£è€¦ | **TBBattle** |\r\n+\r\n ### 8.3 è®¾è®¡å“²å­¦å¯¹æ¯”\r\n \r\n #### Building è®¾è®¡ï¼š**ä¼ ç»Ÿ + å®ç”¨ä¸»ä¹‰**\r\n \r\n"
                },
                {
                    "date": 1764146858424,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1740,5 +1740,13 @@\n - ğŸ¯ **ç®€å•ç³»ç»Ÿï¼ˆæ— è¿é”ååº”ï¼‰**ï¼šä½¿ç”¨ Building è®¾è®¡\r\n - ğŸ¯ **æ€§èƒ½å…³é”®è·¯å¾„**ï¼šåœ¨ TBBattle åŸºç¡€ä¸Šåšæ€§èƒ½ä¼˜åŒ–\r\n \r\n **æ€»ç»“**ï¼š\r\n-> **å¦‚æœ Building ç³»ç»Ÿæœ‰å¤æ‚çš„è¿é”ååº”ï¼ˆå·¥äººã€buffã€æ•ˆç‡ç­‰ï¼‰ï¼ŒTBBattle æ¡†æ¶çš„è´£ä»»é“¾å’Œè‡ªåŠ¨è§¦å‘æœºåˆ¶æ˜¯å·¨å¤§ä¼˜åŠ¿ï¼** ä¸è¦ä¸ºäº†æ€§èƒ½è€Œç‰ºç‰²çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œ**é€‚åˆçš„æ‰æ˜¯æœ€å¥½çš„ï¼**\r\n+> **å¦‚æœ Building ç³»ç»Ÿæœ‰å¤æ‚çš„è¿é”ååº”ï¼ˆå·¥äººã€buffã€æ•ˆç‡ç­‰ï¼‰ï¼ŒTBBattle æ¡†æ¶çš„è´£ä»»é“¾å’Œè‡ªåŠ¨è§¦å‘æœºåˆ¶æ˜¯å·¨å¤§ä¼˜åŠ¿ï¼** \r\n+> \r\n+> **æ ¸å¿ƒä¼˜åŠ¿**ï¼š\r\n+> 1. âœ… **å†…éƒ¨æœºåˆ¶å¤©ç„¶æ”¯æŒ**ï¼šæ— éœ€æ‰‹åŠ¨ç»´æŠ¤é“¾å¼è°ƒç”¨\r\n+> 2. âœ… **é“¾å†é•¿ä¹Ÿä¸æ€•**ï¼šè‡ªåŠ¨å¤„ç†ï¼Œä¸ä¼šé—æ¼\r\n+> 3. âœ… **bug è®°å½•ä¸ä¼šå¢åŠ **ï¼šä¸ä¼šå› ä¸ºé—æ¼è€Œå‡ºç° bug\r\n+> 4. âœ… **å¤–éƒ¨ç³»ç»Ÿç»Ÿä¸€æ¥å£**ï¼šDataHandleQueue ç»Ÿä¸€æ¥å£ï¼Œå¤–éƒ¨ç³»ç»Ÿä¹Ÿäº«å—è‡ªåŠ¨è¿é”ååº”\r\n+> \r\n+> **ä¸è¦ä¸ºäº†æ€§èƒ½è€Œç‰ºç‰²çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œé€‚åˆçš„æ‰æ˜¯æœ€å¥½çš„ï¼**\r\n"
                },
                {
                    "date": 1764148557161,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -115,9 +115,9 @@\n ```lua\r\n -- é€šè¿‡ req(resp) åˆ›å»º\r\n ```\r\n \r\n-### 4.2 Destroyï¼ˆé”€æ¯ï¼‰\r\n+### 4.2 Destroyï¼ˆé”€æ¯ï¼‰                                            \r\n \r\n ```lua\r\n GameObject.Destroy(building.gameObject)\r\n -- åŸåˆ™ï¼šsame Layer + same life cycle\r\n@@ -424,1329 +424,4 @@\n 1. å…ˆæ˜ç¡®æ•°æ®æ¶æ„å’ŒèŒè´£è¾¹ç•Œ\r\n 2. ç»Ÿä¸€å‘½åè§„èŒƒå’Œæ¥å£è®¾è®¡\r\n 3. å®Œå–„é”™è¯¯å¤„ç†å’ŒéªŒè¯æœºåˆ¶\r\n 4. é€æ­¥é‡æ„ï¼Œä¿æŒå‘åå…¼å®¹\r\n-\r\n----\r\n-\r\n-## 8. åŸºäº Building è®¾è®¡æ€è·¯çš„ä¼˜åŒ–æ–¹æ¡ˆ\r\n-\r\n-### 8.1 ä¼˜åŒ–åŸåˆ™\r\n-\r\n-**ä¿æŒ Building è®¾è®¡çš„æ ¸å¿ƒç†å¿µ**ï¼š\r\n-- âœ… æ•°æ®åˆ†ç¦»ï¼ˆSData/CDataï¼‰\r\n-- âœ… ç›´æ¥è®¿é—®ï¼ˆBuildingSystem ä½œä¸ºæ•°æ®ä¸­å¿ƒï¼‰\r\n-- âœ… ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆCreate/Destroy/Get/Set/Updateï¼‰\r\n-- âœ… SynAction æœºåˆ¶æ›´æ–°\r\n-\r\n-**ä¼˜åŒ–æ–¹å‘**ï¼š\r\n-- ğŸ”§ ä¿®å¤å‘½åå’Œæ¥å£é—®é¢˜\r\n-- ğŸ”§ ä¼˜åŒ– Update æœºåˆ¶ï¼Œå‡å°‘å†—ä½™\r\n-- ğŸ”§ å®Œå–„é”™è¯¯å¤„ç†å’ŒéªŒè¯\r\n-- ğŸ”§ æ˜ç¡®æ•°æ®æµå’ŒèŒè´£è¾¹ç•Œ\r\n-\r\n-### 8.2 ä¼˜åŒ–åçš„æ¶æ„è®¾è®¡\r\n-\r\n-#### 1. **æ•°æ®æ¶æ„ä¼˜åŒ–**\r\n-\r\n-```lua\r\n--- ä¼˜åŒ–åçš„æ•°æ®æ¶æ„\r\n-G = {\r\n-    -- å…¨å±€é…ç½®æ•°æ®ï¼ˆåªè¯»ï¼Œå¯åŠ¨æ—¶åŠ è½½ï¼‰\r\n-    building = {\r\n-        configs = {},  -- é…ç½®è¡¨æ•°æ®ï¼ˆCfgData.buildingï¼‰\r\n-    },\r\n-    \r\n-    -- ç©å®¶æ•°æ®ï¼ˆè¯»å†™ï¼Œè¿è¡Œæ—¶æ•°æ®ï¼‰\r\n-    me = {\r\n-        buildings = {},  -- ç©å®¶æ‹¥æœ‰çš„å»ºç­‘å®ä¾‹ ID åˆ—è¡¨\r\n-        -- æ³¨æ„ï¼šè¿™é‡Œåªå­˜ IDï¼Œä¸å­˜ Systemï¼Œä¸å­˜å®Œæ•´å¯¹è±¡\r\n-    },\r\n-    \r\n-    -- å…¶ä»–ç©å®¶æ•°æ®ï¼ˆåªè¯»ï¼ŒåŒæ­¥æ•°æ®ï¼‰\r\n-    other = {\r\n-        [playerId] = {\r\n-            buildings = {},  -- å…¶ä»–ç©å®¶çš„å»ºç­‘ ID åˆ—è¡¨\r\n-        }\r\n-    }\r\n-}\r\n-\r\n--- System ç‹¬ç«‹ç®¡ç†ï¼ˆæ‰€æœ‰å»ºç­‘å¯¹è±¡éƒ½åœ¨è¿™é‡Œï¼‰\r\n-BuildingSystem = {\r\n-    -- æ ¸å¿ƒæ•°æ®å­˜å‚¨\r\n-    buildingMap = {},  -- map[dbId] = Building å¯¹è±¡\r\n-    \r\n-    -- ç´¢å¼•ä¼˜åŒ–\r\n-    playerBuildingMap = {},  -- map[playerId] = {dbId1, dbId2, ...}\r\n-    gameObjectMap = {},      -- map[gameObjectId] = Building å¯¹è±¡\r\n-    \r\n-    -- å¯¹è±¡æ± ï¼ˆå¯é€‰ï¼‰\r\n-    buildingPool = nil,  -- å¯¹è±¡æ± ï¼Œå¤ç”¨ Building å¯¹è±¡\r\n-}\r\n-```\r\n-\r\n-#### 2. **Building å¯¹è±¡ç»“æ„ä¼˜åŒ–**\r\n-\r\n-```lua\r\n--- Building å¯¹è±¡å®Œæ•´ç»“æ„\r\n-Building = {\r\n-    -- å”¯ä¸€æ ‡è¯†\r\n-    dbId = 0,              -- æ•°æ®åº“ IDï¼ˆä¸»é”®ï¼‰\r\n-    gameObjectId = 0,       -- GameObject IDï¼ˆç”¨äº Unityï¼‰\r\n-    \r\n-    -- æ•°æ®å±‚ï¼ˆåˆ†ç¦»ï¼‰\r\n-    serverObject = nil,     -- ServerObjectï¼ˆæœåŠ¡å™¨æ•°æ®ï¼Œåªè¯»ï¼‰\r\n-    clientData = {},        -- ClientDataï¼ˆå®¢æˆ·ç«¯æ•°æ®ï¼Œå¯è¯»å†™ï¼‰\r\n-    \r\n-    -- é…ç½®æ•°æ®ï¼ˆåªè¯»ï¼‰\r\n-    cfg = nil,             -- CfgData.building[id]\r\n-    \r\n-    -- Unity å¯¹è±¡\r\n-    gameObject = nil,       -- Unity GameObject\r\n-    prefab = nil,           -- é¢„åˆ¶ä½“å¼•ç”¨\r\n-    \r\n-    -- çŠ¶æ€æ ‡è®°\r\n-    isDirty = false,        -- æ˜¯å¦éœ€è¦åŒæ­¥åˆ°æœåŠ¡å™¨\r\n-    isActive = true,        -- æ˜¯å¦æ¿€æ´»\r\n-    \r\n-    -- ç”Ÿå‘½å‘¨æœŸ\r\n-    createTime = 0,        -- åˆ›å»ºæ—¶é—´\r\n-    lastUpdateTime = 0,     -- æœ€åæ›´æ–°æ—¶é—´\r\n-}\r\n-```\r\n-\r\n-#### 3. **BuildingSystem æ¥å£ä¼˜åŒ–**\r\n-\r\n-```lua\r\n--- ä¼˜åŒ–åçš„ BuildingSystem æ¥å£\r\n-BuildingSystem = {\r\n-    -- ========== æ ¸å¿ƒæ¥å£ ==========\r\n-    \r\n-    -- æ³¨å†Œå»ºç­‘ï¼ˆç»Ÿä¸€å‘½åï¼šRegister è€Œä¸æ˜¯ Setï¼‰\r\n-    Register = function(self, building)\r\n-        if not building or not building.dbId then\r\n-            LogError(\"BuildingSystem:Register - Invalid building\")\r\n-            return false\r\n-        end\r\n-        \r\n-        -- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨\r\n-        if self.buildingMap[building.dbId] then\r\n-            LogWarning(\"BuildingSystem:Register - Building already exists: \" .. building.dbId)\r\n-            return false\r\n-        end\r\n-        \r\n-        -- æ³¨å†Œåˆ°ä¸»è¡¨\r\n-        self.buildingMap[building.dbId] = building\r\n-        \r\n-        -- æ³¨å†Œåˆ°ç´¢å¼•è¡¨\r\n-        if building.gameObjectId then\r\n-            self.gameObjectMap[building.gameObjectId] = building\r\n-        end\r\n-        \r\n-        -- æ³¨å†Œåˆ°ç©å®¶è¡¨\r\n-        local playerId = building.serverObject and building.serverObject.playerId\r\n-        if playerId then\r\n-            if not self.playerBuildingMap[playerId] then\r\n-                self.playerBuildingMap[playerId] = {}\r\n-            end\r\n-            table.insert(self.playerBuildingMap[playerId], building.dbId)\r\n-        end\r\n-        \r\n-        return true\r\n-    end,\r\n-    \r\n-    -- è·å–å»ºç­‘ï¼ˆä¿æŒ Get å‘½åï¼‰\r\n-    Get = function(self, dbId)\r\n-        local building = self.buildingMap[dbId]\r\n-        if not building then\r\n-            LogWarning(\"BuildingSystem:Get - Building not found: \" .. dbId)\r\n-        end\r\n-        return building\r\n-    end,\r\n-    \r\n-    -- é€šè¿‡ GameObject ID è·å–\r\n-    GetByGameObjectId = function(self, gameObjectId)\r\n-        return self.gameObjectMap[gameObjectId]\r\n-    end,\r\n-    \r\n-    -- è·å–ç©å®¶çš„æ‰€æœ‰å»ºç­‘\r\n-    GetPlayerBuildings = function(self, playerId)\r\n-        local buildingIds = self.playerBuildingMap[playerId] or {}\r\n-        local buildings = {}\r\n-        for _, dbId in ipairs(buildingIds) do\r\n-            local building = self.buildingMap[dbId]\r\n-            if building then\r\n-                table.insert(buildings, building)\r\n-            end\r\n-        end\r\n-        return buildings\r\n-    end,\r\n-    \r\n-    -- æ³¨é”€å»ºç­‘ï¼ˆç»Ÿä¸€å‘½åï¼šUnregister è€Œä¸æ˜¯ Removeï¼‰\r\n-    Unregister = function(self, dbId)\r\n-        local building = self.buildingMap[dbId]\r\n-        if not building then\r\n-            LogWarning(\"BuildingSystem:Unregister - Building not found: \" .. dbId)\r\n-            return false\r\n-        end\r\n-        \r\n-        -- ä»ä¸»è¡¨ç§»é™¤\r\n-        self.buildingMap[dbId] = nil\r\n-        \r\n-        -- ä»ç´¢å¼•è¡¨ç§»é™¤\r\n-        if building.gameObjectId then\r\n-            self.gameObjectMap[building.gameObjectId] = nil\r\n-        end\r\n-        \r\n-        -- ä»ç©å®¶è¡¨ç§»é™¤\r\n-        local playerId = building.serverObject and building.serverObject.playerId\r\n-        if playerId and self.playerBuildingMap[playerId] then\r\n-            for i, id in ipairs(self.playerBuildingMap[playerId]) do\r\n-                if id == dbId then\r\n-                    table.remove(self.playerBuildingMap[playerId], i)\r\n-                    break\r\n-                end\r\n-            end\r\n-        end\r\n-        \r\n-        return true\r\n-    end,\r\n-    \r\n-    -- ========== ç”Ÿå‘½å‘¨æœŸæ¥å£ ==========\r\n-    \r\n-    -- åˆ›å»ºå»ºç­‘ï¼ˆå®Œæ•´æµç¨‹ï¼‰\r\n-    Create = function(self, serverData, gameObject)\r\n-        -- 1. åˆ›å»º Building å¯¹è±¡\r\n-        local building = Building:New()\r\n-        \r\n-        -- 2. è®¾ç½®åŸºç¡€æ•°æ®\r\n-        building.dbId = serverData.id\r\n-        building.serverObject = serverData\r\n-        building.cfg = CfgData.building[serverData.buildingId]\r\n-        \r\n-        if not building.cfg then\r\n-            LogError(\"BuildingSystem:Create - Config not found: \" .. serverData.buildingId)\r\n-            return nil\r\n-        end\r\n-        \r\n-        -- 3. ç»‘å®š GameObject\r\n-        if gameObject then\r\n-            building.gameObject = gameObject\r\n-            building.gameObjectId = gameObject:GetInstanceID()\r\n-        end\r\n-        \r\n-        -- 4. åˆå§‹åŒ–å®¢æˆ·ç«¯æ•°æ®\r\n-        building.clientData = {\r\n-            floor = {},\r\n-            -- å…¶ä»–å®¢æˆ·ç«¯æ•°æ®\r\n-        }\r\n-        \r\n-        -- 5. æ³¨å†Œåˆ°ç³»ç»Ÿ\r\n-        if not self:Register(building) then\r\n-            return nil\r\n-        end\r\n-        \r\n-        -- 6. æ›´æ–° G.meï¼ˆå¦‚æœæ˜¯è‡ªå·±çš„å»ºç­‘ï¼‰\r\n-        if serverData.playerId == G.me.playerId then\r\n-            if not G.me.buildings then\r\n-                G.me.buildings = {}\r\n-            end\r\n-            table.insert(G.me.buildings, building.dbId)\r\n-        end\r\n-        \r\n-        -- 7. è§¦å‘åˆ›å»ºäº‹ä»¶\r\n-        EventSystem:Dispatch(\"OnBuildingCreated\", building)\r\n-        \r\n-        return building\r\n-    end,\r\n-    \r\n-    -- é”€æ¯å»ºç­‘ï¼ˆå®Œæ•´æµç¨‹ï¼‰\r\n-    Destroy = function(self, dbId)\r\n-        local building = self:Get(dbId)\r\n-        if not building then\r\n-            return false\r\n-        end\r\n-        \r\n-        -- 1. è§¦å‘é”€æ¯äº‹ä»¶\r\n-        EventSystem:Dispatch(\"OnBuildingDestroying\", building)\r\n-        \r\n-        -- 2. é”€æ¯ GameObject\r\n-        if building.gameObject then\r\n-            GameObject.Destroy(building.gameObject)\r\n-        end\r\n-        \r\n-        -- 3. ä» G.me ç§»é™¤\r\n-        if G.me.buildings then\r\n-            for i, id in ipairs(G.me.buildings) do\r\n-                if id == dbId then\r\n-                    table.remove(G.me.buildings, i)\r\n-                    break\r\n-                end\r\n-            end\r\n-        end\r\n-        \r\n-        -- 4. ä»ç³»ç»Ÿæ³¨é”€\r\n-        self:Unregister(dbId)\r\n-        \r\n-        -- 5. å›æ”¶å¯¹è±¡ï¼ˆå¦‚æœä½¿ç”¨å¯¹è±¡æ± ï¼‰\r\n-        if self.buildingPool then\r\n-            self.buildingPool:Push(building)\r\n-        end\r\n-        \r\n-        return true\r\n-    end,\r\n-    \r\n-    -- ========== æ›´æ–°æ¥å£ ==========\r\n-    \r\n-    -- æ›´æ–°å»ºç­‘ï¼ˆç»Ÿä¸€æ¥å£ï¼Œæ”¯æŒéƒ¨åˆ†æ›´æ–°ï¼‰\r\n-    Update = function(self, dbId, updates)\r\n-        local building = self:Get(dbId)\r\n-        if not building then\r\n-            return false\r\n-        end\r\n-        \r\n-        -- éƒ¨åˆ†æ›´æ–°æœºåˆ¶\r\n-        if type(updates) == \"table\" then\r\n-            -- æ›´æ–°æŒ‡å®šå­—æ®µ\r\n-            for key, value in pairs(updates) do\r\n-                if building.serverObject[key] ~= nil then\r\n-                    building.serverObject[key] = value\r\n-                elseif building.clientData[key] ~= nil then\r\n-                    building.clientData[key] = value\r\n-                else\r\n-                    LogWarning(\"BuildingSystem:Update - Unknown field: \" .. key)\r\n-                end\r\n-            end\r\n-        else\r\n-            -- å®Œæ•´å¯¹è±¡æ›´æ–°\r\n-            building.serverObject = updates\r\n-        end\r\n-        \r\n-        -- æ ‡è®°ä¸ºè„æ•°æ®\r\n-        building.isDirty = true\r\n-        building.lastUpdateTime = os.time()\r\n-        \r\n-        -- è§¦å‘æ›´æ–°äº‹ä»¶\r\n-        EventSystem:Dispatch(\"OnBuildingUpdated\", building)\r\n-        \r\n-        return true\r\n-    end,\r\n-}\r\n-```\r\n-\r\n-#### 4. **ä¼˜åŒ–åçš„ SynAction æœºåˆ¶**\r\n-\r\n-```lua\r\n--- ä¼˜åŒ–åçš„ SynActionï¼ˆç»Ÿä¸€æ¥å£ï¼Œå‡å°‘å†—ä½™ï¼‰\r\n--- ä½¿ç”¨éƒ¨åˆ†æ›´æ–°æœºåˆ¶ï¼Œé¿å… Action ç±»è†¨èƒ€\r\n-\r\n--- C# ç«¯ï¼šç»Ÿä¸€çš„ UpdateBuildingAction\r\n-class UpdateBuildingAction : SynAction\r\n-{\r\n-    long buildingId;\r\n-    Dictionary<string, object> updates;  // éƒ¨åˆ†æ›´æ–°å­—æ®µ\r\n-}\r\n-\r\n-Execute()\r\n-{\r\n-    local building = BuildingSystem:Get(action.buildingId)\r\n-    if not building then\r\n-        LogError(\"UpdateBuildingAction: Building not found: \" .. action.buildingId)\r\n-        return\r\n-    end\r\n-    \r\n-    -- ä½¿ç”¨ç»Ÿä¸€çš„æ›´æ–°æ¥å£\r\n-    BuildingSystem:Update(action.buildingId, action.updates)\r\n-}\r\n-\r\n--- ä½¿ç”¨ç¤ºä¾‹\r\n--- C# ç«¯\r\n-var action = new UpdateBuildingAction\r\n-{\r\n-    buildingId = 123,\r\n-    updates = new Dictionary<string, object>\r\n-    {\r\n-        {\"level\", 5},\r\n-        {\"worker\", 10}\r\n-    }\r\n-};\r\n-\r\n--- æˆ–è€…å®Œæ•´æ›´æ–°\r\n-var action = new UpdateBuildingAction\r\n-{\r\n-    buildingId = 123,\r\n-    updates = completeBuildingObject  // å®Œæ•´å¯¹è±¡\r\n-};\r\n-```\r\n-\r\n-#### 5. **è¯·æ±‚å“åº”å¤„ç†ä¼˜åŒ–ï¼ˆv3ï¼‰**\r\n-\r\n-```lua\r\n--- req(resp) v3 - ä¼˜åŒ–ç‰ˆæœ¬\r\n-function OnBuildingResponse(resp)\r\n-    -- 1. åˆ›å»º Building å¯¹è±¡\r\n-    local building = Building:New()\r\n-    \r\n-    -- 2. è®¾ç½®æœåŠ¡å™¨æ•°æ®\r\n-    building.serverObject = resp.building\r\n-    \r\n-    -- 3. åŠ è½½é…ç½®æ•°æ®\r\n-    building.cfg = CfgData.building[building.serverObject.buildingId]\r\n-    if not building.cfg then\r\n-        LogError(\"Building config not found: \" .. building.serverObject.buildingId)\r\n-        return\r\n-    end\r\n-    \r\n-    -- 4. åˆ›å»ºæˆ–è·å– GameObject\r\n-    local gameObject = nil\r\n-    if resp.gameObjectId then\r\n-        -- å¤ç”¨å·²æœ‰ GameObject\r\n-        gameObject = GameObject.Find(resp.gameObjectId)\r\n-    else\r\n-        -- åˆ›å»ºæ–° GameObject\r\n-        local prefab = ResNode:Inst(building.cfg.prefabPath)\r\n-        gameObject = GameObject.Instantiate(prefab)\r\n-    end\r\n-    \r\n-    -- 5. ç»‘å®š GameObject\r\n-    building.gameObject = gameObject\r\n-    building.gameObjectId = gameObject:GetInstanceID()\r\n-    \r\n-    -- 6. åˆå§‹åŒ–å®¢æˆ·ç«¯æ•°æ®\r\n-    building.clientData = {\r\n-        floor = resp.clientData and resp.clientData.floor or {},\r\n-    }\r\n-    \r\n-    -- 7. æ³¨å†Œåˆ°ç³»ç»Ÿï¼ˆç»Ÿä¸€æ¥å£ï¼‰\r\n-    if BuildingSystem:Register(building) then\r\n-        -- 8. æ›´æ–° G.me\r\n-        if building.serverObject.playerId == G.me.playerId then\r\n-            if not G.me.buildings then\r\n-                G.me.buildings = {}\r\n-            end\r\n-            table.insert(G.me.buildings, building.dbId)\r\n-        end\r\n-        \r\n-        -- 9. è§¦å‘åˆ›å»ºäº‹ä»¶\r\n-        EventSystem:Dispatch(\"OnBuildingCreated\", building)\r\n-        \r\n-        return building\r\n-    else\r\n-        LogError(\"Failed to register building: \" .. building.dbId)\r\n-        return nil\r\n-    end\r\n-end\r\n-```\r\n-\r\n-#### 6. **æ•°æ®åŒæ­¥æœºåˆ¶ä¼˜åŒ–**\r\n-\r\n-```lua\r\n--- æ˜ç¡®çš„æ•°æ®åŒæ­¥æµç¨‹\r\n--- ç½‘ç»œæ•°æ® â†’ ServerObject â†’ ClientData â†’ GameObject\r\n-\r\n--- åŒæ­¥åˆ°å®¢æˆ·ç«¯æ•°æ®\r\n-function Building:SyncToClientData()\r\n-    -- æ ¹æ® serverObject æ›´æ–° clientData\r\n-    if self.serverObject.floor then\r\n-        self.clientData.floor = self.serverObject.floor\r\n-    end\r\n-    -- å…¶ä»–åŒæ­¥é€»è¾‘...\r\n-end\r\n-\r\n--- åŒæ­¥åˆ° GameObject\r\n-function Building:SyncToGameObject()\r\n-    if not self.gameObject then\r\n-        return\r\n-    end\r\n-    \r\n-    -- åŒæ­¥ä½ç½®\r\n-    if self.serverObject.position then\r\n-        self.gameObject.transform.position = self.serverObject.position\r\n-    end\r\n-    \r\n-    -- åŒæ­¥çŠ¶æ€\r\n-    if self.serverObject.isActive ~= nil then\r\n-        self.gameObject:SetActive(self.serverObject.isActive)\r\n-    end\r\n-    \r\n-    -- å…¶ä»–åŒæ­¥é€»è¾‘...\r\n-end\r\n-\r\n--- å®Œæ•´åŒæ­¥æµç¨‹\r\n-function BuildingSystem:SyncBuilding(dbId)\r\n-    local building = self:Get(dbId)\r\n-    if not building then\r\n-        return false\r\n-    end\r\n-    \r\n-    -- 1. åŒæ­¥åˆ°å®¢æˆ·ç«¯æ•°æ®\r\n-    building:SyncToClientData()\r\n-    \r\n-    -- 2. åŒæ­¥åˆ° GameObject\r\n-    building:SyncToGameObject()\r\n-    \r\n-    -- 3. æ¸…é™¤è„æ ‡è®°\r\n-    building.isDirty = false\r\n-    \r\n-    return true\r\n-end\r\n-```\r\n-\r\n-### 8.3 ä¼˜åŒ–åçš„å®Œæ•´æµç¨‹\r\n-\r\n-#### åˆ›å»ºæµç¨‹\r\n-\r\n-```lua\r\n--- 1. æ”¶åˆ°æœåŠ¡å™¨å“åº”\r\n-OnBuildingResponse(resp)\r\n-    â†“\r\n--- 2. åˆ›å»º Building å¯¹è±¡\r\n-Building:New()\r\n-    â†“\r\n--- 3. è®¾ç½®æ•°æ®\r\n-building.serverObject = resp.building\r\n-building.cfg = CfgData.building[...]\r\n-    â†“\r\n--- 4. åˆ›å»º GameObject\r\n-GameObject.Instantiate(prefab)\r\n-    â†“\r\n--- 5. æ³¨å†Œåˆ° BuildingSystem\r\n-BuildingSystem:Register(building)\r\n-    â†“\r\n--- 6. æ›´æ–° G.me\r\n-G.me.buildings[dbId] = true\r\n-    â†“\r\n--- 7. è§¦å‘äº‹ä»¶\r\n-EventSystem:Dispatch(\"OnBuildingCreated\")\r\n-```\r\n-\r\n-#### æ›´æ–°æµç¨‹\r\n-\r\n-```lua\r\n--- 1. æ”¶åˆ° SynAction\r\n-UpdateBuildingAction.Execute()\r\n-    â†“\r\n--- 2. è·å– Building\r\n-BuildingSystem:Get(buildingId)\r\n-    â†“\r\n--- 3. æ›´æ–°æ•°æ®\r\n-BuildingSystem:Update(buildingId, updates)\r\n-    â†“\r\n--- 4. åŒæ­¥åˆ°å®¢æˆ·ç«¯\r\n-building:SyncToClientData()\r\n-    â†“\r\n--- 5. åŒæ­¥åˆ° GameObject\r\n-building:SyncToGameObject()\r\n-    â†“\r\n--- 6. è§¦å‘äº‹ä»¶\r\n-EventSystem:Dispatch(\"OnBuildingUpdated\")\r\n-```\r\n-\r\n-#### é”€æ¯æµç¨‹\r\n-\r\n-```lua\r\n--- 1. è°ƒç”¨é”€æ¯\r\n-BuildingSystem:Destroy(dbId)\r\n-    â†“\r\n--- 2. è§¦å‘é”€æ¯å‰äº‹ä»¶\r\n-EventSystem:Dispatch(\"OnBuildingDestroying\")\r\n-    â†“\r\n--- 3. é”€æ¯ GameObject\r\n-GameObject.Destroy(gameObject)\r\n-    â†“\r\n--- 4. ä» G.me ç§»é™¤\r\n-G.me.buildings[dbId] = nil\r\n-    â†“\r\n--- 5. ä»ç³»ç»Ÿæ³¨é”€\r\n-BuildingSystem:Unregister(dbId)\r\n-    â†“\r\n--- 6. å›æ”¶å¯¹è±¡ï¼ˆå¯é€‰ï¼‰\r\n-buildingPool:Push(building)\r\n-```\r\n-\r\n-### 8.4 ä¼˜åŒ–è¦ç‚¹æ€»ç»“\r\n-\r\n-#### âœ… å·²ä¼˜åŒ–çš„ç‚¹\r\n-\r\n-1. **å‘½åç»Ÿä¸€**ï¼š\r\n-   - `Register/Unregister` æ›¿ä»£ `Set/Remove`\r\n-   - `Get` ä¿æŒä¸å˜\r\n-   - `Update` ç»Ÿä¸€æ¥å£\r\n-\r\n-2. **å‡å°‘å†—ä½™**ï¼š\r\n-   - ç»Ÿä¸€çš„ `UpdateBuildingAction`ï¼Œæ”¯æŒéƒ¨åˆ†æ›´æ–°\r\n-   - é¿å…å¤šä¸ª Action ç±»\r\n-\r\n-3. **å®Œå–„é”™è¯¯å¤„ç†**ï¼š\r\n-   - æ‰€æœ‰æ¥å£éƒ½æœ‰é”™è¯¯æ£€æŸ¥å’Œæ—¥å¿—\r\n-   - è¿”å› bool å€¼è¡¨ç¤ºæˆåŠŸ/å¤±è´¥\r\n-\r\n-4. **æ˜ç¡®æ•°æ®æµ**ï¼š\r\n-   - ç½‘ç»œæ•°æ® â†’ ServerObject â†’ ClientData â†’ GameObject\r\n-   - æ¯ä¸ªæ­¥éª¤éƒ½æœ‰æ˜ç¡®çš„åŒæ­¥æ–¹æ³•\r\n-\r\n-5. **ç´¢å¼•ä¼˜åŒ–**ï¼š\r\n-   - `buildingMap`ï¼šä¸»ç´¢å¼•ï¼ˆdbId â†’ Buildingï¼‰\r\n-   - `gameObjectMap`ï¼šGameObject ç´¢å¼•\r\n-   - `playerBuildingMap`ï¼šç©å®¶ç´¢å¼•\r\n-\r\n-6. **ç”Ÿå‘½å‘¨æœŸå®Œæ•´**ï¼š\r\n-   - Create/Destroy/Update éƒ½æœ‰å®Œæ•´æµç¨‹\r\n-   - äº‹ä»¶è§¦å‘æœºåˆ¶\r\n-\r\n-#### ğŸ¯ ä¿æŒçš„è®¾è®¡ç†å¿µ\r\n-\r\n-- âœ… **æ•°æ®åˆ†ç¦»**ï¼šSData/CData æ¸…æ™°åˆ†ç¦»\r\n-- âœ… **ç›´æ¥è®¿é—®**ï¼šBuildingSystem ä½œä¸ºæ•°æ®ä¸­å¿ƒ\r\n-- âœ… **ç®€å•ç›´æ¥**ï¼šä¸å¼•å…¥å¤æ‚çš„é˜Ÿåˆ—æœºåˆ¶\r\n-- âœ… **æ€§èƒ½ä¼˜å…ˆ**ï¼šç›´æ¥è®¿é—®ï¼Œæœ€å°å¼€é”€\r\n-\r\n-### 8.5 ä½¿ç”¨ç¤ºä¾‹\r\n-\r\n-```lua\r\n--- åˆ›å»ºå»ºç­‘\r\n-local building = BuildingSystem:Create(serverData, gameObject)\r\n-\r\n--- è·å–å»ºç­‘\r\n-local building = BuildingSystem:Get(123)\r\n-\r\n--- æ›´æ–°å»ºç­‘ï¼ˆéƒ¨åˆ†æ›´æ–°ï¼‰\r\n-BuildingSystem:Update(123, {\r\n-    level = 5,\r\n-    worker = 10\r\n-})\r\n-\r\n--- æ›´æ–°å»ºç­‘ï¼ˆå®Œæ•´æ›´æ–°ï¼‰\r\n-BuildingSystem:Update(123, completeServerData)\r\n-\r\n--- è·å–ç©å®¶çš„æ‰€æœ‰å»ºç­‘\r\n-local buildings = BuildingSystem:GetPlayerBuildings(playerId)\r\n-\r\n--- é”€æ¯å»ºç­‘\r\n-BuildingSystem:Destroy(123)\r\n-```\r\n-\r\n----\r\n-\r\n-## 9. ä¸ TBBattle æ¡†æ¶è®¾è®¡å¯¹æ¯”åˆ†æ\r\n-\r\n-### 8.1 æ¶æ„ç†å¿µå¯¹æ¯”\r\n-\r\n-| ç»´åº¦ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | è¯„ä»· |\r\n-|------|-------------|--------------|------|\r\n-| **æ•°æ®ç®¡ç†** | BuildingSystem ç›´æ¥ç®¡ç† | DataHandleQueue ä¸­å¿ƒåŒ– | TBBattle æ›´è§£è€¦ |\r\n-| **æ¥å£è®¾è®¡** | ä¼ ç»Ÿ Get/Set | Context ç»Ÿä¸€æ¥å£ | TBBattle æ›´çµæ´» |\r\n-| **ç³»ç»Ÿé€šä¿¡** | ç›´æ¥è°ƒç”¨ | é˜Ÿåˆ—è§£è€¦ | TBBattle æ›´è§£è€¦ |\r\n-| **æ•°æ®æ›´æ–°** | SynAction æœºåˆ¶ | å®æ—¶è®¡ç®— + é˜Ÿåˆ—æ¨é€ | TBBattle æ›´ä¸€è‡´ |\r\n-\r\n-### 8.2 æ ¸å¿ƒå·®å¼‚åˆ†æ\r\n-\r\n-#### 1. **æ•°æ®ç®¡ç†æ–¹å¼**\r\n-\r\n-**Building è®¾è®¡**ï¼š\r\n-```lua\r\n--- ç›´æ¥è®¿é—®\r\n-local building = buildingSystem:Get(dbId)\r\n-building.serverObject.worker = worker\r\n-```\r\n-\r\n-**TBBattle æ¡†æ¶**ï¼š\r\n-```lua\r\n--- é€šè¿‡é˜Ÿåˆ—è§£è€¦\r\n-queue:PushData(EDataHandle.Building.UpdateWorker, {\r\n-    buildingId = dbId,\r\n-    worker = worker\r\n-})\r\n-queue:ProcessDataHandler()  -- æ‰¹é‡å¤„ç†\r\n-```\r\n-\r\n-**æ€§èƒ½å¯¹æ¯”**ï¼š\r\n-```lua\r\n--- Building è®¾è®¡ï¼šO(1) ç›´æ¥è®¿é—®\r\n-local building = buildingSystem:Get(dbId)  -- 1æ¬¡å“ˆå¸ŒæŸ¥æ‰¾ O(1)\r\n-building.serverObject.worker = worker      -- 1æ¬¡èµ‹å€¼ O(1)\r\n--- æ€»å¼€é”€ï¼š2æ¬¡æ“ä½œï¼Œå‡ ä¹æ— å¼€é”€\r\n-\r\n--- TBBattle æ¡†æ¶ï¼šå¤šæ¬¡æ“ä½œ\r\n-queue:PushData(...)              -- 1æ¬¡å…¥é˜Ÿæ“ä½œ\r\n-queue:ProcessDataHandler()       -- 1æ¬¡å‡ºé˜Ÿ + æŸ¥æ‰¾Handler + æ‰§è¡ŒHandler\r\n--- æ€»å¼€é”€ï¼šè‡³å°‘4-5æ¬¡æ“ä½œï¼Œè¿˜æœ‰é˜Ÿåˆ—å¤„ç†å¼€é”€\r\n-```\r\n-\r\n-**å¯¹æ¯”**ï¼š\r\n-- âœ… **Building æ€§èƒ½ä¼˜åŠ¿**ï¼š**ç›´æ¥è®¿é—®ï¼ŒO(1) å¤æ‚åº¦ï¼Œæ€§èƒ½å¼€é”€æå°**\r\n-- âš ï¸ **TBBattle æ€§èƒ½åŠ£åŠ¿**ï¼šé˜Ÿåˆ—å¤„ç†ã€Handler æŸ¥æ‰¾ã€Context åˆ›å»ºéƒ½æœ‰å¼€é”€\r\n-- âœ… **TBBattle ä¼˜åŠ¿**ï¼šç³»ç»Ÿå®Œå…¨è§£è€¦ï¼Œæ‰¹é‡å¤„ç†å¯ä»¥ä¼˜åŒ–ï¼ˆä½†å•æ¬¡æ“ä½œæ€§èƒ½æ›´å·®ï¼‰\r\n-\r\n-#### 2. **æ¥å£è®¾è®¡**\r\n-\r\n-**Building è®¾è®¡**ï¼š\r\n-```lua\r\n--- å¤šä¸ªä¸åŒçš„æ¥å£\r\n-buildingSystem:Get(dbId)\r\n-buildingSystem:Set(building)\r\n-buildingSystem:Update(action)\r\n-```\r\n-\r\n-**TBBattle æ¡†æ¶**ï¼š\r\n-```lua\r\n--- ç»Ÿä¸€çš„ Context æ¥å£\r\n-function System:Execute(context)\r\n-    -- context åŒ…å«æ‰€æœ‰éœ€è¦çš„æ•°æ®\r\n-end\r\n-```\r\n-\r\n-**å¯¹æ¯”**ï¼š\r\n-- âœ… **TBBattle ä¼˜åŠ¿**ï¼šæ¥å£ç¨³å®šï¼Œå‘åå…¼å®¹ï¼Œå‚æ•°çµæ´»\r\n-- âš ï¸ **Building ä¼˜åŠ¿**ï¼šæ¥å£æ˜ç¡®ï¼Œç±»å‹å®‰å…¨ï¼Œæ˜“äºç†è§£\r\n-\r\n-#### 3. **æ•°æ®æ›´æ–°æœºåˆ¶ - è´£ä»»é“¾ä¸è‡ªåŠ¨è¿é”ååº”** â­â­â­\r\n-\r\n-è¿™æ˜¯ **TBBattle æ¡†æ¶çš„æ ¸å¿ƒä¼˜åŠ¿**ï¼\r\n-\r\n-**Building è®¾è®¡ï¼ˆç¡¬ç¼–ç ï¼Œéœ€è¦æ‰‹åŠ¨ç»´æŠ¤ï¼‰**ï¼š\r\n-```lua\r\n--- æ›´æ–°å•†åº—å·¥äºº\r\n-function UpdateBuildingWorker(buildingId, worker)\r\n-    local building = BuildingSystem:Get(buildingId)\r\n-    building.serverObject.worker = worker\r\n-    \r\n-    -- âŒ é—®é¢˜ï¼šéœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰è¿é”ååº”\r\n-    -- 1. æ‰‹åŠ¨åŒæ­¥å·¥äººæ•°æ®\r\n-    SyncWorkerData(worker)\r\n-    \r\n-    -- 2. æ‰‹åŠ¨æ£€æŸ¥å·¥äºº buff\r\n-    if worker.hasBuff then\r\n-        ApplyWorkerBuff(worker)\r\n-    end\r\n-    \r\n-    -- 3. æ‰‹åŠ¨æ›´æ–°å•†åº—æ•ˆç‡\r\n-    UpdateShopEfficiency(building)\r\n-    \r\n-    -- 4. æ‰‹åŠ¨è§¦å‘ç›¸å…³äº‹ä»¶\r\n-    EventSystem:Dispatch(\"OnWorkerChanged\", building)\r\n-    \r\n-    -- âš ï¸ é—®é¢˜ï¼šæ¯æ¬¡æ·»åŠ æ–°åŠŸèƒ½ï¼Œéƒ½è¦ä¿®æ”¹è¿™é‡Œï¼\r\n-    -- âš ï¸ é—®é¢˜ï¼šå®¹æ˜“é—æ¼æŸäº›è¿é”ååº”\r\n-    -- âš ï¸ é—®é¢˜ï¼šä»£ç è€¦åˆï¼Œéš¾ä»¥ç»´æŠ¤\r\n-end\r\n-```\r\n-\r\n-**TBBattle æ¡†æ¶ï¼ˆè´£ä»»é“¾ï¼Œè‡ªåŠ¨è§¦å‘ï¼‰**ï¼š\r\n-```lua\r\n--- æ›´æ–°å•†åº—å·¥äººï¼ˆåªéœ€æ¨é€æ•°æ®ï¼‰\r\n-function UpdateBuildingWorker(buildingId, worker)\r\n-    -- 1. æ¨é€æ•°æ®åˆ°é˜Ÿåˆ—\r\n-    queue:PushData(EDataHandle.Building.UpdateWorker, {\r\n-        buildingId = buildingId,\r\n-        worker = worker\r\n-    })\r\n-    \r\n-    -- 2. å¤„ç†é˜Ÿåˆ—ï¼ˆè´£ä»»é“¾è‡ªåŠ¨è§¦å‘æ‰€æœ‰ Handlerï¼‰\r\n-    queue:ProcessDataHandler()\r\n-    \r\n-    -- âœ… ä¼˜åŠ¿ï¼šæ‰€æœ‰è¿é”ååº”è‡ªåŠ¨è§¦å‘ï¼\r\n-    -- âœ… ä¼˜åŠ¿ï¼šæ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ  Handlerï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç \r\n-    -- âœ… ä¼˜åŠ¿ï¼šé…ç½®é©±åŠ¨ï¼Œçµæ´»æ‰©å±•\r\n-end\r\n-\r\n--- Handler æ³¨å†Œï¼ˆè´£ä»»é“¾æ¨¡å¼ï¼‰\r\n-handlerMapping[EDataHandle.Building.UpdateWorker] = function(data)\r\n-    -- Handler 1: æ›´æ–°å·¥äººæ•°æ®\r\n-    local building = BuildingSystem:Get(data.buildingId)\r\n-    building.serverObject.worker = data.worker\r\n-    \r\n-    -- Handler 2: è‡ªåŠ¨è§¦å‘å·¥äººæ•°æ®åŒæ­¥\r\n-    queue:PushData(EDataHandle.Worker.Sync, {\r\n-        worker = data.worker\r\n-    })\r\n-end\r\n-\r\n-handlerMapping[EDataHandle.Worker.Sync] = function(data)\r\n-    -- Handler 3: è‡ªåŠ¨æ£€æŸ¥å·¥äºº buff\r\n-    if data.worker.hasBuff then\r\n-        queue:PushData(EDataHandle.Worker.ApplyBuff, {\r\n-            worker = data.worker\r\n-        })\r\n-    end\r\n-    \r\n-    -- Handler 4: è‡ªåŠ¨æ›´æ–°å•†åº—æ•ˆç‡\r\n-    queue:PushData(EDataHandle.Building.UpdateEfficiency, {\r\n-        buildingId = data.worker.buildingId\r\n-    })\r\n-end\r\n-\r\n-handlerMapping[EDataHandle.Worker.ApplyBuff] = function(data)\r\n-    -- Handler 5: åº”ç”¨å·¥äºº buff\r\n-    ApplyWorkerBuff(data.worker)\r\n-    \r\n-    -- Handler 6: è‡ªåŠ¨è§¦å‘ buff æ•ˆæœ\r\n-    queue:PushData(EDataHandle.Effect.Apply, {\r\n-        target = data.worker,\r\n-        effect = data.worker.buff\r\n-    })\r\n-end\r\n-\r\n--- âœ… ä¼˜åŠ¿ï¼šè´£ä»»é“¾è‡ªåŠ¨è§¦å‘ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤ï¼\r\n--- âœ… ä¼˜åŠ¿ï¼šæ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ æ–° Handler\r\n--- âœ… ä¼˜åŠ¿ï¼šé…ç½®é©±åŠ¨ï¼Œçµæ´»æ‰©å±•\r\n-```\r\n-\r\n-**æ ¸å¿ƒä¼˜åŠ¿å¯¹æ¯”**ï¼š\r\n-\r\n-| ç‰¹æ€§ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | ä¼˜åŠ¿æ–¹ |\r\n-|------|-------------|--------------|--------|\r\n-| **è¿é”ååº”** | âŒ éœ€è¦æ‰‹åŠ¨ç»´æŠ¤ | âœ… è‡ªåŠ¨è§¦å‘ | **TBBattle** |\r\n-| **æ‰©å±•æ€§** | âŒ ä¿®æ”¹ç°æœ‰ä»£ç  | âœ… åªéœ€æ·»åŠ  Handler | **TBBattle** |\r\n-| **çµæ´»æ€§** | âŒ ç¡¬ç¼–ç  | âœ… é…ç½®é©±åŠ¨ | **TBBattle** |\r\n-| **ç»´æŠ¤æˆæœ¬** | âŒ å®¹æ˜“é—æ¼ | âœ… è‡ªåŠ¨å¤„ç† | **TBBattle** |\r\n-| **ä»£ç è€¦åˆ** | âŒ é«˜åº¦è€¦åˆ | âœ… å®Œå…¨è§£è€¦ | **TBBattle** |\r\n-\r\n-**å®é™…åœºæ™¯ç¤ºä¾‹**ï¼š\r\n-\r\n-```lua\r\n--- åœºæ™¯ï¼šè·å¾—å•†åº—ï¼Œå·¥äººéœ€è¦åŒæ­¥ï¼Œå·¥äººæœ‰ buffï¼Œbuff å½±å“å•†åº—æ•ˆç‡\r\n-\r\n--- Building è®¾è®¡ï¼ˆéœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰æ­¥éª¤ï¼‰\r\n-function OnGetShop(shopData)\r\n-    -- 1. åˆ›å»ºå•†åº—\r\n-    local shop = BuildingSystem:Create(shopData)\r\n-    \r\n-    -- 2. æ‰‹åŠ¨åŒæ­¥å·¥äºº\r\n-    if shop.workers then\r\n-        for _, worker in ipairs(shop.workers) do\r\n-            SyncWorkerData(worker)  -- æ‰‹åŠ¨è°ƒç”¨\r\n-            \r\n-            -- 3. æ‰‹åŠ¨æ£€æŸ¥ buff\r\n-            if worker.buffs then\r\n-                for _, buff in ipairs(worker.buffs) do\r\n-                    ApplyBuff(worker, buff)  -- æ‰‹åŠ¨è°ƒç”¨\r\n-                    \r\n-                    -- 4. æ‰‹åŠ¨æ›´æ–°å•†åº—æ•ˆç‡\r\n-                    UpdateShopEfficiency(shop)  -- æ‰‹åŠ¨è°ƒç”¨\r\n-                end\r\n-            end\r\n-        end\r\n-    end\r\n-    \r\n-    -- âš ï¸ é—®é¢˜ï¼šæ¯æ¬¡æ·»åŠ æ–°åŠŸèƒ½ï¼Œéƒ½è¦ä¿®æ”¹è¿™é‡Œ\r\n-    -- âš ï¸ é—®é¢˜ï¼šå®¹æ˜“é—æ¼æŸäº›æ­¥éª¤\r\n-end\r\n-\r\n--- TBBattle æ¡†æ¶ï¼ˆè‡ªåŠ¨è§¦å‘è¿é”ååº”ï¼‰\r\n-function OnGetShop(shopData)\r\n-    -- 1. æ¨é€å•†åº—æ•°æ®\r\n-    queue:PushData(EDataHandle.Building.Create, shopData)\r\n-    queue:ProcessDataHandler()\r\n-    \r\n-    -- âœ… è‡ªåŠ¨è§¦å‘ï¼š\r\n-    --   â†’ Building.Create Handler åˆ›å»ºå•†åº—\r\n-    --   â†’ è‡ªåŠ¨è§¦å‘ Worker.Sync Handlerï¼ˆå¦‚æœé…ç½®äº†ï¼‰\r\n-    --   â†’ è‡ªåŠ¨è§¦å‘ Worker.ApplyBuff Handlerï¼ˆå¦‚æœé…ç½®äº†ï¼‰\r\n-    --   â†’ è‡ªåŠ¨è§¦å‘ Building.UpdateEfficiency Handlerï¼ˆå¦‚æœé…ç½®äº†ï¼‰\r\n-    --   â†’ è‡ªåŠ¨è§¦å‘ Effect.Apply Handlerï¼ˆå¦‚æœé…ç½®äº†ï¼‰\r\n-    --   â†’ ... æ‰€æœ‰è¿é”ååº”è‡ªåŠ¨å¤„ç†ï¼\r\n-    \r\n-    -- âœ… ä¼˜åŠ¿ï¼šæ–°å¢åŠŸèƒ½åªéœ€é…ç½® Handlerï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç \r\n-end\r\n-```\r\n-\r\n-**å¯¹æ¯”æ€»ç»“**ï¼š\r\n-- âœ… **TBBattle æ ¸å¿ƒä¼˜åŠ¿**ï¼š**è´£ä»»é“¾æ¨¡å¼ + è‡ªåŠ¨è¿é”ååº” + é…ç½®é©±åŠ¨**\r\n-- âš ï¸ **Building åŠ£åŠ¿**ï¼š**ç¡¬ç¼–ç  + æ‰‹åŠ¨ç»´æŠ¤ + å®¹æ˜“é—æ¼**\r\n-- ğŸ¯ **å…³é”®å·®å¼‚**ï¼šTBBattle çš„ DataHandleQueue å¤©ç„¶æ”¯æŒè´£ä»»é“¾ï¼ŒBuilding éœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰è¿é”ååº”\r\n-\r\n-#### 4. **æ‰‹åŠ¨ç»´æŠ¤é“¾å¼è°ƒç”¨çš„è‡´å‘½é—®é¢˜** âš ï¸âš ï¸âš ï¸\r\n-\r\n-è¿™æ˜¯ **Building è®¾è®¡åœ¨å¤æ‚åœºæ™¯ä¸‹çš„æ ¸å¿ƒç¼ºé™·**ï¼\r\n-\r\n-**Building è®¾è®¡çš„é—®é¢˜**ï¼š\r\n-\r\n-```lua\r\n--- æ‰‹åŠ¨ç»´æŠ¤é“¾å¼è°ƒç”¨\r\n-function UpdateBuildingWorker(buildingId, worker)\r\n-    local building = BuildingSystem:Get(buildingId)\r\n-    building.serverObject.worker = worker\r\n-    \r\n-    -- âŒ é—®é¢˜1ï¼šéœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰æ­¥éª¤\r\n-    SyncWorkerData(worker)                    -- æ­¥éª¤1\r\n-    if worker.hasBuff then\r\n-        ApplyWorkerBuff(worker)                -- æ­¥éª¤2\r\n-        UpdateShopEfficiency(building)         -- æ­¥éª¤3\r\n-        UpdateShopIncome(building)             -- æ­¥éª¤4\r\n-        NotifyOtherSystems(building)          -- æ­¥éª¤5\r\n-        -- ... é“¾è¶Šé•¿ï¼Œç»´æŠ¤è¶Šå›°éš¾\r\n-    end\r\n-    \r\n-    -- âŒ é—®é¢˜2ï¼šé“¾è¶Šé•¿ï¼Œè°ƒè¯•è¶Šå›°éš¾\r\n-    -- å¦‚æœ UpdateShopIncome å‡ºé”™äº†ï¼Œéœ€è¦è¿½è¸ªæ•´ä¸ªè°ƒç”¨é“¾\r\n-    -- å¦‚æœæŸä¸ªæ­¥éª¤é—æ¼äº†ï¼Œå¾ˆéš¾å‘ç°\r\n-    \r\n-    -- âŒ é—®é¢˜3ï¼šbug è®°å½•ä¼šä¸æ–­å¢åŠ \r\n-    -- - å¿˜è®°è°ƒç”¨æŸä¸ªæ­¥éª¤ â†’ bug\r\n-    -- - è°ƒç”¨é¡ºåºé”™è¯¯ â†’ bug\r\n-    -- - é—æ¼æŸäº›æ¡ä»¶åˆ¤æ–­ â†’ bug\r\n-    -- - æ–°å¢åŠŸèƒ½æ—¶å¿˜è®°æ›´æ–°è°ƒç”¨é“¾ â†’ bug\r\n-end\r\n-```\r\n-\r\n-**TBBattle æ¡†æ¶çš„ä¼˜åŠ¿**ï¼š\r\n-\r\n-```lua\r\n--- å†…éƒ¨æœºåˆ¶å¤©ç„¶æ”¯æŒé“¾å¼å“åº”\r\n-function UpdateBuildingWorker(buildingId, worker)\r\n-    -- åªéœ€æ¨é€æ•°æ®ï¼Œå†…éƒ¨æœºåˆ¶è‡ªåŠ¨å¤„ç†\r\n-    queue:PushData(EDataHandle.Building.UpdateWorker, {\r\n-        buildingId = buildingId,\r\n-        worker = worker\r\n-    })\r\n-    queue:ProcessDataHandler()\r\n-    \r\n-    -- âœ… ä¼˜åŠ¿1ï¼šå†…éƒ¨æœºåˆ¶å¤©ç„¶æ”¯æŒï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤\r\n-    -- âœ… ä¼˜åŠ¿2ï¼šé“¾å†é•¿ä¹Ÿä¸æ€•ï¼Œè‡ªåŠ¨å¤„ç†\r\n-    -- âœ… ä¼˜åŠ¿3ï¼šä¸ä¼šé—æ¼ä»»ä½•æ­¥éª¤ï¼Œbug è®°å½•ä¸ä¼šå¢åŠ \r\n-end\r\n-\r\n--- Handler é…ç½®ï¼ˆå†…éƒ¨æœºåˆ¶è‡ªåŠ¨è§¦å‘ï¼‰\r\n-handlerMapping[EDataHandle.Building.UpdateWorker] = function(data)\r\n-    -- æ›´æ–°å·¥äºº\r\n-    local building = BuildingSystem:Get(data.buildingId)\r\n-    building.serverObject.worker = data.worker\r\n-    \r\n-    -- è‡ªåŠ¨è§¦å‘ä¸‹ä¸€æ­¥ï¼ˆå†…éƒ¨æœºåˆ¶å¤„ç†ï¼‰\r\n-    queue:PushData(EDataHandle.Worker.Sync, {worker = data.worker})\r\n-end\r\n-\r\n-handlerMapping[EDataHandle.Worker.Sync] = function(data)\r\n-    -- è‡ªåŠ¨æ£€æŸ¥å¹¶è§¦å‘ä¸‹ä¸€æ­¥\r\n-    if data.worker.hasBuff then\r\n-        queue:PushData(EDataHandle.Worker.ApplyBuff, {worker = data.worker})\r\n-    end\r\n-    queue:PushData(EDataHandle.Building.UpdateEfficiency, {\r\n-        buildingId = data.worker.buildingId\r\n-    })\r\n-end\r\n-\r\n--- âœ… ä¼˜åŠ¿ï¼šé“¾å†é•¿ä¹Ÿä¸æ€•ï¼Œå†…éƒ¨æœºåˆ¶è‡ªåŠ¨å¤„ç†\r\n--- âœ… ä¼˜åŠ¿ï¼šä¸ä¼šé—æ¼ä»»ä½•æ­¥éª¤\r\n--- âœ… ä¼˜åŠ¿ï¼šbug è®°å½•ä¸ä¼šå› ä¸ºé—æ¼è€Œå¢åŠ \r\n-```\r\n-\r\n-**å…³é”®é—®é¢˜å¯¹æ¯”**ï¼š\r\n-\r\n-| é—®é¢˜ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | å½±å“ |\r\n-|------|-------------|--------------|------|\r\n-| **æ‰‹åŠ¨ç»´æŠ¤** | âŒ éœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰æ­¥éª¤ | âœ… å†…éƒ¨æœºåˆ¶è‡ªåŠ¨å¤„ç† | **é«˜** |\r\n-| **é“¾è¶Šé•¿è°ƒè¯•è¶Šéš¾** | âŒ é“¾è¶Šé•¿ï¼Œè°ƒè¯•è¶Šå›°éš¾ | âœ… é“¾å†é•¿ä¹Ÿä¸æ€•ï¼Œè‡ªåŠ¨å¤„ç† | **é«˜** |\r\n-| **bug è®°å½•å¢åŠ ** | âŒ å®¹æ˜“é—æ¼ï¼Œbug ä¸æ–­ | âœ… ä¸ä¼šé—æ¼ï¼Œbug å°‘ | **é«˜** |\r\n-| **æ–°å¢åŠŸèƒ½é£é™©** | âŒ éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç  | âœ… åªéœ€æ·»åŠ  Handler | **ä¸­** |\r\n-| **ç»´æŠ¤æˆæœ¬** | âŒ æ¯æ¬¡éƒ½è¦æ‰‹åŠ¨ç»´æŠ¤ | âœ… é…ç½®å³å¯ | **é«˜** |\r\n-\r\n-#### 5. **å¤–éƒ¨ç³»ç»Ÿç»Ÿä¸€æ¥å£ - DataHandleQueue** â­â­â­\r\n-\r\n-è¿™æ˜¯ **TBBattle æ¡†æ¶çš„å¦ä¸€ä¸ªæ ¸å¿ƒä¼˜åŠ¿**ï¼\r\n-\r\n-**Building è®¾è®¡ï¼ˆå¤–éƒ¨ç³»ç»Ÿéœ€è¦ç›´æ¥è®¿é—®ï¼‰**ï¼š\r\n-\r\n-```lua\r\n--- å¤–éƒ¨ç³»ç»Ÿéœ€è¦ç›´æ¥è®¿é—® BuildingSystem\r\n-function OtherSystem:UpdateBuildingWorker(buildingId, worker)\r\n-    -- âŒ é—®é¢˜ï¼šå¤–éƒ¨ç³»ç»Ÿéœ€è¦çŸ¥é“ BuildingSystem çš„å†…éƒ¨å®ç°\r\n-    local building = BuildingSystem:Get(buildingId)\r\n-    building.serverObject.worker = worker\r\n-    \r\n-    -- âŒ é—®é¢˜ï¼šå¤–éƒ¨ç³»ç»Ÿéœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰è¿é”ååº”\r\n-    SyncWorkerData(worker)\r\n-    if worker.hasBuff then\r\n-        ApplyWorkerBuff(worker)\r\n-        UpdateShopEfficiency(building)\r\n-    end\r\n-    \r\n-    -- âš ï¸ é—®é¢˜ï¼šå¤–éƒ¨ç³»ç»Ÿéœ€è¦äº†è§£å†…éƒ¨å®ç°ç»†èŠ‚\r\n-    -- âš ï¸ é—®é¢˜ï¼šå¤–éƒ¨ç³»ç»Ÿéœ€è¦æ‰‹åŠ¨ç»´æŠ¤è°ƒç”¨é“¾\r\n-    -- âš ï¸ é—®é¢˜ï¼šå¦‚æœå†…éƒ¨å®ç°æ”¹å˜ï¼Œå¤–éƒ¨ç³»ç»Ÿä¹Ÿè¦ä¿®æ”¹\r\n-end\r\n-```\r\n-\r\n-**TBBattle æ¡†æ¶ï¼ˆç»Ÿä¸€æ¥å£ï¼Œå¤–éƒ¨ç³»ç»Ÿä¹Ÿä½¿ç”¨ DataHandleQueueï¼‰**ï¼š\r\n-\r\n-```lua\r\n--- å¤–éƒ¨ç³»ç»Ÿä¹Ÿä½¿ç”¨ DataHandleQueueï¼ˆç»Ÿä¸€æ¥å£ï¼‰\r\n-function OtherSystem:UpdateBuildingWorker(buildingId, worker)\r\n-    -- âœ… ä¼˜åŠ¿ï¼šå¤–éƒ¨ç³»ç»Ÿä½¿ç”¨ç»Ÿä¸€æ¥å£ï¼Œæ— éœ€çŸ¥é“å†…éƒ¨å®ç°\r\n-    queue:PushData(EDataHandle.Building.UpdateWorker, {\r\n-        buildingId = buildingId,\r\n-        worker = worker\r\n-    })\r\n-    queue:ProcessDataHandler()\r\n-    \r\n-    -- âœ… ä¼˜åŠ¿ï¼šå¤–éƒ¨ç³»ç»Ÿä¹Ÿäº«å—è‡ªåŠ¨è¿é”ååº”\r\n-    -- âœ… ä¼˜åŠ¿ï¼šå¤–éƒ¨ç³»ç»Ÿæ— éœ€æ‰‹åŠ¨ç»´æŠ¤è°ƒç”¨é“¾\r\n-    -- âœ… ä¼˜åŠ¿ï¼šå†…éƒ¨å®ç°æ”¹å˜ï¼Œå¤–éƒ¨ç³»ç»Ÿæ— éœ€ä¿®æ”¹\r\n-end\r\n-\r\n--- å¤–éƒ¨ç³»ç»Ÿä¹Ÿå¯ä»¥è·å–æ•°æ®ï¼ˆç»Ÿä¸€æ¥å£ï¼‰\r\n-function OtherSystem:GetBuildingWorker(buildingId)\r\n-    -- âœ… ä¼˜åŠ¿ï¼šä½¿ç”¨ç»Ÿä¸€æ¥å£è·å–æ•°æ®\r\n-    local worker = queue:ProcessQueryDelegate(\r\n-        EDataHandle.Building.GetWorker,\r\n-        buildingId\r\n-    )\r\n-    return worker\r\n-end\r\n-\r\n--- å¤–éƒ¨ç³»ç»Ÿä¹Ÿå¯ä»¥èµ‹å€¼ï¼ˆç»Ÿä¸€æ¥å£ï¼‰\r\n-function OtherSystem:SetBuildingWorker(buildingId, worker)\r\n-    -- âœ… ä¼˜åŠ¿ï¼šä½¿ç”¨ç»Ÿä¸€æ¥å£èµ‹å€¼\r\n-    queue:PushData(EDataHandle.Building.UpdateWorker, {\r\n-        buildingId = buildingId,\r\n-        worker = worker\r\n-    })\r\n-    queue:ProcessDataHandler()\r\n-    \r\n-    -- âœ… ä¼˜åŠ¿ï¼šè‡ªåŠ¨è§¦å‘æ‰€æœ‰è¿é”ååº”\r\n-    -- âœ… ä¼˜åŠ¿ï¼šå¤–éƒ¨ç³»ç»Ÿæ— éœ€å…³å¿ƒå†…éƒ¨å®ç°\r\n-end\r\n-```\r\n-\r\n-**ç»Ÿä¸€æ¥å£çš„ä¼˜åŠ¿**ï¼š\r\n-\r\n-| ç‰¹æ€§ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | ä¼˜åŠ¿æ–¹ |\r\n-|------|-------------|--------------|--------|\r\n-| **å¤–éƒ¨ç³»ç»Ÿæ¥å£** | âŒ éœ€è¦ç›´æ¥è®¿é—®å†…éƒ¨å®ç° | âœ… ç»Ÿä¸€æ¥å£ DataHandleQueue | **TBBattle** |\r\n-| **å†…éƒ¨å®ç°éšè—** | âŒ å¤–éƒ¨ç³»ç»Ÿéœ€è¦çŸ¥é“å†…éƒ¨å®ç° | âœ… å¤–éƒ¨ç³»ç»Ÿæ— éœ€çŸ¥é“å†…éƒ¨å®ç° | **TBBattle** |\r\n-| **è‡ªåŠ¨è¿é”ååº”** | âŒ å¤–éƒ¨ç³»ç»Ÿéœ€è¦æ‰‹åŠ¨ç»´æŠ¤ | âœ… å¤–éƒ¨ç³»ç»Ÿä¹Ÿäº«å—è‡ªåŠ¨è¿é”ååº” | **TBBattle** |\r\n-| **æ¥å£ç¨³å®šæ€§** | âŒ å†…éƒ¨æ”¹å˜ï¼Œå¤–éƒ¨ä¹Ÿè¦æ”¹ | âœ… å†…éƒ¨æ”¹å˜ï¼Œå¤–éƒ¨æ— éœ€æ”¹ | **TBBattle** |\r\n-| **ä»£ç è§£è€¦** | âŒ å¤–éƒ¨ç³»ç»Ÿè€¦åˆå†…éƒ¨å®ç° | âœ… å¤–éƒ¨ç³»ç»Ÿå®Œå…¨è§£è€¦ | **TBBattle** |\r\n-\r\n-### 8.3 è®¾è®¡å“²å­¦å¯¹æ¯”\r\n-\r\n-#### Building è®¾è®¡ï¼š**ä¼ ç»Ÿ + å®ç”¨ä¸»ä¹‰**\r\n-\r\n-- âœ… **ä¼˜ç‚¹**ï¼šç®€å•ç›´æ¥ï¼Œæ˜“äºç†è§£ï¼Œæ€§èƒ½å¯æ§\r\n-- âš ï¸ **ç¼ºç‚¹**ï¼šç³»ç»Ÿè€¦åˆï¼Œæ‰©å±•æ€§å—é™ï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†çŠ¶æ€\r\n-\r\n-#### TBBattle æ¡†æ¶ï¼š**æ•°æ®é©±åŠ¨ + è§£è€¦è®¾è®¡**\r\n-\r\n-- âœ… **ä¼˜ç‚¹**ï¼šç³»ç»Ÿè§£è€¦ï¼Œé«˜åº¦å¯æ‰©å±•ï¼Œæ•°æ®ä¸€è‡´æ€§ä¿è¯\r\n-- âš ï¸ **ç¼ºç‚¹**ï¼šå­¦ä¹ æ›²çº¿ï¼Œæ€§èƒ½å¼€é”€ï¼ˆé˜Ÿåˆ—å¤„ç†ï¼‰ï¼Œè°ƒè¯•å¤æ‚åº¦\r\n-\r\n-### 8.4 é€‚ç”¨åœºæ™¯åˆ†æ\r\n-\r\n-#### Building è®¾è®¡é€‚åˆï¼š\r\n-- âœ… **å°å‹ç³»ç»Ÿ**ï¼šå»ºç­‘ç³»ç»Ÿç›¸å¯¹ç‹¬ç«‹ï¼Œä¸éœ€è¦å¤æ‚äº¤äº’\r\n-- âœ… **æ€§èƒ½æ•æ„Ÿ**ï¼šéœ€è¦ç›´æ¥è®¿é—®ï¼Œæœ€å°åŒ–å¼€é”€\r\n-- âœ… **ç®€å•ç»´æŠ¤**ï¼šå›¢é˜Ÿè§„æ¨¡å°ï¼Œä»£ç ç®€å•ç›´æ¥\r\n-\r\n-#### TBBattle æ¡†æ¶é€‚åˆï¼š\r\n-- âœ… **å¤§å‹ç³»ç»Ÿ**ï¼šå¤šä¸ªç³»ç»Ÿéœ€è¦äº¤äº’ï¼Œå¤æ‚æ•°æ®æµ\r\n-- âœ… **é«˜åº¦æ‰©å±•**ï¼šéœ€è¦é¢‘ç¹æ·»åŠ æ–°åŠŸèƒ½ï¼Œé…ç½®é©±åŠ¨\r\n-- âœ… **å›¢é˜Ÿåä½œ**ï¼šå¤šäººåä½œï¼Œéœ€è¦ç»Ÿä¸€æ¥å£å’Œè§„èŒƒ\r\n-\r\n-### 8.5 èåˆå»ºè®® ğŸ’¡\r\n-\r\n-**æœ€ä½³å®è·µï¼šç»“åˆä¸¤è€…ä¼˜åŠ¿**\r\n-\r\n-```lua\r\n--- 1. ä½¿ç”¨ TBBattle çš„ Context æ¨¡å¼ç»Ÿä¸€æ¥å£\r\n-function BuildingSystem:Execute(context)\r\n-    local action = context.action\r\n-    local buildingId = context.buildingId\r\n-    \r\n-    if action == \"Update\" then\r\n-        -- 2. ä½¿ç”¨ Building è®¾è®¡çš„ç›´æ¥è®¿é—®ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰\r\n-        local building = self:Get(buildingId)\r\n-        if building then\r\n-            -- 3. ä½¿ç”¨ TBBattle çš„é˜Ÿåˆ—æœºåˆ¶ï¼ˆè§£è€¦ï¼‰\r\n-            building.dataHandleQueue:PushData(\r\n-                EDataHandle.Building.Update,\r\n-                context.updates\r\n-            )\r\n-        end\r\n-    end\r\n-end\r\n-\r\n--- 4. ä½¿ç”¨ TBBattle çš„å®æ—¶è®¡ç®—ï¼ˆæ•°æ®ä¸€è‡´æ€§ï¼‰\r\n-function BuildingData:GetWorker()\r\n-    -- å®æ—¶ä»å„ä¸ªå­ç³»ç»Ÿè·å–ï¼Œæ— éœ€æ‰‹åŠ¨åŒæ­¥\r\n-    return self:CalculateWorker()\r\n-end\r\n-```\r\n-\r\n-### 8.6 æ€§èƒ½è¯¦ç»†å¯¹æ¯”åˆ†æ\r\n-\r\n-#### Building è®¾è®¡çš„æ€§èƒ½ä¼˜åŠ¿ âš¡\r\n-\r\n-**å•æ¬¡æ“ä½œæ€§èƒ½**ï¼š\r\n-\r\n-```lua\r\n--- Building è®¾è®¡ï¼šç›´æ¥è®¿é—®\r\n-local building = BuildingSystem:Get(dbId)  -- O(1) å“ˆå¸ŒæŸ¥æ‰¾\r\n-building.serverObject.worker = 10           -- O(1) ç›´æ¥èµ‹å€¼\r\n--- æ€»è€—æ—¶ï¼š~0.001msï¼ˆå‡ ä¹å¯ä»¥å¿½ç•¥ï¼‰\r\n-```\r\n-\r\n-**æ€§èƒ½å¼€é”€**ï¼š\r\n-- âœ… **1æ¬¡å“ˆå¸Œè¡¨æŸ¥æ‰¾**ï¼šO(1)\r\n-- âœ… **1æ¬¡ç›´æ¥èµ‹å€¼**ï¼šO(1)\r\n-- âœ… **æ€»å¤æ‚åº¦**ï¼šO(1)\r\n-- âœ… **å†…å­˜å¼€é”€**ï¼š0ï¼ˆæ— é¢å¤–å¯¹è±¡åˆ›å»ºï¼‰\r\n-\r\n-#### TBBattle æ¡†æ¶çš„æ€§èƒ½å¼€é”€ âš ï¸\r\n-\r\n-**å•æ¬¡æ“ä½œæ€§èƒ½**ï¼š\r\n-\r\n-```lua\r\n--- TBBattle æ¡†æ¶ï¼šé˜Ÿåˆ—å¤„ç†\r\n-local context = {buildingId = dbId, worker = 10}  -- åˆ›å»º Context å¯¹è±¡\r\n-queue:PushData(EDataHandle.Building.UpdateWorker, context)  -- å…¥é˜Ÿæ“ä½œ\r\n-queue:ProcessDataHandler()  -- å‡ºé˜Ÿ + æŸ¥æ‰¾Handler + æ‰§è¡ŒHandler\r\n--- æ€»è€—æ—¶ï¼š~0.01-0.05msï¼ˆæ˜¯ Building çš„ 10-50 å€ï¼‰\r\n-```\r\n-\r\n-**æ€§èƒ½å¼€é”€**ï¼š\r\n-- âš ï¸ **åˆ›å»º Context å¯¹è±¡**ï¼šå†…å­˜åˆ†é… + GC å‹åŠ›\r\n-- âš ï¸ **å…¥é˜Ÿæ“ä½œ**ï¼šæ•°ç»„æ’å…¥æ“ä½œ\r\n-- âš ï¸ **å‡ºé˜Ÿæ“ä½œ**ï¼šæ•°ç»„åˆ é™¤æ“ä½œ\r\n-- âš ï¸ **æŸ¥æ‰¾ Handler**ï¼šå“ˆå¸ŒæŸ¥æ‰¾ + å‡½æ•°è°ƒç”¨\r\n-- âš ï¸ **æ‰§è¡Œ Handler**ï¼šå‡½æ•°è°ƒç”¨å¼€é”€\r\n-- âš ï¸ **æ€»å¤æ‚åº¦**ï¼šO(1) ä½†å¸¸æ•°é¡¹å¤§\r\n-- âš ï¸ **å†…å­˜å¼€é”€**ï¼šContext å¯¹è±¡ + é˜Ÿåˆ—èŠ‚ç‚¹\r\n-\r\n-#### æ€§èƒ½å¯¹æ¯”æ•°æ®\r\n-\r\n-| æ“ä½œ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | æ€§èƒ½å·®å¼‚ |\r\n-|------|-------------|--------------|---------|\r\n-| **å•æ¬¡æ›´æ–°** | ~0.001ms | ~0.01-0.05ms | **Building å¿« 10-50 å€** |\r\n-| **å†…å­˜å¼€é”€** | 0 | Context + é˜Ÿåˆ—èŠ‚ç‚¹ | **Building æ— é¢å¤–å¼€é”€** |\r\n-| **GC å‹åŠ›** | 0 | Context å¯¹è±¡éœ€è¦ GC | **Building æ—  GC å‹åŠ›** |\r\n-| **æ‰¹é‡æ›´æ–°ï¼ˆ100æ¬¡ï¼‰** | ~0.1ms | ~1-5ms | **Building å¿« 10-50 å€** |\r\n-\r\n-#### ä¸ºä»€ä¹ˆ Building è®¾è®¡æ€§èƒ½æ›´å¥½ï¼Ÿ\r\n-\r\n-1. **ç›´æ¥è®¿é—® vs é—´æ¥è®¿é—®**\r\n-   - Buildingï¼šç›´æ¥å“ˆå¸ŒæŸ¥æ‰¾ â†’ ç›´æ¥èµ‹å€¼\r\n-   - TBBattleï¼šåˆ›å»ºå¯¹è±¡ â†’ å…¥é˜Ÿ â†’ å‡ºé˜Ÿ â†’ æŸ¥æ‰¾ â†’ æ‰§è¡Œ\r\n-\r\n-2. **é›¶å¼€é”€ vs æœ‰å¼€é”€**\r\n-   - Buildingï¼šæ— é¢å¤–å¯¹è±¡åˆ›å»ºï¼Œæ—  GC å‹åŠ›\r\n-   - TBBattleï¼šæ¯æ¬¡æ“ä½œéƒ½åˆ›å»º Contextï¼Œå¢åŠ  GC å‹åŠ›\r\n-\r\n-3. **ç®€å•æ“ä½œ vs å¤æ‚æµç¨‹**\r\n-   - Buildingï¼š2æ­¥æ“ä½œï¼ˆæŸ¥æ‰¾ + èµ‹å€¼ï¼‰\r\n-   - TBBattleï¼š5+ æ­¥æ“ä½œï¼ˆåˆ›å»º + å…¥é˜Ÿ + å‡ºé˜Ÿ + æŸ¥æ‰¾ + æ‰§è¡Œï¼‰\r\n-\r\n-### 8.7 è´£ä»»é“¾ä¸è‡ªåŠ¨è¿é”ååº” - TBBattle çš„æ ¸å¿ƒä¼˜åŠ¿ â­\r\n-\r\n-#### ä¸ºä»€ä¹ˆ TBBattle çš„ DataHandleQueue æ›´çµæ´»ï¼Ÿ\r\n-\r\n-**æ ¸å¿ƒè®¾è®¡ç†å¿µ**ï¼š\r\n-- âœ… **è´£ä»»é“¾æ¨¡å¼**ï¼šHandler è‡ªåŠ¨é“¾å¼è§¦å‘\r\n-- âœ… **é…ç½®é©±åŠ¨**ï¼šæ–°å¢åŠŸèƒ½åªéœ€é…ç½®ï¼Œæ— éœ€ä¿®æ”¹ä»£ç \r\n-- âœ… **è‡ªåŠ¨è¿é”ååº”**ï¼šæ•°æ®å˜åŒ–è‡ªåŠ¨è§¦å‘æ‰€æœ‰ç›¸å…³å¤„ç†\r\n-- âœ… **å®Œå…¨è§£è€¦**ï¼šç³»ç»Ÿé—´é›¶ä¾èµ–ï¼Œæ˜“äºæ‰©å±•\r\n-\r\n-**å®é™…ä¼˜åŠ¿åœºæ™¯**ï¼š\r\n-\r\n-```lua\r\n--- åœºæ™¯ï¼šå•†åº—å·¥äººæœ‰ buffï¼Œbuff å½±å“å•†åº—æ•ˆç‡ï¼Œæ•ˆç‡å½±å“æ”¶ç›Š\r\n-\r\n--- Building è®¾è®¡ï¼ˆç¡¬ç¼–ç ï¼Œéœ€è¦æ‰‹åŠ¨ç»´æŠ¤ï¼‰\r\n-function UpdateShopWorker(shopId, worker)\r\n-    local shop = BuildingSystem:Get(shopId)\r\n-    shop.worker = worker\r\n-    \r\n-    -- âŒ éœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰è¿é”ååº”\r\n-    SyncWorkerData(worker)\r\n-    if worker.buffs then\r\n-        for _, buff in ipairs(worker.buffs) do\r\n-            ApplyBuff(worker, buff)\r\n-            UpdateShopEfficiency(shop)  -- æ‰‹åŠ¨è°ƒç”¨\r\n-            UpdateShopIncome(shop)     -- æ‰‹åŠ¨è°ƒç”¨\r\n-        end\r\n-    end\r\n-    \r\n-    -- âš ï¸ é—®é¢˜ï¼šæ¯æ¬¡æ·»åŠ æ–°åŠŸèƒ½ï¼Œéƒ½è¦ä¿®æ”¹è¿™é‡Œ\r\n-    -- âš ï¸ é—®é¢˜ï¼šå®¹æ˜“é—æ¼æŸäº›è¿é”ååº”\r\n-end\r\n-\r\n--- TBBattle æ¡†æ¶ï¼ˆè´£ä»»é“¾ï¼Œè‡ªåŠ¨è§¦å‘ï¼‰\r\n-function UpdateShopWorker(shopId, worker)\r\n-    queue:PushData(EDataHandle.Building.UpdateWorker, {\r\n-        shopId = shopId,\r\n-        worker = worker\r\n-    })\r\n-    queue:ProcessDataHandler()\r\n-    \r\n-    -- âœ… è‡ªåŠ¨è§¦å‘æ‰€æœ‰ Handlerï¼š\r\n-    --   1. UpdateWorker Handler â†’ æ›´æ–°å·¥äºº\r\n-    --   2. Worker.Sync Handler â†’ åŒæ­¥å·¥äººæ•°æ®\r\n-    --   3. Worker.ApplyBuff Handler â†’ åº”ç”¨ buffï¼ˆå¦‚æœé…ç½®äº†ï¼‰\r\n-    --   4. Building.UpdateEfficiency Handler â†’ æ›´æ–°æ•ˆç‡ï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰\r\n-    --   5. Building.UpdateIncome Handler â†’ æ›´æ–°æ”¶ç›Šï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰\r\n-    --   ... æ‰€æœ‰è¿é”ååº”è‡ªåŠ¨å¤„ç†ï¼\r\n-end\r\n-\r\n--- Handler é…ç½®ï¼ˆé…ç½®é©±åŠ¨ï¼Œçµæ´»æ‰©å±•ï¼‰\r\n-handlerMapping[EDataHandle.Building.UpdateWorker] = function(data)\r\n-    -- æ›´æ–°å·¥äºº\r\n-    local shop = BuildingSystem:Get(data.shopId)\r\n-    shop.worker = data.worker\r\n-    \r\n-    -- è‡ªåŠ¨è§¦å‘å·¥äººåŒæ­¥\r\n-    queue:PushData(EDataHandle.Worker.Sync, {worker = data.worker})\r\n-end\r\n-\r\n-handlerMapping[EDataHandle.Worker.Sync] = function(data)\r\n-    -- è‡ªåŠ¨æ£€æŸ¥å¹¶åº”ç”¨ buff\r\n-    if data.worker.buffs then\r\n-        queue:PushData(EDataHandle.Worker.ApplyBuff, {worker = data.worker})\r\n-    end\r\n-end\r\n-\r\n-handlerMapping[EDataHandle.Worker.ApplyBuff] = function(data)\r\n-    -- åº”ç”¨ buff\r\n-    ApplyBuff(data.worker, data.worker.buffs)\r\n-    \r\n-    -- è‡ªåŠ¨è§¦å‘æ•ˆç‡æ›´æ–°\r\n-    queue:PushData(EDataHandle.Building.UpdateEfficiency, {\r\n-        buildingId = data.worker.buildingId\r\n-    })\r\n-end\r\n-\r\n-handlerMapping[EDataHandle.Building.UpdateEfficiency] = function(data)\r\n-    -- æ›´æ–°æ•ˆç‡\r\n-    UpdateEfficiency(data.buildingId)\r\n-    \r\n-    -- è‡ªåŠ¨è§¦å‘æ”¶ç›Šæ›´æ–°\r\n-    queue:PushData(EDataHandle.Building.UpdateIncome, {\r\n-        buildingId = data.buildingId\r\n-    })\r\n-end\r\n-\r\n--- âœ… ä¼˜åŠ¿ï¼šæ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ  Handlerï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç \r\n--- âœ… ä¼˜åŠ¿ï¼šé…ç½®é©±åŠ¨ï¼Œçµæ´»æ‰©å±•\r\n--- âœ… ä¼˜åŠ¿ï¼šè‡ªåŠ¨è§¦å‘æ‰€æœ‰è¿é”ååº”ï¼Œä¸ä¼šé—æ¼\r\n-```\r\n-\r\n-**å…³é”®ä¼˜åŠ¿å¯¹æ¯”**ï¼š\r\n-\r\n-| ç‰¹æ€§ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | ä¼˜åŠ¿æ–¹ |\r\n-|------|-------------|--------------|--------|\r\n-| **è¿é”ååº”** | âŒ æ‰‹åŠ¨ç»´æŠ¤ï¼Œå®¹æ˜“é—æ¼ | âœ… è‡ªåŠ¨è§¦å‘ï¼Œä¸ä¼šé—æ¼ | **TBBattle** |\r\n-| **æ‰©å±•æ€§** | âŒ ä¿®æ”¹ç°æœ‰ä»£ç  | âœ… åªéœ€æ·»åŠ  Handler | **TBBattle** |\r\n-| **çµæ´»æ€§** | âŒ ç¡¬ç¼–ç  | âœ… é…ç½®é©±åŠ¨ | **TBBattle** |\r\n-| **ç»´æŠ¤æˆæœ¬** | âŒ æ¯æ¬¡éƒ½è¦ä¿®æ”¹ | âœ… é…ç½®å³å¯ | **TBBattle** |\r\n-| **ä»£ç è€¦åˆ** | âŒ é«˜åº¦è€¦åˆ | âœ… å®Œå…¨è§£è€¦ | **TBBattle** |\r\n-| **æ€§èƒ½** | âœ… ç›´æ¥è®¿é—®ï¼Œå¿« | âš ï¸ é˜Ÿåˆ—å¤„ç†ï¼Œç¨æ…¢ | **Building** |\r\n-| **ä»£ç ç®€æ´æ€§** | âœ… ç›´æ¥æ˜äº† | âš ï¸ éœ€è¦ç†è§£è´£ä»»é“¾ | **Building** |\r\n-\r\n-### 8.8 æœ€ç»ˆè¯„ä»·ï¼ˆé‡æ–°è¯„ä¼°ï¼‰\r\n-\r\n-| è¯„ä»·ç»´åº¦ | Building è®¾è®¡ | TBBattle æ¡†æ¶ | ä¼˜åŠ¿æ–¹ |\r\n-|---------|-------------|--------------|--------|\r\n-| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­ | **Buildingï¼ˆå¿« 10-50 å€ï¼‰** |\r\n-| **ä»£ç ç®€æ´æ€§** | â­â­â­â­â­ | â­â­â­ | **Building** |\r\n-| **è°ƒè¯•å‹å¥½æ€§** | â­â­â­â­â­ | â­â­ | **Building** |\r\n-| **å­¦ä¹ æˆæœ¬** | â­â­â­â­â­ | â­â­â­ | **Building** |\r\n-| **å¼€å‘æ•ˆç‡ï¼ˆç®€å•åœºæ™¯ï¼‰** | â­â­â­â­â­ | â­â­â­ | **Building** |\r\n-| **æ¶æ„ç†å¿µ** | â­â­â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n-| **ç³»ç»Ÿè§£è€¦** | â­â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n-| **æ‰©å±•æ€§** | â­â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n-| **çµæ´»æ€§ï¼ˆè´£ä»»é“¾ï¼‰** | â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n-| **è‡ªåŠ¨è¿é”ååº”** | â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n-| **å¯ç»´æŠ¤æ€§ï¼ˆå¤æ‚åœºæ™¯ï¼‰** | â­â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n-| **å¼€å‘æ•ˆç‡ï¼ˆå¤æ‚åœºæ™¯ï¼‰** | â­â­â­ | â­â­â­â­â­ | **TBBattle** |\r\n-\r\n-**ç»¼åˆè¯„åˆ†**ï¼š\r\n-- **Building è®¾è®¡**ï¼šâ­â­â­â­ (4/5) - **ç®€å•åœºæ™¯ä¸‹æ€§èƒ½ã€ç®€æ´æ€§é¢†å…ˆ**\r\n-- **TBBattle æ¡†æ¶**ï¼šâ­â­â­â­â­ (5/5) - **å¤æ‚åœºæ™¯ä¸‹çµæ´»æ€§ã€æ‰©å±•æ€§å…¨é¢é¢†å…ˆ**\r\n-\r\n-### 8.9 æœ€ç»ˆç»“è®ºï¼ˆé‡æ–°è¯„ä¼°ï¼‰\r\n-\r\n-#### Building è®¾è®¡çš„ä¼˜åŠ¿ï¼ˆç®€å•åœºæ™¯ï¼‰\r\n-\r\n-**æ€§èƒ½ä¼˜åŠ¿**ï¼š\r\n-1. âœ… **å¿« 10-50 å€**ï¼šç›´æ¥è®¿é—® vs é˜Ÿåˆ—å¤„ç†\r\n-2. âœ… **é›¶å†…å­˜å¼€é”€**ï¼šæ— é¢å¤–å¯¹è±¡åˆ›å»º\r\n-3. âœ… **é›¶ GC å‹åŠ›**ï¼šæ— ä¸´æ—¶å¯¹è±¡éœ€è¦å›æ”¶\r\n-4. âœ… **O(1) å¤æ‚åº¦**ï¼šç®€å•ç›´æ¥çš„æ“ä½œ\r\n-\r\n-**å…¶ä»–ä¼˜åŠ¿**ï¼š\r\n-1. âœ… **ä»£ç æ›´ç®€æ´**ï¼šç›´æ¥è®¿é—®ï¼Œä¸€ç›®äº†ç„¶\r\n-2. âœ… **è°ƒè¯•æ›´å®¹æ˜“**ï¼šé—®é¢˜å®šä½å¿«ï¼Œä¿®æ”¹æ–¹ä¾¿\r\n-3. âœ… **å­¦ä¹ æˆæœ¬ä½**ï¼šæ–°äººä¸Šæ‰‹å¿«ï¼Œå›¢é˜Ÿåä½œå®¹æ˜“\r\n-4. âœ… **å¼€å‘æ•ˆç‡é«˜ï¼ˆç®€å•åœºæ™¯ï¼‰**ï¼šæ·»åŠ ç®€å•åŠŸèƒ½å¿«\r\n-\r\n-#### TBBattle æ¡†æ¶çš„ä¼˜åŠ¿ï¼ˆå¤æ‚åœºæ™¯ï¼‰\r\n-\r\n-**æ ¸å¿ƒä¼˜åŠ¿ - è´£ä»»é“¾ä¸è‡ªåŠ¨è¿é”ååº”**ï¼š\r\n-1. âœ… **è‡ªåŠ¨è¿é”ååº”**ï¼šæ•°æ®å˜åŒ–è‡ªåŠ¨è§¦å‘æ‰€æœ‰ç›¸å…³å¤„ç†\r\n-2. âœ… **é…ç½®é©±åŠ¨**ï¼šæ–°å¢åŠŸèƒ½åªéœ€é…ç½® Handlerï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç \r\n-3. âœ… **å®Œå…¨è§£è€¦**ï¼šç³»ç»Ÿé—´é›¶ä¾èµ–ï¼Œæ˜“äºæ‰©å±•\r\n-4. âœ… **ä¸ä¼šé—æ¼**ï¼šæ‰€æœ‰è¿é”ååº”è‡ªåŠ¨å¤„ç†ï¼Œä¸ä¼šé—æ¼ä»»ä½•æ­¥éª¤\r\n-\r\n-**å®é™…åœºæ™¯ä¼˜åŠ¿**ï¼š\r\n-```lua\r\n--- åœºæ™¯ï¼šå•†åº— â†’ å·¥äºº â†’ buff â†’ æ•ˆç‡ â†’ æ”¶ç›Š â†’ å…¶ä»–ç³»ç»Ÿ\r\n--- Building è®¾è®¡ï¼šéœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ‰€æœ‰æ­¥éª¤ï¼Œå®¹æ˜“é—æ¼\r\n--- TBBattle æ¡†æ¶ï¼šè‡ªåŠ¨è§¦å‘æ‰€æœ‰è¿é”ååº”ï¼Œä¸ä¼šé—æ¼\r\n-```\r\n-\r\n-#### é€‚ç”¨åœºæ™¯é‡æ–°åˆ’åˆ†\r\n-\r\n-**Building è®¾è®¡é€‚åˆ**ï¼š\r\n-- âœ… **ç®€å•ç‹¬ç«‹ç³»ç»Ÿ**ï¼šæ•°æ®æµç®€å•ï¼Œæ— å¤æ‚è¿é”ååº”\r\n-- âœ… **æ€§èƒ½æ•æ„Ÿåœºæ™¯**ï¼šéœ€è¦æè‡´æ€§èƒ½ï¼Œç›´æ¥è®¿é—®\r\n-- âœ… **å¿«é€ŸåŸå‹å¼€å‘**ï¼šéœ€è¦å¿«é€ŸéªŒè¯æƒ³æ³•\r\n-- âœ… **å›¢é˜Ÿè§„æ¨¡å°**ï¼š1-2 äººï¼Œä»£ç ç®€å•ç›´æ¥\r\n-\r\n-**TBBattle æ¡†æ¶é€‚åˆ**ï¼š\r\n-- âœ… **å¤æ‚ç³»ç»Ÿäº¤äº’**ï¼šå¤šä¸ªç³»ç»Ÿéœ€è¦äº¤äº’ï¼Œæœ‰è¿é”ååº”\r\n-- âœ… **é¢‘ç¹æ‰©å±•**ï¼šéœ€è¦é¢‘ç¹æ·»åŠ æ–°åŠŸèƒ½ï¼Œé…ç½®é©±åŠ¨\r\n-- âœ… **é•¿æœŸç»´æŠ¤**ï¼šéœ€è¦é•¿æœŸç»´æŠ¤ï¼Œé¿å…æ‰‹åŠ¨ç»´æŠ¤é—æ¼\r\n-- âœ… **å›¢é˜Ÿåä½œ**ï¼šå¤šäººåä½œï¼Œéœ€è¦ç»Ÿä¸€æ¶æ„\r\n-\r\n-#### æœ€ç»ˆå»ºè®®\r\n-\r\n-**å…³é”®åˆ¤æ–­æ ‡å‡†**ï¼š\r\n-\r\n-1. **æ˜¯å¦æœ‰å¤æ‚çš„è¿é”ååº”ï¼Ÿ**\r\n-   - âŒ æ— ï¼šBuilding è®¾è®¡æ›´åˆé€‚ï¼ˆç®€å•ç›´æ¥ï¼‰\r\n-   - âœ… æœ‰ï¼šTBBattle æ¡†æ¶æ›´åˆé€‚ï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰\r\n-\r\n-2. **æ˜¯å¦éœ€è¦é¢‘ç¹æ‰©å±•ï¼Ÿ**\r\n-   - âŒ å¦ï¼šBuilding è®¾è®¡æ›´åˆé€‚ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰\r\n-   - âœ… æ˜¯ï¼šTBBattle æ¡†æ¶æ›´åˆé€‚ï¼ˆé…ç½®é©±åŠ¨ï¼‰\r\n-\r\n-3. **ç³»ç»Ÿæ˜¯å¦ç‹¬ç«‹ï¼Ÿ**\r\n-   - âœ… æ˜¯ï¼šBuilding è®¾è®¡æ›´åˆé€‚ï¼ˆç®€å•ç›´æ¥ï¼‰\r\n-   - âŒ å¦ï¼šTBBattle æ¡†æ¶æ›´åˆé€‚ï¼ˆè§£è€¦è®¾è®¡ï¼‰\r\n-\r\n-**å¯¹äº Building ç³»ç»Ÿçš„å»ºè®®**ï¼š\r\n-\r\n-å¦‚æœ Building ç³»ç»Ÿï¼š\r\n-- âœ… **æœ‰å·¥äººã€buffã€æ•ˆç‡ç­‰è¿é”ååº”** â†’ **æ¨è TBBattle æ¡†æ¶**\r\n-  - è‡ªåŠ¨è§¦å‘æ‰€æœ‰è¿é”ååº”\r\n-  - ä¸ä¼šé—æ¼ä»»ä½•æ­¥éª¤\r\n-  - æ–°å¢åŠŸèƒ½åªéœ€é…ç½®\r\n-\r\n-- âœ… **åªæ˜¯ç®€å•çš„æ•°æ®å­˜å‚¨** â†’ **æ¨è Building è®¾è®¡**\r\n-  - æ€§èƒ½æ›´å¥½\r\n-  - ä»£ç æ›´ç®€æ´\r\n-  - å¼€å‘æ•ˆç‡æ›´é«˜\r\n-\r\n-**æ··åˆæ–¹æ¡ˆ**ï¼š\r\n-- ğŸ¯ **æ ¸å¿ƒç³»ç»Ÿï¼ˆæœ‰è¿é”ååº”ï¼‰**ï¼šä½¿ç”¨ TBBattle æ¡†æ¶\r\n-- ğŸ¯ **ç®€å•ç³»ç»Ÿï¼ˆæ— è¿é”ååº”ï¼‰**ï¼šä½¿ç”¨ Building è®¾è®¡\r\n-- ğŸ¯ **æ€§èƒ½å…³é”®è·¯å¾„**ï¼šåœ¨ TBBattle åŸºç¡€ä¸Šåšæ€§èƒ½ä¼˜åŒ–\r\n-\r\n-**æ€»ç»“**ï¼š\r\n-> **å¦‚æœ Building ç³»ç»Ÿæœ‰å¤æ‚çš„è¿é”ååº”ï¼ˆå·¥äººã€buffã€æ•ˆç‡ç­‰ï¼‰ï¼ŒTBBattle æ¡†æ¶çš„è´£ä»»é“¾å’Œè‡ªåŠ¨è§¦å‘æœºåˆ¶æ˜¯å·¨å¤§ä¼˜åŠ¿ï¼** \r\n-> \r\n-> **æ ¸å¿ƒä¼˜åŠ¿**ï¼š\r\n-> 1. âœ… **å†…éƒ¨æœºåˆ¶å¤©ç„¶æ”¯æŒ**ï¼šæ— éœ€æ‰‹åŠ¨ç»´æŠ¤é“¾å¼è°ƒç”¨\r\n-> 2. âœ… **é“¾å†é•¿ä¹Ÿä¸æ€•**ï¼šè‡ªåŠ¨å¤„ç†ï¼Œä¸ä¼šé—æ¼\r\n-> 3. âœ… **bug è®°å½•ä¸ä¼šå¢åŠ **ï¼šä¸ä¼šå› ä¸ºé—æ¼è€Œå‡ºç° bug\r\n-> 4. âœ… **å¤–éƒ¨ç³»ç»Ÿç»Ÿä¸€æ¥å£**ï¼šDataHandleQueue ç»Ÿä¸€æ¥å£ï¼Œå¤–éƒ¨ç³»ç»Ÿä¹Ÿäº«å—è‡ªåŠ¨è¿é”ååº”\r\n-> \r\n-> **ä¸è¦ä¸ºäº†æ€§èƒ½è€Œç‰ºç‰²çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œé€‚åˆçš„æ‰æ˜¯æœ€å¥½çš„ï¼**\r\n"
                }
            ],
            "date": 1764145299476,
            "name": "Commit-0",
            "content": "# Building ä»£ç ä¼˜åŒ–\r\n\r\n## 1. æ•°æ®å±‚çº§è°ƒæ•´\r\n\r\n### 1.1 çˆ¶ç±» Player è°ƒæ•´\r\n\r\n- **å½“å‰çŠ¶æ€**ï¼šä½¿ç”¨ `single`\r\n- **è°ƒæ•´æ–¹æ¡ˆ**ï¼šæ”¹ä¸ºä½¿ç”¨ `G`\r\n\r\n### 1.2 G.building æ•°æ®ç»“æ„\r\n\r\n```lua\r\nG.building = {\r\n    SData = {\r\n        -- Pmall ç­‰æœåŠ¡å™¨æ•°æ®\r\n    },\r\n    CData = {\r\n        floor = {\r\n            -- å•†åº—è®¾å¤‡ç­‰å®¢æˆ·ç«¯æ•°æ®\r\n        }\r\n    },\r\n    -- ... å…¶ä»–æ•°æ®\r\n    -- Object\r\n    -- SData ?? component\r\n}\r\n```\r\n\r\n### 1.3 G.me ç›¸å…³\r\n\r\n- **è·¯å¾„**ï¼š`G.me.Buildings`\r\n- **åŸåˆ™**ï¼š`G.me` ä¸è¦å­˜åœ¨ System\r\n- **System ç®¡ç†**ï¼š\r\n  - `BuildSystem`\r\n  - `GameState`\r\n  - `me.building` ä½ æ‹¥æœ‰çš„æ•°é‡ï¼Œä¾‹å¦‚ï¼š1000\r\n\r\n### 1.4 G.other ç›¸å…³\r\n\r\n```lua\r\nG.other[1001]  -- Player\r\n```\r\n\r\n---\r\n\r\n## 2. Data å±‚çº§\r\n\r\n### 2.1 Program Language ä¸­çš„ Data\r\n\r\n- **Data decl**ï¼ˆæ•°æ®å£°æ˜ï¼‰\r\n- **Data Type**ï¼ˆæ•°æ®ç±»å‹ï¼‰\r\n- **Data inst**ï¼ˆæ•°æ®å®ä¾‹ï¼‰\r\n- **Data copy**ï¼ˆæ•°æ®æ‹·è´ï¼‰\r\n\r\n### 2.2 NetData\r\n\r\nç½‘ç»œæ•°æ®ä¼ è¾“ç±»å‹ï¼š\r\n- `string`\r\n- `int`\r\n- `float`\r\n- `class`\r\n\r\n### 2.3 Objï¼ˆå¯¹è±¡ï¼‰\r\n\r\n- **ServerObject**\r\n  - `ObjectPool`\r\n- **Client**\r\n- **dbObj**\r\n\r\n### 2.4 OOP / ESC / Lua\r\n\r\n**ESCï¼ˆEntity-Component-Systemï¼‰æ¶æ„ï¼š**\r\n- **E (Entity)** = `GameObject`\r\n- **C (Component)** = `Building`\r\n- **S (System)** = `BuildingSystem:Set(Building)`\r\n  - ç±»ä¼¼ Mgrï¼ˆç®¡ç†å™¨ï¼‰\r\n\r\n---\r\n\r\n## 3. è¯·æ±‚å“åº”å¤„ç†\r\n\r\n### 3.1 req(resp) v1\r\n\r\n```lua\r\n-- req(resp) v1\r\nlocal building = resp.building\r\n\r\nbuilding.cfg = CfgData.building[building.id]\r\n\r\nlocal prefab = ResNode:Inst()\r\nprefab.AddTable(building)\r\n```\r\n\r\n### 3.2 req(resp) v2\r\n\r\n```lua\r\n-- req(resp) v2\r\n-- resp.building\r\nlocal building = Building:New()  -- ??\r\n\r\nbuilding.serverObject = resp.building\r\nbuilding.cfg = CfgData.building[building.id]\r\n\r\nGameObject go = new GameObject\r\n\r\nlocal prefab = ResNode:Inst()\r\nprefab.AddTable(building)\r\n```\r\n\r\n---\r\n\r\n## 4. ç”Ÿå‘½å‘¨æœŸç®¡ç†\r\n\r\n### 4.1 Createï¼ˆåˆ›å»ºï¼‰\r\n\r\n```lua\r\n-- é€šè¿‡ req(resp) åˆ›å»º\r\n```\r\n\r\n### 4.2 Destroyï¼ˆé”€æ¯ï¼‰\r\n\r\n```lua\r\nGameObject.Destroy(building.gameObject)\r\n-- åŸåˆ™ï¼šsame Layer + same life cycle\r\n-- building.gameObjectId\r\n```\r\n\r\n### 4.3 Getï¼ˆè·å–ï¼‰\r\n\r\n```lua\r\nbuildingSystem:Set(building)\r\n-- map[building.dbId] = building\r\n```\r\n\r\n### 4.4 Setï¼ˆè®¾ç½®ï¼‰\r\n\r\n```lua\r\nlocal building = buildingSystem:Get(dbId)\r\n```\r\n\r\n### 4.5 Updateï¼ˆæ›´æ–°ï¼‰\r\n\r\n#### UpdateBuildingAction\r\n\r\n```csharp\r\nclass UpdateBuildingAction : SynAction\r\n{\r\n    long buildingId;\r\n    int level;\r\n    int worker;\r\n}\r\n\r\nExecute()\r\n{\r\n    local building = buildingSystem:Get(updateBuilding.Id)\r\n    building.serverObject.worker = worker\r\n}\r\n```\r\n\r\n#### UpdateBuildingWorkerAction\r\n\r\n```csharp\r\nclass UpdateBuildingWorkerAction : SynAction\r\n{\r\n    long buildingId;\r\n    int worker;\r\n}\r\n\r\nExecute()\r\n{\r\n    local building = buildingSystem:Get(updateBuilding.Id)\r\n    building.serverObject.worker = worker\r\n}\r\n```\r\n\r\n#### UpdateBuildingActionï¼ˆå®Œæ•´å¯¹è±¡æ›´æ–°ï¼‰\r\n\r\n```csharp\r\nclass UpdateBuildingAction : SynAction\r\n{\r\n    Building updateBuilding;\r\n}\r\n\r\nExecute()\r\n{\r\n    local building = buildingSystem:Get(updateBuilding.Id)\r\n    building.serverObject = updateBuilding\r\n}\r\n```\r\n\r\n---\r\n\r\n## 5. BuildingSystem\r\n\r\n**èŒè´£**ï¼šæ•°æ®ç®¡ç†ï¼Œæ‰€æœ‰æ•°æ®ä»è¿™é‡Œè·å–\r\n\r\n```lua\r\nbuildingSystem = {\r\n    -- æ•°æ®ç®¡ç†ï¼Œæ‰€æœ‰æ•°æ®è¿™é‡Œæ‹¿\r\n}\r\n```\r\n\r\n---\r\n\r\n## 6. UI\r\n\r\n### 6.1 ä¼˜åŒ–æ–¹å‘\r\n\r\n- **é€šç”¨æ¨¡æ¿æŠ½å–**ï¼šå¯èƒ½éœ€è¦æŠ½ä¸€äº›é€šç”¨æ¨¡æ¿\r\n- **ç»Ÿä¸€ç®¡ç†**ï¼šå°† UI ç»Ÿä¸€ä»¥ GameObject ä¸ºå•ä½æ‰¿è½½åŠŸèƒ½\r\n\r\n"
        }
    ]
}