{
    "sourceFile": "游戏编程精粹/3/调度器概念说明.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1765104732137,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1765104732137,
            "name": "Commit-0",
            "content": "# 📅 调度器（Scheduler）概念说明\r\n\r\n## 🎯 核心概念\r\n\r\n**调度器（Scheduler）** 是一个用于**管理和执行延迟任务、定时任务、周期性任务**的系统组件。\r\n\r\n### 简单理解\r\n调度器就像一个\"任务管理器\"，它负责：\r\n- ⏰ **什么时候**执行任务（时间管理）\r\n- 🔄 **如何**执行任务（执行方式）\r\n- 📋 **管理**待执行的任务队列\r\n\r\n---\r\n\r\n## 🔄 调度器 vs 事件系统\r\n\r\n### 事件系统（Event System）\r\n```\r\n事件发生 → 立即通知所有监听者 → 同步执行\r\n```\r\n- **特点**：即时响应，同步执行\r\n- **用途**：处理实时事件（如玩家点击、碰撞检测）\r\n\r\n### 调度器（Scheduler）\r\n```\r\n任务注册 → 等待指定时间 → 延迟执行 → 可能重复执行\r\n```\r\n- **特点**：延迟执行，可定时、可重复\r\n- **用途**：处理需要延迟或定时执行的任务\r\n\r\n---\r\n\r\n## 🏗️ 调度器的核心功能\r\n\r\n### 1. **延迟执行（Delay）**\r\n```\r\n现在注册 → 3秒后执行\r\n```\r\n\r\n### 2. **定时执行（Schedule）**\r\n```\r\n每天12:00执行\r\n每5秒执行一次\r\n```\r\n\r\n### 3. **周期性执行（Repeat）**\r\n```\r\n每帧执行\r\n每100ms执行一次\r\n```\r\n\r\n### 4. **任务管理**\r\n- 添加任务\r\n- 取消任务\r\n- 暂停/恢复任务\r\n- 查询任务状态\r\n\r\n---\r\n\r\n## 📊 调度器工作流程图\r\n\r\n```\r\n┌─────────────────────────────────────────────────────────┐\r\n│                    调度器系统架构                          │\r\n└─────────────────────────────────────────────────────────┘\r\n\r\n                    ┌──────────────┐\r\n                    │  任务注册     │\r\n                    │ (Register)   │\r\n                    └──────┬───────┘\r\n                           │\r\n                           ▼\r\n        ┌──────────────────────────────────┐\r\n        │        任务队列管理器              │\r\n        │  ┌──────────────────────────┐   │\r\n        │  │  优先级队列                │   │\r\n        │  │  - 按时间排序              │   │\r\n        │  │  - 按优先级排序            │   │\r\n        │  └──────────────────────────┘   │\r\n        └──────────────┬───────────────────┘\r\n                       │\r\n                       ▼\r\n        ┌──────────────────────────────┐\r\n        │      时间管理器               │\r\n        │  - 游戏时间                  │\r\n        │  - 真实时间                  │\r\n        │  - 时间缩放                  │\r\n        └──────────────┬───────────────┘\r\n                       │\r\n                       ▼\r\n        ┌──────────────────────────────┐\r\n        │      任务执行器              │\r\n        │  - 检查到期任务              │\r\n        │  - 执行任务                  │\r\n        │  - 处理重复任务              │\r\n        └──────────────┬───────────────┘\r\n                       │\r\n                       ▼\r\n        ┌──────────────────────────────┐\r\n        │      任务生命周期管理         │\r\n        │  - 执行完成                  │\r\n        │  - 取消任务                  │\r\n        │  - 错误处理                  │\r\n        └──────────────────────────────┘\r\n```\r\n\r\n---\r\n\r\n## 🎮 游戏开发中的应用场景\r\n\r\n### 场景1：技能冷却\r\n```lua\r\n-- 玩家使用技能后，10秒后才能再次使用\r\nscheduler:Schedule(10.0, function()\r\n    skill:ResetCooldown()\r\nend)\r\n```\r\n\r\n### 场景2：延迟伤害\r\n```lua\r\n-- 毒药效果：每秒造成10点伤害，持续5秒\r\nfor i = 1, 5 do\r\n    scheduler:Schedule(i, function()\r\n        player:TakeDamage(10)\r\n    end)\r\nend\r\n```\r\n\r\n### 场景3：定时刷新\r\n```lua\r\n-- 每30秒刷新一次商店物品\r\nscheduler:Repeat(30.0, function()\r\n    shop:RefreshItems()\r\nend)\r\n```\r\n\r\n### 场景4：延迟UI更新\r\n```lua\r\n-- 延迟0.1秒后更新UI，避免频繁更新\r\nscheduler:Schedule(0.1, function()\r\n    ui:Update()\r\nend)\r\n```\r\n\r\n### 场景5：动画序列\r\n```lua\r\n-- 播放动画序列\r\nscheduler:Schedule(0.0, function() playAnimation(\"fadeIn\") end)\r\nscheduler:Schedule(1.0, function() playAnimation(\"move\") end)\r\nscheduler:Schedule(2.0, function() playAnimation(\"fadeOut\") end)\r\n```\r\n\r\n---\r\n\r\n## 🔧 调度器的关键设计点\r\n\r\n### 1. **时间管理**\r\n- 游戏时间 vs 真实时间\r\n- 时间缩放（暂停、加速）\r\n- 时间精度\r\n\r\n### 2. **任务优先级**\r\n- 高优先级任务优先执行\r\n- 相同时间的任务按优先级排序\r\n\r\n### 3. **性能优化**\r\n- 使用堆（Heap）管理任务队列\r\n- 批量处理到期任务\r\n- 避免频繁的队列操作\r\n\r\n### 4. **任务取消**\r\n- 支持任务ID管理\r\n- 支持条件取消\r\n- 支持批量取消\r\n\r\n---\r\n\r\n## 📋 调度器 vs 其他模式对比\r\n\r\n| 特性 | 调度器 | 事件系统 | 协程 |\r\n|------|--------|----------|------|\r\n| **执行时机** | 延迟/定时 | 立即 | 可暂停/恢复 |\r\n| **时间控制** | ✅ 精确 | ❌ 无 | ⚠️ 有限 |\r\n| **重复执行** | ✅ 支持 | ❌ 不支持 | ⚠️ 手动实现 |\r\n| **任务管理** | ✅ 完整 | ⚠️ 简单 | ⚠️ 简单 |\r\n| **性能** | ✅ 高效 | ✅ 高效 | ⚠️ 中等 |\r\n\r\n---\r\n\r\n## 🎯 调度器的实现思路\r\n\r\n### 核心数据结构\r\n```\r\n任务 = {\r\n    id: 唯一标识\r\n    executeTime: 执行时间\r\n    priority: 优先级\r\n    callback: 回调函数\r\n    repeat: 是否重复\r\n    interval: 重复间隔\r\n    cancelled: 是否已取消\r\n}\r\n```\r\n\r\n### 核心算法\r\n1. **添加任务**：插入到优先级队列（按时间+优先级排序）\r\n2. **更新调度器**：每帧检查队列，执行到期任务\r\n3. **执行任务**：调用回调函数，处理重复任务\r\n4. **清理任务**：移除已完成或已取消的任务\r\n\r\n---\r\n\r\n## 💡 调度器与事件系统的协同\r\n\r\n在实际项目中，调度器和事件系统通常**协同工作**：\r\n\r\n```\r\n┌─────────────────────────────────────────┐\r\n│          游戏系统架构                     │\r\n└─────────────────────────────────────────┘\r\n\r\n事件系统（即时响应）\r\n    │\r\n    ├─→ 玩家点击按钮 → 立即触发UI事件\r\n    ├─→ 碰撞检测 → 立即触发碰撞事件\r\n    └─→ 状态变化 → 立即通知观察者\r\n\r\n调度器（延迟/定时）\r\n    │\r\n    ├─→ 3秒后执行技能冷却\r\n    ├─→ 每5秒刷新一次数据\r\n    └─→ 延迟0.1秒更新UI\r\n```\r\n\r\n**最佳实践**：\r\n- **事件系统**：处理需要立即响应的交互\r\n- **调度器**：处理需要延迟或定时执行的任务\r\n\r\n---\r\n\r\n## 🚀 学习价值\r\n\r\n学习调度器的设计可以帮助你：\r\n1. ✅ 优化游戏中的时间管理\r\n2. ✅ 实现复杂的任务序列\r\n3. ✅ 提高代码的可维护性\r\n4. ✅ 理解时间相关的设计模式\r\n\r\n---\r\n\r\n## 📚 相关设计模式\r\n\r\n调度器通常结合以下模式使用：\r\n- **命令模式**：将任务封装成命令对象\r\n- **策略模式**：不同的任务执行策略\r\n- **观察者模式**：任务执行完成的通知\r\n- **对象池模式**：复用任务对象，减少GC\r\n\r\n---\r\n\r\n*调度器是游戏开发中非常重要的基础设施，掌握它可以让你的游戏逻辑更加清晰和高效！*\r\n\r\n"
        }
    ]
}