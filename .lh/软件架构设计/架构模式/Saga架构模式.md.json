{
    "sourceFile": "è½¯ä»¶æ¶æ„è®¾è®¡/æ¶æ„æ¨¡å¼/Sagaæ¶æ„æ¨¡å¼.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1767097468620,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1767097468620,
            "name": "Commit-0",
            "content": "# Sagaæ¶æ„æ¨¡å¼ï¼ˆSaga Architecture Patternï¼‰\r\n\r\n## ç›®å½•\r\n\r\n- [æ¦‚è¿°](#æ¦‚è¿°)\r\n- [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)\r\n- [æ¶æ„ç»“æ„](#æ¶æ„ç»“æ„)\r\n- [è®¾è®¡è§„åˆ™](#è®¾è®¡è§„åˆ™)\r\n- [ä¼˜ç¼ºç‚¹åˆ†æ](#ä¼˜ç¼ºç‚¹åˆ†æ)\r\n- [å®è·µæŒ‡å—](#å®è·µæŒ‡å—)\r\n- [ä¸å…¶ä»–æ¶æ„æ¨¡å¼çš„å…³ç³»](#ä¸å…¶ä»–æ¶æ„æ¨¡å¼çš„å…³ç³»)\r\n- [åº”ç”¨åœºæ™¯](#åº”ç”¨åœºæ™¯)\r\n- [å®é™…æ¡ˆä¾‹](#å®é™…æ¡ˆä¾‹)\r\n- [è®¾è®¡åŸåˆ™](#è®¾è®¡åŸåˆ™)\r\n- [æ€»ç»“](#æ€»ç»“)\r\n\r\n---\r\n\r\n## æ¦‚è¿°\r\n\r\n**Sagaæ¶æ„æ¨¡å¼ï¼ˆSaga Architecture Patternï¼‰**æ˜¯ä¸€ç§ç”¨äºç®¡ç†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é•¿æ—¶é—´è¿è¡Œäº‹åŠ¡çš„æ¶æ„æ¨¡å¼ã€‚å®ƒå°†ä¸€ä¸ªé•¿äº‹åŠ¡åˆ†è§£ä¸ºä¸€ç³»åˆ—å¯ä»¥ç‹¬ç«‹æ‰§è¡Œå’Œè¡¥å¿çš„æœ¬åœ°äº‹åŠ¡ï¼Œé€šè¿‡è¡¥å¿æœºåˆ¶ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚\r\n\r\n### ä»€ä¹ˆæ˜¯Sagaï¼Ÿ\r\n\r\nSagaå°†é•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªæœ¬åœ°äº‹åŠ¡ï¼š\r\n\r\n```mermaid\r\ngraph LR\r\n    subgraph \"ä¼ ç»Ÿåˆ†å¸ƒå¼äº‹åŠ¡\"\r\n        LongTransaction[é•¿äº‹åŠ¡<br/>Long Transaction<br/>2PC/3PC]\r\n        Lock[é”å®šèµ„æº<br/>Lock Resources]\r\n        Rollback[å…¨éƒ¨å›æ»š<br/>Rollback All]\r\n    end\r\n    \r\n    subgraph \"Sagaæ¨¡å¼\"\r\n        Step1[æ­¥éª¤1<br/>Step 1<br/>æœ¬åœ°äº‹åŠ¡]\r\n        Step2[æ­¥éª¤2<br/>Step 2<br/>æœ¬åœ°äº‹åŠ¡]\r\n        Step3[æ­¥éª¤3<br/>Step 3<br/>æœ¬åœ°äº‹åŠ¡]\r\n        Compensate[è¡¥å¿æœºåˆ¶<br/>Compensation]\r\n        \r\n        Step1 --> Step2\r\n        Step2 --> Step3\r\n        Step3 -.å¤±è´¥.-> Compensate\r\n    end\r\n    \r\n    style LongTransaction fill:#ffcccb\r\n    style Step1 fill:#ffebee\r\n    style Compensate fill:#fff4e1\r\n```\r\n\r\n**æ ¸å¿ƒåŸåˆ™**ï¼š\r\n- **åˆ†è§£äº‹åŠ¡**ï¼šå°†é•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªæœ¬åœ°äº‹åŠ¡\r\n- **é¡ºåºæ‰§è¡Œ**ï¼šæŒ‰é¡ºåºæ‰§è¡Œå„ä¸ªæ­¥éª¤\r\n- **è¡¥å¿æœºåˆ¶**ï¼šå¤±è´¥æ—¶æ‰§è¡Œè¡¥å¿æ“ä½œ\r\n- **æœ€ç»ˆä¸€è‡´æ€§**ï¼šä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œè€Œéå¼ºä¸€è‡´æ€§\r\n\r\n### ä¸ºä»€ä¹ˆéœ€è¦Sagaï¼Ÿ\r\n\r\nSagaè§£å†³äº†ä»¥ä¸‹é—®é¢˜ï¼š\r\n- **é•¿äº‹åŠ¡é—®é¢˜**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿä¸­é•¿äº‹åŠ¡éš¾ä»¥ç®¡ç†\r\n- **èµ„æºé”å®š**ï¼šé¿å…é•¿æ—¶é—´é”å®šèµ„æº\r\n- **æ€§èƒ½é—®é¢˜**ï¼šæé«˜ç³»ç»Ÿæ€§èƒ½å’Œå¯ç”¨æ€§\r\n- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒå¾®æœåŠ¡æ¶æ„\r\n- **å®¹é”™æ€§**ï¼šé€šè¿‡è¡¥å¿æœºåˆ¶å¤„ç†å¤±è´¥\r\n\r\n---\r\n\r\n## æ ¸å¿ƒæ¦‚å¿µ\r\n\r\n### æ ¸å¿ƒæ€æƒ³\r\n\r\nSagaçš„æ ¸å¿ƒæ€æƒ³æ˜¯**è¡¥å¿äº‹åŠ¡ï¼ˆCompensating Transactionsï¼‰**ï¼š\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"Sagaæ ¸å¿ƒæ€æƒ³\"\r\n        Normal[æ­£å¸¸æµç¨‹<br/>Normal Flow<br/>é¡ºåºæ‰§è¡Œ]\r\n        Failure[å¤±è´¥å¤„ç†<br/>Failure Handling<br/>è¡¥å¿æ“ä½œ]\r\n        Compensation[è¡¥å¿æœºåˆ¶<br/>Compensation<br/>æ’¤é”€å·²æ‰§è¡Œçš„æ“ä½œ]\r\n        Consistency[æœ€ç»ˆä¸€è‡´æ€§<br/>Eventual Consistency]\r\n    end\r\n    \r\n    Normal --> Failure\r\n    Failure --> Compensation\r\n    Compensation --> Consistency\r\n    \r\n    style Compensation fill:#ffebee\r\n```\r\n\r\n**å…³é”®åŸåˆ™**ï¼š\r\n1. **åˆ†è§£äº‹åŠ¡**ï¼šå°†é•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªæœ¬åœ°äº‹åŠ¡\r\n2. **é¡ºåºæ‰§è¡Œ**ï¼šæŒ‰é¡ºåºæ‰§è¡Œå„ä¸ªæ­¥éª¤\r\n3. **è¡¥å¿æœºåˆ¶**ï¼šå¤±è´¥æ—¶æ‰§è¡Œè¡¥å¿æ“ä½œæ’¤é”€å·²æ‰§è¡Œçš„æ“ä½œ\r\n4. **æœ€ç»ˆä¸€è‡´æ€§**ï¼šä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œè€Œéå¼ºä¸€è‡´æ€§\r\n\r\n### åŸºæœ¬ç‰¹å¾\r\n\r\n- **æœ¬åœ°äº‹åŠ¡**ï¼šæ¯ä¸ªæ­¥éª¤æ˜¯ç‹¬ç«‹çš„æœ¬åœ°äº‹åŠ¡\r\n- **é¡ºåºæ‰§è¡Œ**ï¼šæŒ‰é¡ºåºæ‰§è¡Œå„ä¸ªæ­¥éª¤\r\n- **è¡¥å¿æœºåˆ¶**ï¼šå¤±è´¥æ—¶æ‰§è¡Œè¡¥å¿æ“ä½œ\r\n- **æœ€ç»ˆä¸€è‡´æ€§**ï¼šä¿è¯æœ€ç»ˆä¸€è‡´æ€§\r\n- **æ— é”è®¾è®¡**ï¼šä¸éœ€è¦é•¿æ—¶é—´é”å®šèµ„æº\r\n\r\n---\r\n\r\n## æ¶æ„ç»“æ„\r\n\r\n### Sagaå®Œæ•´æ¶æ„\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"Sagaç¼–æ’å™¨ï¼ˆSaga Orchestratorï¼‰\"\r\n        Orchestrator[Sagaç¼–æ’å™¨<br/>Saga Orchestrator]\r\n        State[çŠ¶æ€ç®¡ç†<br/>State Management]\r\n        Compensation[è¡¥å¿é€»è¾‘<br/>Compensation Logic]\r\n    end\r\n    \r\n    subgraph \"æœ¬åœ°äº‹åŠ¡ï¼ˆLocal Transactionsï¼‰\"\r\n        Step1[æ­¥éª¤1<br/>Step 1<br/>åˆ›å»ºè®¢å•]\r\n        Step2[æ­¥éª¤2<br/>Step 2<br/>æ‰£å‡åº“å­˜]\r\n        Step3[æ­¥éª¤3<br/>Step 3<br/>å¤„ç†æ”¯ä»˜]\r\n        Step4[æ­¥éª¤4<br/>Step 4<br/>å‘é€é€šçŸ¥]\r\n    end\r\n    \r\n    subgraph \"è¡¥å¿æ“ä½œï¼ˆCompensating Actionsï¼‰\"\r\n        Compensate1[è¡¥å¿1<br/>Compensate 1<br/>å–æ¶ˆè®¢å•]\r\n        Compensate2[è¡¥å¿2<br/>Compensate 2<br/>æ¢å¤åº“å­˜]\r\n        Compensate3[è¡¥å¿3<br/>Compensate 3<br/>é€€æ¬¾]\r\n    end\r\n    \r\n    subgraph \"æœåŠ¡ï¼ˆServicesï¼‰\"\r\n        OrderService[è®¢å•æœåŠ¡<br/>Order Service]\r\n        InventoryService[åº“å­˜æœåŠ¡<br/>Inventory Service]\r\n        PaymentService[æ”¯ä»˜æœåŠ¡<br/>Payment Service]\r\n        NotificationService[é€šçŸ¥æœåŠ¡<br/>Notification Service]\r\n    end\r\n    \r\n    Orchestrator --> State\r\n    Orchestrator --> Compensation\r\n    \r\n    Orchestrator --> Step1\r\n    Step1 --> Step2\r\n    Step2 --> Step3\r\n    Step3 --> Step4\r\n    \r\n    Step1 --> OrderService\r\n    Step2 --> InventoryService\r\n    Step3 --> PaymentService\r\n    Step4 --> NotificationService\r\n    \r\n    Compensation --> Compensate1\r\n    Compensation --> Compensate2\r\n    Compensation --> Compensate3\r\n    \r\n    Compensate1 --> OrderService\r\n    Compensate2 --> InventoryService\r\n    Compensate3 --> PaymentService\r\n    \r\n    style Orchestrator fill:#ffebee\r\n    style Step1 fill:#fff4e1\r\n    style Compensate1 fill:#e1f5ff\r\n```\r\n\r\n### æ ¸å¿ƒç»„ä»¶è¯¦è§£\r\n\r\n#### 1. Sagaç¼–æ’å™¨ï¼ˆSaga Orchestratorï¼‰\r\n\r\n**å®šä¹‰**ï¼šåè°ƒSagaæ‰§è¡Œçš„ç»„ä»¶\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"Sagaç¼–æ’å™¨ç‰¹å¾\"\r\n        Coordination[åè°ƒæ‰§è¡Œ<br/>Coordination]\r\n        StateManagement[çŠ¶æ€ç®¡ç†<br/>State Management]\r\n        Compensation[è¡¥å¿é€»è¾‘<br/>Compensation Logic]\r\n        ErrorHandling[é”™è¯¯å¤„ç†<br/>Error Handling]\r\n    end\r\n    \r\n    style Coordination fill:#ffebee\r\n```\r\n\r\n**èŒè´£**ï¼š\r\n- åè°ƒå„ä¸ªæ­¥éª¤çš„æ‰§è¡Œ\r\n- ç®¡ç†SagaçŠ¶æ€\r\n- å¤„ç†å¤±è´¥å’Œè¡¥å¿\r\n- ä¿è¯æ‰§è¡Œé¡ºåº\r\n\r\n**ç‰¹ç‚¹**ï¼š\r\n- é›†ä¸­å¼åè°ƒ\r\n- çŠ¶æ€ç®¡ç†\r\n- è¡¥å¿é€»è¾‘\r\n- é”™è¯¯å¤„ç†\r\n\r\n#### 2. æœ¬åœ°äº‹åŠ¡ï¼ˆLocal Transactionï¼‰\r\n\r\n**å®šä¹‰**ï¼šSagaä¸­çš„ä¸€ä¸ªæ­¥éª¤ï¼Œæ˜¯ç‹¬ç«‹çš„æœ¬åœ°äº‹åŠ¡\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"æœ¬åœ°äº‹åŠ¡ç‰¹å¾\"\r\n        Independent[ç‹¬ç«‹<br/>Independent]\r\n        Atomic[åŸå­æ€§<br/>Atomic]\r\n        Compensatable[å¯è¡¥å¿<br/>Compensatable]\r\n        Idempotent[å¹‚ç­‰æ€§<br/>Idempotent]\r\n    end\r\n    \r\n    style Independent fill:#fff4e1\r\n```\r\n\r\n**ç‰¹ç‚¹**ï¼š\r\n- ç‹¬ç«‹çš„æœ¬åœ°äº‹åŠ¡\r\n- åŸå­æ€§ä¿è¯\r\n- å¯ä»¥è¡¥å¿\r\n- åº”è¯¥æ”¯æŒå¹‚ç­‰æ€§\r\n\r\n**ç¤ºä¾‹**ï¼š\r\n- åˆ›å»ºè®¢å•ï¼ˆCreateOrderï¼‰\r\n- æ‰£å‡åº“å­˜ï¼ˆReduceInventoryï¼‰\r\n- å¤„ç†æ”¯ä»˜ï¼ˆProcessPaymentï¼‰\r\n\r\n#### 3. è¡¥å¿æ“ä½œï¼ˆCompensating Actionï¼‰\r\n\r\n**å®šä¹‰**ï¼šæ’¤é”€å·²æ‰§è¡Œæ“ä½œçš„è¡¥å¿æ“ä½œ\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"è¡¥å¿æ“ä½œç‰¹å¾\"\r\n        Undo[æ’¤é”€æ“ä½œ<br/>Undo Operation]\r\n        Idempotent[å¹‚ç­‰æ€§<br/>Idempotent]\r\n        Reversible[å¯é€†<br/>Reversible]\r\n        Safe[å®‰å…¨<br/>Safe]\r\n    end\r\n    \r\n    style Undo fill:#e1f5ff\r\n```\r\n\r\n**ç‰¹ç‚¹**ï¼š\r\n- æ’¤é”€å·²æ‰§è¡Œçš„æ“ä½œ\r\n- åº”è¯¥æ”¯æŒå¹‚ç­‰æ€§\r\n- åº”è¯¥æ˜¯å¯é€†çš„\r\n- åº”è¯¥æ˜¯å®‰å…¨çš„\r\n\r\n**ç¤ºä¾‹**ï¼š\r\n- å–æ¶ˆè®¢å•ï¼ˆCancelOrderï¼‰\r\n- æ¢å¤åº“å­˜ï¼ˆRestoreInventoryï¼‰\r\n- é€€æ¬¾ï¼ˆRefundï¼‰\r\n\r\n#### 4. SagaçŠ¶æ€ï¼ˆSaga Stateï¼‰\r\n\r\n**å®šä¹‰**ï¼šSagaæ‰§è¡Œçš„çŠ¶æ€\r\n\r\n```mermaid\r\ngraph LR\r\n    subgraph \"SagaçŠ¶æ€\"\r\n        Started[å·²å¼€å§‹<br/>Started]\r\n        InProgress[è¿›è¡Œä¸­<br/>InProgress]\r\n        Completed[å·²å®Œæˆ<br/>Completed]\r\n        Compensating[è¡¥å¿ä¸­<br/>Compensating]\r\n        Failed[å·²å¤±è´¥<br/>Failed]\r\n        \r\n        Started --> InProgress\r\n        InProgress --> Completed\r\n        InProgress --> Failed\r\n        Failed --> Compensating\r\n        Compensating --> Failed\r\n    end\r\n    \r\n    style Started fill:#fff4e1\r\n    style Completed fill:#90ee90\r\n    style Failed fill:#ffcccb\r\n```\r\n\r\n**çŠ¶æ€è¯´æ˜**ï¼š\r\n- **Started**ï¼šSagaå·²å¼€å§‹\r\n- **InProgress**ï¼šæ­£åœ¨æ‰§è¡Œä¸­\r\n- **Completed**ï¼šæ‰€æœ‰æ­¥éª¤å®Œæˆ\r\n- **Compensating**ï¼šæ­£åœ¨æ‰§è¡Œè¡¥å¿\r\n- **Failed**ï¼šæ‰§è¡Œå¤±è´¥\r\n\r\n---\r\n\r\n## è®¾è®¡è§„åˆ™\r\n\r\n### Sagaè®¾è®¡è§„åˆ™\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"Sagaè®¾è®¡è§„åˆ™\"\r\n        Rule1[æœ¬åœ°äº‹åŠ¡<br/>Local Transactions<br/>æ¯ä¸ªæ­¥éª¤æ˜¯æœ¬åœ°äº‹åŠ¡]\r\n        Rule2[é¡ºåºæ‰§è¡Œ<br/>Sequential Execution<br/>æŒ‰é¡ºåºæ‰§è¡Œ]\r\n        Rule3[è¡¥å¿æœºåˆ¶<br/>Compensation<br/>å¤±è´¥æ—¶æ‰§è¡Œè¡¥å¿]\r\n        Rule4[å¹‚ç­‰æ€§<br/>Idempotency<br/>æ“ä½œåº”è¯¥å¹‚ç­‰]\r\n    end\r\n    \r\n    style Rule1 fill:#ffebee\r\n```\r\n\r\n**è§„åˆ™è¯´æ˜**ï¼š\r\n- âœ… **æœ¬åœ°äº‹åŠ¡**ï¼šæ¯ä¸ªæ­¥éª¤æ˜¯ç‹¬ç«‹çš„æœ¬åœ°äº‹åŠ¡\r\n- âœ… **é¡ºåºæ‰§è¡Œ**ï¼šæŒ‰é¡ºåºæ‰§è¡Œå„ä¸ªæ­¥éª¤\r\n- âœ… **è¡¥å¿æœºåˆ¶**ï¼šå¤±è´¥æ—¶æ‰§è¡Œè¡¥å¿æ“ä½œ\r\n- âœ… **å¹‚ç­‰æ€§**ï¼šæ“ä½œåº”è¯¥æ”¯æŒå¹‚ç­‰æ€§\r\n\r\n### è¡¥å¿è®¾è®¡è§„åˆ™\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"è¡¥å¿è®¾è®¡è§„åˆ™\"\r\n        Rule1[å¯é€†æ“ä½œ<br/>Reversible Operations<br/>è¡¥å¿åº”è¯¥æ˜¯å¯é€†çš„]\r\n        Rule2[å¹‚ç­‰æ€§<br/>Idempotency<br/>è¡¥å¿åº”è¯¥å¹‚ç­‰]\r\n        Rule3[é¡ºåºè¡¥å¿<br/>Reverse Order<br/>æŒ‰ç›¸åé¡ºåºè¡¥å¿]\r\n        Rule4[å®‰å…¨è¡¥å¿<br/>Safe Compensation<br/>è¡¥å¿åº”è¯¥æ˜¯å®‰å…¨çš„]\r\n    end\r\n    \r\n    style Rule1 fill:#ffebee\r\n```\r\n\r\n**è§„åˆ™è¯´æ˜**ï¼š\r\n- âœ… **å¯é€†æ“ä½œ**ï¼šè¡¥å¿æ“ä½œåº”è¯¥èƒ½å¤Ÿæ’¤é”€åŸæ“ä½œ\r\n- âœ… **å¹‚ç­‰æ€§**ï¼šè¡¥å¿æ“ä½œåº”è¯¥æ”¯æŒå¹‚ç­‰æ€§\r\n- âœ… **é¡ºåºè¡¥å¿**ï¼šæŒ‰ç›¸åé¡ºåºæ‰§è¡Œè¡¥å¿\r\n- âœ… **å®‰å…¨è¡¥å¿**ï¼šè¡¥å¿æ“ä½œåº”è¯¥æ˜¯å®‰å…¨çš„\r\n\r\n---\r\n\r\n## ä¼˜ç¼ºç‚¹åˆ†æ\r\n\r\n### ä¼˜ç‚¹\r\n\r\n```mermaid\r\nmindmap\r\n  root((Sagaä¼˜ç‚¹))\r\n    æ€§èƒ½ä¼˜åŒ–\r\n      æ— é•¿æ—¶é—´é”å®š\r\n      æé«˜å¹¶å‘æ€§\r\n      æé«˜å¯ç”¨æ€§\r\n    å¯æ‰©å±•æ€§\r\n      æ”¯æŒå¾®æœåŠ¡\r\n      æœåŠ¡ç‹¬ç«‹\r\n      æ˜“äºæ‰©å±•\r\n    å®¹é”™æ€§\r\n      è¡¥å¿æœºåˆ¶\r\n      éƒ¨åˆ†å¤±è´¥å¤„ç†\r\n      æœ€ç»ˆä¸€è‡´æ€§\r\n    çµæ´»æ€§\r\n      çµæ´»ç¼–æ’\r\n      åŠ¨æ€è°ƒæ•´\r\n      æ˜“äºä¿®æ”¹\r\n```\r\n\r\n**è¯¦ç»†è¯´æ˜**ï¼š\r\n- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šæ— é•¿æ—¶é—´é”å®šèµ„æºï¼Œæé«˜å¹¶å‘æ€§å’Œå¯ç”¨æ€§\r\n- âœ… **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒå¾®æœåŠ¡æ¶æ„ï¼ŒæœåŠ¡ç‹¬ç«‹æ‰©å±•\r\n- âœ… **å®¹é”™æ€§**ï¼šé€šè¿‡è¡¥å¿æœºåˆ¶å¤„ç†å¤±è´¥ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§\r\n- âœ… **çµæ´»æ€§**ï¼šå¯ä»¥çµæ´»ç¼–æ’äº‹åŠ¡æ­¥éª¤ï¼Œæ˜“äºä¿®æ”¹\r\n\r\n### ç¼ºç‚¹\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"Sagaç¼ºç‚¹\"\r\n        Complexity[å¤æ‚åº¦é«˜<br/>éœ€è¦ç®¡ç†è¡¥å¿é€»è¾‘]\r\n        Consistency[æœ€ç»ˆä¸€è‡´æ€§<br/>ä¸æ˜¯å¼ºä¸€è‡´æ€§]\r\n        Compensation[è¡¥å¿å¤æ‚æ€§<br/>è¡¥å¿é€»è¾‘å¯èƒ½å¤æ‚]\r\n        Testing[æµ‹è¯•å›°éš¾<br/>éœ€è¦æµ‹è¯•å„ç§åœºæ™¯]\r\n    end\r\n    \r\n    style Complexity fill:#ffcccb\r\n    style Consistency fill:#ffcccb\r\n```\r\n\r\n**è¯¦ç»†è¯´æ˜**ï¼š\r\n- âŒ **å¤æ‚åº¦é«˜**ï¼šéœ€è¦ç®¡ç†è¡¥å¿é€»è¾‘å’ŒçŠ¶æ€\r\n- âŒ **æœ€ç»ˆä¸€è‡´æ€§**ï¼šåªèƒ½ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸æ˜¯å¼ºä¸€è‡´æ€§\r\n- âŒ **è¡¥å¿å¤æ‚æ€§**ï¼šè¡¥å¿é€»è¾‘å¯èƒ½å¾ˆå¤æ‚\r\n- âŒ **æµ‹è¯•å›°éš¾**ï¼šéœ€è¦æµ‹è¯•å„ç§æˆåŠŸå’Œå¤±è´¥åœºæ™¯\r\n- âŒ **æ•°æ®ä¸€è‡´æ€§**ï¼šå¯èƒ½å­˜åœ¨ä¸­é—´çŠ¶æ€ä¸ä¸€è‡´\r\n\r\n---\r\n\r\n## å®è·µæŒ‡å—\r\n\r\n### Sagaå®æ–½æ­¥éª¤\r\n\r\n```mermaid\r\ngraph TD\r\n    Start[å¼€å§‹Saga] --> Step1[1. è¯†åˆ«äº‹åŠ¡æ­¥éª¤<br/>Identify Transaction Steps]\r\n    Step1 --> Step2[2. è®¾è®¡è¡¥å¿æ“ä½œ<br/>Design Compensating Actions]\r\n    Step2 --> Step3[3. å®ç°Sagaç¼–æ’å™¨<br/>Implement Saga Orchestrator]\r\n    Step3 --> Step4[4. å®ç°æœ¬åœ°äº‹åŠ¡<br/>Implement Local Transactions]\r\n    Step4 --> Step5[5. å®ç°è¡¥å¿é€»è¾‘<br/>Implement Compensation Logic]\r\n    Step5 --> Step6[6. æµ‹è¯•å„ç§åœºæ™¯<br/>Test Various Scenarios]\r\n    Step6 --> End[å®Œæˆ]\r\n    \r\n    style Step1 fill:#ffebee\r\n    style Step2 fill:#fff4e1\r\n    style Step3 fill:#e1f5ff\r\n```\r\n\r\n### Sagaç¼–æ’æ¨¡å¼\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"ç¼–æ’æ¨¡å¼\"\r\n        Orchestration[ç¼–æ’æ¨¡å¼<br/>Orchestration<br/>é›†ä¸­å¼åè°ƒ]\r\n        Choreography[ç¼–æ’æ¨¡å¼<br/>Choreography<br/>åˆ†å¸ƒå¼åè°ƒ]\r\n    end\r\n    \r\n    subgraph \"ç¼–æ’æ¨¡å¼ç‰¹ç‚¹\"\r\n        Central[é›†ä¸­å¼<br/>Centralized<br/>Sagaç¼–æ’å™¨]\r\n        Distributed[åˆ†å¸ƒå¼<br/>Distributed<br/>äº‹ä»¶é©±åŠ¨]\r\n    end\r\n    \r\n    Orchestration --> Central\r\n    Choreography --> Distributed\r\n    \r\n    style Orchestration fill:#ffebee\r\n    style Choreography fill:#e1f5ff\r\n```\r\n\r\n**ç¼–æ’æ¨¡å¼**ï¼š\r\n- **ç¼–æ’æ¨¡å¼ï¼ˆOrchestrationï¼‰**ï¼šé›†ä¸­å¼åè°ƒï¼ŒSagaç¼–æ’å™¨åè°ƒæ‰§è¡Œ\r\n- **ç¼–æ’æ¨¡å¼ï¼ˆChoreographyï¼‰**ï¼šåˆ†å¸ƒå¼åè°ƒï¼Œé€šè¿‡äº‹ä»¶é©±åŠ¨\r\n\r\n---\r\n\r\n## ä¸å…¶ä»–æ¶æ„æ¨¡å¼çš„å…³ç³»\r\n\r\n### Sagaä¸å…¶ä»–æ¶æ„çš„å…³ç³»\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"æ¶æ„å…³ç³»\"\r\n        Saga[Saga]\r\n        Microservices[å¾®æœåŠ¡<br/>Microservices]\r\n        EventSourcing[äº‹ä»¶æº¯æº<br/>Event Sourcing]\r\n        CQRS[CQRS]\r\n        \r\n        Microservices --> Saga\r\n        EventSourcing --> Saga\r\n        CQRS --> Saga\r\n    end\r\n    \r\n    style Saga fill:#ffebee\r\n```\r\n\r\n**å…³ç³»è¯´æ˜**ï¼š\r\n- **å¾®æœåŠ¡**ï¼šSagaæ˜¯å¾®æœåŠ¡æ¶æ„ä¸­å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆ\r\n- **äº‹ä»¶æº¯æº**ï¼šSagaå¯ä»¥ä¸äº‹ä»¶æº¯æºç»“åˆä½¿ç”¨\r\n- **CQRS**ï¼šSagaå¯ä»¥ä¸CQRSç»“åˆä½¿ç”¨\r\n\r\n---\r\n\r\n## åº”ç”¨åœºæ™¯\r\n\r\n### é€‚ç”¨åœºæ™¯\r\n\r\n```mermaid\r\nmindmap\r\n  root((Sagaé€‚ç”¨åœºæ™¯))\r\n    å¾®æœåŠ¡æ¶æ„\r\n      åˆ†å¸ƒå¼ç³»ç»Ÿ\r\n      æœåŠ¡é—´äº‹åŠ¡\r\n      è·¨æœåŠ¡æ“ä½œ\r\n    é•¿æ—¶é—´äº‹åŠ¡\r\n      è®¢å•å¤„ç†\r\n      å·¥ä½œæµ\r\n      å®¡æ‰¹æµç¨‹\r\n    æœ€ç»ˆä¸€è‡´æ€§\r\n      å¯ä»¥æ¥å—æœ€ç»ˆä¸€è‡´æ€§\r\n      ä¸éœ€è¦å¼ºä¸€è‡´æ€§\r\n      è¡¥å¿æœºåˆ¶å¯è¡Œ\r\n    é«˜å¯ç”¨æ€§\r\n      éœ€è¦é«˜å¯ç”¨\r\n      ä¸èƒ½é•¿æ—¶é—´é”å®š\r\n      éœ€è¦å¿«é€Ÿå“åº”\r\n```\r\n\r\n**å…·ä½“åœºæ™¯**ï¼š\r\n- âœ… **å¾®æœåŠ¡æ¶æ„**ï¼šå¤„ç†è·¨æœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡\r\n- âœ… **è®¢å•å¤„ç†**ï¼šç”µå•†è®¢å•åˆ›å»ºã€æ”¯ä»˜ã€å‘è´§æµç¨‹\r\n- âœ… **å·¥ä½œæµç³»ç»Ÿ**ï¼šå¤šæ­¥éª¤å·¥ä½œæµå¤„ç†\r\n- âœ… **å®¡æ‰¹æµç¨‹**ï¼šå¤šçº§å®¡æ‰¹æµç¨‹\r\n\r\n### ä¸é€‚ç”¨åœºæ™¯\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"ä¸é€‚ç”¨åœºæ™¯\"\r\n        StrongConsistency[å¼ºä¸€è‡´æ€§è¦æ±‚<br/>éœ€è¦å¼ºä¸€è‡´æ€§]\r\n        Simple[ç®€å•äº‹åŠ¡<br/>äº‹åŠ¡ç®€å•ï¼Œä¸éœ€è¦Saga]\r\n        NoCompensation[æ— è¡¥å¿å¯èƒ½<br/>æ— æ³•è¡¥å¿çš„æ“ä½œ]\r\n        ShortTransaction[çŸ­äº‹åŠ¡<br/>äº‹åŠ¡æ—¶é—´çŸ­]\r\n    end\r\n    \r\n    style StrongConsistency fill:#ffcccb\r\n```\r\n\r\n**ä¸é€‚ç”¨åœºæ™¯**ï¼š\r\n- âŒ **å¼ºä¸€è‡´æ€§è¦æ±‚**ï¼šéœ€è¦å¼ºä¸€è‡´æ€§çš„åœºæ™¯\r\n- âŒ **ç®€å•äº‹åŠ¡**ï¼šäº‹åŠ¡ç®€å•ï¼Œä¸éœ€è¦Saga\r\n- âŒ **æ— è¡¥å¿å¯èƒ½**ï¼šæ— æ³•è¡¥å¿çš„æ“ä½œï¼ˆå¦‚å‘é€é‚®ä»¶ï¼‰\r\n- âŒ **çŸ­äº‹åŠ¡**ï¼šäº‹åŠ¡æ—¶é—´çŸ­ï¼Œå¯ä»¥ä½¿ç”¨ä¼ ç»Ÿäº‹åŠ¡\r\n\r\n---\r\n\r\n## å®é™…æ¡ˆä¾‹\r\n\r\n### æ¡ˆä¾‹1ï¼šç”µå•†è®¢å•å¤„ç†\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"è®¢å•å¤„ç†Saga\"\r\n        Start[å¼€å§‹è®¢å•å¤„ç†]\r\n        Step1[æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•<br/>CreateOrder]\r\n        Step2[æ­¥éª¤2ï¼šæ‰£å‡åº“å­˜<br/>ReduceInventory]\r\n        Step3[æ­¥éª¤3ï¼šå¤„ç†æ”¯ä»˜<br/>ProcessPayment]\r\n        Step4[æ­¥éª¤4ï¼šå‘é€é€šçŸ¥<br/>SendNotification]\r\n        Success[æˆåŠŸå®Œæˆ]\r\n    end\r\n    \r\n    subgraph \"è¡¥å¿æ“ä½œ\"\r\n        Compensate1[è¡¥å¿1ï¼šå–æ¶ˆè®¢å•<br/>CancelOrder]\r\n        Compensate2[è¡¥å¿2ï¼šæ¢å¤åº“å­˜<br/>RestoreInventory]\r\n        Compensate3[è¡¥å¿3ï¼šé€€æ¬¾<br/>Refund]\r\n    end\r\n    \r\n    Start --> Step1\r\n    Step1 --> Step2\r\n    Step2 --> Step3\r\n    Step3 --> Step4\r\n    Step4 --> Success\r\n    \r\n    Step1 -.å¤±è´¥.-> Compensate1\r\n    Step2 -.å¤±è´¥.-> Compensate2\r\n    Step2 -.å¤±è´¥.-> Compensate1\r\n    Step3 -.å¤±è´¥.-> Compensate3\r\n    Step3 -.å¤±è´¥.-> Compensate2\r\n    Step3 -.å¤±è´¥.-> Compensate1\r\n    \r\n    style Step1 fill:#ffebee\r\n    style Compensate1 fill:#fff4e1\r\n```\r\n\r\n### æ¡ˆä¾‹2ï¼šæ¸¸æˆæˆ˜æ–—æµç¨‹\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"æˆ˜æ–—æµç¨‹Saga\"\r\n        Start[å¼€å§‹æˆ˜æ–—æµç¨‹]\r\n        Step1[æ­¥éª¤1ï¼šåˆå§‹åŒ–æˆ˜æ–—<br/>InitializeBattle]\r\n        Step2[æ­¥éª¤2ï¼šæ‰§è¡Œè¡ŒåŠ¨<br/>ExecuteAction]\r\n        Step3[æ­¥éª¤3ï¼šè®¡ç®—ä¼¤å®³<br/>CalculateDamage]\r\n        Step4[æ­¥éª¤4ï¼šæ›´æ–°çŠ¶æ€<br/>UpdateState]\r\n        Step5[æ­¥éª¤5ï¼šä¿å­˜è®°å½•<br/>SaveRecord]\r\n        Success[æˆåŠŸå®Œæˆ]\r\n    end\r\n    \r\n    subgraph \"è¡¥å¿æ“ä½œ\"\r\n        Compensate1[è¡¥å¿1ï¼šé‡ç½®æˆ˜æ–—<br/>ResetBattle]\r\n        Compensate2[è¡¥å¿2ï¼šæ¢å¤çŠ¶æ€<br/>RestoreState]\r\n        Compensate3[è¡¥å¿3ï¼šæ’¤é”€ä¼¤å®³<br/>UndoDamage]\r\n    end\r\n    \r\n    Start --> Step1\r\n    Step1 --> Step2\r\n    Step2 --> Step3\r\n    Step3 --> Step4\r\n    Step4 --> Step5\r\n    Step5 --> Success\r\n    \r\n    Step2 -.å¤±è´¥.-> Compensate1\r\n    Step3 -.å¤±è´¥.-> Compensate2\r\n    Step3 -.å¤±è´¥.-> Compensate1\r\n    Step4 -.å¤±è´¥.-> Compensate3\r\n    Step4 -.å¤±è´¥.-> Compensate2\r\n    Step4 -.å¤±è´¥.-> Compensate1\r\n    \r\n    style Step1 fill:#ffebee\r\n    style Compensate1 fill:#fff4e1\r\n```\r\n\r\n---\r\n\r\n## è®¾è®¡åŸåˆ™\r\n\r\n### Sagaè®¾è®¡åŸåˆ™\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph \"Sagaè®¾è®¡åŸåˆ™\"\r\n        Principle1[æœ¬åœ°äº‹åŠ¡<br/>Local Transactions]\r\n        Principle2[è¡¥å¿æœºåˆ¶<br/>Compensation]\r\n        Principle3[å¹‚ç­‰æ€§<br/>Idempotency]\r\n        Principle4[æœ€ç»ˆä¸€è‡´æ€§<br/>Eventual Consistency]\r\n        Principle5[å¯è§‚æµ‹æ€§<br/>Observability]\r\n    end\r\n    \r\n    style Principle1 fill:#ffebee\r\n```\r\n\r\n**æ ¸å¿ƒåŸåˆ™**ï¼š\r\n- **æœ¬åœ°äº‹åŠ¡**ï¼šæ¯ä¸ªæ­¥éª¤æ˜¯ç‹¬ç«‹çš„æœ¬åœ°äº‹åŠ¡\r\n- **è¡¥å¿æœºåˆ¶**ï¼šå¤±è´¥æ—¶æ‰§è¡Œè¡¥å¿æ“ä½œ\r\n- **å¹‚ç­‰æ€§**ï¼šæ“ä½œåº”è¯¥æ”¯æŒå¹‚ç­‰æ€§\r\n- **æœ€ç»ˆä¸€è‡´æ€§**ï¼šä¿è¯æœ€ç»ˆä¸€è‡´æ€§\r\n- **å¯è§‚æµ‹æ€§**ï¼šæä¾›Sagaæ‰§è¡Œçš„å¯è§‚æµ‹æ€§\r\n\r\n---\r\n\r\n## æ€»ç»“\r\n\r\nSagaæ¶æ„æ¨¡å¼é€šè¿‡å°†é•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œä½¿ç”¨è¡¥å¿æœºåˆ¶å¤„ç†å¤±è´¥ï¼Œæ˜¯å¾®æœåŠ¡æ¶æ„ä¸­å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡çš„é‡è¦è§£å†³æ–¹æ¡ˆã€‚\r\n\r\n**æ ¸å¿ƒä»·å€¼**ï¼š\r\n- ğŸš€ **æ€§èƒ½ä¼˜åŒ–**ï¼šæ— é•¿æ—¶é—´é”å®šèµ„æºï¼Œæé«˜å¹¶å‘æ€§å’Œå¯ç”¨æ€§\r\n- ğŸ“ˆ **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒå¾®æœåŠ¡æ¶æ„ï¼ŒæœåŠ¡ç‹¬ç«‹æ‰©å±•\r\n- ğŸ›¡ï¸ **å®¹é”™æ€§**ï¼šé€šè¿‡è¡¥å¿æœºåˆ¶å¤„ç†å¤±è´¥ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§\r\n- ğŸ”§ **çµæ´»æ€§**ï¼šå¯ä»¥çµæ´»ç¼–æ’äº‹åŠ¡æ­¥éª¤ï¼Œæ˜“äºä¿®æ”¹\r\n\r\n**é€‚ç”¨åœºæ™¯**ï¼š\r\n- âœ… å¾®æœåŠ¡æ¶æ„\r\n- âœ… é•¿æ—¶é—´äº‹åŠ¡\r\n- âœ… æœ€ç»ˆä¸€è‡´æ€§\r\n- âœ… é«˜å¯ç”¨æ€§\r\n\r\n**æ³¨æ„äº‹é¡¹**ï¼š\r\n- âš ï¸ å¤æ‚åº¦è¾ƒé«˜ï¼Œéœ€è¦ç®¡ç†è¡¥å¿é€»è¾‘\r\n- âš ï¸ åªèƒ½ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸æ˜¯å¼ºä¸€è‡´æ€§\r\n- âš ï¸ è¡¥å¿é€»è¾‘å¯èƒ½å¾ˆå¤æ‚\r\n- âš ï¸ æµ‹è¯•å›°éš¾ï¼Œéœ€è¦æµ‹è¯•å„ç§åœºæ™¯\r\n\r\nSagaæ˜¯å¾®æœåŠ¡æ¶æ„ä¸­å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¼˜ç§€æ¶æ„æ¨¡å¼ï¼Œç‰¹åˆ«é€‚åˆéœ€è¦é«˜å¯ç”¨æ€§å’Œå¯æ‰©å±•æ€§çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚\r\n\r\n"
        }
    ]
}