# 📅 调度器（Scheduler）概念说明

## 🎯 核心概念

**调度器（Scheduler）** 是一个用于**管理和执行延迟任务、定时任务、周期性任务**的系统组件。

### 简单理解
调度器就像一个"任务管理器"，它负责：
- ⏰ **什么时候**执行任务（时间管理）
- 🔄 **如何**执行任务（执行方式）
- 📋 **管理**待执行的任务队列

---

## 🔄 调度器 vs 事件系统

### 事件系统（Event System）
```
事件发生 → 立即通知所有监听者 → 同步执行
```
- **特点**：即时响应，同步执行
- **用途**：处理实时事件（如玩家点击、碰撞检测）

### 调度器（Scheduler）
```
任务注册 → 等待指定时间 → 延迟执行 → 可能重复执行
```
- **特点**：延迟执行，可定时、可重复
- **用途**：处理需要延迟或定时执行的任务

---

## 🏗️ 调度器的核心功能

### 1. **延迟执行（Delay）**
```
现在注册 → 3秒后执行
```

### 2. **定时执行（Schedule）**
```
每天12:00执行
每5秒执行一次
```

### 3. **周期性执行（Repeat）**
```
每帧执行
每100ms执行一次
```

### 4. **任务管理**
- 添加任务
- 取消任务
- 暂停/恢复任务
- 查询任务状态

---

## 📊 调度器工作流程图

```
┌─────────────────────────────────────────────────────────┐
│                    调度器系统架构                          │
└─────────────────────────────────────────────────────────┘

                    ┌──────────────┐
                    │  任务注册     │
                    │ (Register)   │
                    └──────┬───────┘
                           │
                           ▼
        ┌──────────────────────────────────┐
        │        任务队列管理器              │
        │  ┌──────────────────────────┐   │
        │  │  优先级队列                │   │
        │  │  - 按时间排序              │   │
        │  │  - 按优先级排序            │   │
        │  └──────────────────────────┘   │
        └──────────────┬───────────────────┘
                       │
                       ▼
        ┌──────────────────────────────┐
        │      时间管理器               │
        │  - 游戏时间                  │
        │  - 真实时间                  │
        │  - 时间缩放                  │
        └──────────────┬───────────────┘
                       │
                       ▼
        ┌──────────────────────────────┐
        │      任务执行器              │
        │  - 检查到期任务              │
        │  - 执行任务                  │
        │  - 处理重复任务              │
        └──────────────┬───────────────┘
                       │
                       ▼
        ┌──────────────────────────────┐
        │      任务生命周期管理         │
        │  - 执行完成                  │
        │  - 取消任务                  │
        │  - 错误处理                  │
        └──────────────────────────────┘
```

---

## 🎮 游戏开发中的应用场景

### 场景1：技能冷却
```lua
-- 玩家使用技能后，10秒后才能再次使用
scheduler:Schedule(10.0, function()
    skill:ResetCooldown()
end)
```

### 场景2：延迟伤害
```lua
-- 毒药效果：每秒造成10点伤害，持续5秒
for i = 1, 5 do
    scheduler:Schedule(i, function()
        player:TakeDamage(10)
    end)
end
```

### 场景3：定时刷新
```lua
-- 每30秒刷新一次商店物品
scheduler:Repeat(30.0, function()
    shop:RefreshItems()
end)
```

### 场景4：延迟UI更新
```lua
-- 延迟0.1秒后更新UI，避免频繁更新
scheduler:Schedule(0.1, function()
    ui:Update()
end)
```

### 场景5：动画序列
```lua
-- 播放动画序列
scheduler:Schedule(0.0, function() playAnimation("fadeIn") end)
scheduler:Schedule(1.0, function() playAnimation("move") end)
scheduler:Schedule(2.0, function() playAnimation("fadeOut") end)
```

---

## 🔧 调度器的关键设计点

### 1. **时间管理**
- 游戏时间 vs 真实时间
- 时间缩放（暂停、加速）
- 时间精度

### 2. **任务优先级**
- 高优先级任务优先执行
- 相同时间的任务按优先级排序

### 3. **性能优化**
- 使用堆（Heap）管理任务队列
- 批量处理到期任务
- 避免频繁的队列操作

### 4. **任务取消**
- 支持任务ID管理
- 支持条件取消
- 支持批量取消

---

## 📋 调度器 vs 其他模式对比

| 特性 | 调度器 | 事件系统 | 协程 |
|------|--------|----------|------|
| **执行时机** | 延迟/定时 | 立即 | 可暂停/恢复 |
| **时间控制** | ✅ 精确 | ❌ 无 | ⚠️ 有限 |
| **重复执行** | ✅ 支持 | ❌ 不支持 | ⚠️ 手动实现 |
| **任务管理** | ✅ 完整 | ⚠️ 简单 | ⚠️ 简单 |
| **性能** | ✅ 高效 | ✅ 高效 | ⚠️ 中等 |

---

## 🎯 调度器的实现思路

### 核心数据结构
```
任务 = {
    id: 唯一标识
    executeTime: 执行时间
    priority: 优先级
    callback: 回调函数
    repeat: 是否重复
    interval: 重复间隔
    cancelled: 是否已取消
}
```

### 核心算法
1. **添加任务**：插入到优先级队列（按时间+优先级排序）
2. **更新调度器**：每帧检查队列，执行到期任务
3. **执行任务**：调用回调函数，处理重复任务
4. **清理任务**：移除已完成或已取消的任务

---

## 💡 调度器与事件系统的协同

在实际项目中，调度器和事件系统通常**协同工作**：

```
┌─────────────────────────────────────────┐
│          游戏系统架构                     │
└─────────────────────────────────────────┘

事件系统（即时响应）
    │
    ├─→ 玩家点击按钮 → 立即触发UI事件
    ├─→ 碰撞检测 → 立即触发碰撞事件
    └─→ 状态变化 → 立即通知观察者

调度器（延迟/定时）
    │
    ├─→ 3秒后执行技能冷却
    ├─→ 每5秒刷新一次数据
    └─→ 延迟0.1秒更新UI
```

**最佳实践**：
- **事件系统**：处理需要立即响应的交互
- **调度器**：处理需要延迟或定时执行的任务

---

## 🚀 学习价值

学习调度器的设计可以帮助你：
1. ✅ 优化游戏中的时间管理
2. ✅ 实现复杂的任务序列
3. ✅ 提高代码的可维护性
4. ✅ 理解时间相关的设计模式

---

## 📚 相关设计模式

调度器通常结合以下模式使用：
- **命令模式**：将任务封装成命令对象
- **策略模式**：不同的任务执行策略
- **观察者模式**：任务执行完成的通知
- **对象池模式**：复用任务对象，减少GC

---

*调度器是游戏开发中非常重要的基础设施，掌握它可以让你的游戏逻辑更加清晰和高效！*

