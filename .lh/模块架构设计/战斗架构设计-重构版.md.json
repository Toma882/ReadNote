{
    "sourceFile": "模块架构设计/战斗架构设计-重构版.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 102,
            "patches": [
                {
                    "date": 1767182075703,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1767182111294,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -935,8 +935,81 @@\n \r\n - 执行节点接收技能效果数据、状态变更数据\r\n - 可视化节点接收数据变更通知\r\n \r\n+### 节点实现细节\r\n+\r\n+#### UnitContext逐步增强过程\r\n+\r\n+单位行动流程的核心是UnitContext的维护和管理，Context在节点间流转并逐步增强：\r\n+\r\n+```\r\n+UnitContext（节点1：单位循环开始）\r\n+  + unitData（单位数据）\r\n+  + roundContext（回合上下文）\r\n+  ↓\r\n+  + currentUnit（当前行动单位）\r\n+  + unitValidation（单位验证结果）\r\n+  ↓\r\n+  + moveInput（移动输入：点击坐标）\r\n+  + moveValidation（移动验证结果）\r\n+  + movePath（移动路径）\r\n+  + moveResult（移动结果）\r\n+  ↓\r\n+  + selectedSkill（选中的技能）\r\n+  + skillValidation（技能验证结果）\r\n+  + skillContext（技能上下文）\r\n+  ↓\r\n+  + selectedTargets（选中的目标）\r\n+  + targetValidation（目标验证结果）\r\n+  ↓\r\n+  + skillExecutionResult（技能执行结果）\r\n+  + resourceConsumption（资源消耗信息）\r\n+  ↓\r\n+  + visualResult（表现播放结果）\r\n+  + effectResults（效果处理结果）\r\n+  + resourceCheck（资源检查结果）\r\n+  + loopState（循环状态）\r\n+  ↓\r\n+UnitContext（节点7：执行施法后处理）\r\n+```\r\n+\r\n+#### 节点内部架构设计原则\r\n+\r\n+**管道过滤器模式**：\r\n+- 单Context设计：所有节点使用统一的`UnitContext`\r\n+- 逐步增强：每个节点在Context中添加自己的数据\r\n+- 数据流循环：节点1 → 节点2 → ... → 节点7 → 节点3（循环）\r\n+\r\n+**节点内部组件设计**：\r\n+- **输入接收器**：接收外部输入，验证输入有效性\r\n+- **验证器组**：负责各种验证（范围、路径、资源等）\r\n+- **执行器**：负责实际执行操作\r\n+- **数据更新器**：负责更新数据\r\n+- **表现通知器**：负责通知表现层\r\n+- **上下文增强器**：负责增强Context并传递给下一个节点\r\n+- **循环推动器**：负责推动循环状态转换\r\n+\r\n+#### 错误处理和恢复机制\r\n+\r\n+**错误类型**：\r\n+1. **资源错误**：资源不足、资源被消耗等\r\n+2. **验证错误**：验证失败、状态不合法等\r\n+3. **执行错误**：执行失败、异常等\r\n+4. **系统错误**：系统异常、外部系统错误等\r\n+\r\n+**错误处理流程**：\r\n+1. **资源回滚**：执行失败时，回滚已消耗的资源\r\n+2. **状态恢复**：从Context恢复节点执行前的状态\r\n+3. **错误通知**：通知用户错误信息，提供重试或取消选项\r\n+4. **日志记录**：记录错误信息到Context，便于调试和问题追踪\r\n+\r\n+**节点状态机**：\r\n+- **IDLE**：节点未开始执行\r\n+- **EXECUTING**：节点正在执行\r\n+- **COMPLETED**：节点执行完成\r\n+- **FAILED**：节点执行失败\r\n+\r\n ---\r\n \r\n ## 核心机制\r\n \r\n"
                },
                {
                    "date": 1767182195298,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1198,29 +1198,9 @@\n - **事件订阅**：可视化节点订阅EventChannel接收表现事件\r\n \r\n ---\r\n \r\n-## 实现指南\r\n \r\n-### 实现优先级\r\n-\r\n-**第一阶段（核心流程）**：\r\n-1. 战斗领域基础实现\r\n-2. 回合领域核心流程\r\n-3. 单位领域节点编排器基础\r\n-\r\n-**第二阶段（完整流程）**：\r\n-4. 节点分类完整实现\r\n-5. 外部系统集成\r\n-6. 数据驱动配置\r\n-\r\n-**第三阶段（优化和错误处理）**：\r\n-7. 错误处理和恢复机制\r\n-8. 性能优化\r\n-9. 边界情况处理\r\n-\r\n-### 关键实现要点\r\n-\r\n 1. **Domain controls Loop**：确保Domain管理通过协调器控制循环状态转换\r\n 2. **反向推动机制**：协调器执行完业务后，主动推动循环进入下一个状态\r\n 3. **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n 4. **数据驱动**：所有特性通过配置数据实现，无需修改代码\r\n"
                },
                {
                    "date": 1767182211426,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1070,104 +1070,9 @@\n - 行动规则、资源消耗、状态转换 → 通过UnitData/UnitTurnData配置\r\n - 节点流程、状态转换 → 通过NodeFlowConfig配置\r\n - 新增行动类型 → 扩展配置字段即可\r\n \r\n----\r\n \r\n-## 数据结构\r\n-\r\n-### UnitContext（单位上下文）\r\n-\r\n-**数据结构定义**：\r\n-\r\n-```lua\r\n-UnitContext = {\r\n-    -- 基础数据\r\n-    unitData = UnitData,              -- 单位数据\r\n-    roundContext = RoundContext,       -- 回合上下文\r\n-    \r\n-    -- 输入数据\r\n-    moveInput = {x, y},                -- 移动输入（由ReceiveMoveInputNode提供）\r\n-    skillInput = skillId,              -- 技能选择输入（由ReceiveSkillSelectNode提供）\r\n-    targetInput = {targets},            -- 目标选择输入（由ReceiveTargetSelectNode提供）\r\n-    \r\n-    -- 验证结果\r\n-    moveValidation = {...},             -- 移动验证结果\r\n-    skillValidation = {...},            -- 技能验证结果\r\n-    targetValidation = {...},          -- 目标验证结果\r\n-    \r\n-    -- 执行结果\r\n-    movePath = {...},                   -- 移动路径\r\n-    moveResult = {...},                 -- 移动结果\r\n-    skillExecutionResult = {...},       -- 技能执行结果\r\n-    resourceConsumption = {...},        -- 资源消耗信息\r\n-    \r\n-    -- 状态数据\r\n-    visualResult = {...},               -- 表现播放结果\r\n-    effectResults = {...},              -- 效果处理结果\r\n-    resourceCheck = {...},              -- 资源检查结果\r\n-    loopState = \"ACTION\"/\"END\",         -- 循环状态\r\n-    \r\n-    -- 节点执行状态\r\n-    nodeState = \"IDLE\"/\"EXECUTING\"/\"COMPLETED\"/\"FAILED\",\r\n-    errorInfo = {...}                   -- 错误信息（可选）\r\n-}\r\n-```\r\n-\r\n-### NodeFlowConfig（流程配置）\r\n-\r\n-**配置结构**：\r\n-\r\n-```lua\r\n-NodeFlowConfig = {\r\n-    nodes = {\r\n-        {id = \"init\", type = \"execution\", node = \"InitUnitNode\"},\r\n-        {id = \"checkMove\", type = \"condition\", node = \"CheckMovePointNode\"},\r\n-        -- ... 其他节点\r\n-    },\r\n-    flow = {\r\n-        {from = \"init\", to = \"checkMove\"},\r\n-        {from = \"checkMove\", to = \"move\", condition = \"hasMovePoint\"},\r\n-        {from = \"checkMove\", to = \"selectSkill\", condition = \"noMovePoint\"},\r\n-        {from = \"move\", to = \"playMove\"},\r\n-        -- ... 其他流程\r\n-    },\r\n-    events = {\r\n-        {node = \"move\", publish = \"UNIT_MOVE_COMPLETED\"},\r\n-        {node = \"playMove\", subscribe = \"UNIT_MOVE_COMPLETED\"},\r\n-        -- ... 其他事件\r\n-    }\r\n-}\r\n-```\r\n-\r\n-### RoundData（回合数据）\r\n-\r\n-**数据结构定义**：\r\n-\r\n-```lua\r\n-RoundData = {\r\n-    currentRound = number,              -- 当前回合数\r\n-    turnQueue = PriorityQueue,          -- 行动顺序队列（基于先攻值）\r\n-    unitSet = Set,                      -- 单位集合\r\n-    delayedActions = {},                -- 延迟行动列表\r\n-    surpriseRoundFactionIDs = {},      -- 突袭回合阵营列表\r\n-    activeFactionIDs = {}               -- 活跃阵营列表\r\n-}\r\n-```\r\n-\r\n-### BattleData（战斗数据）\r\n-\r\n-**数据结构定义**：\r\n-\r\n-```lua\r\n-BattleData = {\r\n-    currentPhase = string,              -- 当前战斗阶段\r\n-    roundHistoryQueue = Queue,           -- 回合历史队列\r\n-    surpriseRoundFactionIDs = {},       -- 突袭回合阵营列表\r\n-    activeFactionIDs = {}               -- 活跃阵营列表\r\n-}\r\n-```\r\n-\r\n ---\r\n \r\n ## 外部系统集成\r\n \r\n@@ -1196,17 +1101,9 @@\n **集成方式**：\r\n - **通知方式**：ActionCoordinator通知VisualSystem播放表现\r\n - **事件订阅**：可视化节点订阅EventChannel接收表现事件\r\n \r\n----\r\n \r\n-\r\n-1. **Domain controls Loop**：确保Domain管理通过协调器控制循环状态转换\r\n-2. **反向推动机制**：协调器执行完业务后，主动推动循环进入下一个状态\r\n-3. **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n-4. **数据驱动**：所有特性通过配置数据实现，无需修改代码\r\n-5. **解耦设计**：通过CommunicationBus实现节点与数据模块的解耦\r\n-\r\n ### 设计原则总结\r\n \r\n - ✅ **Domain controls Loop**：Domain控制循环，循环是Domain的工具\r\n - ✅ **数据驱动架构**：战斗特性通过配置数据实现，无需额外机制\r\n"
                },
                {
                    "date": 1767182226343,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1038,41 +1038,8 @@\n - Domain controls Loop：Domain管理通过协调器控制循环状态转换\r\n - 反向推动机制：协调器执行完业务后，主动推动循环进入下一个状态\r\n - 状态转换验证：状态转换前进行验证，确保转换合法\r\n \r\n-### 通信机制\r\n-\r\n-#### CommunicationBus 在战斗系统中的应用\r\n-\r\n-**核心设计**：节点通过 CommunicationBus 统一获取不同模块的数据，实现节点与数据模块的解耦\r\n-\r\n-**应用场景**：\r\n-\r\n-1. **QueryChannel（同步查询）**\r\n-   - 条件节点查询单位属性、技能状态、资源数量\r\n-   - 执行节点查询移动范围、技能范围、目标信息\r\n-\r\n-2. **PushChannel（批量数据推送）**\r\n-   - 执行节点接收技能效果数据、状态变更数据\r\n-   - 可视化节点接收数据变更通知\r\n-\r\n-3. **EventChannel（异步事件）**\r\n-   - 节点发布事件，其他节点订阅\r\n-   - 支持解耦的事件通知\r\n-\r\n-4. **MessageChannel（同步，1对1）**\r\n-   - 节点间需要直接通讯时使用\r\n-\r\n-### 数据驱动机制\r\n-\r\n-**核心理解**：战斗特性通过配置数据实现，无需修改代码\r\n-\r\n-**数据驱动内容**：\r\n-- 行动规则、资源消耗、状态转换 → 通过UnitData/UnitTurnData配置\r\n-- 节点流程、状态转换 → 通过NodeFlowConfig配置\r\n-- 新增行动类型 → 扩展配置字段即可\r\n-\r\n-\r\n ---\r\n \r\n ## 外部系统集成\r\n \r\n"
                },
                {
                    "date": 1767182232880,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,1073 @@\n+# 战斗系统架构设计文档\r\n+\r\n+## 目录\r\n+\r\n+1. [概述](#概述)\r\n+2. [整体架构](#整体架构)\r\n+3. [战斗领域](#战斗领域)\r\n+4. [回合领域](#回合领域)\r\n+5. [单位领域](#单位领域)\r\n+6. [核心机制](#核心机制)\r\n+7. [数据结构](#数据结构)\r\n+8. [外部系统集成](#外部系统集成)\r\n+9. [实现指南](#实现指南)\r\n+\r\n+---\r\n+\r\n+## 概述\r\n+\r\n+### 设计目标\r\n+\r\n+设计一套完整的回合制战斗系统架构，支持DND规则、回合管理、状态机控制、AI决策，实现战斗流程管理、伤害计算、效果应用，提供数据驱动的配置化战斗系统。\r\n+\r\n+### 核心设计理念\r\n+\r\n+#### 1. 多层循环架构为核心\r\n+\r\n+**本质**：战斗系统的核心是多层循环的维护和管理（当前实现为三层）\r\n+\r\n+- **战斗循环**：管理整个战斗的生命周期\r\n+- **回合循环**：管理回合的循环和切换\r\n+- **单位循环**：管理单个单位的行动流程\r\n+- **循环驱动**：所有战斗逻辑都在循环框架内执行\r\n+- **状态维护**：每层循环维护自己的状态，驱动下层循环\r\n+\r\n+#### 2. 数据驱动架构\r\n+\r\n+**本质**：战斗特性通过配置数据实现，无需修改代码\r\n+\r\n+- 战斗规则、伤害计算、效果应用 → 通过配置数据定义\r\n+- 回合流程、状态转换 → 通过配置数据调整\r\n+- 新增战斗机制 → 扩展配置数据即可\r\n+- 战斗平衡 → 调整配置数值即可\r\n+\r\n+#### 3. 分层架构（循环内的功能组织）\r\n+\r\n+**本质**：分层架构是循环内的功能组织方式，不是主要架构\r\n+\r\n+- 功能组织：输入层、决策层、执行层、表现层、管理层\r\n+- 执行位置：所有分层功能都在单位循环内执行\r\n+- 解耦设计：层间通过Context和CommunicationBus通信\r\n+\r\n+#### 4. Domain controls Loop\r\n+\r\n+**核心原则**：Domain控制循环，循环是Domain的工具\r\n+\r\n+- Domain是领域核心，拥有循环机制来推进业务流程\r\n+- Domain管理通过协调器控制循环状态转换\r\n+- 协调器执行完业务后，主动推动循环进入下一个状态\r\n+\r\n+---\r\n+\r\n+## 整体架构\r\n+\r\n+### 多层循环架构\r\n+\r\n+**核心观点**：整个回合制战斗系统的核心是维护多层循环，所有战斗逻辑都在循环框架内执行。\r\n+\r\n+#### Domain与循环的关系\r\n+\r\n+**术语说明**：使用\"Domain\"而非\"Entity\"，避免与项目中的\"Unit\"概念混淆。\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    subgraph BattleDomain[\"战斗Domain<br/>Battle Domain\"]\r\n+        BattleManagement[战斗管理<br/>结算奖励/同步任务]\r\n+        BattleLoop[\"战斗循环<br/>BattleLoop\"]\r\n+        BattleManagement -->|控制| BattleLoop\r\n+        BattleLoop -->|推进| BattleManagement\r\n+        \r\n+        subgraph RoundDomain[\"回合Domain<br/>Round Domain\"]\r\n+            RoundManagement[回合管理<br/>行动值排序/单位行动顺序]\r\n+            RoundLoop[\"回合循环<br/>RoundLoop\"]\r\n+            RoundManagement -->|控制| RoundLoop\r\n+            RoundLoop -->|推进| RoundManagement\r\n+            \r\n+            subgraph UnitDomain[\"单位Domain<br/>Unit Domain\"]\r\n+                UnitManagement[单位管理<br/>移动/施法/选择技能对象]\r\n+                UnitLoop[\"单位循环<br/>UnitLoop\"]\r\n+                UnitManagement -->|控制| UnitLoop\r\n+                UnitLoop -->|推进| UnitManagement\r\n+            end\r\n+        end\r\n+    end\r\n+    \r\n+    style BattleDomain fill:#ffebee\r\n+    style RoundDomain fill:#fff4e1\r\n+    style UnitDomain fill:#e1f5ff\r\n+    style BattleLoop fill:#f3e5f5\r\n+    style RoundLoop fill:#f3e5f5\r\n+    style UnitLoop fill:#f3e5f5\r\n+```\r\n+\r\n+**备注**：\r\n+- **三层架构**：当前实现为三层架构（战斗→回合→单位），符合DND规则中所有单位按先攻值统一排序的设计\r\n+- **阵营循环**：在标准DND规则中，所有单位按先攻值（Initiative）统一排序行动，不存在阵营循环。此处保留作为扩展设计，便于后续支持阵营差异行为\r\n+\r\n+#### Domain协作关系\r\n+\r\n+**核心观点**：Domain之间通过协作推进业务流程，父Domain调用子Domain，子Domain完成业务后返回父Domain。\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    BattleDomain[战斗Domain<br/>Battle Domain]\r\n+    RoundDomain[回合Domain<br/>Round Domain]\r\n+    UnitDomain[单位Domain<br/>Unit Domain]\r\n+    \r\n+    BattleDomain -->|1. 调用| RoundDomain\r\n+    RoundDomain -->|2. 返回| BattleDomain\r\n+    RoundDomain -->|3. 调用| UnitDomain\r\n+    UnitDomain -->|4. 返回| RoundDomain\r\n+    \r\n+    BattleDomain -.->|包含| RoundDomain\r\n+    RoundDomain -.->|包含| UnitDomain\r\n+    \r\n+    style BattleDomain fill:#ffebee\r\n+    style RoundDomain fill:#fff4e1\r\n+    style UnitDomain fill:#e1f5ff\r\n+```\r\n+\r\n+**协作流程说明**：\r\n+1. **战斗Domain** → 调用 **回合Domain**：战斗进行中，需要执行回合\r\n+2. **回合Domain** → 调用 **单位Domain**：回合进行中，需要处理单位行动\r\n+3. **单位Domain** → 返回 **回合Domain**：单位行动完成\r\n+4. **回合Domain** → 返回 **战斗Domain**：回合完成\r\n+\r\n+**协作原则**：\r\n+- 父Domain控制子Domain的调用时机\r\n+- 子Domain完成业务后主动返回父Domain\r\n+- 每个Domain独立管理自己的业务逻辑和循环\r\n+\r\n+### 循环职责说明\r\n+\r\n+#### 1. 战斗循环（BattleLoop）\r\n+- **职责**：管理整个战斗的生命周期\r\n+- **状态**：PREPARING → IN_PROGRESS → ENDED\r\n+- **维护**：BattleLoopManager\r\n+\r\n+#### 2. 回合循环（RoundLoop）\r\n+- **职责**：管理回合的循环和切换\r\n+- **状态**：START → ACTION → END\r\n+- **维护**：RoundLoopManager\r\n+\r\n+#### 3. 单位循环（UnitLoop）\r\n+- **职责**：管理单个单位的行动流程\r\n+- **状态**：START → ACTION → END\r\n+- **维护**：UnitLoopManager\r\n+\r\n+---\r\n+\r\n+## 战斗领域\r\n+\r\n+### 核心职责\r\n+\r\n+战斗领域负责管理整个战斗的生命周期，包括战斗初始化、战斗流程控制、战斗结束判断、奖励结算、任务同步等。\r\n+\r\n+### 架构结构\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    subgraph BattleDomain[\"战斗Domain<br/>Battle Domain\"]\r\n+        BattleManagement[战斗管理<br/>BattleManagement]\r\n+        BattleLoop[战斗循环<br/>BattleLoop<br/>PREPARING → IN_PROGRESS → ENDED]\r\n+        RoundCoordinator[回合协调器<br/>RoundCoordinator<br/>微核心：只负责协调调用]\r\n+        \r\n+        subgraph BattleManagement[\"战斗管理<br/>BattleManagement\"]\r\n+            BattleData[战斗数据<br/>BattleData]\r\n+            DataMgr[战斗数据管理<br/>战斗状态/回合历史/活跃阵营]\r\n+            RuleMgr[战斗规则管理<br/>战斗开始/结束条件/胜利条件/失败条件]\r\n+            RewardMgr[奖励管理<br/>奖励结算/任务同步]\r\n+        end\r\n+    end\r\n+    \r\n+    subgraph ExternalSystems[\"外部系统\"]\r\n+        RoundDomain[回合领域<br/>Round Domain]\r\n+        RewardSystem[奖励系统<br/>Reward System]\r\n+        TaskSystem[任务系统<br/>Task System]\r\n+    end\r\n+    \r\n+    BattleManagement -->|控制| BattleLoop\r\n+    BattleManagement --> RoundCoordinator\r\n+    RoundCoordinator -->|反向推动| BattleLoop\r\n+    BattleLoop -->|推进| BattleManagement\r\n+    \r\n+    RoundCoordinator -->|调用| RoundDomain\r\n+    RoundDomain -->|返回| RoundCoordinator\r\n+    \r\n+    BattleManagement -->|结算奖励| RewardSystem\r\n+    BattleManagement -->|同步任务| TaskSystem\r\n+    \r\n+    style BattleDomain fill:#ffebee\r\n+    style BattleManagement fill:#ffebee\r\n+    style BattleLoop fill:#f3e5f5\r\n+    style RoundCoordinator fill:#c8e6c9\r\n+```\r\n+\r\n+### 战斗管理（BattleManagement）\r\n+\r\n+#### 1. 战斗数据管理\r\n+- **战斗状态**：当前战斗状态（PREPARING/IN_PROGRESS/ENDED）\r\n+- **回合历史**：记录已完成的回合历史（`roundHistoryQueue`）\r\n+- **活跃阵营列表**：当前战斗中活跃的阵营ID列表（`activeFactionIDs`）\r\n+- **突袭回合阵营列表**：被突袭的阵营ID列表（`surpriseRoundFactionIDs`）\r\n+\r\n+#### 2. 战斗规则管理\r\n+- **战斗开始条件**：检查是否可以开始战斗\r\n+- **战斗结束条件**：检查是否应该结束战斗\r\n+- **胜利条件**：检查是否满足胜利条件（`CheckVictoryCondition`）\r\n+- **失败条件**：检查是否满足失败条件（`CheckDefeatCondition`）\r\n+\r\n+#### 3. 奖励管理\r\n+- **奖励结算**：战斗结束后结算奖励\r\n+- **任务同步**：同步战斗相关的任务进度\r\n+\r\n+### 战斗循环（BattleLoop）\r\n+\r\n+**循环状态**：PREPARING → IN_PROGRESS → ENDED\r\n+\r\n+- **PREPARING**：战斗准备中，初始化战斗数据\r\n+- **IN_PROGRESS**：战斗进行中，执行回合（调用回合领域）\r\n+- **ENDED**：战斗已结束，结算奖励、同步任务\r\n+\r\n+### 回合协调器（RoundCoordinator）\r\n+\r\n+**核心原则**：只负责协调调用，不包含业务规则\r\n+\r\n+**核心职责**：\r\n+- ✅ **协调调用**：调用回合领域执行回合\r\n+- ✅ **反向推动循环**：回合完成后，主动推动战斗循环进入下一个状态（Domain controls Loop）\r\n+\r\n+### 战斗完整流程\r\n+\r\n+```mermaid\r\n+flowchart TD\r\n+    LoopPreparing[LoopPreparing<br/>战斗准备] --> InitBattle[初始化战斗数据<br/>战斗管理初始化]\r\n+    \r\n+    InitBattle --> LoopProgress[LoopProgress<br/>战斗进行中]\r\n+    \r\n+    LoopProgress --> CallRound[调用回合领域<br/>回合协调器调用回合领域]\r\n+    \r\n+    CallRound --> RoundAction[回合领域执行回合<br/>回合领域完成回合]\r\n+    \r\n+    RoundAction --> PushProgress[回合协调器推动循环<br/>推动到IN_PROGRESS状态继续]\r\n+    \r\n+    PushProgress --> CheckEnd{检查战斗结束条件<br/>战斗管理检查}\r\n+    \r\n+    CheckEnd -->|未结束| CallRound\r\n+    CheckEnd -->|已结束| PushEnd[回合协调器推动循环<br/>推动到ENDED状态]\r\n+    \r\n+    PushEnd --> LoopEnd[LoopEnd<br/>战斗结束]\r\n+    \r\n+    LoopEnd --> Reward[结算奖励<br/>奖励管理结算奖励]\r\n+    Reward --> Task[同步任务<br/>任务管理同步任务]\r\n+    Task --> Complete[战斗完成]\r\n+    \r\n+    style LoopPreparing fill:#ffebee\r\n+    style LoopProgress fill:#ffebee\r\n+    style CallRound fill:#c8e6c9\r\n+    style RoundAction fill:#c8e6c9\r\n+    style PushProgress fill:#f3e5f5\r\n+    style PushEnd fill:#f3e5f5\r\n+    style LoopEnd fill:#ffebee\r\n+    style CheckEnd fill:#ffe0b2\r\n+```\r\n+\r\n+---\r\n+\r\n+## 回合领域\r\n+\r\n+### 核心职责\r\n+\r\n+回合领域负责管理回合的循环和切换，包括回合数管理、行动顺序管理（基于先攻值）、回合开始/结束控制等。\r\n+\r\n+### 架构结构\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    subgraph RoundDomain[\"回合Domain<br/>Round Domain\"]\r\n+        RoundManagement[回合管理<br/>RoundManagement]\r\n+        RoundLoop[回合循环<br/>RoundLoop<br/>START → ACTION → END]\r\n+        UnitCoordinator[单位协调器<br/>UnitCoordinator<br/>微核心：只负责协调调用]\r\n+        \r\n+        subgraph RoundManagement[\"回合管理<br/>RoundManagement\"]\r\n+            RoundData[回合数据<br/>RoundData]\r\n+            DataMgr[回合数据管理<br/>回合数/行动顺序队列]\r\n+            RuleMgr[回合规则管理<br/>回合开始/结束条件]\r\n+            OrderMgr[行动顺序管理<br/>队列初始化/管理/获取下一个单位]\r\n+        end\r\n+        \r\n+        subgraph UnitCoordinator[\"单位协调器<br/>UnitCoordinator<br/>微核心：只负责协调调用\"]\r\n+            UnitCall[单位调用<br/>从回合管理获取单位<br/>调用单位领域]\r\n+        end\r\n+    end\r\n+    \r\n+    subgraph ExternalSystems[\"外部系统\"]\r\n+        BattleDomain[战斗领域<br/>Battle Domain]\r\n+        UnitDomain[单位领域<br/>Unit Domain]\r\n+    end\r\n+    \r\n+    BattleDomain -->|控制| RoundDomain\r\n+    RoundManagement -->|控制| RoundLoop\r\n+    RoundManagement --> UnitCoordinator\r\n+    UnitCoordinator -->|反向推动| RoundLoop\r\n+    RoundLoop -->|推进| RoundManagement\r\n+    \r\n+    UnitCoordinator -->|调用| UnitDomain\r\n+    UnitDomain -->|返回| UnitCoordinator\r\n+    \r\n+    style RoundDomain fill:#fff4e1\r\n+    style RoundManagement fill:#fff4e1\r\n+    style RoundLoop fill:#f3e5f5\r\n+    style UnitCoordinator fill:#c8e6c9\r\n+    style RoundData fill:#e1f5ff\r\n+```\r\n+\r\n+### 回合管理（RoundManagement）\r\n+\r\n+#### 1. 回合数据管理\r\n+- **回合数**：当前回合数、总回合数\r\n+- **行动顺序队列**：基于先攻值的优先级队列（TurnQueue）\r\n+- **当前行动单位**：当前正在行动的单位\r\n+- **活跃阵营列表**：当前回合中活跃的阵营ID列表\r\n+\r\n+#### 2. 回合规则管理\r\n+- **回合开始条件**：检查是否可以开始新回合\r\n+- **回合结束条件**：检查是否应该结束当前回合（所有单位行动完成）\r\n+- **回合切换规则**：判断是否还有下一个回合\r\n+- **突袭回合规则**：战斗开始时，只有被突袭的阵营才能行动（Surprise Round）\r\n+- **单位存活检查**：只有存活的单位才能参与回合（`unit:IsAlive()`）\r\n+- **活跃阵营过滤**：只有活跃的阵营才能参与回合（`activeFactionIDs`）\r\n+\r\n+#### 3. 行动顺序管理\r\n+- **初始化队列**：回合开始时，根据先攻值初始化行动顺序队列\r\n+  - **突袭回合处理**：战斗开始时，只有被突袭的阵营单位加入队列\r\n+  - **正常回合处理**：正常回合中，所有活跃阵营的存活单位加入队列\r\n+- **队列管理**：管理行动顺序队列的添加、移除、清空\r\n+- **获取下一个单位**：从行动顺序队列中获取下一个行动单位（自动过滤死亡单位）\r\n+- **下一个单位检查**：检查是否还有下一个行动单位\r\n+- **延迟行动管理**：管理延迟行动的单位列表，在适当时候插入到行动顺序中\r\n+\r\n+### 回合循环（RoundLoop）\r\n+\r\n+**循环状态**：START → ACTION → END\r\n+\r\n+- **START**：回合开始，初始化行动顺序队列\r\n+  - **突袭回合**：只有被突袭的阵营单位加入队列\r\n+  - **正常回合**：所有活跃阵营的存活单位加入队列\r\n+- **ACTION**：执行回合行动（调用单位领域）\r\n+- **END**：回合结束，清理回合数据，处理延迟行动\r\n+\r\n+### 单位协调器（UnitCoordinator）\r\n+\r\n+**核心原则**：只负责协调调用，不包含业务规则\r\n+\r\n+**核心职责**：\r\n+- ✅ **协调调用**：从回合管理获取下一个单位，调用单位领域执行单位行动\r\n+- ✅ **反向推动循环**：单位行动完成后，主动推动回合循环进入下一个状态（Domain controls Loop）\r\n+\r\n+#### 循环推动机制\r\n+- **推动到END**：所有单位行动完成后，推动循环从ACTION状态进入END状态\r\n+- **推动到START**：回合结束时，推动循环从END状态进入START状态（下一个回合）\r\n+- **推动到ACTION**：回合开始时，推动循环从START状态进入ACTION状态\r\n+\r\n+### 回合完整流程\r\n+\r\n+```mermaid\r\n+flowchart TD\r\n+    LoopStart[LoopStart<br/>战斗领域推动循环] --> InitQueue[初始化行动顺序队列<br/>回合管理根据先攻值排序]\r\n+    \r\n+    InitQueue --> LoopAction[LoopAction<br/>执行回合行动]\r\n+    \r\n+    LoopAction --> GetNextUnit{获取下一个单位<br/>回合管理从队列获取}\r\n+    \r\n+    GetNextUnit -->|有单位| CallUnit[调用单位领域<br/>单位协调器调用单位领域]\r\n+    GetNextUnit -->|无单位| PushEnd\r\n+    \r\n+    CallUnit --> UnitAction[单位领域执行行动<br/>单位领域完成行动]\r\n+    \r\n+    UnitAction --> PushAction[单位协调器推动循环<br/>推动到ACTION状态继续]\r\n+    \r\n+    PushAction --> GetNextUnit\r\n+    \r\n+    PushEnd[单位协调器推动循环<br/>推动到END状态]\r\n+    \r\n+    PushEnd --> RoundEnd[LoopEnd<br/>回合结束]\r\n+    \r\n+    RoundEnd --> CheckNextRound{检查下一个回合<br/>回合管理检查是否还有下一个回合}\r\n+    \r\n+    CheckNextRound -->|有下一个回合| PushStart[单位协调器推动循环<br/>推动到START状态]\r\n+    CheckNextRound -->|无下一个回合| EndRound[结束回合循环<br/>返回战斗领域]\r\n+    \r\n+    PushStart --> LoopStart\r\n+    \r\n+    style LoopStart fill:#fff4e1\r\n+    style LoopAction fill:#fff4e1\r\n+    style CallUnit fill:#c8e6c9\r\n+    style UnitAction fill:#c8e6c9\r\n+    style PushAction fill:#f3e5f5\r\n+    style PushEnd fill:#f3e5f5\r\n+    style PushStart fill:#f3e5f5\r\n+    style LoopEnd fill:#fff4e1\r\n+    style GetNextUnit fill:#ffe0b2\r\n+    style CheckNextRound fill:#ffe0b2\r\n+```\r\n+\r\n+**关键点**：\r\n+- ✅ **Domain controls Loop**：回合管理通过单位协调器控制循环状态转换\r\n+- ✅ **反向推动机制**：单位协调器执行完单位行动后，主动推动循环进入下一个状态\r\n+- ✅ **单位协调器不处理业务规则**：只负责协调调用单位领域，不处理回合业务逻辑\r\n+- ✅ **行动顺序管理**：回合管理负责基于先攻值的优先级队列，确保单位按正确顺序行动\r\n+- ✅ **队列驱动**：通过行动顺序队列驱动单位行动，队列为空时回合结束\r\n+\r\n+### 职责划分\r\n+\r\n+| 组件 | 职责 | 说明 |\r\n+|------|------|------|\r\n+| **回合管理** | 回合数据与规则 | 管理回合数、行动顺序队列、回合开始/结束规则、队列管理 |\r\n+| **单位协调器** | 协调调用 | 从回合管理获取单位，调用单位领域，不处理回合业务规则 |\r\n+| **回合循环** | 流程控制 | START/ACTION/END状态转换，由回合管理控制 |\r\n+\r\n+---\r\n+\r\n+## 单位领域\r\n+\r\n+### 核心职责\r\n+\r\n+单位领域是战斗系统的核心，负责管理单个单位的行动流程，包括移动、技能释放、数值控制等。\r\n+\r\n+### 架构结构\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    subgraph UnitDomain[\"单位Domain<br/>Unit Domain\"]\r\n+        UnitManagement[单位管理<br/>UnitManagement]\r\n+        UnitLoop[单位循环<br/>UnitLoop<br/>START → ACTION → END]\r\n+        ActionCoordinator[行动协调器<br/>ActionCoordinator<br/>微核心：只负责协调调用]\r\n+        \r\n+        subgraph UnitManagement[\"单位管理<br/>UnitManagement\"]\r\n+            UnitData[单位数据<br/>UnitData]\r\n+            DataMgr[单位数据管理<br/>属性/状态/位置/回合数据<br/>AP/MP/先攻值]\r\n+            RuleMgr[单位规则管理<br/>行动点数规则/移动点数规则<br/>先攻值规则/回合初始化规则]\r\n+        end\r\n+        \r\n+        subgraph DataHandleQueue[\"DataHandleQueue<br/>数据队列<br/>1:1关系\"]\r\n+        end\r\n+        \r\n+        subgraph ActionCoordinator[\"行动协调器<br/>ActionCoordinator<br/>微核心：只负责协调调用\"]\r\n+            MoveCoord[移动协调<br/>调用网格系统]\r\n+            SkillCoord[技能协调<br/>调用技能领域]\r\n+            TerrainCoord[地形交互协调<br/>调用地形领域<br/>可选]\r\n+            VisualCoord[表现协调<br/>通知表现层]\r\n+        end\r\n+    end\r\n+    \r\n+    subgraph ExternalSystems[\"外部系统\"]\r\n+        GridSystem[网格系统<br/>GridSystem]\r\n+        SkillDomain[技能领域<br/>Skill Domain]\r\n+        VisualSystem[表现系统<br/>Visual System]\r\n+        TerrainDomain[地形领域<br/>Terrain Domain]\r\n+    end\r\n+    \r\n+    UnitManagement -->|控制| UnitLoop\r\n+    UnitManagement --> ActionCoordinator\r\n+    UnitManagement --> UnitData\r\n+    ActionCoordinator -->|反向推动| UnitLoop\r\n+    UnitLoop -->|推进| UnitManagement\r\n+    \r\n+    ActionCoordinator -->|调用| GridSystem\r\n+    ActionCoordinator -->|调用| SkillDomain\r\n+    ActionCoordinator -->|调用| TerrainDomain\r\n+    ActionCoordinator -->|通知| VisualSystem\r\n+    \r\n+    SkillDomain -->|EffectHandler推送| DataHandleQueue\r\n+    TerrainDomain -->|EffectHandler推送| DataHandleQueue\r\n+\r\n+    DataHandleQueue -->|推送数据| UnitData\r\n+    \r\n+    style UnitDomain fill:#e1f5ff\r\n+    style UnitManagement fill:#fff4e1\r\n+    style UnitLoop fill:#f3e5f5\r\n+    style ActionCoordinator fill:#c8e6c9\r\n+    style DataHandleQueue fill:#f3e5f5\r\n+    style UnitData fill:#e1f5ff\r\n+```\r\n+\r\n+### 单位管理（UnitManagement）\r\n+\r\n+#### 1. 单位数据管理\r\n+- **单位属性**：生命值、行动点数（AP）、移动点数（MP）、先攻值等\r\n+- **单位状态**：是否可行动、是否已移动、是否已攻击、是否存活等\r\n+- **单位位置**：当前网格位置\r\n+- **回合数据**：UnitTurnData管理行动点数、移动点数、先攻值等回合相关数据\r\n+\r\n+#### 2. 单位规则管理\r\n+- **移动点数规则**：移动前检查能否移动\r\n+- **行动点数规则**：检查行动是否可执行（`CheckAction`），消耗行动点数和移动点数（`ConsumeAction`）\r\n+- **行动规则**：是否可执行行动（移动、攻击、技能等）\r\n+- **状态规则**：状态转换规则（是否存活、是否可行动等）\r\n+- **先攻值规则**：管理单位的先攻值，用于回合顺序排序\r\n+- **回合初始化规则**：回合开始时初始化行动点数和移动点数（`StartUnitTurn`）\r\n+\r\n+#### 3. UnitData与DataHandleQueue关系\r\n+- **1:1关系**：DataHandleQueue 与 UnitData 是 1:1 关系，数据直接修改 UnitData\r\n+- **直接修改**：技能领域的EffectHandler推送数据到DataHandleQueue后，直接修改UnitData\r\n+- **无需中间层**：不需要\"数值控制管理\"中间层，DataHandleQueue直接修改UnitData\r\n+\r\n+### 单位循环（UnitLoop）\r\n+\r\n+**循环状态**：START → ACTION → END\r\n+\r\n+- **START**：单位开始行动\r\n+- **ACTION**：执行行动（移动、技能等）\r\n+- **END**：单位结束行动\r\n+\r\n+### 行动协调器（ActionCoordinator）\r\n+\r\n+**核心原则**：只负责协调调用，不包含业务规则\r\n+\r\n+**核心职责**：\r\n+- ✅ **协调调用**：调用网格系统、技能领域、表现系统\r\n+- ✅ **反向推动循环**：执行完行动后，主动推动单位循环进入下一个状态（Domain controls Loop）\r\n+\r\n+#### 1. 移动协调\r\n+- **移动前检查**：调用单位管理检查移动点数和行动点数\r\n+- **调用网格系统**：进行移动计算（路径查找、移动范围等）\r\n+- **移动后更新**：通过 DataHandleQueue 更新单位位置和移动点数\r\n+- **推动循环**：移动完成后，推动循环进入下一个状态\r\n+\r\n+#### 2. 技能协调\r\n+- **行动点数检查**：调用单位管理检查行动点数是否足够\r\n+- **调用技能领域**：执行技能\r\n+- **不处理数值控制**：数值控制由技能领域的EffectHandler通过DataHandleQueue处理\r\n+- **接收技能结果**：获取技能执行结果（成功/失败），用于流程控制\r\n+- **推动循环**：技能执行完成后，推动循环进入下一个状态\r\n+\r\n+#### 3. 地形交互协调（可选）\r\n+- **地形交互检查**：检查单位是否触发地形要素（陷阱、门等）\r\n+- **调用地形领域**：如果触发地形要素，调用地形领域处理\r\n+- **推动循环**：地形交互完成后，推动循环进入下一个状态\r\n+\r\n+#### 4. 表现协调\r\n+- **通知表现层**：移动表现、技能表现、受攻击表现\r\n+- **推动循环**：表现播放完成后（可选），推动循环进入下一个状态\r\n+\r\n+### 单位行动完整流程\r\n+\r\n+```mermaid\r\n+flowchart TD\r\n+    LoopStart[LoopStart<br/>单位管理推动循环] --> LoopAction[LoopAction<br/>执行行动]\r\n+    \r\n+    LoopAction --> CheckAction{行动前检查<br/>单位管理检查行动点数/移动点数}\r\n+    \r\n+    CheckAction -->|可以移动| Move[单位移动<br/>行动协调器调用网格系统]\r\n+    CheckAction -->|不能移动| Skill\r\n+    \r\n+    Move --> UpdateMove[更新移动点数<br/>DataHandleQueue推送]\r\n+    UpdateMove --> Skill[攻击/治疗<br/>行动协调器调用技能领域]\r\n+    \r\n+    Skill --> EffectPush[EffectHandler推送效果<br/>通过DataHandleQueue到目标单位]\r\n+    EffectPush --> Visual[可视化<br/>行动协调器通知表现层]\r\n+    \r\n+    Visual --> PushEnd[行动协调器推动循环<br/>推动到END状态]\r\n+    \r\n+    PushEnd --> CheckActionPoint{行动点数检查<br/>单位管理检查是否还有行动点数/移动点数}\r\n+    \r\n+    CheckActionPoint -->|还有行动点数/移动点数| PushAction[行动协调器推动循环<br/>推动回ACTION状态]\r\n+    CheckActionPoint -->|无行动点数/移动点数| LoopEnd[LoopEnd<br/>单位结束行动]\r\n+    \r\n+    PushAction --> LoopAction\r\n+    \r\n+    style LoopStart fill:#e1f5ff\r\n+    style LoopAction fill:#e1f5ff\r\n+    style Move fill:#fff4e1\r\n+    style Skill fill:#c8e6c9\r\n+    style EffectPush fill:#fff4e1\r\n+    style Visual fill:#c8e6c9\r\n+    style PushEnd fill:#f3e5f5\r\n+    style PushAction fill:#f3e5f5\r\n+    style LoopEnd fill:#e1f5ff\r\n+    style CheckAction fill:#ffe0b2\r\n+    style CheckActionPoint fill:#ffe0b2\r\n+```\r\n+\r\n+### 数值控制流程（通过 DataHandleQueue）\r\n+\r\n+```mermaid\r\n+flowchart LR\r\n+    ActionCoord[行动协调器<br/>调用技能领域] --> SkillDomain[技能领域<br/>执行技能]\r\n+    SkillDomain --> EffectHandler[EffectHandler<br/>应用效果]\r\n+    TerrainDomain[地形领域<br/>执行地形要素] --> EffectHandler[EffectHandler<br/>应用效果]\r\n+    EffectHandler --> ProcessQueue[DataHandleQueue]\r\n+    ProcessQueue --> UnitData[UnitData<br/>1:1关系<br/>推送修改]\r\n+    UnitData --> UpdateState[更新状态<br/>扣血/加buff]\r\n+    ActionCoord --> TerrainDomain\r\n+    ActionCoord --> 其他领域\r\n+    其他领域 --> EffectHandler\r\n+\r\n+    style ActionCoord fill:#c8e6c9\r\n+    style SkillDomain fill:#c8e6c9\r\n+    style EffectHandler fill:#fff4e1\r\n+    style ProcessQueue fill:#f3e5f5\r\n+    style UnitData fill:#e1f5ff\r\n+    style UpdateState fill:#fff4e1\r\n+```\r\n+\r\n+---\r\n+\r\n+## 单位领域：节点编排架构\r\n+\r\n+### 核心设计理念\r\n+\r\n+#### 1. 节点编排器为核心\r\n+\r\n+**本质**：单位行动流程的核心是节点编排器的动态组织和管理\r\n+\r\n+- 单位行动流程 = 节点编排器根据配置动态组织节点执行\r\n+- 节点编排 = 条件节点 → 执行节点 → 可视化节点的组合\r\n+- 流程控制 = 节点编排器根据节点执行结果决定下一个节点\r\n+- 灵活扩展 = 新增节点类型只需注册到编排器\r\n+\r\n+#### 2. 节点分类设计\r\n+\r\n+**本质**：节点按功能职责分为四类，每类节点职责单一、可复用\r\n+\r\n+- **输入节点（Input Node）**：负责接收玩家输入（如：接收移动点击、接收技能选择、接收目标选择等）\r\n+- **条件节点（Condition Node）**：负责验证、检查、判断，返回判断结果和流程控制建议（如：检查移动点数、验证技能可释放、检查资源决定是否继续等）\r\n+- **执行节点（Execution Node）**：负责实际执行操作，修改数据（如：执行移动、执行技能、消耗资源、更新状态等）\r\n+- **可视化节点（Visual Node）**：负责表现播放（如：播放移动表现、播放技能表现等）\r\n+\r\n+#### 3. 节点数据获取机制\r\n+\r\n+**本质**：节点通过 CommunicationBus 统一获取不同模块的数据，实现节点与数据模块的解耦\r\n+\r\n+**核心概念**：\r\n+- **数据访问层**：CommunicationBus 作为节点访问所有数据模块的统一接口\r\n+- **解耦设计**：节点不直接依赖具体的数据模块（UnitData、SkillDomain、TerrainDomain等）\r\n+- **统一接口**：所有数据获取都通过 PushChannel（批量数据推送）和 QueryChannel（同步查询）进行\r\n+- **灵活扩展**：新增数据模块时，只需注册到 CommunicationBus，节点无需修改\r\n+\r\n+**数据获取方式**：\r\n+\r\n+1. **QueryChannel（同步查询）**：用于节点需要立即获取数据的场景\r\n+   - **条件节点**：查询单位属性、技能状态、资源数量等用于验证和检查\r\n+   - **执行节点**：查询移动范围、技能范围、目标信息等用于执行\r\n+\r\n+2. **PushChannel（批量数据推送）**：用于节点需要接收数据变更通知的场景\r\n+   - **执行节点**：接收技能效果数据、状态变更数据等用于执行\r\n+   - **可视化节点**：接收数据变更通知用于更新表现\r\n+\r\n+### 节点编排器架构\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    subgraph UnitDomain[\"单位Domain\"]\r\n+        NodeOrchestrator[节点编排器<br/>NodeOrchestrator]\r\n+        \r\n+        subgraph NodeRegistry[\"节点注册表<br/>NodeRegistry\"]\r\n+            subgraph InputNodes[\"输入节点组<br/>Input Nodes\"]\r\n+                ReceiveMoveInputNode[接收移动输入节点]\r\n+                ReceiveSkillSelectNode[接收技能选择节点]\r\n+                ReceiveTargetSelectNode[接收目标选择节点]\r\n+            end\r\n+            \r\n+            subgraph ConditionNodes[\"条件节点组<br/>Condition Nodes\"]\r\n+                CheckMovePointNode[检查移动点数节点]\r\n+                CheckActionPointNode[检查行动点数节点]\r\n+                ValidateSkillNode[验证技能节点]\r\n+                ValidateTargetNode[验证目标节点]\r\n+                ValidateMoveNode[验证移动节点]\r\n+                CheckResourceNode[检查资源节点]\r\n+            end\r\n+            \r\n+            subgraph ExecutionNodes[\"执行节点组<br/>Execution Nodes\"]\r\n+                InitUnitNode[初始化单位节点]\r\n+                MoveNode[移动节点]\r\n+                SelectSkillNode[选择技能节点]\r\n+                SelectTargetNode[选择目标节点]\r\n+                ExecuteSkillNode[执行技能节点]\r\n+                ConsumeResourceNode[消耗资源节点]\r\n+                UpdateStateNode[更新状态节点]\r\n+            end\r\n+            \r\n+            subgraph VisualNodes[\"可视化节点组<br/>Visual Nodes\"]\r\n+                PlayMoveVisualNode[播放移动表现节点]\r\n+                PlaySkillVisualNode[播放技能表现节点]\r\n+                PlayTargetVisualNode[播放目标表现节点]\r\n+            end\r\n+        end\r\n+        \r\n+        FlowConfig[流程配置<br/>NodeFlowConfig]\r\n+        ContextManager[上下文管理器<br/>ContextManager]\r\n+        \r\n+        subgraph CommunicationBus[\"通讯总线\"]\r\n+            EventChannel[事件通道<br/>EventChannel]\r\n+            MessageChannel[消息通道<br/>MessageChannel]\r\n+            PushChannel[推送通道<br/>PushChannel]\r\n+            QueryChannel[查询通道<br/>QueryChannel]\r\n+        end\r\n+        \r\n+        subgraph DataModules[\"数据模块\"]\r\n+            UnitDataModule[单位数据模块<br/>UnitData]\r\n+            SkillDomainModule[技能领域模块<br/>SkillDomain]\r\n+            TerrainDomainModule[地形领域模块<br/>TerrainDomain]\r\n+            GridSystemModule[网格系统模块<br/>GridSystem]\r\n+        end\r\n+    end\r\n+    \r\n+    NodeOrchestrator -->|管理节点| NodeRegistry\r\n+    NodeOrchestrator -->|读取配置| FlowConfig\r\n+    NodeOrchestrator -->|执行节点| InputNodes\r\n+    NodeOrchestrator -->|执行节点| ConditionNodes\r\n+    NodeOrchestrator -->|执行节点| ExecutionNodes\r\n+    NodeOrchestrator -->|执行节点| VisualNodes\r\n+    NodeOrchestrator -->|管理Context| ContextManager\r\n+    \r\n+    InputNodes -->|发布事件| EventChannel\r\n+    ConditionNodes -->|发布事件| EventChannel\r\n+    ConditionNodes -->|查询数据| QueryChannel\r\n+    ExecutionNodes -->|订阅事件| EventChannel\r\n+    ExecutionNodes -->|1对1通讯| MessageChannel\r\n+    ExecutionNodes -->|查询数据| QueryChannel\r\n+    ExecutionNodes -->|接收数据| PushChannel\r\n+    VisualNodes -->|订阅事件| EventChannel\r\n+    VisualNodes -->|接收数据| PushChannel\r\n+    \r\n+    QueryChannel -->|查询| UnitDataModule\r\n+    QueryChannel -->|查询| SkillDomainModule\r\n+    QueryChannel -->|查询| TerrainDomainModule\r\n+    QueryChannel -->|查询| GridSystemModule\r\n+    \r\n+    PushChannel -->|推送数据| UnitDataModule\r\n+    SkillDomainModule -->|推送数据| PushChannel\r\n+    TerrainDomainModule -->|推送数据| PushChannel\r\n+    \r\n+    style NodeOrchestrator fill:#c8e6c9\r\n+    style NodeRegistry fill:#e1f5ff\r\n+    style InputNodes fill:#ffebee\r\n+    style ConditionNodes fill:#fff4e1\r\n+    style ExecutionNodes fill:#c8e6c9\r\n+    style VisualNodes fill:#f3e5f5\r\n+    style CommunicationBus fill:#fff4e1\r\n+```\r\n+\r\n+### 节点编排器职责\r\n+\r\n+1. **节点注册管理**\r\n+   - 管理节点注册表（NodeRegistry）\r\n+   - 支持动态注册/注销节点\r\n+   - 提供节点查找接口（按ID、按类型）\r\n+\r\n+2. **流程编排**\r\n+   - 根据FlowConfig动态组织节点执行顺序\r\n+   - 处理节点间的跳转、条件分支、循环\r\n+   - 管理节点执行状态和生命周期\r\n+\r\n+3. **Context管理**\r\n+   - 在节点间传递UnitContext\r\n+   - 管理Context的生命周期\r\n+   - 处理Context状态恢复\r\n+\r\n+4. **错误处理**\r\n+   - 处理节点执行失败\r\n+   - 资源回滚和状态恢复\r\n+   - 错误通知和日志记录\r\n+\r\n+### 节点分类详细设计\r\n+\r\n+#### 输入节点（Input Node）\r\n+\r\n+**职责**：接收玩家输入，不修改数据，只负责输入数据的收集和传递\r\n+\r\n+**节点列表**：\r\n+1. **ReceiveMoveInputNode**：接收玩家点击的网格坐标\r\n+2. **ReceiveSkillSelectNode**：接收玩家选择的技能ID\r\n+3. **ReceiveTargetSelectNode**：接收玩家选择的目标（单位、位置等）\r\n+\r\n+**节点接口**：\r\n+- `Execute(context) -> result`：接收输入，返回输入数据和有效性\r\n+- `WaitForInput(context) -> input`：等待玩家输入（异步）\r\n+- `ValidateInput(input) -> bool`：验证输入有效性\r\n+\r\n+#### 条件节点（Condition Node）\r\n+\r\n+**职责**：验证、检查、判断，不修改数据，返回判断结果和流程控制建议\r\n+\r\n+**节点列表**：\r\n+1. **CheckMovePointNode**：检查单位是否有足够的移动点数\r\n+2. **CheckActionPointNode**：检查单位是否有足够的行动点数\r\n+3. **ValidateMoveNode**：验证移动输入是否合法（位置、路径、范围等）\r\n+4. **ValidateSkillNode**：验证技能是否可释放\r\n+5. **ValidateTargetNode**：验证目标是否合法（距离、状态、条件等）\r\n+6. **CheckResourceNode**：检查单位是否还有资源继续行动\r\n+\r\n+**返回结果结构**：\r\n+```lua\r\n+{\r\n+    success: true/false,           -- 判断结果\r\n+    data: {...},                   -- 判断数据（可选）\r\n+    nextAction: \"continue\"/\"end\"/\"skip\", -- 流程控制建议（可选）\r\n+    loopState: \"ACTION\"/\"END\"      -- 循环状态建议（可选）\r\n+}\r\n+```\r\n+\r\n+#### 执行节点（Execution Node）\r\n+\r\n+**职责**：实际执行操作，修改数据，返回执行结果\r\n+\r\n+**节点列表**：\r\n+1. **InitUnitNode**：初始化单位行动状态，重置行动点数和移动点数\r\n+2. **MoveNode**：执行移动并更新单位位置，消耗移动点数\r\n+3. **SelectSkillNode**：显示可用的技能列表，准备技能释放上下文\r\n+4. **SelectTargetNode**：根据技能类型显示可选目标，更新技能上下文中的目标信息\r\n+5. **ExecuteSkillNode**：调用技能领域执行技能，处理技能执行结果\r\n+6. **ConsumeResourceNode**：消耗行动点数和资源，记录资源消耗信息\r\n+7. **UpdateStateNode**：批量处理所有状态变更数据，更新单位状态\r\n+\r\n+**节点接口**：\r\n+- `Execute(context) -> result`：执行操作\r\n+- `CanExecute(context) -> bool`：检查是否可以执行\r\n+- `Rollback(context)`：回滚操作（失败时）\r\n+\r\n+#### 可视化节点（Visual Node）\r\n+\r\n+**职责**：播放表现，不修改数据，只负责视觉反馈\r\n+\r\n+**节点列表**：\r\n+1. **PlayMoveVisualNode**：通知VisualSystem播放移动表现\r\n+2. **PlaySkillVisualNode**：通知VisualSystem播放技能释放表现\r\n+3. **PlayTargetVisualNode**：通知VisualSystem播放受攻击单位表现\r\n+\r\n+**节点接口**：\r\n+- `Execute(context) -> result`：播放表现\r\n+- `WaitForComplete(context) -> bool`：等待表现完成（可选）\r\n+\r\n+### 节点编排流程示例\r\n+\r\n+```mermaid\r\n+flowchart TD\r\n+    Start[开始] --> Init[InitUnitNode<br/>初始化单位]\r\n+    \r\n+    Init --> CheckMove{CheckMovePointNode<br/>检查移动点数}\r\n+    CheckMove -->|有移动点数| ReceiveMove[ReceiveMoveInputNode<br/>接收移动输入]\r\n+    CheckMove -->|无移动点数| SelectSkill\r\n+    \r\n+    ReceiveMove --> ValidateMove{ValidateMoveNode<br/>验证移动}\r\n+    ValidateMove -->|验证通过| Move[MoveNode<br/>执行移动]\r\n+    ValidateMove -->|验证失败| ReceiveMove\r\n+    \r\n+    Move --> PlayMove[PlayMoveVisualNode<br/>播放移动表现]\r\n+    PlayMove --> SelectSkill[SelectSkillNode<br/>选择技能]\r\n+    \r\n+    SelectSkill --> ReceiveSkill[ReceiveSkillSelectNode<br/>接收技能选择]\r\n+    ReceiveSkill --> ValidateSkill{ValidateSkillNode<br/>验证技能}\r\n+    ValidateSkill -->|验证通过| SelectTarget[SelectTargetNode<br/>选择目标]\r\n+    ValidateSkill -->|验证失败| SelectSkill\r\n+    \r\n+    SelectTarget --> ReceiveTarget[ReceiveTargetSelectNode<br/>接收目标选择]\r\n+    ReceiveTarget --> ValidateTarget{ValidateTargetNode<br/>验证目标}\r\n+    ValidateTarget -->|验证通过| Consume[ConsumeResourceNode<br/>消耗资源]\r\n+    ValidateTarget -->|验证失败| SelectTarget\r\n+    \r\n+    Consume --> Execute[ExecuteSkillNode<br/>执行技能]\r\n+    Execute --> Update[UpdateStateNode<br/>更新状态]\r\n+    Update --> PlaySkill[PlaySkillVisualNode<br/>播放技能表现]\r\n+    PlaySkill --> PlayTarget[PlayTargetVisualNode<br/>播放目标表现]\r\n+    \r\n+    PlayTarget --> CheckResource{CheckResourceNode<br/>检查资源}\r\n+    CheckResource -->|还有资源| CheckMove\r\n+    CheckResource -->|无资源| End[结束]\r\n+    \r\n+    style Init fill:#c8e6c9\r\n+    style CheckMove fill:#fff4e1\r\n+    style ReceiveMove fill:#ffebee\r\n+    style ValidateMove fill:#fff4e1\r\n+    style Move fill:#c8e6c9\r\n+    style PlayMove fill:#f3e5f5\r\n+    style SelectSkill fill:#c8e6c9\r\n+    style ReceiveSkill fill:#ffebee\r\n+    style ValidateSkill fill:#fff4e1\r\n+    style SelectTarget fill:#c8e6c9\r\n+    style ReceiveTarget fill:#ffebee\r\n+    style ValidateTarget fill:#fff4e1\r\n+    style Consume fill:#c8e6c9\r\n+    style Execute fill:#c8e6c9\r\n+    style Update fill:#c8e6c9\r\n+    style PlaySkill fill:#f3e5f5\r\n+    style PlayTarget fill:#f3e5f5\r\n+    style CheckResource fill:#fff4e1\r\n+    style End fill:#ffebee\r\n+```\r\n+\r\n+### 节点间通讯机制\r\n+\r\n+#### 1. Context传递（同步）\r\n+\r\n+**设计**：节点编排器负责在节点间传递UnitContext\r\n+\r\n+- 节点执行时接收Context\r\n+- 节点执行后增强Context并返回\r\n+- 编排器根据结果决定下一个节点\r\n+\r\n+#### 2. EventChannel（异步）\r\n+\r\n+**设计**：节点可以发布事件，其他节点可以订阅\r\n+\r\n+- 支持解耦的事件通知\r\n+- 事件类型：`UNIT_MOVE_COMPLETED`、`SKILL_EXECUTED`、`RESOURCE_CONSUMED`、`STATE_UPDATED`\r\n+\r\n+#### 3. MessageChannel（同步，1对1）\r\n+\r\n+**设计**：节点间需要直接通讯时使用\r\n+\r\n+- 1对1单向消息传递\r\n+- 支持请求-响应模式\r\n+\r\n+#### 4. QueryChannel（同步查询）\r\n+\r\n+**设计**：节点通过QueryChannel查询数据模块\r\n+\r\n+- 条件节点查询单位属性、技能状态\r\n+- 执行节点查询移动范围、技能范围\r\n+\r\n+#### 5. PushChannel（批量数据推送）\r\n+\r\n+**设计**：数据模块通过PushChannel推送数据变更\r\n+\r\n+- 执行节点接收技能效果数据、状态变更数据\r\n+- 可视化节点接收数据变更通知\r\n+\r\n+### 节点实现细节\r\n+\r\n+#### UnitContext逐步增强过程\r\n+\r\n+单位行动流程的核心是UnitContext的维护和管理，Context在节点间流转并逐步增强：\r\n+\r\n+```\r\n+UnitContext（节点1：单位循环开始）\r\n+  + unitData（单位数据）\r\n+  + roundContext（回合上下文）\r\n+  ↓\r\n+  + currentUnit（当前行动单位）\r\n+  + unitValidation（单位验证结果）\r\n+  ↓\r\n+  + moveInput（移动输入：点击坐标）\r\n+  + moveValidation（移动验证结果）\r\n+  + movePath（移动路径）\r\n+  + moveResult（移动结果）\r\n+  ↓\r\n+  + selectedSkill（选中的技能）\r\n+  + skillValidation（技能验证结果）\r\n+  + skillContext（技能上下文）\r\n+  ↓\r\n+  + selectedTargets（选中的目标）\r\n+  + targetValidation（目标验证结果）\r\n+  ↓\r\n+  + skillExecutionResult（技能执行结果）\r\n+  + resourceConsumption（资源消耗信息）\r\n+  ↓\r\n+  + visualResult（表现播放结果）\r\n+  + effectResults（效果处理结果）\r\n+  + resourceCheck（资源检查结果）\r\n+  + loopState（循环状态）\r\n+  ↓\r\n+UnitContext（节点7：执行施法后处理）\r\n+```\r\n+\r\n+#### 节点内部架构设计原则\r\n+\r\n+**管道过滤器模式**：\r\n+- 单Context设计：所有节点使用统一的`UnitContext`\r\n+- 逐步增强：每个节点在Context中添加自己的数据\r\n+- 数据流循环：节点1 → 节点2 → ... → 节点7 → 节点3（循环）\r\n+\r\n+**节点内部组件设计**：\r\n+- **输入接收器**：接收外部输入，验证输入有效性\r\n+- **验证器组**：负责各种验证（范围、路径、资源等）\r\n+- **执行器**：负责实际执行操作\r\n+- **数据更新器**：负责更新数据\r\n+- **表现通知器**：负责通知表现层\r\n+- **上下文增强器**：负责增强Context并传递给下一个节点\r\n+- **循环推动器**：负责推动循环状态转换\r\n+\r\n+#### 错误处理和恢复机制\r\n+\r\n+**错误类型**：\r\n+1. **资源错误**：资源不足、资源被消耗等\r\n+2. **验证错误**：验证失败、状态不合法等\r\n+3. **执行错误**：执行失败、异常等\r\n+4. **系统错误**：系统异常、外部系统错误等\r\n+\r\n+**错误处理流程**：\r\n+1. **资源回滚**：执行失败时，回滚已消耗的资源\r\n+2. **状态恢复**：从Context恢复节点执行前的状态\r\n+3. **错误通知**：通知用户错误信息，提供重试或取消选项\r\n+4. **日志记录**：记录错误信息到Context，便于调试和问题追踪\r\n+\r\n+**节点状态机**：\r\n+- **IDLE**：节点未开始执行\r\n+- **EXECUTING**：节点正在执行\r\n+- **COMPLETED**：节点执行完成\r\n+- **FAILED**：节点执行失败\r\n+\r\n+---\r\n+\r\n+## 外部系统集成\r\n+\r\n+### SkillDomain（技能领域）集成\r\n+\r\n+**集成方式**：\r\n+- **调用方式**：ActionCoordinator调用SkillDomain执行技能\r\n+- **数据推送**：SkillDomain的EffectHandler通过DataHandleQueue推送效果数据\r\n+- **数据查询**：节点通过QueryChannel查询技能状态\r\n+\r\n+### TerrainDomain（地形领域）集成\r\n+\r\n+**集成方式**：\r\n+- **调用方式**：ActionCoordinator调用TerrainDomain处理地形要素\r\n+- **数据推送**：TerrainDomain的EffectHandler通过DataHandleQueue推送效果数据\r\n+- **共享Handler机制**：与SkillDomain共享Handler接口，但保持独立系统\r\n+\r\n+### GridSystem（网格系统）集成\r\n+\r\n+**集成方式**：\r\n+- **调用方式**：ActionCoordinator调用GridSystem进行移动计算\r\n+- **数据查询**：节点通过QueryChannel查询移动范围、路径信息\r\n+\r\n+### VisualSystem（表现系统）集成\r\n+\r\n+**集成方式**：\r\n+- **通知方式**：ActionCoordinator通知VisualSystem播放表现\r\n+- **事件订阅**：可视化节点订阅EventChannel接收表现事件\r\n+\r\n+\r\n+### 设计原则总结\r\n+\r\n+- ✅ **Domain controls Loop**：Domain控制循环，循环是Domain的工具\r\n+- ✅ **数据驱动架构**：战斗特性通过配置数据实现，无需额外机制\r\n+- ✅ **节点编排模式**：单位行动流程通过节点编排器动态组织\r\n+- ✅ **解耦设计**：节点间通过CommunicationBus和Context通信，不直接依赖\r\n+- ✅ **多层循环架构**：战斗→回合→单位三层循环架构\r\n+- ✅ **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n+- ✅ **统一数据访问**：节点通过CommunicationBus统一获取数据\r\n+\r\n+---\r\n+\r\n+## 总结\r\n+\r\n+### 架构设计价值\r\n+\r\n+该架构设计文档的价值在于：\r\n+- ✅ **思路解构**：完整解构回合制战斗系统的搭建思路\r\n+- ✅ **流程验证**：从架构层面验证流程合理性\r\n+- ✅ **问题识别**：提前识别潜在的资源和状态问题\r\n+- ✅ **开发指导**：为后续详细设计和实现提供清晰指导\r\n+\r\n+### 架构特点\r\n+\r\n+- ✅ **多层循环架构**：战斗→回合→单位三层循环架构\r\n+- ✅ **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n+- ✅ **统一数据访问**：节点通过CommunicationBus统一获取数据\r\n+- ✅ **错误处理防护**：资源回滚 + 状态恢复 + 错误通知，避免状态不一致\r\n+- ✅ **数据驱动**：所有特性通过配置数据实现，无需修改代码\r\n+\r\n+细节实现是后续开发阶段的工作，当前架构设计已足够指导整个回合制战斗系统的开发。\r\n"
                },
                {
                    "date": 1767182259999,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -896,47 +896,8 @@\n     style PlayTarget fill:#f3e5f5\r\n     style CheckResource fill:#fff4e1\r\n     style End fill:#ffebee\r\n ```\r\n-\r\n-### 节点间通讯机制\r\n-\r\n-#### 1. Context传递（同步）\r\n-\r\n-**设计**：节点编排器负责在节点间传递UnitContext\r\n-\r\n-- 节点执行时接收Context\r\n-- 节点执行后增强Context并返回\r\n-- 编排器根据结果决定下一个节点\r\n-\r\n-#### 2. EventChannel（异步）\r\n-\r\n-**设计**：节点可以发布事件，其他节点可以订阅\r\n-\r\n-- 支持解耦的事件通知\r\n-- 事件类型：`UNIT_MOVE_COMPLETED`、`SKILL_EXECUTED`、`RESOURCE_CONSUMED`、`STATE_UPDATED`\r\n-\r\n-#### 3. MessageChannel（同步，1对1）\r\n-\r\n-**设计**：节点间需要直接通讯时使用\r\n-\r\n-- 1对1单向消息传递\r\n-- 支持请求-响应模式\r\n-\r\n-#### 4. QueryChannel（同步查询）\r\n-\r\n-**设计**：节点通过QueryChannel查询数据模块\r\n-\r\n-- 条件节点查询单位属性、技能状态\r\n-- 执行节点查询移动范围、技能范围\r\n-\r\n-#### 5. PushChannel（批量数据推送）\r\n-\r\n-**设计**：数据模块通过PushChannel推送数据变更\r\n-\r\n-- 执行节点接收技能效果数据、状态变更数据\r\n-- 可视化节点接收数据变更通知\r\n-\r\n ### 节点实现细节\r\n \r\n #### UnitContext逐步增强过程\r\n \r\n@@ -1070,1107 +1031,4 @@\n - ✅ **错误处理防护**：资源回滚 + 状态恢复 + 错误通知，避免状态不一致\r\n - ✅ **数据驱动**：所有特性通过配置数据实现，无需修改代码\r\n \r\n 细节实现是后续开发阶段的工作，当前架构设计已足够指导整个回合制战斗系统的开发。\r\n-# 战斗系统架构设计文档\r\n-\r\n-## 目录\r\n-\r\n-1. [概述](#概述)\r\n-2. [整体架构](#整体架构)\r\n-3. [战斗领域](#战斗领域)\r\n-4. [回合领域](#回合领域)\r\n-5. [单位领域](#单位领域)\r\n-6. [核心机制](#核心机制)\r\n-7. [数据结构](#数据结构)\r\n-8. [外部系统集成](#外部系统集成)\r\n-9. [实现指南](#实现指南)\r\n-\r\n----\r\n-\r\n-## 概述\r\n-\r\n-### 设计目标\r\n-\r\n-设计一套完整的回合制战斗系统架构，支持DND规则、回合管理、状态机控制、AI决策，实现战斗流程管理、伤害计算、效果应用，提供数据驱动的配置化战斗系统。\r\n-\r\n-### 核心设计理念\r\n-\r\n-#### 1. 多层循环架构为核心\r\n-\r\n-**本质**：战斗系统的核心是多层循环的维护和管理（当前实现为三层）\r\n-\r\n-- **战斗循环**：管理整个战斗的生命周期\r\n-- **回合循环**：管理回合的循环和切换\r\n-- **单位循环**：管理单个单位的行动流程\r\n-- **循环驱动**：所有战斗逻辑都在循环框架内执行\r\n-- **状态维护**：每层循环维护自己的状态，驱动下层循环\r\n-\r\n-#### 2. 数据驱动架构\r\n-\r\n-**本质**：战斗特性通过配置数据实现，无需修改代码\r\n-\r\n-- 战斗规则、伤害计算、效果应用 → 通过配置数据定义\r\n-- 回合流程、状态转换 → 通过配置数据调整\r\n-- 新增战斗机制 → 扩展配置数据即可\r\n-- 战斗平衡 → 调整配置数值即可\r\n-\r\n-#### 3. 分层架构（循环内的功能组织）\r\n-\r\n-**本质**：分层架构是循环内的功能组织方式，不是主要架构\r\n-\r\n-- 功能组织：输入层、决策层、执行层、表现层、管理层\r\n-- 执行位置：所有分层功能都在单位循环内执行\r\n-- 解耦设计：层间通过Context和CommunicationBus通信\r\n-\r\n-#### 4. Domain controls Loop\r\n-\r\n-**核心原则**：Domain控制循环，循环是Domain的工具\r\n-\r\n-- Domain是领域核心，拥有循环机制来推进业务流程\r\n-- Domain管理通过协调器控制循环状态转换\r\n-- 协调器执行完业务后，主动推动循环进入下一个状态\r\n-\r\n----\r\n-\r\n-## 整体架构\r\n-\r\n-### 多层循环架构\r\n-\r\n-**核心观点**：整个回合制战斗系统的核心是维护多层循环，所有战斗逻辑都在循环框架内执行。\r\n-\r\n-#### Domain与循环的关系\r\n-\r\n-**术语说明**：使用\"Domain\"而非\"Entity\"，避免与项目中的\"Unit\"概念混淆。\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    subgraph BattleDomain[\"战斗Domain<br/>Battle Domain\"]\r\n-        BattleManagement[战斗管理<br/>结算奖励/同步任务]\r\n-        BattleLoop[\"战斗循环<br/>BattleLoop\"]\r\n-        BattleManagement -->|控制| BattleLoop\r\n-        BattleLoop -->|推进| BattleManagement\r\n-        \r\n-        subgraph RoundDomain[\"回合Domain<br/>Round Domain\"]\r\n-            RoundManagement[回合管理<br/>行动值排序/单位行动顺序]\r\n-            RoundLoop[\"回合循环<br/>RoundLoop\"]\r\n-            RoundManagement -->|控制| RoundLoop\r\n-            RoundLoop -->|推进| RoundManagement\r\n-            \r\n-            subgraph UnitDomain[\"单位Domain<br/>Unit Domain\"]\r\n-                UnitManagement[单位管理<br/>移动/施法/选择技能对象]\r\n-                UnitLoop[\"单位循环<br/>UnitLoop\"]\r\n-                UnitManagement -->|控制| UnitLoop\r\n-                UnitLoop -->|推进| UnitManagement\r\n-            end\r\n-        end\r\n-    end\r\n-    \r\n-    style BattleDomain fill:#ffebee\r\n-    style RoundDomain fill:#fff4e1\r\n-    style UnitDomain fill:#e1f5ff\r\n-    style BattleLoop fill:#f3e5f5\r\n-    style RoundLoop fill:#f3e5f5\r\n-    style UnitLoop fill:#f3e5f5\r\n-```\r\n-\r\n-**备注**：\r\n-- **三层架构**：当前实现为三层架构（战斗→回合→单位），符合DND规则中所有单位按先攻值统一排序的设计\r\n-- **阵营循环**：在标准DND规则中，所有单位按先攻值（Initiative）统一排序行动，不存在阵营循环。此处保留作为扩展设计，便于后续支持阵营差异行为\r\n-\r\n-#### Domain协作关系\r\n-\r\n-**核心观点**：Domain之间通过协作推进业务流程，父Domain调用子Domain，子Domain完成业务后返回父Domain。\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    BattleDomain[战斗Domain<br/>Battle Domain]\r\n-    RoundDomain[回合Domain<br/>Round Domain]\r\n-    UnitDomain[单位Domain<br/>Unit Domain]\r\n-    \r\n-    BattleDomain -->|1. 调用| RoundDomain\r\n-    RoundDomain -->|2. 返回| BattleDomain\r\n-    RoundDomain -->|3. 调用| UnitDomain\r\n-    UnitDomain -->|4. 返回| RoundDomain\r\n-    \r\n-    BattleDomain -.->|包含| RoundDomain\r\n-    RoundDomain -.->|包含| UnitDomain\r\n-    \r\n-    style BattleDomain fill:#ffebee\r\n-    style RoundDomain fill:#fff4e1\r\n-    style UnitDomain fill:#e1f5ff\r\n-```\r\n-\r\n-**协作流程说明**：\r\n-1. **战斗Domain** → 调用 **回合Domain**：战斗进行中，需要执行回合\r\n-2. **回合Domain** → 调用 **单位Domain**：回合进行中，需要处理单位行动\r\n-3. **单位Domain** → 返回 **回合Domain**：单位行动完成\r\n-4. **回合Domain** → 返回 **战斗Domain**：回合完成\r\n-\r\n-**协作原则**：\r\n-- 父Domain控制子Domain的调用时机\r\n-- 子Domain完成业务后主动返回父Domain\r\n-- 每个Domain独立管理自己的业务逻辑和循环\r\n-\r\n-### 循环职责说明\r\n-\r\n-#### 1. 战斗循环（BattleLoop）\r\n-- **职责**：管理整个战斗的生命周期\r\n-- **状态**：PREPARING → IN_PROGRESS → ENDED\r\n-- **维护**：BattleLoopManager\r\n-\r\n-#### 2. 回合循环（RoundLoop）\r\n-- **职责**：管理回合的循环和切换\r\n-- **状态**：START → ACTION → END\r\n-- **维护**：RoundLoopManager\r\n-\r\n-#### 3. 单位循环（UnitLoop）\r\n-- **职责**：管理单个单位的行动流程\r\n-- **状态**：START → ACTION → END\r\n-- **维护**：UnitLoopManager\r\n-\r\n----\r\n-\r\n-## 战斗领域\r\n-\r\n-### 核心职责\r\n-\r\n-战斗领域负责管理整个战斗的生命周期，包括战斗初始化、战斗流程控制、战斗结束判断、奖励结算、任务同步等。\r\n-\r\n-### 架构结构\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    subgraph BattleDomain[\"战斗Domain<br/>Battle Domain\"]\r\n-        BattleManagement[战斗管理<br/>BattleManagement]\r\n-        BattleLoop[战斗循环<br/>BattleLoop<br/>PREPARING → IN_PROGRESS → ENDED]\r\n-        RoundCoordinator[回合协调器<br/>RoundCoordinator<br/>微核心：只负责协调调用]\r\n-        \r\n-        subgraph BattleManagement[\"战斗管理<br/>BattleManagement\"]\r\n-            BattleData[战斗数据<br/>BattleData]\r\n-            DataMgr[战斗数据管理<br/>战斗状态/回合历史/活跃阵营]\r\n-            RuleMgr[战斗规则管理<br/>战斗开始/结束条件/胜利条件/失败条件]\r\n-            RewardMgr[奖励管理<br/>奖励结算/任务同步]\r\n-        end\r\n-    end\r\n-    \r\n-    subgraph ExternalSystems[\"外部系统\"]\r\n-        RoundDomain[回合领域<br/>Round Domain]\r\n-        RewardSystem[奖励系统<br/>Reward System]\r\n-        TaskSystem[任务系统<br/>Task System]\r\n-    end\r\n-    \r\n-    BattleManagement -->|控制| BattleLoop\r\n-    BattleManagement --> RoundCoordinator\r\n-    RoundCoordinator -->|反向推动| BattleLoop\r\n-    BattleLoop -->|推进| BattleManagement\r\n-    \r\n-    RoundCoordinator -->|调用| RoundDomain\r\n-    RoundDomain -->|返回| RoundCoordinator\r\n-    \r\n-    BattleManagement -->|结算奖励| RewardSystem\r\n-    BattleManagement -->|同步任务| TaskSystem\r\n-    \r\n-    style BattleDomain fill:#ffebee\r\n-    style BattleManagement fill:#ffebee\r\n-    style BattleLoop fill:#f3e5f5\r\n-    style RoundCoordinator fill:#c8e6c9\r\n-```\r\n-\r\n-### 战斗管理（BattleManagement）\r\n-\r\n-#### 1. 战斗数据管理\r\n-- **战斗状态**：当前战斗状态（PREPARING/IN_PROGRESS/ENDED）\r\n-- **回合历史**：记录已完成的回合历史（`roundHistoryQueue`）\r\n-- **活跃阵营列表**：当前战斗中活跃的阵营ID列表（`activeFactionIDs`）\r\n-- **突袭回合阵营列表**：被突袭的阵营ID列表（`surpriseRoundFactionIDs`）\r\n-\r\n-#### 2. 战斗规则管理\r\n-- **战斗开始条件**：检查是否可以开始战斗\r\n-- **战斗结束条件**：检查是否应该结束战斗\r\n-- **胜利条件**：检查是否满足胜利条件（`CheckVictoryCondition`）\r\n-- **失败条件**：检查是否满足失败条件（`CheckDefeatCondition`）\r\n-\r\n-#### 3. 奖励管理\r\n-- **奖励结算**：战斗结束后结算奖励\r\n-- **任务同步**：同步战斗相关的任务进度\r\n-\r\n-### 战斗循环（BattleLoop）\r\n-\r\n-**循环状态**：PREPARING → IN_PROGRESS → ENDED\r\n-\r\n-- **PREPARING**：战斗准备中，初始化战斗数据\r\n-- **IN_PROGRESS**：战斗进行中，执行回合（调用回合领域）\r\n-- **ENDED**：战斗已结束，结算奖励、同步任务\r\n-\r\n-### 回合协调器（RoundCoordinator）\r\n-\r\n-**核心原则**：只负责协调调用，不包含业务规则\r\n-\r\n-**核心职责**：\r\n-- ✅ **协调调用**：调用回合领域执行回合\r\n-- ✅ **反向推动循环**：回合完成后，主动推动战斗循环进入下一个状态（Domain controls Loop）\r\n-\r\n-### 战斗完整流程\r\n-\r\n-```mermaid\r\n-flowchart TD\r\n-    LoopPreparing[LoopPreparing<br/>战斗准备] --> InitBattle[初始化战斗数据<br/>战斗管理初始化]\r\n-    \r\n-    InitBattle --> LoopProgress[LoopProgress<br/>战斗进行中]\r\n-    \r\n-    LoopProgress --> CallRound[调用回合领域<br/>回合协调器调用回合领域]\r\n-    \r\n-    CallRound --> RoundAction[回合领域执行回合<br/>回合领域完成回合]\r\n-    \r\n-    RoundAction --> PushProgress[回合协调器推动循环<br/>推动到IN_PROGRESS状态继续]\r\n-    \r\n-    PushProgress --> CheckEnd{检查战斗结束条件<br/>战斗管理检查}\r\n-    \r\n-    CheckEnd -->|未结束| CallRound\r\n-    CheckEnd -->|已结束| PushEnd[回合协调器推动循环<br/>推动到ENDED状态]\r\n-    \r\n-    PushEnd --> LoopEnd[LoopEnd<br/>战斗结束]\r\n-    \r\n-    LoopEnd --> Reward[结算奖励<br/>奖励管理结算奖励]\r\n-    Reward --> Task[同步任务<br/>任务管理同步任务]\r\n-    Task --> Complete[战斗完成]\r\n-    \r\n-    style LoopPreparing fill:#ffebee\r\n-    style LoopProgress fill:#ffebee\r\n-    style CallRound fill:#c8e6c9\r\n-    style RoundAction fill:#c8e6c9\r\n-    style PushProgress fill:#f3e5f5\r\n-    style PushEnd fill:#f3e5f5\r\n-    style LoopEnd fill:#ffebee\r\n-    style CheckEnd fill:#ffe0b2\r\n-```\r\n-\r\n----\r\n-\r\n-## 回合领域\r\n-\r\n-### 核心职责\r\n-\r\n-回合领域负责管理回合的循环和切换，包括回合数管理、行动顺序管理（基于先攻值）、回合开始/结束控制等。\r\n-\r\n-### 架构结构\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    subgraph RoundDomain[\"回合Domain<br/>Round Domain\"]\r\n-        RoundManagement[回合管理<br/>RoundManagement]\r\n-        RoundLoop[回合循环<br/>RoundLoop<br/>START → ACTION → END]\r\n-        UnitCoordinator[单位协调器<br/>UnitCoordinator<br/>微核心：只负责协调调用]\r\n-        \r\n-        subgraph RoundManagement[\"回合管理<br/>RoundManagement\"]\r\n-            RoundData[回合数据<br/>RoundData]\r\n-            DataMgr[回合数据管理<br/>回合数/行动顺序队列]\r\n-            RuleMgr[回合规则管理<br/>回合开始/结束条件]\r\n-            OrderMgr[行动顺序管理<br/>队列初始化/管理/获取下一个单位]\r\n-        end\r\n-        \r\n-        subgraph UnitCoordinator[\"单位协调器<br/>UnitCoordinator<br/>微核心：只负责协调调用\"]\r\n-            UnitCall[单位调用<br/>从回合管理获取单位<br/>调用单位领域]\r\n-        end\r\n-    end\r\n-    \r\n-    subgraph ExternalSystems[\"外部系统\"]\r\n-        BattleDomain[战斗领域<br/>Battle Domain]\r\n-        UnitDomain[单位领域<br/>Unit Domain]\r\n-    end\r\n-    \r\n-    BattleDomain -->|控制| RoundDomain\r\n-    RoundManagement -->|控制| RoundLoop\r\n-    RoundManagement --> UnitCoordinator\r\n-    UnitCoordinator -->|反向推动| RoundLoop\r\n-    RoundLoop -->|推进| RoundManagement\r\n-    \r\n-    UnitCoordinator -->|调用| UnitDomain\r\n-    UnitDomain -->|返回| UnitCoordinator\r\n-    \r\n-    style RoundDomain fill:#fff4e1\r\n-    style RoundManagement fill:#fff4e1\r\n-    style RoundLoop fill:#f3e5f5\r\n-    style UnitCoordinator fill:#c8e6c9\r\n-    style RoundData fill:#e1f5ff\r\n-```\r\n-\r\n-### 回合管理（RoundManagement）\r\n-\r\n-#### 1. 回合数据管理\r\n-- **回合数**：当前回合数、总回合数\r\n-- **行动顺序队列**：基于先攻值的优先级队列（TurnQueue）\r\n-- **当前行动单位**：当前正在行动的单位\r\n-- **活跃阵营列表**：当前回合中活跃的阵营ID列表\r\n-\r\n-#### 2. 回合规则管理\r\n-- **回合开始条件**：检查是否可以开始新回合\r\n-- **回合结束条件**：检查是否应该结束当前回合（所有单位行动完成）\r\n-- **回合切换规则**：判断是否还有下一个回合\r\n-- **突袭回合规则**：战斗开始时，只有被突袭的阵营才能行动（Surprise Round）\r\n-- **单位存活检查**：只有存活的单位才能参与回合（`unit:IsAlive()`）\r\n-- **活跃阵营过滤**：只有活跃的阵营才能参与回合（`activeFactionIDs`）\r\n-\r\n-#### 3. 行动顺序管理\r\n-- **初始化队列**：回合开始时，根据先攻值初始化行动顺序队列\r\n-  - **突袭回合处理**：战斗开始时，只有被突袭的阵营单位加入队列\r\n-  - **正常回合处理**：正常回合中，所有活跃阵营的存活单位加入队列\r\n-- **队列管理**：管理行动顺序队列的添加、移除、清空\r\n-- **获取下一个单位**：从行动顺序队列中获取下一个行动单位（自动过滤死亡单位）\r\n-- **下一个单位检查**：检查是否还有下一个行动单位\r\n-- **延迟行动管理**：管理延迟行动的单位列表，在适当时候插入到行动顺序中\r\n-\r\n-### 回合循环（RoundLoop）\r\n-\r\n-**循环状态**：START → ACTION → END\r\n-\r\n-- **START**：回合开始，初始化行动顺序队列\r\n-  - **突袭回合**：只有被突袭的阵营单位加入队列\r\n-  - **正常回合**：所有活跃阵营的存活单位加入队列\r\n-- **ACTION**：执行回合行动（调用单位领域）\r\n-- **END**：回合结束，清理回合数据，处理延迟行动\r\n-\r\n-### 单位协调器（UnitCoordinator）\r\n-\r\n-**核心原则**：只负责协调调用，不包含业务规则\r\n-\r\n-**核心职责**：\r\n-- ✅ **协调调用**：从回合管理获取下一个单位，调用单位领域执行单位行动\r\n-- ✅ **反向推动循环**：单位行动完成后，主动推动回合循环进入下一个状态（Domain controls Loop）\r\n-\r\n-#### 循环推动机制\r\n-- **推动到END**：所有单位行动完成后，推动循环从ACTION状态进入END状态\r\n-- **推动到START**：回合结束时，推动循环从END状态进入START状态（下一个回合）\r\n-- **推动到ACTION**：回合开始时，推动循环从START状态进入ACTION状态\r\n-\r\n-### 回合完整流程\r\n-\r\n-```mermaid\r\n-flowchart TD\r\n-    LoopStart[LoopStart<br/>战斗领域推动循环] --> InitQueue[初始化行动顺序队列<br/>回合管理根据先攻值排序]\r\n-    \r\n-    InitQueue --> LoopAction[LoopAction<br/>执行回合行动]\r\n-    \r\n-    LoopAction --> GetNextUnit{获取下一个单位<br/>回合管理从队列获取}\r\n-    \r\n-    GetNextUnit -->|有单位| CallUnit[调用单位领域<br/>单位协调器调用单位领域]\r\n-    GetNextUnit -->|无单位| PushEnd\r\n-    \r\n-    CallUnit --> UnitAction[单位领域执行行动<br/>单位领域完成行动]\r\n-    \r\n-    UnitAction --> PushAction[单位协调器推动循环<br/>推动到ACTION状态继续]\r\n-    \r\n-    PushAction --> GetNextUnit\r\n-    \r\n-    PushEnd[单位协调器推动循环<br/>推动到END状态]\r\n-    \r\n-    PushEnd --> RoundEnd[LoopEnd<br/>回合结束]\r\n-    \r\n-    RoundEnd --> CheckNextRound{检查下一个回合<br/>回合管理检查是否还有下一个回合}\r\n-    \r\n-    CheckNextRound -->|有下一个回合| PushStart[单位协调器推动循环<br/>推动到START状态]\r\n-    CheckNextRound -->|无下一个回合| EndRound[结束回合循环<br/>返回战斗领域]\r\n-    \r\n-    PushStart --> LoopStart\r\n-    \r\n-    style LoopStart fill:#fff4e1\r\n-    style LoopAction fill:#fff4e1\r\n-    style CallUnit fill:#c8e6c9\r\n-    style UnitAction fill:#c8e6c9\r\n-    style PushAction fill:#f3e5f5\r\n-    style PushEnd fill:#f3e5f5\r\n-    style PushStart fill:#f3e5f5\r\n-    style LoopEnd fill:#fff4e1\r\n-    style GetNextUnit fill:#ffe0b2\r\n-    style CheckNextRound fill:#ffe0b2\r\n-```\r\n-\r\n-**关键点**：\r\n-- ✅ **Domain controls Loop**：回合管理通过单位协调器控制循环状态转换\r\n-- ✅ **反向推动机制**：单位协调器执行完单位行动后，主动推动循环进入下一个状态\r\n-- ✅ **单位协调器不处理业务规则**：只负责协调调用单位领域，不处理回合业务逻辑\r\n-- ✅ **行动顺序管理**：回合管理负责基于先攻值的优先级队列，确保单位按正确顺序行动\r\n-- ✅ **队列驱动**：通过行动顺序队列驱动单位行动，队列为空时回合结束\r\n-\r\n-### 职责划分\r\n-\r\n-| 组件 | 职责 | 说明 |\r\n-|------|------|------|\r\n-| **回合管理** | 回合数据与规则 | 管理回合数、行动顺序队列、回合开始/结束规则、队列管理 |\r\n-| **单位协调器** | 协调调用 | 从回合管理获取单位，调用单位领域，不处理回合业务规则 |\r\n-| **回合循环** | 流程控制 | START/ACTION/END状态转换，由回合管理控制 |\r\n-\r\n----\r\n-\r\n-## 单位领域\r\n-\r\n-### 核心职责\r\n-\r\n-单位领域是战斗系统的核心，负责管理单个单位的行动流程，包括移动、技能释放、数值控制等。\r\n-\r\n-### 架构结构\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    subgraph UnitDomain[\"单位Domain<br/>Unit Domain\"]\r\n-        UnitManagement[单位管理<br/>UnitManagement]\r\n-        UnitLoop[单位循环<br/>UnitLoop<br/>START → ACTION → END]\r\n-        ActionCoordinator[行动协调器<br/>ActionCoordinator<br/>微核心：只负责协调调用]\r\n-        \r\n-        subgraph UnitManagement[\"单位管理<br/>UnitManagement\"]\r\n-            UnitData[单位数据<br/>UnitData]\r\n-            DataMgr[单位数据管理<br/>属性/状态/位置/回合数据<br/>AP/MP/先攻值]\r\n-            RuleMgr[单位规则管理<br/>行动点数规则/移动点数规则<br/>先攻值规则/回合初始化规则]\r\n-        end\r\n-        \r\n-        subgraph DataHandleQueue[\"DataHandleQueue<br/>数据队列<br/>1:1关系\"]\r\n-        end\r\n-        \r\n-        subgraph ActionCoordinator[\"行动协调器<br/>ActionCoordinator<br/>微核心：只负责协调调用\"]\r\n-            MoveCoord[移动协调<br/>调用网格系统]\r\n-            SkillCoord[技能协调<br/>调用技能领域]\r\n-            TerrainCoord[地形交互协调<br/>调用地形领域<br/>可选]\r\n-            VisualCoord[表现协调<br/>通知表现层]\r\n-        end\r\n-    end\r\n-    \r\n-    subgraph ExternalSystems[\"外部系统\"]\r\n-        GridSystem[网格系统<br/>GridSystem]\r\n-        SkillDomain[技能领域<br/>Skill Domain]\r\n-        VisualSystem[表现系统<br/>Visual System]\r\n-        TerrainDomain[地形领域<br/>Terrain Domain]\r\n-    end\r\n-    \r\n-    UnitManagement -->|控制| UnitLoop\r\n-    UnitManagement --> ActionCoordinator\r\n-    UnitManagement --> UnitData\r\n-    ActionCoordinator -->|反向推动| UnitLoop\r\n-    UnitLoop -->|推进| UnitManagement\r\n-    \r\n-    ActionCoordinator -->|调用| GridSystem\r\n-    ActionCoordinator -->|调用| SkillDomain\r\n-    ActionCoordinator -->|调用| TerrainDomain\r\n-    ActionCoordinator -->|通知| VisualSystem\r\n-    \r\n-    SkillDomain -->|EffectHandler推送| DataHandleQueue\r\n-    TerrainDomain -->|EffectHandler推送| DataHandleQueue\r\n-\r\n-    DataHandleQueue -->|推送数据| UnitData\r\n-    \r\n-    style UnitDomain fill:#e1f5ff\r\n-    style UnitManagement fill:#fff4e1\r\n-    style UnitLoop fill:#f3e5f5\r\n-    style ActionCoordinator fill:#c8e6c9\r\n-    style DataHandleQueue fill:#f3e5f5\r\n-    style UnitData fill:#e1f5ff\r\n-```\r\n-\r\n-### 单位管理（UnitManagement）\r\n-\r\n-#### 1. 单位数据管理\r\n-- **单位属性**：生命值、行动点数（AP）、移动点数（MP）、先攻值等\r\n-- **单位状态**：是否可行动、是否已移动、是否已攻击、是否存活等\r\n-- **单位位置**：当前网格位置\r\n-- **回合数据**：UnitTurnData管理行动点数、移动点数、先攻值等回合相关数据\r\n-\r\n-#### 2. 单位规则管理\r\n-- **移动点数规则**：移动前检查能否移动\r\n-- **行动点数规则**：检查行动是否可执行（`CheckAction`），消耗行动点数和移动点数（`ConsumeAction`）\r\n-- **行动规则**：是否可执行行动（移动、攻击、技能等）\r\n-- **状态规则**：状态转换规则（是否存活、是否可行动等）\r\n-- **先攻值规则**：管理单位的先攻值，用于回合顺序排序\r\n-- **回合初始化规则**：回合开始时初始化行动点数和移动点数（`StartUnitTurn`）\r\n-\r\n-#### 3. UnitData与DataHandleQueue关系\r\n-- **1:1关系**：DataHandleQueue 与 UnitData 是 1:1 关系，数据直接修改 UnitData\r\n-- **直接修改**：技能领域的EffectHandler推送数据到DataHandleQueue后，直接修改UnitData\r\n-- **无需中间层**：不需要\"数值控制管理\"中间层，DataHandleQueue直接修改UnitData\r\n-\r\n-### 单位循环（UnitLoop）\r\n-\r\n-**循环状态**：START → ACTION → END\r\n-\r\n-- **START**：单位开始行动\r\n-- **ACTION**：执行行动（移动、技能等）\r\n-- **END**：单位结束行动\r\n-\r\n-### 行动协调器（ActionCoordinator）\r\n-\r\n-**核心原则**：只负责协调调用，不包含业务规则\r\n-\r\n-**核心职责**：\r\n-- ✅ **协调调用**：调用网格系统、技能领域、表现系统\r\n-- ✅ **反向推动循环**：执行完行动后，主动推动单位循环进入下一个状态（Domain controls Loop）\r\n-\r\n-#### 1. 移动协调\r\n-- **移动前检查**：调用单位管理检查移动点数和行动点数\r\n-- **调用网格系统**：进行移动计算（路径查找、移动范围等）\r\n-- **移动后更新**：通过 DataHandleQueue 更新单位位置和移动点数\r\n-- **推动循环**：移动完成后，推动循环进入下一个状态\r\n-\r\n-#### 2. 技能协调\r\n-- **行动点数检查**：调用单位管理检查行动点数是否足够\r\n-- **调用技能领域**：执行技能\r\n-- **不处理数值控制**：数值控制由技能领域的EffectHandler通过DataHandleQueue处理\r\n-- **接收技能结果**：获取技能执行结果（成功/失败），用于流程控制\r\n-- **推动循环**：技能执行完成后，推动循环进入下一个状态\r\n-\r\n-#### 3. 地形交互协调（可选）\r\n-- **地形交互检查**：检查单位是否触发地形要素（陷阱、门等）\r\n-- **调用地形领域**：如果触发地形要素，调用地形领域处理\r\n-- **推动循环**：地形交互完成后，推动循环进入下一个状态\r\n-\r\n-#### 4. 表现协调\r\n-- **通知表现层**：移动表现、技能表现、受攻击表现\r\n-- **推动循环**：表现播放完成后（可选），推动循环进入下一个状态\r\n-\r\n-### 单位行动完整流程\r\n-\r\n-```mermaid\r\n-flowchart TD\r\n-    LoopStart[LoopStart<br/>单位管理推动循环] --> LoopAction[LoopAction<br/>执行行动]\r\n-    \r\n-    LoopAction --> CheckAction{行动前检查<br/>单位管理检查行动点数/移动点数}\r\n-    \r\n-    CheckAction -->|可以移动| Move[单位移动<br/>行动协调器调用网格系统]\r\n-    CheckAction -->|不能移动| Skill\r\n-    \r\n-    Move --> UpdateMove[更新移动点数<br/>DataHandleQueue推送]\r\n-    UpdateMove --> Skill[攻击/治疗<br/>行动协调器调用技能领域]\r\n-    \r\n-    Skill --> EffectPush[EffectHandler推送效果<br/>通过DataHandleQueue到目标单位]\r\n-    EffectPush --> Visual[可视化<br/>行动协调器通知表现层]\r\n-    \r\n-    Visual --> PushEnd[行动协调器推动循环<br/>推动到END状态]\r\n-    \r\n-    PushEnd --> CheckActionPoint{行动点数检查<br/>单位管理检查是否还有行动点数/移动点数}\r\n-    \r\n-    CheckActionPoint -->|还有行动点数/移动点数| PushAction[行动协调器推动循环<br/>推动回ACTION状态]\r\n-    CheckActionPoint -->|无行动点数/移动点数| LoopEnd[LoopEnd<br/>单位结束行动]\r\n-    \r\n-    PushAction --> LoopAction\r\n-    \r\n-    style LoopStart fill:#e1f5ff\r\n-    style LoopAction fill:#e1f5ff\r\n-    style Move fill:#fff4e1\r\n-    style Skill fill:#c8e6c9\r\n-    style EffectPush fill:#fff4e1\r\n-    style Visual fill:#c8e6c9\r\n-    style PushEnd fill:#f3e5f5\r\n-    style PushAction fill:#f3e5f5\r\n-    style LoopEnd fill:#e1f5ff\r\n-    style CheckAction fill:#ffe0b2\r\n-    style CheckActionPoint fill:#ffe0b2\r\n-```\r\n-\r\n-### 数值控制流程（通过 DataHandleQueue）\r\n-\r\n-```mermaid\r\n-flowchart LR\r\n-    ActionCoord[行动协调器<br/>调用技能领域] --> SkillDomain[技能领域<br/>执行技能]\r\n-    SkillDomain --> EffectHandler[EffectHandler<br/>应用效果]\r\n-    TerrainDomain[地形领域<br/>执行地形要素] --> EffectHandler[EffectHandler<br/>应用效果]\r\n-    EffectHandler --> ProcessQueue[DataHandleQueue]\r\n-    ProcessQueue --> UnitData[UnitData<br/>1:1关系<br/>推送修改]\r\n-    UnitData --> UpdateState[更新状态<br/>扣血/加buff]\r\n-    ActionCoord --> TerrainDomain\r\n-    ActionCoord --> 其他领域\r\n-    其他领域 --> EffectHandler\r\n-\r\n-    style ActionCoord fill:#c8e6c9\r\n-    style SkillDomain fill:#c8e6c9\r\n-    style EffectHandler fill:#fff4e1\r\n-    style ProcessQueue fill:#f3e5f5\r\n-    style UnitData fill:#e1f5ff\r\n-    style UpdateState fill:#fff4e1\r\n-```\r\n-\r\n----\r\n-\r\n-## 单位领域：节点编排架构\r\n-\r\n-### 核心设计理念\r\n-\r\n-#### 1. 节点编排器为核心\r\n-\r\n-**本质**：单位行动流程的核心是节点编排器的动态组织和管理\r\n-\r\n-- 单位行动流程 = 节点编排器根据配置动态组织节点执行\r\n-- 节点编排 = 条件节点 → 执行节点 → 可视化节点的组合\r\n-- 流程控制 = 节点编排器根据节点执行结果决定下一个节点\r\n-- 灵活扩展 = 新增节点类型只需注册到编排器\r\n-\r\n-#### 2. 节点分类设计\r\n-\r\n-**本质**：节点按功能职责分为四类，每类节点职责单一、可复用\r\n-\r\n-- **输入节点（Input Node）**：负责接收玩家输入（如：接收移动点击、接收技能选择、接收目标选择等）\r\n-- **条件节点（Condition Node）**：负责验证、检查、判断，返回判断结果和流程控制建议（如：检查移动点数、验证技能可释放、检查资源决定是否继续等）\r\n-- **执行节点（Execution Node）**：负责实际执行操作，修改数据（如：执行移动、执行技能、消耗资源、更新状态等）\r\n-- **可视化节点（Visual Node）**：负责表现播放（如：播放移动表现、播放技能表现等）\r\n-\r\n-#### 3. 节点数据获取机制\r\n-\r\n-**本质**：节点通过 CommunicationBus 统一获取不同模块的数据，实现节点与数据模块的解耦\r\n-\r\n-**核心概念**：\r\n-- **数据访问层**：CommunicationBus 作为节点访问所有数据模块的统一接口\r\n-- **解耦设计**：节点不直接依赖具体的数据模块（UnitData、SkillDomain、TerrainDomain等）\r\n-- **统一接口**：所有数据获取都通过 PushChannel（批量数据推送）和 QueryChannel（同步查询）进行\r\n-- **灵活扩展**：新增数据模块时，只需注册到 CommunicationBus，节点无需修改\r\n-\r\n-**数据获取方式**：\r\n-\r\n-1. **QueryChannel（同步查询）**：用于节点需要立即获取数据的场景\r\n-   - **条件节点**：查询单位属性、技能状态、资源数量等用于验证和检查\r\n-   - **执行节点**：查询移动范围、技能范围、目标信息等用于执行\r\n-\r\n-2. **PushChannel（批量数据推送）**：用于节点需要接收数据变更通知的场景\r\n-   - **执行节点**：接收技能效果数据、状态变更数据等用于执行\r\n-   - **可视化节点**：接收数据变更通知用于更新表现\r\n-\r\n-### 节点编排器架构\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    subgraph UnitDomain[\"单位Domain\"]\r\n-        NodeOrchestrator[节点编排器<br/>NodeOrchestrator]\r\n-        \r\n-        subgraph NodeRegistry[\"节点注册表<br/>NodeRegistry\"]\r\n-            subgraph InputNodes[\"输入节点组<br/>Input Nodes\"]\r\n-                ReceiveMoveInputNode[接收移动输入节点]\r\n-                ReceiveSkillSelectNode[接收技能选择节点]\r\n-                ReceiveTargetSelectNode[接收目标选择节点]\r\n-            end\r\n-            \r\n-            subgraph ConditionNodes[\"条件节点组<br/>Condition Nodes\"]\r\n-                CheckMovePointNode[检查移动点数节点]\r\n-                CheckActionPointNode[检查行动点数节点]\r\n-                ValidateSkillNode[验证技能节点]\r\n-                ValidateTargetNode[验证目标节点]\r\n-                ValidateMoveNode[验证移动节点]\r\n-                CheckResourceNode[检查资源节点]\r\n-            end\r\n-            \r\n-            subgraph ExecutionNodes[\"执行节点组<br/>Execution Nodes\"]\r\n-                InitUnitNode[初始化单位节点]\r\n-                MoveNode[移动节点]\r\n-                SelectSkillNode[选择技能节点]\r\n-                SelectTargetNode[选择目标节点]\r\n-                ExecuteSkillNode[执行技能节点]\r\n-                ConsumeResourceNode[消耗资源节点]\r\n-                UpdateStateNode[更新状态节点]\r\n-            end\r\n-            \r\n-            subgraph VisualNodes[\"可视化节点组<br/>Visual Nodes\"]\r\n-                PlayMoveVisualNode[播放移动表现节点]\r\n-                PlaySkillVisualNode[播放技能表现节点]\r\n-                PlayTargetVisualNode[播放目标表现节点]\r\n-            end\r\n-        end\r\n-        \r\n-        FlowConfig[流程配置<br/>NodeFlowConfig]\r\n-        ContextManager[上下文管理器<br/>ContextManager]\r\n-        \r\n-        subgraph CommunicationBus[\"通讯总线\"]\r\n-            EventChannel[事件通道<br/>EventChannel]\r\n-            MessageChannel[消息通道<br/>MessageChannel]\r\n-            PushChannel[推送通道<br/>PushChannel]\r\n-            QueryChannel[查询通道<br/>QueryChannel]\r\n-        end\r\n-        \r\n-        subgraph DataModules[\"数据模块\"]\r\n-            UnitDataModule[单位数据模块<br/>UnitData]\r\n-            SkillDomainModule[技能领域模块<br/>SkillDomain]\r\n-            TerrainDomainModule[地形领域模块<br/>TerrainDomain]\r\n-            GridSystemModule[网格系统模块<br/>GridSystem]\r\n-        end\r\n-    end\r\n-    \r\n-    NodeOrchestrator -->|管理节点| NodeRegistry\r\n-    NodeOrchestrator -->|读取配置| FlowConfig\r\n-    NodeOrchestrator -->|执行节点| InputNodes\r\n-    NodeOrchestrator -->|执行节点| ConditionNodes\r\n-    NodeOrchestrator -->|执行节点| ExecutionNodes\r\n-    NodeOrchestrator -->|执行节点| VisualNodes\r\n-    NodeOrchestrator -->|管理Context| ContextManager\r\n-    \r\n-    InputNodes -->|发布事件| EventChannel\r\n-    ConditionNodes -->|发布事件| EventChannel\r\n-    ConditionNodes -->|查询数据| QueryChannel\r\n-    ExecutionNodes -->|订阅事件| EventChannel\r\n-    ExecutionNodes -->|1对1通讯| MessageChannel\r\n-    ExecutionNodes -->|查询数据| QueryChannel\r\n-    ExecutionNodes -->|接收数据| PushChannel\r\n-    VisualNodes -->|订阅事件| EventChannel\r\n-    VisualNodes -->|接收数据| PushChannel\r\n-    \r\n-    QueryChannel -->|查询| UnitDataModule\r\n-    QueryChannel -->|查询| SkillDomainModule\r\n-    QueryChannel -->|查询| TerrainDomainModule\r\n-    QueryChannel -->|查询| GridSystemModule\r\n-    \r\n-    PushChannel -->|推送数据| UnitDataModule\r\n-    SkillDomainModule -->|推送数据| PushChannel\r\n-    TerrainDomainModule -->|推送数据| PushChannel\r\n-    \r\n-    style NodeOrchestrator fill:#c8e6c9\r\n-    style NodeRegistry fill:#e1f5ff\r\n-    style InputNodes fill:#ffebee\r\n-    style ConditionNodes fill:#fff4e1\r\n-    style ExecutionNodes fill:#c8e6c9\r\n-    style VisualNodes fill:#f3e5f5\r\n-    style CommunicationBus fill:#fff4e1\r\n-```\r\n-\r\n-### 节点编排器职责\r\n-\r\n-1. **节点注册管理**\r\n-   - 管理节点注册表（NodeRegistry）\r\n-   - 支持动态注册/注销节点\r\n-   - 提供节点查找接口（按ID、按类型）\r\n-\r\n-2. **流程编排**\r\n-   - 根据FlowConfig动态组织节点执行顺序\r\n-   - 处理节点间的跳转、条件分支、循环\r\n-   - 管理节点执行状态和生命周期\r\n-\r\n-3. **Context管理**\r\n-   - 在节点间传递UnitContext\r\n-   - 管理Context的生命周期\r\n-   - 处理Context状态恢复\r\n-\r\n-4. **错误处理**\r\n-   - 处理节点执行失败\r\n-   - 资源回滚和状态恢复\r\n-   - 错误通知和日志记录\r\n-\r\n-### 节点分类详细设计\r\n-\r\n-#### 输入节点（Input Node）\r\n-\r\n-**职责**：接收玩家输入，不修改数据，只负责输入数据的收集和传递\r\n-\r\n-**节点列表**：\r\n-1. **ReceiveMoveInputNode**：接收玩家点击的网格坐标\r\n-2. **ReceiveSkillSelectNode**：接收玩家选择的技能ID\r\n-3. **ReceiveTargetSelectNode**：接收玩家选择的目标（单位、位置等）\r\n-\r\n-**节点接口**：\r\n-- `Execute(context) -> result`：接收输入，返回输入数据和有效性\r\n-- `WaitForInput(context) -> input`：等待玩家输入（异步）\r\n-- `ValidateInput(input) -> bool`：验证输入有效性\r\n-\r\n-#### 条件节点（Condition Node）\r\n-\r\n-**职责**：验证、检查、判断，不修改数据，返回判断结果和流程控制建议\r\n-\r\n-**节点列表**：\r\n-1. **CheckMovePointNode**：检查单位是否有足够的移动点数\r\n-2. **CheckActionPointNode**：检查单位是否有足够的行动点数\r\n-3. **ValidateMoveNode**：验证移动输入是否合法（位置、路径、范围等）\r\n-4. **ValidateSkillNode**：验证技能是否可释放\r\n-5. **ValidateTargetNode**：验证目标是否合法（距离、状态、条件等）\r\n-6. **CheckResourceNode**：检查单位是否还有资源继续行动\r\n-\r\n-**返回结果结构**：\r\n-```lua\r\n-{\r\n-    success: true/false,           -- 判断结果\r\n-    data: {...},                   -- 判断数据（可选）\r\n-    nextAction: \"continue\"/\"end\"/\"skip\", -- 流程控制建议（可选）\r\n-    loopState: \"ACTION\"/\"END\"      -- 循环状态建议（可选）\r\n-}\r\n-```\r\n-\r\n-#### 执行节点（Execution Node）\r\n-\r\n-**职责**：实际执行操作，修改数据，返回执行结果\r\n-\r\n-**节点列表**：\r\n-1. **InitUnitNode**：初始化单位行动状态，重置行动点数和移动点数\r\n-2. **MoveNode**：执行移动并更新单位位置，消耗移动点数\r\n-3. **SelectSkillNode**：显示可用的技能列表，准备技能释放上下文\r\n-4. **SelectTargetNode**：根据技能类型显示可选目标，更新技能上下文中的目标信息\r\n-5. **ExecuteSkillNode**：调用技能领域执行技能，处理技能执行结果\r\n-6. **ConsumeResourceNode**：消耗行动点数和资源，记录资源消耗信息\r\n-7. **UpdateStateNode**：批量处理所有状态变更数据，更新单位状态\r\n-\r\n-**节点接口**：\r\n-- `Execute(context) -> result`：执行操作\r\n-- `CanExecute(context) -> bool`：检查是否可以执行\r\n-- `Rollback(context)`：回滚操作（失败时）\r\n-\r\n-#### 可视化节点（Visual Node）\r\n-\r\n-**职责**：播放表现，不修改数据，只负责视觉反馈\r\n-\r\n-**节点列表**：\r\n-1. **PlayMoveVisualNode**：通知VisualSystem播放移动表现\r\n-2. **PlaySkillVisualNode**：通知VisualSystem播放技能释放表现\r\n-3. **PlayTargetVisualNode**：通知VisualSystem播放受攻击单位表现\r\n-\r\n-**节点接口**：\r\n-- `Execute(context) -> result`：播放表现\r\n-- `WaitForComplete(context) -> bool`：等待表现完成（可选）\r\n-\r\n-### 节点编排流程示例\r\n-\r\n-```mermaid\r\n-flowchart TD\r\n-    Start[开始] --> Init[InitUnitNode<br/>初始化单位]\r\n-    \r\n-    Init --> CheckMove{CheckMovePointNode<br/>检查移动点数}\r\n-    CheckMove -->|有移动点数| ReceiveMove[ReceiveMoveInputNode<br/>接收移动输入]\r\n-    CheckMove -->|无移动点数| SelectSkill\r\n-    \r\n-    ReceiveMove --> ValidateMove{ValidateMoveNode<br/>验证移动}\r\n-    ValidateMove -->|验证通过| Move[MoveNode<br/>执行移动]\r\n-    ValidateMove -->|验证失败| ReceiveMove\r\n-    \r\n-    Move --> PlayMove[PlayMoveVisualNode<br/>播放移动表现]\r\n-    PlayMove --> SelectSkill[SelectSkillNode<br/>选择技能]\r\n-    \r\n-    SelectSkill --> ReceiveSkill[ReceiveSkillSelectNode<br/>接收技能选择]\r\n-    ReceiveSkill --> ValidateSkill{ValidateSkillNode<br/>验证技能}\r\n-    ValidateSkill -->|验证通过| SelectTarget[SelectTargetNode<br/>选择目标]\r\n-    ValidateSkill -->|验证失败| SelectSkill\r\n-    \r\n-    SelectTarget --> ReceiveTarget[ReceiveTargetSelectNode<br/>接收目标选择]\r\n-    ReceiveTarget --> ValidateTarget{ValidateTargetNode<br/>验证目标}\r\n-    ValidateTarget -->|验证通过| Consume[ConsumeResourceNode<br/>消耗资源]\r\n-    ValidateTarget -->|验证失败| SelectTarget\r\n-    \r\n-    Consume --> Execute[ExecuteSkillNode<br/>执行技能]\r\n-    Execute --> Update[UpdateStateNode<br/>更新状态]\r\n-    Update --> PlaySkill[PlaySkillVisualNode<br/>播放技能表现]\r\n-    PlaySkill --> PlayTarget[PlayTargetVisualNode<br/>播放目标表现]\r\n-    \r\n-    PlayTarget --> CheckResource{CheckResourceNode<br/>检查资源}\r\n-    CheckResource -->|还有资源| CheckMove\r\n-    CheckResource -->|无资源| End[结束]\r\n-    \r\n-    style Init fill:#c8e6c9\r\n-    style CheckMove fill:#fff4e1\r\n-    style ReceiveMove fill:#ffebee\r\n-    style ValidateMove fill:#fff4e1\r\n-    style Move fill:#c8e6c9\r\n-    style PlayMove fill:#f3e5f5\r\n-    style SelectSkill fill:#c8e6c9\r\n-    style ReceiveSkill fill:#ffebee\r\n-    style ValidateSkill fill:#fff4e1\r\n-    style SelectTarget fill:#c8e6c9\r\n-    style ReceiveTarget fill:#ffebee\r\n-    style ValidateTarget fill:#fff4e1\r\n-    style Consume fill:#c8e6c9\r\n-    style Execute fill:#c8e6c9\r\n-    style Update fill:#c8e6c9\r\n-    style PlaySkill fill:#f3e5f5\r\n-    style PlayTarget fill:#f3e5f5\r\n-    style CheckResource fill:#fff4e1\r\n-    style End fill:#ffebee\r\n-```\r\n-\r\n-### 节点间通讯机制\r\n-\r\n-#### 1. Context传递（同步）\r\n-\r\n-**设计**：节点编排器负责在节点间传递UnitContext\r\n-\r\n-- 节点执行时接收Context\r\n-- 节点执行后增强Context并返回\r\n-- 编排器根据结果决定下一个节点\r\n-\r\n-#### 2. EventChannel（异步）\r\n-\r\n-**设计**：节点可以发布事件，其他节点可以订阅\r\n-\r\n-- 支持解耦的事件通知\r\n-- 事件类型：`UNIT_MOVE_COMPLETED`、`SKILL_EXECUTED`、`RESOURCE_CONSUMED`、`STATE_UPDATED`\r\n-\r\n-#### 3. MessageChannel（同步，1对1）\r\n-\r\n-**设计**：节点间需要直接通讯时使用\r\n-\r\n-- 1对1单向消息传递\r\n-- 支持请求-响应模式\r\n-\r\n-#### 4. QueryChannel（同步查询）\r\n-\r\n-**设计**：节点通过QueryChannel查询数据模块\r\n-\r\n-- 条件节点查询单位属性、技能状态\r\n-- 执行节点查询移动范围、技能范围\r\n-\r\n-#### 5. PushChannel（批量数据推送）\r\n-\r\n-**设计**：数据模块通过PushChannel推送数据变更\r\n-\r\n-- 执行节点接收技能效果数据、状态变更数据\r\n-- 可视化节点接收数据变更通知\r\n-\r\n-### 节点实现细节\r\n-\r\n-#### UnitContext逐步增强过程\r\n-\r\n-单位行动流程的核心是UnitContext的维护和管理，Context在节点间流转并逐步增强：\r\n-\r\n-```\r\n-UnitContext（节点1：单位循环开始）\r\n-  + unitData（单位数据）\r\n-  + roundContext（回合上下文）\r\n-  ↓\r\n-  + currentUnit（当前行动单位）\r\n-  + unitValidation（单位验证结果）\r\n-  ↓\r\n-  + moveInput（移动输入：点击坐标）\r\n-  + moveValidation（移动验证结果）\r\n-  + movePath（移动路径）\r\n-  + moveResult（移动结果）\r\n-  ↓\r\n-  + selectedSkill（选中的技能）\r\n-  + skillValidation（技能验证结果）\r\n-  + skillContext（技能上下文）\r\n-  ↓\r\n-  + selectedTargets（选中的目标）\r\n-  + targetValidation（目标验证结果）\r\n-  ↓\r\n-  + skillExecutionResult（技能执行结果）\r\n-  + resourceConsumption（资源消耗信息）\r\n-  ↓\r\n-  + visualResult（表现播放结果）\r\n-  + effectResults（效果处理结果）\r\n-  + resourceCheck（资源检查结果）\r\n-  + loopState（循环状态）\r\n-  ↓\r\n-UnitContext（节点7：执行施法后处理）\r\n-```\r\n-\r\n-#### 节点内部架构设计原则\r\n-\r\n-**管道过滤器模式**：\r\n-- 单Context设计：所有节点使用统一的`UnitContext`\r\n-- 逐步增强：每个节点在Context中添加自己的数据\r\n-- 数据流循环：节点1 → 节点2 → ... → 节点7 → 节点3（循环）\r\n-\r\n-**节点内部组件设计**：\r\n-- **输入接收器**：接收外部输入，验证输入有效性\r\n-- **验证器组**：负责各种验证（范围、路径、资源等）\r\n-- **执行器**：负责实际执行操作\r\n-- **数据更新器**：负责更新数据\r\n-- **表现通知器**：负责通知表现层\r\n-- **上下文增强器**：负责增强Context并传递给下一个节点\r\n-- **循环推动器**：负责推动循环状态转换\r\n-\r\n-#### 错误处理和恢复机制\r\n-\r\n-**错误类型**：\r\n-1. **资源错误**：资源不足、资源被消耗等\r\n-2. **验证错误**：验证失败、状态不合法等\r\n-3. **执行错误**：执行失败、异常等\r\n-4. **系统错误**：系统异常、外部系统错误等\r\n-\r\n-**错误处理流程**：\r\n-1. **资源回滚**：执行失败时，回滚已消耗的资源\r\n-2. **状态恢复**：从Context恢复节点执行前的状态\r\n-3. **错误通知**：通知用户错误信息，提供重试或取消选项\r\n-4. **日志记录**：记录错误信息到Context，便于调试和问题追踪\r\n-\r\n-**节点状态机**：\r\n-- **IDLE**：节点未开始执行\r\n-- **EXECUTING**：节点正在执行\r\n-- **COMPLETED**：节点执行完成\r\n-- **FAILED**：节点执行失败\r\n-\r\n----\r\n-\r\n-## 核心机制\r\n-\r\n-### 循环机制\r\n-\r\n-#### 循环状态机设计\r\n-\r\n-**各层循环的状态定义**：\r\n-\r\n-1. **战斗循环（BattleLoop）**\r\n-   - **PREPARING**：战斗准备中\r\n-   - **IN_PROGRESS**：战斗进行中\r\n-   - **ENDED**：战斗已结束\r\n-\r\n-2. **回合循环（RoundLoop）**\r\n-   - **START**：回合开始\r\n-   - **ACTION**：执行回合行动\r\n-   - **END**：回合结束\r\n-\r\n-3. **单位循环（UnitLoop）**\r\n-   - **START**：单位开始行动\r\n-   - **ACTION**：执行行动\r\n-   - **END**：单位结束行动\r\n-\r\n-**状态转换原则**：\r\n-- Domain controls Loop：Domain管理通过协调器控制循环状态转换\r\n-- 反向推动机制：协调器执行完业务后，主动推动循环进入下一个状态\r\n-- 状态转换验证：状态转换前进行验证，确保转换合法\r\n-\r\n----\r\n-\r\n-## 外部系统集成\r\n-\r\n-### SkillDomain（技能领域）集成\r\n-\r\n-**集成方式**：\r\n-- **调用方式**：ActionCoordinator调用SkillDomain执行技能\r\n-- **数据推送**：SkillDomain的EffectHandler通过DataHandleQueue推送效果数据\r\n-- **数据查询**：节点通过QueryChannel查询技能状态\r\n-\r\n-### TerrainDomain（地形领域）集成\r\n-\r\n-**集成方式**：\r\n-- **调用方式**：ActionCoordinator调用TerrainDomain处理地形要素\r\n-- **数据推送**：TerrainDomain的EffectHandler通过DataHandleQueue推送效果数据\r\n-- **共享Handler机制**：与SkillDomain共享Handler接口，但保持独立系统\r\n-\r\n-### GridSystem（网格系统）集成\r\n-\r\n-**集成方式**：\r\n-- **调用方式**：ActionCoordinator调用GridSystem进行移动计算\r\n-- **数据查询**：节点通过QueryChannel查询移动范围、路径信息\r\n-\r\n-### VisualSystem（表现系统）集成\r\n-\r\n-**集成方式**：\r\n-- **通知方式**：ActionCoordinator通知VisualSystem播放表现\r\n-- **事件订阅**：可视化节点订阅EventChannel接收表现事件\r\n-\r\n-\r\n-### 设计原则总结\r\n-\r\n-- ✅ **Domain controls Loop**：Domain控制循环，循环是Domain的工具\r\n-- ✅ **数据驱动架构**：战斗特性通过配置数据实现，无需额外机制\r\n-- ✅ **节点编排模式**：单位行动流程通过节点编排器动态组织\r\n-- ✅ **解耦设计**：节点间通过CommunicationBus和Context通信，不直接依赖\r\n-- ✅ **多层循环架构**：战斗→回合→单位三层循环架构\r\n-- ✅ **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n-- ✅ **统一数据访问**：节点通过CommunicationBus统一获取数据\r\n-\r\n----\r\n-\r\n-## 总结\r\n-\r\n-### 架构设计价值\r\n-\r\n-该架构设计文档的价值在于：\r\n-- ✅ **思路解构**：完整解构回合制战斗系统的搭建思路\r\n-- ✅ **流程验证**：从架构层面验证流程合理性\r\n-- ✅ **问题识别**：提前识别潜在的资源和状态问题\r\n-- ✅ **开发指导**：为后续详细设计和实现提供清晰指导\r\n-\r\n-### 架构特点\r\n-\r\n-- ✅ **多层循环架构**：战斗→回合→单位三层循环架构\r\n-- ✅ **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n-- ✅ **统一数据访问**：节点通过CommunicationBus统一获取数据\r\n-- ✅ **错误处理防护**：资源回滚 + 状态恢复 + 错误通知，避免状态不一致\r\n-- ✅ **数据驱动**：所有特性通过配置数据实现，无需修改代码\r\n-\r\n-细节实现是后续开发阶段的工作，当前架构设计已足够指导整个回合制战斗系统的开发。\r\n"
                },
                {
                    "date": 1767182730993,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -434,8 +434,31 @@\n ### 核心职责\r\n \r\n 单位领域是战斗系统的核心，负责管理单个单位的行动流程，包括移动、技能释放、数值控制等。\r\n \r\n+\r\n+### 数值控制流程（通过 DataHandleQueue）\r\n+\r\n+```mermaid\r\n+flowchart LR\r\n+    ActionCoord[行动协调器<br/>调用技能领域] --> SkillDomain[技能领域<br/>执行技能]\r\n+    SkillDomain --> EffectHandler[EffectHandler<br/>应用效果]\r\n+    TerrainDomain[地形领域<br/>执行地形要素] --> EffectHandler[EffectHandler<br/>应用效果]\r\n+    EffectHandler --> ProcessQueue[DataHandleQueue]\r\n+    ProcessQueue --> UnitData[UnitData<br/>1:1关系<br/>推送修改]\r\n+    UnitData --> UpdateState[更新状态<br/>扣血/加buff]\r\n+    ActionCoord --> TerrainDomain\r\n+    ActionCoord --> 其他领域\r\n+    其他领域 --> EffectHandler\r\n+\r\n+    style ActionCoord fill:#c8e6c9\r\n+    style SkillDomain fill:#c8e6c9\r\n+    style EffectHandler fill:#fff4e1\r\n+    style ProcessQueue fill:#f3e5f5\r\n+    style UnitData fill:#e1f5ff\r\n+    style UpdateState fill:#fff4e1\r\n+```\r\n+\r\n ### 架构结构\r\n \r\n ```mermaid\r\n graph TB\r\n@@ -589,30 +612,10 @@\n     style CheckAction fill:#ffe0b2\r\n     style CheckActionPoint fill:#ffe0b2\r\n ```\r\n \r\n-### 数值控制流程（通过 DataHandleQueue）\r\n \r\n-```mermaid\r\n-flowchart LR\r\n-    ActionCoord[行动协调器<br/>调用技能领域] --> SkillDomain[技能领域<br/>执行技能]\r\n-    SkillDomain --> EffectHandler[EffectHandler<br/>应用效果]\r\n-    TerrainDomain[地形领域<br/>执行地形要素] --> EffectHandler[EffectHandler<br/>应用效果]\r\n-    EffectHandler --> ProcessQueue[DataHandleQueue]\r\n-    ProcessQueue --> UnitData[UnitData<br/>1:1关系<br/>推送修改]\r\n-    UnitData --> UpdateState[更新状态<br/>扣血/加buff]\r\n-    ActionCoord --> TerrainDomain\r\n-    ActionCoord --> 其他领域\r\n-    其他领域 --> EffectHandler\r\n \r\n-    style ActionCoord fill:#c8e6c9\r\n-    style SkillDomain fill:#c8e6c9\r\n-    style EffectHandler fill:#fff4e1\r\n-    style ProcessQueue fill:#f3e5f5\r\n-    style UnitData fill:#e1f5ff\r\n-    style UpdateState fill:#fff4e1\r\n-```\r\n-\r\n ---\r\n \r\n ## 单位领域：节点编排架构\r\n \r\n"
                },
                {
                    "date": 1767182819338,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -638,28 +638,10 @@\n - **条件节点（Condition Node）**：负责验证、检查、判断，返回判断结果和流程控制建议（如：检查移动点数、验证技能可释放、检查资源决定是否继续等）\r\n - **执行节点（Execution Node）**：负责实际执行操作，修改数据（如：执行移动、执行技能、消耗资源、更新状态等）\r\n - **可视化节点（Visual Node）**：负责表现播放（如：播放移动表现、播放技能表现等）\r\n \r\n-#### 3. 节点数据获取机制\r\n \r\n-**本质**：节点通过 CommunicationBus 统一获取不同模块的数据，实现节点与数据模块的解耦\r\n \r\n-**核心概念**：\r\n-- **数据访问层**：CommunicationBus 作为节点访问所有数据模块的统一接口\r\n-- **解耦设计**：节点不直接依赖具体的数据模块（UnitData、SkillDomain、TerrainDomain等）\r\n-- **统一接口**：所有数据获取都通过 PushChannel（批量数据推送）和 QueryChannel（同步查询）进行\r\n-- **灵活扩展**：新增数据模块时，只需注册到 CommunicationBus，节点无需修改\r\n-\r\n-**数据获取方式**：\r\n-\r\n-1. **QueryChannel（同步查询）**：用于节点需要立即获取数据的场景\r\n-   - **条件节点**：查询单位属性、技能状态、资源数量等用于验证和检查\r\n-   - **执行节点**：查询移动范围、技能范围、目标信息等用于执行\r\n-\r\n-2. **PushChannel（批量数据推送）**：用于节点需要接收数据变更通知的场景\r\n-   - **执行节点**：接收技能效果数据、状态变更数据等用于执行\r\n-   - **可视化节点**：接收数据变更通知用于更新表现\r\n-\r\n ### 节点编排器架构\r\n \r\n ```mermaid\r\n graph TB\r\n"
                },
                {
                    "date": 1767182987877,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -435,9 +435,9 @@\n \r\n 单位领域是战斗系统的核心，负责管理单个单位的行动流程，包括移动、技能释放、数值控制等。\r\n \r\n \r\n-### 数值控制流程（通过 DataHandleQueue）\r\n+### 数值查询及推送流程（通过 DataHandleQueue）\r\n \r\n ```mermaid\r\n flowchart LR\r\n     ActionCoord[行动协调器<br/>调用技能领域] --> SkillDomain[技能领域<br/>执行技能]\r\n"
                },
                {
                    "date": 1767182993921,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -435,9 +435,9 @@\n \r\n 单位领域是战斗系统的核心，负责管理单个单位的行动流程，包括移动、技能释放、数值控制等。\r\n \r\n \r\n-### 数值查询及推送流程（通过 DataHandleQueue）\r\n+### 数值查询及推送\r\n \r\n ```mermaid\r\n flowchart LR\r\n     ActionCoord[行动协调器<br/>调用技能领域] --> SkillDomain[技能领域<br/>执行技能]\r\n"
                },
                {
                    "date": 1767183000419,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -435,9 +435,9 @@\n \r\n 单位领域是战斗系统的核心，负责管理单个单位的行动流程，包括移动、技能释放、数值控制等。\r\n \r\n \r\n-### 数值查询及推送\r\n+### 数值查询及推送 (CommunicationBus)\r\n \r\n ```mermaid\r\n flowchart LR\r\n     ActionCoord[行动协调器<br/>调用技能领域] --> SkillDomain[技能领域<br/>执行技能]\r\n"
                },
                {
                    "date": 1767183077020,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -437,8 +437,10 @@\n \r\n \r\n ### 数值查询及推送 (CommunicationBus)\r\n \r\n+- 节点、领域、数据模块、外部系统、通过CommunicationBus的PushChannel和QueryChannel进行通讯\r\n+\r\n ```mermaid\r\n flowchart LR\r\n     ActionCoord[行动协调器<br/>调用技能领域] --> SkillDomain[技能领域<br/>执行技能]\r\n     SkillDomain --> EffectHandler[EffectHandler<br/>应用效果]\r\n"
                },
                {
                    "date": 1767183091737,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -437,10 +437,12 @@\n \r\n \r\n ### 数值查询及推送 (CommunicationBus)\r\n \r\n-- 节点、领域、数据模块、外部系统、通过CommunicationBus的PushChannel和QueryChannel进行通讯\r\n+- 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n \r\n+\r\n+\r\n ```mermaid\r\n flowchart LR\r\n     ActionCoord[行动协调器<br/>调用技能领域] --> SkillDomain[技能领域<br/>执行技能]\r\n     SkillDomain --> EffectHandler[EffectHandler<br/>应用效果]\r\n"
                },
                {
                    "date": 1767183119897,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -440,27 +440,15 @@\n \r\n - 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n \r\n \r\n-\r\n ```mermaid\r\n flowchart LR\r\n-    ActionCoord[行动协调器<br/>调用技能领域] --> SkillDomain[技能领域<br/>执行技能]\r\n-    SkillDomain --> EffectHandler[EffectHandler<br/>应用效果]\r\n-    TerrainDomain[地形领域<br/>执行地形要素] --> EffectHandler[EffectHandler<br/>应用效果]\r\n-    EffectHandler --> ProcessQueue[DataHandleQueue]\r\n-    ProcessQueue --> UnitData[UnitData<br/>1:1关系<br/>推送修改]\r\n-    UnitData --> UpdateState[更新状态<br/>扣血/加buff]\r\n-    ActionCoord --> TerrainDomain\r\n-    ActionCoord --> 其他领域\r\n-    其他领域 --> EffectHandler\r\n-\r\n-    style ActionCoord fill:#c8e6c9\r\n-    style SkillDomain fill:#c8e6c9\r\n-    style EffectHandler fill:#fff4e1\r\n-    style ProcessQueue fill:#f3e5f5\r\n-    style UnitData fill:#e1f5ff\r\n-    style UpdateState fill:#fff4e1\r\n+    节点\r\n+    领域\r\n+    数据模块\r\n+    外部系统\r\n+    通过CommunicationBus的PushChannel和QueryChannel进行通讯\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183186669,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -446,9 +446,11 @@\n     节点\r\n     领域\r\n     数据模块\r\n     外部系统\r\n-    通过CommunicationBus的PushChannel和QueryChannel进行通讯\r\n+\r\n+    通讯推送频道 --> 节点\r\n+    通讯查询频道 --> 节点\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183205365,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -447,10 +447,12 @@\n     领域\r\n     数据模块\r\n     外部系统\r\n \r\n-    通讯推送频道 --> 节点\r\n-    通讯查询频道 --> 节点\r\n+    通讯推送频道 \r\n+    通讯查询频道\r\n+\r\n+    \r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183230107,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -450,9 +450,9 @@\n \r\n     通讯推送频道 \r\n     通讯查询频道\r\n \r\n-    \r\n+    节点 --> 通讯推送频道 <-- 数据模块\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183236610,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -450,9 +450,9 @@\n \r\n     通讯推送频道 \r\n     通讯查询频道\r\n \r\n-    节点 --> 通讯推送频道 <-- 数据模块\r\n+    节点 --> 通讯推送频道\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183273518,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -451,8 +451,11 @@\n     通讯推送频道 \r\n     通讯查询频道\r\n \r\n     节点 --> 通讯推送频道\r\n+\r\n+\r\n+     通讯推送频道:flowchart LR\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183284310,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -453,9 +453,9 @@\n \r\n     节点 --> 通讯推送频道\r\n \r\n \r\n-     通讯推送频道:flowchart LR\r\n+    style 通讯推送频道 fill:#c8e6c9\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183292184,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -454,8 +454,9 @@\n     节点 --> 通讯推送频道\r\n \r\n \r\n     style 通讯推送频道 fill:#c8e6c9\r\n+    style 通讯查询频道 fill:#c8e6c9\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183304886,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -446,9 +446,9 @@\n     节点\r\n     领域\r\n     数据模块\r\n     外部系统\r\n-\r\n+    \r\n     通讯推送频道 \r\n     通讯查询频道\r\n \r\n     节点 --> 通讯推送频道\r\n"
                },
                {
                    "date": 1767183326368,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -446,15 +446,15 @@\n     节点\r\n     领域\r\n     数据模块\r\n     外部系统\r\n-    \r\n+\r\n     通讯推送频道 \r\n     通讯查询频道\r\n \r\n     节点 --> 通讯推送频道\r\n+    \r\n \r\n-\r\n     style 通讯推送频道 fill:#c8e6c9\r\n     style 通讯查询频道 fill:#c8e6c9\r\n ```\r\n \r\n"
                },
                {
                    "date": 1767183331453,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -451,8 +451,10 @@\n     通讯推送频道 \r\n     通讯查询频道\r\n \r\n     节点 --> 通讯推送频道\r\n+    节点 --> 通讯查询频道\r\n+\r\n     \r\n \r\n     style 通讯推送频道 fill:#c8e6c9\r\n     style 通讯查询频道 fill:#c8e6c9\r\n"
                },
                {
                    "date": 1767183343027,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -453,10 +453,13 @@\n \r\n     节点 --> 通讯推送频道\r\n     节点 --> 通讯查询频道\r\n \r\n-    \r\n \r\n+    领域 --> 通讯推送频道\r\n+    领域 --> 通讯查询频道\r\n+\r\n+\r\n     style 通讯推送频道 fill:#c8e6c9\r\n     style 通讯查询频道 fill:#c8e6c9\r\n ```\r\n \r\n"
                },
                {
                    "date": 1767183348267,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -457,9 +457,12 @@\n \r\n     领域 --> 通讯推送频道\r\n     领域 --> 通讯查询频道\r\n \r\n+    数据模块 --> 通讯推送频道\r\n+    数据模块 --> 通讯查询频道\r\n \r\n+\r\n     style 通讯推送频道 fill:#c8e6c9\r\n     style 通讯查询频道 fill:#c8e6c9\r\n ```\r\n \r\n"
                },
                {
                    "date": 1767183357747,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -460,8 +460,10 @@\n \r\n     数据模块 --> 通讯推送频道\r\n     数据模块 --> 通讯查询频道\r\n \r\n+    外部系统 --> 通讯推送频道\r\n+    外部系统 --> 通讯查询频道\r\n \r\n     style 通讯推送频道 fill:#c8e6c9\r\n     style 通讯查询频道 fill:#c8e6c9\r\n ```\r\n"
                },
                {
                    "date": 1767183397659,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -463,8 +463,14 @@\n \r\n     外部系统 --> 通讯推送频道\r\n     外部系统 --> 通讯查询频道\r\n \r\n+\r\n+    通讯推送频道 --> 节点\r\n+    通讯推送频道 --> 领域\r\n+    通讯推送频道 --> 数据模块\r\n+    通讯推送频道 --> 外部系统\r\n+\r\n     style 通讯推送频道 fill:#c8e6c9\r\n     style 通讯查询频道 fill:#c8e6c9\r\n ```\r\n \r\n"
                },
                {
                    "date": 1767183403935,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -469,8 +469,13 @@\n     通讯推送频道 --> 领域\r\n     通讯推送频道 --> 数据模块\r\n     通讯推送频道 --> 外部系统\r\n \r\n+    通讯查询频道 --> 节点\r\n+    通讯查询频道 --> 领域\r\n+    通讯查询频道 --> 数据模块\r\n+    通讯查询频道 --> 外部系统\r\n+\r\n     style 通讯推送频道 fill:#c8e6c9\r\n     style 通讯查询频道 fill:#c8e6c9\r\n ```\r\n \r\n"
                },
                {
                    "date": 1767183417060,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -441,9 +441,9 @@\n - 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n \r\n \r\n ```mermaid\r\n-flowchart LR\r\n+flowchart TB\r\n     节点\r\n     领域\r\n     数据模块\r\n     外部系统\r\n"
                },
                {
                    "date": 1767183430150,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -452,16 +452,12 @@\n     通讯查询频道\r\n \r\n     节点 --> 通讯推送频道\r\n     节点 --> 通讯查询频道\r\n-\r\n-\r\n     领域 --> 通讯推送频道\r\n     领域 --> 通讯查询频道\r\n-\r\n     数据模块 --> 通讯推送频道\r\n     数据模块 --> 通讯查询频道\r\n-\r\n     外部系统 --> 通讯推送频道\r\n     外部系统 --> 通讯查询频道\r\n \r\n \r\n"
                },
                {
                    "date": 1767183439664,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -450,18 +450,19 @@\n \r\n     通讯推送频道 \r\n     通讯查询频道\r\n \r\n+\r\n+    数据模块 --> 通讯推送频道\r\n+    数据模块 --> 通讯查询频道\r\n+    外部系统 --> 通讯推送频道\r\n+    外部系统 --> 通讯查询频道\r\n+    \r\n     节点 --> 通讯推送频道\r\n     节点 --> 通讯查询频道\r\n     领域 --> 通讯推送频道\r\n     领域 --> 通讯查询频道\r\n-    数据模块 --> 通讯推送频道\r\n-    数据模块 --> 通讯查询频道\r\n-    外部系统 --> 通讯推送频道\r\n-    外部系统 --> 通讯查询频道\r\n \r\n-\r\n     通讯推送频道 --> 节点\r\n     通讯推送频道 --> 领域\r\n     通讯推送频道 --> 数据模块\r\n     通讯推送频道 --> 外部系统\r\n"
                },
                {
                    "date": 1767183445977,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -450,29 +450,31 @@\n \r\n     通讯推送频道 \r\n     通讯查询频道\r\n \r\n+     通讯推送频道 --> 节点\r\n+    通讯推送频道 --> 领域\r\n+    通讯推送频道 --> 数据模块\r\n+    通讯推送频道 --> 外部系统\r\n \r\n+    通讯查询频道 --> 节点\r\n+    通讯查询频道 --> 领域\r\n+    通讯查询频道 --> 数据模块\r\n+    通讯查询频道 --> 外部系统\r\n+\r\n+\r\n     数据模块 --> 通讯推送频道\r\n     数据模块 --> 通讯查询频道\r\n     外部系统 --> 通讯推送频道\r\n     外部系统 --> 通讯查询频道\r\n-    \r\n+\r\n     节点 --> 通讯推送频道\r\n     节点 --> 通讯查询频道\r\n     领域 --> 通讯推送频道\r\n     领域 --> 通讯查询频道\r\n \r\n-    通讯推送频道 --> 节点\r\n-    通讯推送频道 --> 领域\r\n-    通讯推送频道 --> 数据模块\r\n-    通讯推送频道 --> 外部系统\r\n+   \r\n \r\n-    通讯查询频道 --> 节点\r\n-    通讯查询频道 --> 领域\r\n-    通讯查询频道 --> 数据模块\r\n-    通讯查询频道 --> 外部系统\r\n-\r\n     style 通讯推送频道 fill:#c8e6c9\r\n     style 通讯查询频道 fill:#c8e6c9\r\n ```\r\n \r\n"
                },
                {
                    "date": 1767183451403,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -450,9 +450,9 @@\n \r\n     通讯推送频道 \r\n     通讯查询频道\r\n \r\n-     通讯推送频道 --> 节点\r\n+    通讯推送频道 --> 节点\r\n     通讯推送频道 --> 领域\r\n     通讯推送频道 --> 数据模块\r\n     通讯推送频道 --> 外部系统\r\n \r\n@@ -460,9 +460,8 @@\n     通讯查询频道 --> 领域\r\n     通讯查询频道 --> 数据模块\r\n     通讯查询频道 --> 外部系统\r\n \r\n-\r\n     数据模块 --> 通讯推送频道\r\n     数据模块 --> 通讯查询频道\r\n     外部系统 --> 通讯推送频道\r\n     外部系统 --> 通讯查询频道\r\n"
                },
                {
                    "date": 1767183476642,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -460,20 +460,8 @@\n     通讯查询频道 --> 领域\r\n     通讯查询频道 --> 数据模块\r\n     通讯查询频道 --> 外部系统\r\n \r\n-    数据模块 --> 通讯推送频道\r\n-    数据模块 --> 通讯查询频道\r\n-    外部系统 --> 通讯推送频道\r\n-    外部系统 --> 通讯查询频道\r\n-\r\n-    节点 --> 通讯推送频道\r\n-    节点 --> 通讯查询频道\r\n-    领域 --> 通讯推送频道\r\n-    领域 --> 通讯查询频道\r\n-\r\n-   \r\n-\r\n     style 通讯推送频道 fill:#c8e6c9\r\n     style 通讯查询频道 fill:#c8e6c9\r\n ```\r\n \r\n"
                },
                {
                    "date": 1767183487726,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -447,11 +447,8 @@\n     领域\r\n     数据模块\r\n     外部系统\r\n \r\n-    通讯推送频道 \r\n-    通讯查询频道\r\n-\r\n     通讯推送频道 --> 节点\r\n     通讯推送频道 --> 领域\r\n     通讯推送频道 --> 数据模块\r\n     通讯推送频道 --> 外部系统\r\n"
                },
                {
                    "date": 1767183515409,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -446,9 +446,12 @@\n     节点\r\n     领域\r\n     数据模块\r\n     外部系统\r\n+    \r\n+    HandlerPush \r\n \r\n+    subgraph 通讯推送频道[\"通讯推送频道\"]\r\n     通讯推送频道 --> 节点\r\n     通讯推送频道 --> 领域\r\n     通讯推送频道 --> 数据模块\r\n     通讯推送频道 --> 外部系统\r\n"
                },
                {
                    "date": 1767183546990,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -441,29 +441,10 @@\n - 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n \r\n \r\n ```mermaid\r\n-flowchart TB\r\n-    节点\r\n-    领域\r\n-    数据模块\r\n-    外部系统\r\n-    \r\n-    HandlerPush \r\n+   graph TB\r\n \r\n-    subgraph 通讯推送频道[\"通讯推送频道\"]\r\n-    通讯推送频道 --> 节点\r\n-    通讯推送频道 --> 领域\r\n-    通讯推送频道 --> 数据模块\r\n-    通讯推送频道 --> 外部系统\r\n-\r\n-    通讯查询频道 --> 节点\r\n-    通讯查询频道 --> 领域\r\n-    通讯查询频道 --> 数据模块\r\n-    通讯查询频道 --> 外部系统\r\n-\r\n-    style 通讯推送频道 fill:#c8e6c9\r\n-    style 通讯查询频道 fill:#c8e6c9\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183563553,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -441,9 +441,17 @@\n - 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n \r\n \r\n ```mermaid\r\n-   graph TB\r\n+graph TB\r\n+    HandlerPush[通讯推送频道]\r\n+    HandlerQuery[通讯查询频道]\r\n+    Node[节点]\r\n+    Domain[领域]\r\n+    DataModule[数据模块]\r\n+    ExternalSystem[外部系统]\r\n+    \r\n+    HandlerPush --> Node\r\n \r\n ```\r\n \r\n ### 架构结构\r\n"
                },
                {
                    "date": 1767183576485,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -449,10 +449,21 @@\n     Domain[领域]\r\n     DataModule[数据模块]\r\n     ExternalSystem[外部系统]\r\n     \r\n+subgraph 通讯推送频道[\"通讯推送频道\"]\r\n     HandlerPush --> Node\r\n+    HandlerPush --> Domain\r\n+    HandlerPush --> DataModule\r\n+    HandlerPush --> ExternalSystem\r\n+end\r\n \r\n+subgraph 通讯查询频道[\"通讯查询频道\"]\r\n+    HandlerQuery --> Node\r\n+    HandlerQuery --> Domain\r\n+    HandlerQuery --> DataModule\r\n+    HandlerQuery --> ExternalSystem\r\n+end\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183587778,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -449,21 +449,21 @@\n     Domain[领域]\r\n     DataModule[数据模块]\r\n     ExternalSystem[外部系统]\r\n     \r\n-subgraph 通讯推送频道[\"通讯推送频道\"]\r\n-    HandlerPush --> Node\r\n-    HandlerPush --> Domain\r\n-    HandlerPush --> DataModule\r\n-    HandlerPush --> ExternalSystem\r\n-end\r\n+    subgraph 通讯推送频道[\"通讯推送频道\"]\r\n+        HandlerPush --> Node\r\n+        HandlerPush --> Domain\r\n+        HandlerPush --> DataModule\r\n+        HandlerPush --> ExternalSystem\r\n+    end\r\n \r\n-subgraph 通讯查询频道[\"通讯查询频道\"]\r\n-    HandlerQuery --> Node\r\n-    HandlerQuery --> Domain\r\n-    HandlerQuery --> DataModule\r\n-    HandlerQuery --> ExternalSystem\r\n-end\r\n+    subgraph 通讯查询频道[\"通讯查询频道\"]\r\n+        HandlerQuery --> Node\r\n+        HandlerQuery --> Domain\r\n+        HandlerQuery --> DataModule\r\n+        HandlerQuery --> ExternalSystem\r\n+    end\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183598195,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -442,10 +442,8 @@\n \r\n \r\n ```mermaid\r\n graph TB\r\n-    HandlerPush[通讯推送频道]\r\n-    HandlerQuery[通讯查询频道]\r\n     Node[节点]\r\n     Domain[领域]\r\n     DataModule[数据模块]\r\n     ExternalSystem[外部系统]\r\n"
                },
                {
                    "date": 1767183618374,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -455,12 +455,9 @@\n         HandlerPush --> ExternalSystem\r\n     end\r\n \r\n     subgraph 通讯查询频道[\"通讯查询频道\"]\r\n-        HandlerQuery --> Node\r\n-        HandlerQuery --> Domain\r\n-        HandlerQuery --> DataModule\r\n-        HandlerQuery --> ExternalSystem\r\n+        \r\n     end\r\n ```\r\n \r\n ### 架构结构\r\n"
                },
                {
                    "date": 1767183630925,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -442,23 +442,9 @@\n \r\n \r\n ```mermaid\r\n graph TB\r\n-    Node[节点]\r\n-    Domain[领域]\r\n-    DataModule[数据模块]\r\n-    ExternalSystem[外部系统]\r\n     \r\n-    subgraph 通讯推送频道[\"通讯推送频道\"]\r\n-        HandlerPush --> Node\r\n-        HandlerPush --> Domain\r\n-        HandlerPush --> DataModule\r\n-        HandlerPush --> ExternalSystem\r\n-    end\r\n-\r\n-    subgraph 通讯查询频道[\"通讯查询频道\"]\r\n-        \r\n-    end\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183642429,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -442,8 +442,10 @@\n \r\n \r\n ```mermaid\r\n graph TB\r\n+    节点\r\n+    领域\r\n     \r\n ```\r\n \r\n ### 架构结构\r\n"
                },
                {
                    "date": 1767183679121,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -442,11 +442,12 @@\n \r\n \r\n ```mermaid\r\n graph TB\r\n-    节点\r\n+    EffectHandler\r\n+    节点 -->  PushChannel\r\n     领域\r\n-    \r\n+\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183695406,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -443,9 +443,9 @@\n \r\n ```mermaid\r\n graph TB\r\n     EffectHandler\r\n-    节点 -->  PushChannel\r\n+    节点 --> EffectHandler --> PushChannel --> 数据模块\r\n     领域\r\n \r\n ```\r\n \r\n"
                },
                {
                    "date": 1767183707306,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -442,11 +442,10 @@\n \r\n \r\n ```mermaid\r\n graph TB\r\n-    EffectHandler\r\n     节点 --> EffectHandler --> PushChannel --> 数据模块\r\n-    领域\r\n+    领域 --> EffectHandler --> PushChannel --> 数据模块\r\n \r\n ```\r\n \r\n ### 架构结构\r\n"
                },
                {
                    "date": 1767183713201,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -445,8 +445,10 @@\n graph TB\r\n     节点 --> EffectHandler --> PushChannel --> 数据模块\r\n     领域 --> EffectHandler --> PushChannel --> 数据模块\r\n \r\n+    \r\n+\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183720054,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -443,12 +443,12 @@\n \r\n ```mermaid\r\n graph TB\r\n     节点 --> EffectHandler --> PushChannel --> 数据模块\r\n-    领域 --> EffectHandler --> PushChannel --> 数据模块\r\n+    领域 --> EffectHandler\r\n \r\n-    \r\n \r\n+\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183738042,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -446,8 +446,9 @@\n     节点 --> EffectHandler --> PushChannel --> 数据模块\r\n     领域 --> EffectHandler\r\n \r\n \r\n+    节点 --> QueryChannel --> 数据模块\r\n \r\n ```\r\n \r\n ### 架构结构\r\n"
                },
                {
                    "date": 1767183756059,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -447,9 +447,11 @@\n     领域 --> EffectHandler\r\n \r\n \r\n     节点 --> QueryChannel --> 数据模块\r\n+    领域 --> QueryChannel\r\n \r\n+\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183775771,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -447,11 +447,11 @@\n     领域 --> EffectHandler\r\n \r\n \r\n     节点 --> QueryChannel --> 数据模块\r\n-    领域 --> QueryChannel\r\n+    领域 --> QueryChannel \r\n+    QueryChannel --> 外部系统\r\n \r\n-\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183786657,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -449,8 +449,9 @@\n \r\n     节点 --> QueryChannel --> 数据模块\r\n     领域 --> QueryChannel \r\n     QueryChannel --> 外部系统\r\n+    QueryChannel --> 节点\r\n \r\n ```\r\n \r\n ### 架构结构\r\n"
                },
                {
                    "date": 1767183798744,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -448,10 +448,9 @@\n \r\n \r\n     节点 --> QueryChannel --> 数据模块\r\n     领域 --> QueryChannel \r\n-    QueryChannel --> 外部系统\r\n-    QueryChannel --> 节点\r\n+    QueryChannel -.-> 外部系统\r\n \r\n ```\r\n \r\n ### 架构结构\r\n"
                },
                {
                    "date": 1767183805898,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -448,9 +448,9 @@\n \r\n \r\n     节点 --> QueryChannel --> 数据模块\r\n     领域 --> QueryChannel \r\n-    QueryChannel -.-> 外部系统\r\n+    QueryChannel --> 外部系统\r\n \r\n ```\r\n \r\n ### 架构结构\r\n"
                },
                {
                    "date": 1767183815445,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -446,11 +446,11 @@\n     节点 --> EffectHandler --> PushChannel --> 数据模块\r\n     领域 --> EffectHandler\r\n \r\n \r\n-    节点 --> QueryChannel --> 数据模块\r\n+    节点 --> QueryChannel  -.-> 数据模块\r\n     领域 --> QueryChannel \r\n-    QueryChannel --> 外部系统\r\n+    QueryChannel -.-> 外部系统\r\n \r\n ```\r\n \r\n ### 架构结构\r\n"
                },
                {
                    "date": 1767183821394,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -446,10 +446,10 @@\n     节点 --> EffectHandler --> PushChannel --> 数据模块\r\n     领域 --> EffectHandler\r\n \r\n \r\n-    节点 --> QueryChannel  -.-> 数据模块\r\n-    领域 --> QueryChannel \r\n+    节点  -.-> QueryChannel  -.-> 数据模块\r\n+    领域  -.-> QueryChannel \r\n     QueryChannel -.-> 外部系统\r\n \r\n ```\r\n \r\n"
                },
                {
                    "date": 1767183839189,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -442,9 +442,9 @@\n \r\n \r\n ```mermaid\r\n graph TB\r\n-    节点 --> EffectHandler --> PushChannel --> 数据模块\r\n+    节点 --> EffectHandler -.-> PushChannel -.-> 数据模块\r\n     领域 --> EffectHandler\r\n \r\n \r\n     节点  -.-> QueryChannel  -.-> 数据模块\r\n"
                },
                {
                    "date": 1767183854256,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -450,8 +450,11 @@\n     节点  -.-> QueryChannel  -.-> 数据模块\r\n     领域  -.-> QueryChannel \r\n     QueryChannel -.-> 外部系统\r\n \r\n+\r\n+ style PushChannel fill:#c8e6c9\r\n+ style QueryChannel fill:#c8e6c9\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183861803,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -450,11 +450,10 @@\n     节点  -.-> QueryChannel  -.-> 数据模块\r\n     领域  -.-> QueryChannel \r\n     QueryChannel -.-> 外部系统\r\n \r\n-\r\n- style PushChannel fill:#c8e6c9\r\n- style QueryChannel fill:#c8e6c9\r\n+    style PushChannel fill:#c8e6c9\r\n+    style QueryChannel fill:#c8e6c9\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767183907420,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -445,13 +445,14 @@\n graph TB\r\n     节点 --> EffectHandler -.-> PushChannel -.-> 数据模块\r\n     领域 --> EffectHandler\r\n \r\n-\r\n     节点  -.-> QueryChannel  -.-> 数据模块\r\n     领域  -.-> QueryChannel \r\n     QueryChannel -.-> 外部系统\r\n \r\n+    外部系统 --> EffectHandler\r\n+\r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n ```\r\n \r\n"
                },
                {
                    "date": 1767183994412,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -442,19 +442,22 @@\n \r\n \r\n ```mermaid\r\n graph TB\r\n+\r\n+    subgraph 起点[\"起点\"]\r\n+        节点\r\n+        领域\r\n+        外部系统\r\n+    end\r\n     节点 --> EffectHandler -.-> PushChannel -.-> 数据模块\r\n     领域 --> EffectHandler\r\n+    EffectHandler  -.-> QueryChannel  -.-> 数据模块\r\n+    EffectHandler -.-> 外部系统\r\n \r\n-    节点  -.-> QueryChannel  -.-> 数据模块\r\n-    领域  -.-> QueryChannel \r\n-    QueryChannel -.-> 外部系统\r\n-\r\n-    外部系统 --> EffectHandler\r\n-\r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n+    style 起点 fill:#ffe0b2\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767184019321,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -448,8 +448,10 @@\n         节点\r\n         领域\r\n         外部系统\r\n     end\r\n+\r\n+\r\n     节点 --> EffectHandler -.-> PushChannel -.-> 数据模块\r\n     领域 --> EffectHandler\r\n     EffectHandler  -.-> QueryChannel  -.-> 数据模块\r\n     EffectHandler -.-> 外部系统\r\n"
                },
                {
                    "date": 1767184057243,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,1021 @@\n+# 战斗系统架构设计文档\r\n+\r\n+## 目录\r\n+\r\n+1. [概述](#概述)\r\n+2. [整体架构](#整体架构)\r\n+3. [战斗领域](#战斗领域)\r\n+4. [回合领域](#回合领域)\r\n+5. [单位领域](#单位领域)\r\n+6. [核心机制](#核心机制)\r\n+7. [数据结构](#数据结构)\r\n+8. [外部系统集成](#外部系统集成)\r\n+9. [实现指南](#实现指南)\r\n+\r\n+---\r\n+\r\n+## 概述\r\n+\r\n+### 设计目标\r\n+\r\n+设计一套完整的回合制战斗系统架构，支持DND规则、回合管理、状态机控制、AI决策，实现战斗流程管理、伤害计算、效果应用，提供数据驱动的配置化战斗系统。\r\n+\r\n+### 核心设计理念\r\n+\r\n+#### 1. 多层循环架构为核心\r\n+\r\n+**本质**：战斗系统的核心是多层循环的维护和管理（当前实现为三层）\r\n+\r\n+- **战斗循环**：管理整个战斗的生命周期\r\n+- **回合循环**：管理回合的循环和切换\r\n+- **单位循环**：管理单个单位的行动流程\r\n+- **循环驱动**：所有战斗逻辑都在循环框架内执行\r\n+- **状态维护**：每层循环维护自己的状态，驱动下层循环\r\n+\r\n+#### 2. 数据驱动架构\r\n+\r\n+**本质**：战斗特性通过配置数据实现，无需修改代码\r\n+\r\n+- 战斗规则、伤害计算、效果应用 → 通过配置数据定义\r\n+- 回合流程、状态转换 → 通过配置数据调整\r\n+- 新增战斗机制 → 扩展配置数据即可\r\n+- 战斗平衡 → 调整配置数值即可\r\n+\r\n+#### 3. 分层架构（循环内的功能组织）\r\n+\r\n+**本质**：分层架构是循环内的功能组织方式，不是主要架构\r\n+\r\n+- 功能组织：输入层、决策层、执行层、表现层、管理层\r\n+- 执行位置：所有分层功能都在单位循环内执行\r\n+- 解耦设计：层间通过Context和CommunicationBus通信\r\n+\r\n+#### 4. Domain controls Loop\r\n+\r\n+**核心原则**：Domain控制循环，循环是Domain的工具\r\n+\r\n+- Domain是领域核心，拥有循环机制来推进业务流程\r\n+- Domain管理通过协调器控制循环状态转换\r\n+- 协调器执行完业务后，主动推动循环进入下一个状态\r\n+\r\n+---\r\n+\r\n+## 整体架构\r\n+\r\n+### 多层循环架构\r\n+\r\n+**核心观点**：整个回合制战斗系统的核心是维护多层循环，所有战斗逻辑都在循环框架内执行。\r\n+\r\n+#### Domain与循环的关系\r\n+\r\n+**术语说明**：使用\"Domain\"而非\"Entity\"，避免与项目中的\"Unit\"概念混淆。\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    subgraph BattleDomain[\"战斗Domain<br/>Battle Domain\"]\r\n+        BattleManagement[战斗管理<br/>结算奖励/同步任务]\r\n+        BattleLoop[\"战斗循环<br/>BattleLoop\"]\r\n+        BattleManagement -->|控制| BattleLoop\r\n+        BattleLoop -->|推进| BattleManagement\r\n+        \r\n+        subgraph RoundDomain[\"回合Domain<br/>Round Domain\"]\r\n+            RoundManagement[回合管理<br/>行动值排序/单位行动顺序]\r\n+            RoundLoop[\"回合循环<br/>RoundLoop\"]\r\n+            RoundManagement -->|控制| RoundLoop\r\n+            RoundLoop -->|推进| RoundManagement\r\n+            \r\n+            subgraph UnitDomain[\"单位Domain<br/>Unit Domain\"]\r\n+                UnitManagement[单位管理<br/>移动/施法/选择技能对象]\r\n+                UnitLoop[\"单位循环<br/>UnitLoop\"]\r\n+                UnitManagement -->|控制| UnitLoop\r\n+                UnitLoop -->|推进| UnitManagement\r\n+            end\r\n+        end\r\n+    end\r\n+    \r\n+    style BattleDomain fill:#ffebee\r\n+    style RoundDomain fill:#fff4e1\r\n+    style UnitDomain fill:#e1f5ff\r\n+    style BattleLoop fill:#f3e5f5\r\n+    style RoundLoop fill:#f3e5f5\r\n+    style UnitLoop fill:#f3e5f5\r\n+```\r\n+\r\n+**备注**：\r\n+- **三层架构**：当前实现为三层架构（战斗→回合→单位），符合DND规则中所有单位按先攻值统一排序的设计\r\n+- **阵营循环**：在标准DND规则中，所有单位按先攻值（Initiative）统一排序行动，不存在阵营循环。此处保留作为扩展设计，便于后续支持阵营差异行为\r\n+\r\n+#### Domain协作关系\r\n+\r\n+**核心观点**：Domain之间通过协作推进业务流程，父Domain调用子Domain，子Domain完成业务后返回父Domain。\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    BattleDomain[战斗Domain<br/>Battle Domain]\r\n+    RoundDomain[回合Domain<br/>Round Domain]\r\n+    UnitDomain[单位Domain<br/>Unit Domain]\r\n+    \r\n+    BattleDomain -->|1. 调用| RoundDomain\r\n+    RoundDomain -->|2. 返回| BattleDomain\r\n+    RoundDomain -->|3. 调用| UnitDomain\r\n+    UnitDomain -->|4. 返回| RoundDomain\r\n+    \r\n+    BattleDomain -.->|包含| RoundDomain\r\n+    RoundDomain -.->|包含| UnitDomain\r\n+    \r\n+    style BattleDomain fill:#ffebee\r\n+    style RoundDomain fill:#fff4e1\r\n+    style UnitDomain fill:#e1f5ff\r\n+```\r\n+\r\n+**协作流程说明**：\r\n+1. **战斗Domain** → 调用 **回合Domain**：战斗进行中，需要执行回合\r\n+2. **回合Domain** → 调用 **单位Domain**：回合进行中，需要处理单位行动\r\n+3. **单位Domain** → 返回 **回合Domain**：单位行动完成\r\n+4. **回合Domain** → 返回 **战斗Domain**：回合完成\r\n+\r\n+**协作原则**：\r\n+- 父Domain控制子Domain的调用时机\r\n+- 子Domain完成业务后主动返回父Domain\r\n+- 每个Domain独立管理自己的业务逻辑和循环\r\n+\r\n+### 循环职责说明\r\n+\r\n+#### 1. 战斗循环（BattleLoop）\r\n+- **职责**：管理整个战斗的生命周期\r\n+- **状态**：PREPARING → IN_PROGRESS → ENDED\r\n+- **维护**：BattleLoopManager\r\n+\r\n+#### 2. 回合循环（RoundLoop）\r\n+- **职责**：管理回合的循环和切换\r\n+- **状态**：START → ACTION → END\r\n+- **维护**：RoundLoopManager\r\n+\r\n+#### 3. 单位循环（UnitLoop）\r\n+- **职责**：管理单个单位的行动流程\r\n+- **状态**：START → ACTION → END\r\n+- **维护**：UnitLoopManager\r\n+\r\n+---\r\n+\r\n+## 战斗领域\r\n+\r\n+### 核心职责\r\n+\r\n+战斗领域负责管理整个战斗的生命周期，包括战斗初始化、战斗流程控制、战斗结束判断、奖励结算、任务同步等。\r\n+\r\n+### 架构结构\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    subgraph BattleDomain[\"战斗Domain<br/>Battle Domain\"]\r\n+        BattleManagement[战斗管理<br/>BattleManagement]\r\n+        BattleLoop[战斗循环<br/>BattleLoop<br/>PREPARING → IN_PROGRESS → ENDED]\r\n+        RoundCoordinator[回合协调器<br/>RoundCoordinator<br/>微核心：只负责协调调用]\r\n+        \r\n+        subgraph BattleManagement[\"战斗管理<br/>BattleManagement\"]\r\n+            BattleData[战斗数据<br/>BattleData]\r\n+            DataMgr[战斗数据管理<br/>战斗状态/回合历史/活跃阵营]\r\n+            RuleMgr[战斗规则管理<br/>战斗开始/结束条件/胜利条件/失败条件]\r\n+            RewardMgr[奖励管理<br/>奖励结算/任务同步]\r\n+        end\r\n+    end\r\n+    \r\n+    subgraph ExternalSystems[\"外部系统\"]\r\n+        RoundDomain[回合领域<br/>Round Domain]\r\n+        RewardSystem[奖励系统<br/>Reward System]\r\n+        TaskSystem[任务系统<br/>Task System]\r\n+    end\r\n+    \r\n+    BattleManagement -->|控制| BattleLoop\r\n+    BattleManagement --> RoundCoordinator\r\n+    RoundCoordinator -->|反向推动| BattleLoop\r\n+    BattleLoop -->|推进| BattleManagement\r\n+    \r\n+    RoundCoordinator -->|调用| RoundDomain\r\n+    RoundDomain -->|返回| RoundCoordinator\r\n+    \r\n+    BattleManagement -->|结算奖励| RewardSystem\r\n+    BattleManagement -->|同步任务| TaskSystem\r\n+    \r\n+    style BattleDomain fill:#ffebee\r\n+    style BattleManagement fill:#ffebee\r\n+    style BattleLoop fill:#f3e5f5\r\n+    style RoundCoordinator fill:#c8e6c9\r\n+```\r\n+\r\n+### 战斗管理（BattleManagement）\r\n+\r\n+#### 1. 战斗数据管理\r\n+- **战斗状态**：当前战斗状态（PREPARING/IN_PROGRESS/ENDED）\r\n+- **回合历史**：记录已完成的回合历史（`roundHistoryQueue`）\r\n+- **活跃阵营列表**：当前战斗中活跃的阵营ID列表（`activeFactionIDs`）\r\n+- **突袭回合阵营列表**：被突袭的阵营ID列表（`surpriseRoundFactionIDs`）\r\n+\r\n+#### 2. 战斗规则管理\r\n+- **战斗开始条件**：检查是否可以开始战斗\r\n+- **战斗结束条件**：检查是否应该结束战斗\r\n+- **胜利条件**：检查是否满足胜利条件（`CheckVictoryCondition`）\r\n+- **失败条件**：检查是否满足失败条件（`CheckDefeatCondition`）\r\n+\r\n+#### 3. 奖励管理\r\n+- **奖励结算**：战斗结束后结算奖励\r\n+- **任务同步**：同步战斗相关的任务进度\r\n+\r\n+### 战斗循环（BattleLoop）\r\n+\r\n+**循环状态**：PREPARING → IN_PROGRESS → ENDED\r\n+\r\n+- **PREPARING**：战斗准备中，初始化战斗数据\r\n+- **IN_PROGRESS**：战斗进行中，执行回合（调用回合领域）\r\n+- **ENDED**：战斗已结束，结算奖励、同步任务\r\n+\r\n+### 回合协调器（RoundCoordinator）\r\n+\r\n+**核心原则**：只负责协调调用，不包含业务规则\r\n+\r\n+**核心职责**：\r\n+- ✅ **协调调用**：调用回合领域执行回合\r\n+- ✅ **反向推动循环**：回合完成后，主动推动战斗循环进入下一个状态（Domain controls Loop）\r\n+\r\n+### 战斗完整流程\r\n+\r\n+```mermaid\r\n+flowchart TD\r\n+    LoopPreparing[LoopPreparing<br/>战斗准备] --> InitBattle[初始化战斗数据<br/>战斗管理初始化]\r\n+    \r\n+    InitBattle --> LoopProgress[LoopProgress<br/>战斗进行中]\r\n+    \r\n+    LoopProgress --> CallRound[调用回合领域<br/>回合协调器调用回合领域]\r\n+    \r\n+    CallRound --> RoundAction[回合领域执行回合<br/>回合领域完成回合]\r\n+    \r\n+    RoundAction --> PushProgress[回合协调器推动循环<br/>推动到IN_PROGRESS状态继续]\r\n+    \r\n+    PushProgress --> CheckEnd{检查战斗结束条件<br/>战斗管理检查}\r\n+    \r\n+    CheckEnd -->|未结束| CallRound\r\n+    CheckEnd -->|已结束| PushEnd[回合协调器推动循环<br/>推动到ENDED状态]\r\n+    \r\n+    PushEnd --> LoopEnd[LoopEnd<br/>战斗结束]\r\n+    \r\n+    LoopEnd --> Reward[结算奖励<br/>奖励管理结算奖励]\r\n+    Reward --> Task[同步任务<br/>任务管理同步任务]\r\n+    Task --> Complete[战斗完成]\r\n+    \r\n+    style LoopPreparing fill:#ffebee\r\n+    style LoopProgress fill:#ffebee\r\n+    style CallRound fill:#c8e6c9\r\n+    style RoundAction fill:#c8e6c9\r\n+    style PushProgress fill:#f3e5f5\r\n+    style PushEnd fill:#f3e5f5\r\n+    style LoopEnd fill:#ffebee\r\n+    style CheckEnd fill:#ffe0b2\r\n+```\r\n+\r\n+---\r\n+\r\n+## 回合领域\r\n+\r\n+### 核心职责\r\n+\r\n+回合领域负责管理回合的循环和切换，包括回合数管理、行动顺序管理（基于先攻值）、回合开始/结束控制等。\r\n+\r\n+### 架构结构\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    subgraph RoundDomain[\"回合Domain<br/>Round Domain\"]\r\n+        RoundManagement[回合管理<br/>RoundManagement]\r\n+        RoundLoop[回合循环<br/>RoundLoop<br/>START → ACTION → END]\r\n+        UnitCoordinator[单位协调器<br/>UnitCoordinator<br/>微核心：只负责协调调用]\r\n+        \r\n+        subgraph RoundManagement[\"回合管理<br/>RoundManagement\"]\r\n+            RoundData[回合数据<br/>RoundData]\r\n+            DataMgr[回合数据管理<br/>回合数/行动顺序队列]\r\n+            RuleMgr[回合规则管理<br/>回合开始/结束条件]\r\n+            OrderMgr[行动顺序管理<br/>队列初始化/管理/获取下一个单位]\r\n+        end\r\n+        \r\n+        subgraph UnitCoordinator[\"单位协调器<br/>UnitCoordinator<br/>微核心：只负责协调调用\"]\r\n+            UnitCall[单位调用<br/>从回合管理获取单位<br/>调用单位领域]\r\n+        end\r\n+    end\r\n+    \r\n+    subgraph ExternalSystems[\"外部系统\"]\r\n+        BattleDomain[战斗领域<br/>Battle Domain]\r\n+        UnitDomain[单位领域<br/>Unit Domain]\r\n+    end\r\n+    \r\n+    BattleDomain -->|控制| RoundDomain\r\n+    RoundManagement -->|控制| RoundLoop\r\n+    RoundManagement --> UnitCoordinator\r\n+    UnitCoordinator -->|反向推动| RoundLoop\r\n+    RoundLoop -->|推进| RoundManagement\r\n+    \r\n+    UnitCoordinator -->|调用| UnitDomain\r\n+    UnitDomain -->|返回| UnitCoordinator\r\n+    \r\n+    style RoundDomain fill:#fff4e1\r\n+    style RoundManagement fill:#fff4e1\r\n+    style RoundLoop fill:#f3e5f5\r\n+    style UnitCoordinator fill:#c8e6c9\r\n+    style RoundData fill:#e1f5ff\r\n+```\r\n+\r\n+### 回合管理（RoundManagement）\r\n+\r\n+#### 1. 回合数据管理\r\n+- **回合数**：当前回合数、总回合数\r\n+- **行动顺序队列**：基于先攻值的优先级队列（TurnQueue）\r\n+- **当前行动单位**：当前正在行动的单位\r\n+- **活跃阵营列表**：当前回合中活跃的阵营ID列表\r\n+\r\n+#### 2. 回合规则管理\r\n+- **回合开始条件**：检查是否可以开始新回合\r\n+- **回合结束条件**：检查是否应该结束当前回合（所有单位行动完成）\r\n+- **回合切换规则**：判断是否还有下一个回合\r\n+- **突袭回合规则**：战斗开始时，只有被突袭的阵营才能行动（Surprise Round）\r\n+- **单位存活检查**：只有存活的单位才能参与回合（`unit:IsAlive()`）\r\n+- **活跃阵营过滤**：只有活跃的阵营才能参与回合（`activeFactionIDs`）\r\n+\r\n+#### 3. 行动顺序管理\r\n+- **初始化队列**：回合开始时，根据先攻值初始化行动顺序队列\r\n+  - **突袭回合处理**：战斗开始时，只有被突袭的阵营单位加入队列\r\n+  - **正常回合处理**：正常回合中，所有活跃阵营的存活单位加入队列\r\n+- **队列管理**：管理行动顺序队列的添加、移除、清空\r\n+- **获取下一个单位**：从行动顺序队列中获取下一个行动单位（自动过滤死亡单位）\r\n+- **下一个单位检查**：检查是否还有下一个行动单位\r\n+- **延迟行动管理**：管理延迟行动的单位列表，在适当时候插入到行动顺序中\r\n+\r\n+### 回合循环（RoundLoop）\r\n+\r\n+**循环状态**：START → ACTION → END\r\n+\r\n+- **START**：回合开始，初始化行动顺序队列\r\n+  - **突袭回合**：只有被突袭的阵营单位加入队列\r\n+  - **正常回合**：所有活跃阵营的存活单位加入队列\r\n+- **ACTION**：执行回合行动（调用单位领域）\r\n+- **END**：回合结束，清理回合数据，处理延迟行动\r\n+\r\n+### 单位协调器（UnitCoordinator）\r\n+\r\n+**核心原则**：只负责协调调用，不包含业务规则\r\n+\r\n+**核心职责**：\r\n+- ✅ **协调调用**：从回合管理获取下一个单位，调用单位领域执行单位行动\r\n+- ✅ **反向推动循环**：单位行动完成后，主动推动回合循环进入下一个状态（Domain controls Loop）\r\n+\r\n+#### 循环推动机制\r\n+- **推动到END**：所有单位行动完成后，推动循环从ACTION状态进入END状态\r\n+- **推动到START**：回合结束时，推动循环从END状态进入START状态（下一个回合）\r\n+- **推动到ACTION**：回合开始时，推动循环从START状态进入ACTION状态\r\n+\r\n+### 回合完整流程\r\n+\r\n+```mermaid\r\n+flowchart TD\r\n+    LoopStart[LoopStart<br/>战斗领域推动循环] --> InitQueue[初始化行动顺序队列<br/>回合管理根据先攻值排序]\r\n+    \r\n+    InitQueue --> LoopAction[LoopAction<br/>执行回合行动]\r\n+    \r\n+    LoopAction --> GetNextUnit{获取下一个单位<br/>回合管理从队列获取}\r\n+    \r\n+    GetNextUnit -->|有单位| CallUnit[调用单位领域<br/>单位协调器调用单位领域]\r\n+    GetNextUnit -->|无单位| PushEnd\r\n+    \r\n+    CallUnit --> UnitAction[单位领域执行行动<br/>单位领域完成行动]\r\n+    \r\n+    UnitAction --> PushAction[单位协调器推动循环<br/>推动到ACTION状态继续]\r\n+    \r\n+    PushAction --> GetNextUnit\r\n+    \r\n+    PushEnd[单位协调器推动循环<br/>推动到END状态]\r\n+    \r\n+    PushEnd --> RoundEnd[LoopEnd<br/>回合结束]\r\n+    \r\n+    RoundEnd --> CheckNextRound{检查下一个回合<br/>回合管理检查是否还有下一个回合}\r\n+    \r\n+    CheckNextRound -->|有下一个回合| PushStart[单位协调器推动循环<br/>推动到START状态]\r\n+    CheckNextRound -->|无下一个回合| EndRound[结束回合循环<br/>返回战斗领域]\r\n+    \r\n+    PushStart --> LoopStart\r\n+    \r\n+    style LoopStart fill:#fff4e1\r\n+    style LoopAction fill:#fff4e1\r\n+    style CallUnit fill:#c8e6c9\r\n+    style UnitAction fill:#c8e6c9\r\n+    style PushAction fill:#f3e5f5\r\n+    style PushEnd fill:#f3e5f5\r\n+    style PushStart fill:#f3e5f5\r\n+    style LoopEnd fill:#fff4e1\r\n+    style GetNextUnit fill:#ffe0b2\r\n+    style CheckNextRound fill:#ffe0b2\r\n+```\r\n+\r\n+**关键点**：\r\n+- ✅ **Domain controls Loop**：回合管理通过单位协调器控制循环状态转换\r\n+- ✅ **反向推动机制**：单位协调器执行完单位行动后，主动推动循环进入下一个状态\r\n+- ✅ **单位协调器不处理业务规则**：只负责协调调用单位领域，不处理回合业务逻辑\r\n+- ✅ **行动顺序管理**：回合管理负责基于先攻值的优先级队列，确保单位按正确顺序行动\r\n+- ✅ **队列驱动**：通过行动顺序队列驱动单位行动，队列为空时回合结束\r\n+\r\n+### 职责划分\r\n+\r\n+| 组件 | 职责 | 说明 |\r\n+|------|------|------|\r\n+| **回合管理** | 回合数据与规则 | 管理回合数、行动顺序队列、回合开始/结束规则、队列管理 |\r\n+| **单位协调器** | 协调调用 | 从回合管理获取单位，调用单位领域，不处理回合业务规则 |\r\n+| **回合循环** | 流程控制 | START/ACTION/END状态转换，由回合管理控制 |\r\n+\r\n+---\r\n+\r\n+## 单位领域\r\n+\r\n+### 核心职责\r\n+\r\n+单位领域是战斗系统的核心，负责管理单个单位的行动流程，包括移动、技能释放、数值控制等。\r\n+\r\n+\r\n+### 数值查询及推送 (CommunicationBus)\r\n+\r\n+- 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n+\r\n+\r\n+```mermaid\r\n+graph TB\r\n+\r\n+    subgraph 起点[\"起点\"]\r\n+        节点\r\n+        领域\r\n+        外部系统\r\n+    end\r\n+\r\n+    节点 --> EffectHandler -.-> PushChannel -.-> 数据模块\r\n+    领域 --> EffectHandler\r\n+    EffectHandler  -.-> QueryChannel  -.-> 数据模块\r\n+    外部系统 -.-> EffectHandler\r\n+\r\n+    style PushChannel fill:#c8e6c9\r\n+    style QueryChannel fill:#c8e6c9\r\n+    style 起点 fill:#ffe0b2\r\n+```\r\n+\r\n+### 架构结构\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    subgraph UnitDomain[\"单位Domain<br/>Unit Domain\"]\r\n+        UnitManagement[单位管理<br/>UnitManagement]\r\n+        UnitLoop[单位循环<br/>UnitLoop<br/>START → ACTION → END]\r\n+        ActionCoordinator[行动协调器<br/>ActionCoordinator<br/>微核心：只负责协调调用]\r\n+        \r\n+        subgraph UnitManagement[\"单位管理<br/>UnitManagement\"]\r\n+            UnitData[单位数据<br/>UnitData]\r\n+            DataMgr[单位数据管理<br/>属性/状态/位置/回合数据<br/>AP/MP/先攻值]\r\n+            RuleMgr[单位规则管理<br/>行动点数规则/移动点数规则<br/>先攻值规则/回合初始化规则]\r\n+        end\r\n+        \r\n+        subgraph DataHandleQueue[\"DataHandleQueue<br/>数据队列<br/>1:1关系\"]\r\n+        end\r\n+        \r\n+        subgraph ActionCoordinator[\"行动协调器<br/>ActionCoordinator<br/>微核心：只负责协调调用\"]\r\n+            MoveCoord[移动协调<br/>调用网格系统]\r\n+            SkillCoord[技能协调<br/>调用技能领域]\r\n+            TerrainCoord[地形交互协调<br/>调用地形领域<br/>可选]\r\n+            VisualCoord[表现协调<br/>通知表现层]\r\n+        end\r\n+    end\r\n+    \r\n+    subgraph ExternalSystems[\"外部系统\"]\r\n+        GridSystem[网格系统<br/>GridSystem]\r\n+        SkillDomain[技能领域<br/>Skill Domain]\r\n+        VisualSystem[表现系统<br/>Visual System]\r\n+        TerrainDomain[地形领域<br/>Terrain Domain]\r\n+    end\r\n+    \r\n+    UnitManagement -->|控制| UnitLoop\r\n+    UnitManagement --> ActionCoordinator\r\n+    UnitManagement --> UnitData\r\n+    ActionCoordinator -->|反向推动| UnitLoop\r\n+    UnitLoop -->|推进| UnitManagement\r\n+    \r\n+    ActionCoordinator -->|调用| GridSystem\r\n+    ActionCoordinator -->|调用| SkillDomain\r\n+    ActionCoordinator -->|调用| TerrainDomain\r\n+    ActionCoordinator -->|通知| VisualSystem\r\n+    \r\n+    SkillDomain -->|EffectHandler推送| DataHandleQueue\r\n+    TerrainDomain -->|EffectHandler推送| DataHandleQueue\r\n+\r\n+    DataHandleQueue -->|推送数据| UnitData\r\n+    \r\n+    style UnitDomain fill:#e1f5ff\r\n+    style UnitManagement fill:#fff4e1\r\n+    style UnitLoop fill:#f3e5f5\r\n+    style ActionCoordinator fill:#c8e6c9\r\n+    style DataHandleQueue fill:#f3e5f5\r\n+    style UnitData fill:#e1f5ff\r\n+```\r\n+\r\n+### 单位管理（UnitManagement）\r\n+\r\n+#### 1. 单位数据管理\r\n+- **单位属性**：生命值、行动点数（AP）、移动点数（MP）、先攻值等\r\n+- **单位状态**：是否可行动、是否已移动、是否已攻击、是否存活等\r\n+- **单位位置**：当前网格位置\r\n+- **回合数据**：UnitTurnData管理行动点数、移动点数、先攻值等回合相关数据\r\n+\r\n+#### 2. 单位规则管理\r\n+- **移动点数规则**：移动前检查能否移动\r\n+- **行动点数规则**：检查行动是否可执行（`CheckAction`），消耗行动点数和移动点数（`ConsumeAction`）\r\n+- **行动规则**：是否可执行行动（移动、攻击、技能等）\r\n+- **状态规则**：状态转换规则（是否存活、是否可行动等）\r\n+- **先攻值规则**：管理单位的先攻值，用于回合顺序排序\r\n+- **回合初始化规则**：回合开始时初始化行动点数和移动点数（`StartUnitTurn`）\r\n+\r\n+#### 3. UnitData与DataHandleQueue关系\r\n+- **1:1关系**：DataHandleQueue 与 UnitData 是 1:1 关系，数据直接修改 UnitData\r\n+- **直接修改**：技能领域的EffectHandler推送数据到DataHandleQueue后，直接修改UnitData\r\n+- **无需中间层**：不需要\"数值控制管理\"中间层，DataHandleQueue直接修改UnitData\r\n+\r\n+### 单位循环（UnitLoop）\r\n+\r\n+**循环状态**：START → ACTION → END\r\n+\r\n+- **START**：单位开始行动\r\n+- **ACTION**：执行行动（移动、技能等）\r\n+- **END**：单位结束行动\r\n+\r\n+### 行动协调器（ActionCoordinator）\r\n+\r\n+**核心原则**：只负责协调调用，不包含业务规则\r\n+\r\n+**核心职责**：\r\n+- ✅ **协调调用**：调用网格系统、技能领域、表现系统\r\n+- ✅ **反向推动循环**：执行完行动后，主动推动单位循环进入下一个状态（Domain controls Loop）\r\n+\r\n+#### 1. 移动协调\r\n+- **移动前检查**：调用单位管理检查移动点数和行动点数\r\n+- **调用网格系统**：进行移动计算（路径查找、移动范围等）\r\n+- **移动后更新**：通过 DataHandleQueue 更新单位位置和移动点数\r\n+- **推动循环**：移动完成后，推动循环进入下一个状态\r\n+\r\n+#### 2. 技能协调\r\n+- **行动点数检查**：调用单位管理检查行动点数是否足够\r\n+- **调用技能领域**：执行技能\r\n+- **不处理数值控制**：数值控制由技能领域的EffectHandler通过DataHandleQueue处理\r\n+- **接收技能结果**：获取技能执行结果（成功/失败），用于流程控制\r\n+- **推动循环**：技能执行完成后，推动循环进入下一个状态\r\n+\r\n+#### 3. 地形交互协调（可选）\r\n+- **地形交互检查**：检查单位是否触发地形要素（陷阱、门等）\r\n+- **调用地形领域**：如果触发地形要素，调用地形领域处理\r\n+- **推动循环**：地形交互完成后，推动循环进入下一个状态\r\n+\r\n+#### 4. 表现协调\r\n+- **通知表现层**：移动表现、技能表现、受攻击表现\r\n+- **推动循环**：表现播放完成后（可选），推动循环进入下一个状态\r\n+\r\n+### 单位行动完整流程\r\n+\r\n+```mermaid\r\n+flowchart TD\r\n+    LoopStart[LoopStart<br/>单位管理推动循环] --> LoopAction[LoopAction<br/>执行行动]\r\n+    \r\n+    LoopAction --> CheckAction{行动前检查<br/>单位管理检查行动点数/移动点数}\r\n+    \r\n+    CheckAction -->|可以移动| Move[单位移动<br/>行动协调器调用网格系统]\r\n+    CheckAction -->|不能移动| Skill\r\n+    \r\n+    Move --> UpdateMove[更新移动点数<br/>DataHandleQueue推送]\r\n+    UpdateMove --> Skill[攻击/治疗<br/>行动协调器调用技能领域]\r\n+    \r\n+    Skill --> EffectPush[EffectHandler推送效果<br/>通过DataHandleQueue到目标单位]\r\n+    EffectPush --> Visual[可视化<br/>行动协调器通知表现层]\r\n+    \r\n+    Visual --> PushEnd[行动协调器推动循环<br/>推动到END状态]\r\n+    \r\n+    PushEnd --> CheckActionPoint{行动点数检查<br/>单位管理检查是否还有行动点数/移动点数}\r\n+    \r\n+    CheckActionPoint -->|还有行动点数/移动点数| PushAction[行动协调器推动循环<br/>推动回ACTION状态]\r\n+    CheckActionPoint -->|无行动点数/移动点数| LoopEnd[LoopEnd<br/>单位结束行动]\r\n+    \r\n+    PushAction --> LoopAction\r\n+    \r\n+    style LoopStart fill:#e1f5ff\r\n+    style LoopAction fill:#e1f5ff\r\n+    style Move fill:#fff4e1\r\n+    style Skill fill:#c8e6c9\r\n+    style EffectPush fill:#fff4e1\r\n+    style Visual fill:#c8e6c9\r\n+    style PushEnd fill:#f3e5f5\r\n+    style PushAction fill:#f3e5f5\r\n+    style LoopEnd fill:#e1f5ff\r\n+    style CheckAction fill:#ffe0b2\r\n+    style CheckActionPoint fill:#ffe0b2\r\n+```\r\n+\r\n+\r\n+\r\n+---\r\n+\r\n+## 单位领域：节点编排架构\r\n+\r\n+### 核心设计理念\r\n+\r\n+#### 1. 节点编排器为核心\r\n+\r\n+**本质**：单位行动流程的核心是节点编排器的动态组织和管理\r\n+\r\n+- 单位行动流程 = 节点编排器根据配置动态组织节点执行\r\n+- 节点编排 = 条件节点 → 执行节点 → 可视化节点的组合\r\n+- 流程控制 = 节点编排器根据节点执行结果决定下一个节点\r\n+- 灵活扩展 = 新增节点类型只需注册到编排器\r\n+\r\n+#### 2. 节点分类设计\r\n+\r\n+**本质**：节点按功能职责分为四类，每类节点职责单一、可复用\r\n+\r\n+- **输入节点（Input Node）**：负责接收玩家输入（如：接收移动点击、接收技能选择、接收目标选择等）\r\n+- **条件节点（Condition Node）**：负责验证、检查、判断，返回判断结果和流程控制建议（如：检查移动点数、验证技能可释放、检查资源决定是否继续等）\r\n+- **执行节点（Execution Node）**：负责实际执行操作，修改数据（如：执行移动、执行技能、消耗资源、更新状态等）\r\n+- **可视化节点（Visual Node）**：负责表现播放（如：播放移动表现、播放技能表现等）\r\n+\r\n+\r\n+\r\n+### 节点编排器架构\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    subgraph UnitDomain[\"单位Domain\"]\r\n+        NodeOrchestrator[节点编排器<br/>NodeOrchestrator]\r\n+        \r\n+        subgraph NodeRegistry[\"节点注册表<br/>NodeRegistry\"]\r\n+            subgraph InputNodes[\"输入节点组<br/>Input Nodes\"]\r\n+                ReceiveMoveInputNode[接收移动输入节点]\r\n+                ReceiveSkillSelectNode[接收技能选择节点]\r\n+                ReceiveTargetSelectNode[接收目标选择节点]\r\n+            end\r\n+            \r\n+            subgraph ConditionNodes[\"条件节点组<br/>Condition Nodes\"]\r\n+                CheckMovePointNode[检查移动点数节点]\r\n+                CheckActionPointNode[检查行动点数节点]\r\n+                ValidateSkillNode[验证技能节点]\r\n+                ValidateTargetNode[验证目标节点]\r\n+                ValidateMoveNode[验证移动节点]\r\n+                CheckResourceNode[检查资源节点]\r\n+            end\r\n+            \r\n+            subgraph ExecutionNodes[\"执行节点组<br/>Execution Nodes\"]\r\n+                InitUnitNode[初始化单位节点]\r\n+                MoveNode[移动节点]\r\n+                SelectSkillNode[选择技能节点]\r\n+                SelectTargetNode[选择目标节点]\r\n+                ExecuteSkillNode[执行技能节点]\r\n+                ConsumeResourceNode[消耗资源节点]\r\n+                UpdateStateNode[更新状态节点]\r\n+            end\r\n+            \r\n+            subgraph VisualNodes[\"可视化节点组<br/>Visual Nodes\"]\r\n+                PlayMoveVisualNode[播放移动表现节点]\r\n+                PlaySkillVisualNode[播放技能表现节点]\r\n+                PlayTargetVisualNode[播放目标表现节点]\r\n+            end\r\n+        end\r\n+        \r\n+        FlowConfig[流程配置<br/>NodeFlowConfig]\r\n+        ContextManager[上下文管理器<br/>ContextManager]\r\n+        \r\n+        subgraph CommunicationBus[\"通讯总线\"]\r\n+            EventChannel[事件通道<br/>EventChannel]\r\n+            MessageChannel[消息通道<br/>MessageChannel]\r\n+            PushChannel[推送通道<br/>PushChannel]\r\n+            QueryChannel[查询通道<br/>QueryChannel]\r\n+        end\r\n+        \r\n+        subgraph DataModules[\"数据模块\"]\r\n+            UnitDataModule[单位数据模块<br/>UnitData]\r\n+            SkillDomainModule[技能领域模块<br/>SkillDomain]\r\n+            TerrainDomainModule[地形领域模块<br/>TerrainDomain]\r\n+            GridSystemModule[网格系统模块<br/>GridSystem]\r\n+        end\r\n+    end\r\n+    \r\n+    NodeOrchestrator -->|管理节点| NodeRegistry\r\n+    NodeOrchestrator -->|读取配置| FlowConfig\r\n+    NodeOrchestrator -->|执行节点| InputNodes\r\n+    NodeOrchestrator -->|执行节点| ConditionNodes\r\n+    NodeOrchestrator -->|执行节点| ExecutionNodes\r\n+    NodeOrchestrator -->|执行节点| VisualNodes\r\n+    NodeOrchestrator -->|管理Context| ContextManager\r\n+    \r\n+    InputNodes -->|发布事件| EventChannel\r\n+    ConditionNodes -->|发布事件| EventChannel\r\n+    ConditionNodes -->|查询数据| QueryChannel\r\n+    ExecutionNodes -->|订阅事件| EventChannel\r\n+    ExecutionNodes -->|1对1通讯| MessageChannel\r\n+    ExecutionNodes -->|查询数据| QueryChannel\r\n+    ExecutionNodes -->|接收数据| PushChannel\r\n+    VisualNodes -->|订阅事件| EventChannel\r\n+    VisualNodes -->|接收数据| PushChannel\r\n+    \r\n+    QueryChannel -->|查询| UnitDataModule\r\n+    QueryChannel -->|查询| SkillDomainModule\r\n+    QueryChannel -->|查询| TerrainDomainModule\r\n+    QueryChannel -->|查询| GridSystemModule\r\n+    \r\n+    PushChannel -->|推送数据| UnitDataModule\r\n+    SkillDomainModule -->|推送数据| PushChannel\r\n+    TerrainDomainModule -->|推送数据| PushChannel\r\n+    \r\n+    style NodeOrchestrator fill:#c8e6c9\r\n+    style NodeRegistry fill:#e1f5ff\r\n+    style InputNodes fill:#ffebee\r\n+    style ConditionNodes fill:#fff4e1\r\n+    style ExecutionNodes fill:#c8e6c9\r\n+    style VisualNodes fill:#f3e5f5\r\n+    style CommunicationBus fill:#fff4e1\r\n+```\r\n+\r\n+### 节点编排器职责\r\n+\r\n+1. **节点注册管理**\r\n+   - 管理节点注册表（NodeRegistry）\r\n+   - 支持动态注册/注销节点\r\n+   - 提供节点查找接口（按ID、按类型）\r\n+\r\n+2. **流程编排**\r\n+   - 根据FlowConfig动态组织节点执行顺序\r\n+   - 处理节点间的跳转、条件分支、循环\r\n+   - 管理节点执行状态和生命周期\r\n+\r\n+3. **Context管理**\r\n+   - 在节点间传递UnitContext\r\n+   - 管理Context的生命周期\r\n+   - 处理Context状态恢复\r\n+\r\n+4. **错误处理**\r\n+   - 处理节点执行失败\r\n+   - 资源回滚和状态恢复\r\n+   - 错误通知和日志记录\r\n+\r\n+### 节点分类详细设计\r\n+\r\n+#### 输入节点（Input Node）\r\n+\r\n+**职责**：接收玩家输入，不修改数据，只负责输入数据的收集和传递\r\n+\r\n+**节点列表**：\r\n+1. **ReceiveMoveInputNode**：接收玩家点击的网格坐标\r\n+2. **ReceiveSkillSelectNode**：接收玩家选择的技能ID\r\n+3. **ReceiveTargetSelectNode**：接收玩家选择的目标（单位、位置等）\r\n+\r\n+**节点接口**：\r\n+- `Execute(context) -> result`：接收输入，返回输入数据和有效性\r\n+- `WaitForInput(context) -> input`：等待玩家输入（异步）\r\n+- `ValidateInput(input) -> bool`：验证输入有效性\r\n+\r\n+#### 条件节点（Condition Node）\r\n+\r\n+**职责**：验证、检查、判断，不修改数据，返回判断结果和流程控制建议\r\n+\r\n+**节点列表**：\r\n+1. **CheckMovePointNode**：检查单位是否有足够的移动点数\r\n+2. **CheckActionPointNode**：检查单位是否有足够的行动点数\r\n+3. **ValidateMoveNode**：验证移动输入是否合法（位置、路径、范围等）\r\n+4. **ValidateSkillNode**：验证技能是否可释放\r\n+5. **ValidateTargetNode**：验证目标是否合法（距离、状态、条件等）\r\n+6. **CheckResourceNode**：检查单位是否还有资源继续行动\r\n+\r\n+**返回结果结构**：\r\n+```lua\r\n+{\r\n+    success: true/false,           -- 判断结果\r\n+    data: {...},                   -- 判断数据（可选）\r\n+    nextAction: \"continue\"/\"end\"/\"skip\", -- 流程控制建议（可选）\r\n+    loopState: \"ACTION\"/\"END\"      -- 循环状态建议（可选）\r\n+}\r\n+```\r\n+\r\n+#### 执行节点（Execution Node）\r\n+\r\n+**职责**：实际执行操作，修改数据，返回执行结果\r\n+\r\n+**节点列表**：\r\n+1. **InitUnitNode**：初始化单位行动状态，重置行动点数和移动点数\r\n+2. **MoveNode**：执行移动并更新单位位置，消耗移动点数\r\n+3. **SelectSkillNode**：显示可用的技能列表，准备技能释放上下文\r\n+4. **SelectTargetNode**：根据技能类型显示可选目标，更新技能上下文中的目标信息\r\n+5. **ExecuteSkillNode**：调用技能领域执行技能，处理技能执行结果\r\n+6. **ConsumeResourceNode**：消耗行动点数和资源，记录资源消耗信息\r\n+7. **UpdateStateNode**：批量处理所有状态变更数据，更新单位状态\r\n+\r\n+**节点接口**：\r\n+- `Execute(context) -> result`：执行操作\r\n+- `CanExecute(context) -> bool`：检查是否可以执行\r\n+- `Rollback(context)`：回滚操作（失败时）\r\n+\r\n+#### 可视化节点（Visual Node）\r\n+\r\n+**职责**：播放表现，不修改数据，只负责视觉反馈\r\n+\r\n+**节点列表**：\r\n+1. **PlayMoveVisualNode**：通知VisualSystem播放移动表现\r\n+2. **PlaySkillVisualNode**：通知VisualSystem播放技能释放表现\r\n+3. **PlayTargetVisualNode**：通知VisualSystem播放受攻击单位表现\r\n+\r\n+**节点接口**：\r\n+- `Execute(context) -> result`：播放表现\r\n+- `WaitForComplete(context) -> bool`：等待表现完成（可选）\r\n+\r\n+### 节点编排流程示例\r\n+\r\n+```mermaid\r\n+flowchart TD\r\n+    Start[开始] --> Init[InitUnitNode<br/>初始化单位]\r\n+    \r\n+    Init --> CheckMove{CheckMovePointNode<br/>检查移动点数}\r\n+    CheckMove -->|有移动点数| ReceiveMove[ReceiveMoveInputNode<br/>接收移动输入]\r\n+    CheckMove -->|无移动点数| SelectSkill\r\n+    \r\n+    ReceiveMove --> ValidateMove{ValidateMoveNode<br/>验证移动}\r\n+    ValidateMove -->|验证通过| Move[MoveNode<br/>执行移动]\r\n+    ValidateMove -->|验证失败| ReceiveMove\r\n+    \r\n+    Move --> PlayMove[PlayMoveVisualNode<br/>播放移动表现]\r\n+    PlayMove --> SelectSkill[SelectSkillNode<br/>选择技能]\r\n+    \r\n+    SelectSkill --> ReceiveSkill[ReceiveSkillSelectNode<br/>接收技能选择]\r\n+    ReceiveSkill --> ValidateSkill{ValidateSkillNode<br/>验证技能}\r\n+    ValidateSkill -->|验证通过| SelectTarget[SelectTargetNode<br/>选择目标]\r\n+    ValidateSkill -->|验证失败| SelectSkill\r\n+    \r\n+    SelectTarget --> ReceiveTarget[ReceiveTargetSelectNode<br/>接收目标选择]\r\n+    ReceiveTarget --> ValidateTarget{ValidateTargetNode<br/>验证目标}\r\n+    ValidateTarget -->|验证通过| Consume[ConsumeResourceNode<br/>消耗资源]\r\n+    ValidateTarget -->|验证失败| SelectTarget\r\n+    \r\n+    Consume --> Execute[ExecuteSkillNode<br/>执行技能]\r\n+    Execute --> Update[UpdateStateNode<br/>更新状态]\r\n+    Update --> PlaySkill[PlaySkillVisualNode<br/>播放技能表现]\r\n+    PlaySkill --> PlayTarget[PlayTargetVisualNode<br/>播放目标表现]\r\n+    \r\n+    PlayTarget --> CheckResource{CheckResourceNode<br/>检查资源}\r\n+    CheckResource -->|还有资源| CheckMove\r\n+    CheckResource -->|无资源| End[结束]\r\n+    \r\n+    style Init fill:#c8e6c9\r\n+    style CheckMove fill:#fff4e1\r\n+    style ReceiveMove fill:#ffebee\r\n+    style ValidateMove fill:#fff4e1\r\n+    style Move fill:#c8e6c9\r\n+    style PlayMove fill:#f3e5f5\r\n+    style SelectSkill fill:#c8e6c9\r\n+    style ReceiveSkill fill:#ffebee\r\n+    style ValidateSkill fill:#fff4e1\r\n+    style SelectTarget fill:#c8e6c9\r\n+    style ReceiveTarget fill:#ffebee\r\n+    style ValidateTarget fill:#fff4e1\r\n+    style Consume fill:#c8e6c9\r\n+    style Execute fill:#c8e6c9\r\n+    style Update fill:#c8e6c9\r\n+    style PlaySkill fill:#f3e5f5\r\n+    style PlayTarget fill:#f3e5f5\r\n+    style CheckResource fill:#fff4e1\r\n+    style End fill:#ffebee\r\n+```\r\n+### 节点实现细节\r\n+\r\n+#### UnitContext逐步增强过程\r\n+\r\n+单位行动流程的核心是UnitContext的维护和管理，Context在节点间流转并逐步增强：\r\n+\r\n+```\r\n+UnitContext（节点1：单位循环开始）\r\n+  + unitData（单位数据）\r\n+  + roundContext（回合上下文）\r\n+  ↓\r\n+  + currentUnit（当前行动单位）\r\n+  + unitValidation（单位验证结果）\r\n+  ↓\r\n+  + moveInput（移动输入：点击坐标）\r\n+  + moveValidation（移动验证结果）\r\n+  + movePath（移动路径）\r\n+  + moveResult（移动结果）\r\n+  ↓\r\n+  + selectedSkill（选中的技能）\r\n+  + skillValidation（技能验证结果）\r\n+  + skillContext（技能上下文）\r\n+  ↓\r\n+  + selectedTargets（选中的目标）\r\n+  + targetValidation（目标验证结果）\r\n+  ↓\r\n+  + skillExecutionResult（技能执行结果）\r\n+  + resourceConsumption（资源消耗信息）\r\n+  ↓\r\n+  + visualResult（表现播放结果）\r\n+  + effectResults（效果处理结果）\r\n+  + resourceCheck（资源检查结果）\r\n+  + loopState（循环状态）\r\n+  ↓\r\n+UnitContext（节点7：执行施法后处理）\r\n+```\r\n+\r\n+#### 节点内部架构设计原则\r\n+\r\n+**管道过滤器模式**：\r\n+- 单Context设计：所有节点使用统一的`UnitContext`\r\n+- 逐步增强：每个节点在Context中添加自己的数据\r\n+- 数据流循环：节点1 → 节点2 → ... → 节点7 → 节点3（循环）\r\n+\r\n+**节点内部组件设计**：\r\n+- **输入接收器**：接收外部输入，验证输入有效性\r\n+- **验证器组**：负责各种验证（范围、路径、资源等）\r\n+- **执行器**：负责实际执行操作\r\n+- **数据更新器**：负责更新数据\r\n+- **表现通知器**：负责通知表现层\r\n+- **上下文增强器**：负责增强Context并传递给下一个节点\r\n+- **循环推动器**：负责推动循环状态转换\r\n+\r\n+#### 错误处理和恢复机制\r\n+\r\n+**错误类型**：\r\n+1. **资源错误**：资源不足、资源被消耗等\r\n+2. **验证错误**：验证失败、状态不合法等\r\n+3. **执行错误**：执行失败、异常等\r\n+4. **系统错误**：系统异常、外部系统错误等\r\n+\r\n+**错误处理流程**：\r\n+1. **资源回滚**：执行失败时，回滚已消耗的资源\r\n+2. **状态恢复**：从Context恢复节点执行前的状态\r\n+3. **错误通知**：通知用户错误信息，提供重试或取消选项\r\n+4. **日志记录**：记录错误信息到Context，便于调试和问题追踪\r\n+\r\n+**节点状态机**：\r\n+- **IDLE**：节点未开始执行\r\n+- **EXECUTING**：节点正在执行\r\n+- **COMPLETED**：节点执行完成\r\n+- **FAILED**：节点执行失败\r\n+\r\n+---\r\n+\r\n+## 外部系统集成\r\n+\r\n+### SkillDomain（技能领域）集成\r\n+\r\n+**集成方式**：\r\n+- **调用方式**：ActionCoordinator调用SkillDomain执行技能\r\n+- **数据推送**：SkillDomain的EffectHandler通过DataHandleQueue推送效果数据\r\n+- **数据查询**：节点通过QueryChannel查询技能状态\r\n+\r\n+### TerrainDomain（地形领域）集成\r\n+\r\n+**集成方式**：\r\n+- **调用方式**：ActionCoordinator调用TerrainDomain处理地形要素\r\n+- **数据推送**：TerrainDomain的EffectHandler通过DataHandleQueue推送效果数据\r\n+- **共享Handler机制**：与SkillDomain共享Handler接口，但保持独立系统\r\n+\r\n+### GridSystem（网格系统）集成\r\n+\r\n+**集成方式**：\r\n+- **调用方式**：ActionCoordinator调用GridSystem进行移动计算\r\n+- **数据查询**：节点通过QueryChannel查询移动范围、路径信息\r\n+\r\n+### VisualSystem（表现系统）集成\r\n+\r\n+**集成方式**：\r\n+- **通知方式**：ActionCoordinator通知VisualSystem播放表现\r\n+- **事件订阅**：可视化节点订阅EventChannel接收表现事件\r\n+\r\n+\r\n+### 设计原则总结\r\n+\r\n+- ✅ **Domain controls Loop**：Domain控制循环，循环是Domain的工具\r\n+- ✅ **数据驱动架构**：战斗特性通过配置数据实现，无需额外机制\r\n+- ✅ **节点编排模式**：单位行动流程通过节点编排器动态组织\r\n+- ✅ **解耦设计**：节点间通过CommunicationBus和Context通信，不直接依赖\r\n+- ✅ **多层循环架构**：战斗→回合→单位三层循环架构\r\n+- ✅ **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n+- ✅ **统一数据访问**：节点通过CommunicationBus统一获取数据\r\n+\r\n+---\r\n+\r\n+## 总结\r\n+\r\n+### 架构设计价值\r\n+\r\n+该架构设计文档的价值在于：\r\n+- ✅ **思路解构**：完整解构回合制战斗系统的搭建思路\r\n+- ✅ **流程验证**：从架构层面验证流程合理性\r\n+- ✅ **问题识别**：提前识别潜在的资源和状态问题\r\n+- ✅ **开发指导**：为后续详细设计和实现提供清晰指导\r\n+\r\n+### 架构特点\r\n+\r\n+- ✅ **多层循环架构**：战斗→回合→单位三层循环架构\r\n+- ✅ **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n+- ✅ **统一数据访问**：节点通过CommunicationBus统一获取数据\r\n+- ✅ **错误处理防护**：资源回滚 + 状态恢复 + 错误通知，避免状态不一致\r\n+- ✅ **数据驱动**：所有特性通过配置数据实现，无需修改代码\r\n+\r\n+细节实现是后续开发阶段的工作，当前架构设计已足够指导整个回合制战斗系统的开发。\r\n"
                },
                {
                    "date": 1767184082925,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -451,9 +451,9 @@\n     end\r\n \r\n     节点 --> EffectHandler -.-> PushChannel -.-> 数据模块\r\n     领域 --> EffectHandler\r\n-    EffectHandler  -.-> QueryChannel  -.-> 数据模块\r\n+    起点  -.-> QueryChannel  -.-> 数据模块\r\n     外部系统 -.-> EffectHandler\r\n \r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n@@ -1018,1026 +1018,4 @@\n - ✅ **错误处理防护**：资源回滚 + 状态恢复 + 错误通知，避免状态不一致\r\n - ✅ **数据驱动**：所有特性通过配置数据实现，无需修改代码\r\n \r\n 细节实现是后续开发阶段的工作，当前架构设计已足够指导整个回合制战斗系统的开发。\r\n-# 战斗系统架构设计文档\r\n-\r\n-## 目录\r\n-\r\n-1. [概述](#概述)\r\n-2. [整体架构](#整体架构)\r\n-3. [战斗领域](#战斗领域)\r\n-4. [回合领域](#回合领域)\r\n-5. [单位领域](#单位领域)\r\n-6. [核心机制](#核心机制)\r\n-7. [数据结构](#数据结构)\r\n-8. [外部系统集成](#外部系统集成)\r\n-9. [实现指南](#实现指南)\r\n-\r\n----\r\n-\r\n-## 概述\r\n-\r\n-### 设计目标\r\n-\r\n-设计一套完整的回合制战斗系统架构，支持DND规则、回合管理、状态机控制、AI决策，实现战斗流程管理、伤害计算、效果应用，提供数据驱动的配置化战斗系统。\r\n-\r\n-### 核心设计理念\r\n-\r\n-#### 1. 多层循环架构为核心\r\n-\r\n-**本质**：战斗系统的核心是多层循环的维护和管理（当前实现为三层）\r\n-\r\n-- **战斗循环**：管理整个战斗的生命周期\r\n-- **回合循环**：管理回合的循环和切换\r\n-- **单位循环**：管理单个单位的行动流程\r\n-- **循环驱动**：所有战斗逻辑都在循环框架内执行\r\n-- **状态维护**：每层循环维护自己的状态，驱动下层循环\r\n-\r\n-#### 2. 数据驱动架构\r\n-\r\n-**本质**：战斗特性通过配置数据实现，无需修改代码\r\n-\r\n-- 战斗规则、伤害计算、效果应用 → 通过配置数据定义\r\n-- 回合流程、状态转换 → 通过配置数据调整\r\n-- 新增战斗机制 → 扩展配置数据即可\r\n-- 战斗平衡 → 调整配置数值即可\r\n-\r\n-#### 3. 分层架构（循环内的功能组织）\r\n-\r\n-**本质**：分层架构是循环内的功能组织方式，不是主要架构\r\n-\r\n-- 功能组织：输入层、决策层、执行层、表现层、管理层\r\n-- 执行位置：所有分层功能都在单位循环内执行\r\n-- 解耦设计：层间通过Context和CommunicationBus通信\r\n-\r\n-#### 4. Domain controls Loop\r\n-\r\n-**核心原则**：Domain控制循环，循环是Domain的工具\r\n-\r\n-- Domain是领域核心，拥有循环机制来推进业务流程\r\n-- Domain管理通过协调器控制循环状态转换\r\n-- 协调器执行完业务后，主动推动循环进入下一个状态\r\n-\r\n----\r\n-\r\n-## 整体架构\r\n-\r\n-### 多层循环架构\r\n-\r\n-**核心观点**：整个回合制战斗系统的核心是维护多层循环，所有战斗逻辑都在循环框架内执行。\r\n-\r\n-#### Domain与循环的关系\r\n-\r\n-**术语说明**：使用\"Domain\"而非\"Entity\"，避免与项目中的\"Unit\"概念混淆。\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    subgraph BattleDomain[\"战斗Domain<br/>Battle Domain\"]\r\n-        BattleManagement[战斗管理<br/>结算奖励/同步任务]\r\n-        BattleLoop[\"战斗循环<br/>BattleLoop\"]\r\n-        BattleManagement -->|控制| BattleLoop\r\n-        BattleLoop -->|推进| BattleManagement\r\n-        \r\n-        subgraph RoundDomain[\"回合Domain<br/>Round Domain\"]\r\n-            RoundManagement[回合管理<br/>行动值排序/单位行动顺序]\r\n-            RoundLoop[\"回合循环<br/>RoundLoop\"]\r\n-            RoundManagement -->|控制| RoundLoop\r\n-            RoundLoop -->|推进| RoundManagement\r\n-            \r\n-            subgraph UnitDomain[\"单位Domain<br/>Unit Domain\"]\r\n-                UnitManagement[单位管理<br/>移动/施法/选择技能对象]\r\n-                UnitLoop[\"单位循环<br/>UnitLoop\"]\r\n-                UnitManagement -->|控制| UnitLoop\r\n-                UnitLoop -->|推进| UnitManagement\r\n-            end\r\n-        end\r\n-    end\r\n-    \r\n-    style BattleDomain fill:#ffebee\r\n-    style RoundDomain fill:#fff4e1\r\n-    style UnitDomain fill:#e1f5ff\r\n-    style BattleLoop fill:#f3e5f5\r\n-    style RoundLoop fill:#f3e5f5\r\n-    style UnitLoop fill:#f3e5f5\r\n-```\r\n-\r\n-**备注**：\r\n-- **三层架构**：当前实现为三层架构（战斗→回合→单位），符合DND规则中所有单位按先攻值统一排序的设计\r\n-- **阵营循环**：在标准DND规则中，所有单位按先攻值（Initiative）统一排序行动，不存在阵营循环。此处保留作为扩展设计，便于后续支持阵营差异行为\r\n-\r\n-#### Domain协作关系\r\n-\r\n-**核心观点**：Domain之间通过协作推进业务流程，父Domain调用子Domain，子Domain完成业务后返回父Domain。\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    BattleDomain[战斗Domain<br/>Battle Domain]\r\n-    RoundDomain[回合Domain<br/>Round Domain]\r\n-    UnitDomain[单位Domain<br/>Unit Domain]\r\n-    \r\n-    BattleDomain -->|1. 调用| RoundDomain\r\n-    RoundDomain -->|2. 返回| BattleDomain\r\n-    RoundDomain -->|3. 调用| UnitDomain\r\n-    UnitDomain -->|4. 返回| RoundDomain\r\n-    \r\n-    BattleDomain -.->|包含| RoundDomain\r\n-    RoundDomain -.->|包含| UnitDomain\r\n-    \r\n-    style BattleDomain fill:#ffebee\r\n-    style RoundDomain fill:#fff4e1\r\n-    style UnitDomain fill:#e1f5ff\r\n-```\r\n-\r\n-**协作流程说明**：\r\n-1. **战斗Domain** → 调用 **回合Domain**：战斗进行中，需要执行回合\r\n-2. **回合Domain** → 调用 **单位Domain**：回合进行中，需要处理单位行动\r\n-3. **单位Domain** → 返回 **回合Domain**：单位行动完成\r\n-4. **回合Domain** → 返回 **战斗Domain**：回合完成\r\n-\r\n-**协作原则**：\r\n-- 父Domain控制子Domain的调用时机\r\n-- 子Domain完成业务后主动返回父Domain\r\n-- 每个Domain独立管理自己的业务逻辑和循环\r\n-\r\n-### 循环职责说明\r\n-\r\n-#### 1. 战斗循环（BattleLoop）\r\n-- **职责**：管理整个战斗的生命周期\r\n-- **状态**：PREPARING → IN_PROGRESS → ENDED\r\n-- **维护**：BattleLoopManager\r\n-\r\n-#### 2. 回合循环（RoundLoop）\r\n-- **职责**：管理回合的循环和切换\r\n-- **状态**：START → ACTION → END\r\n-- **维护**：RoundLoopManager\r\n-\r\n-#### 3. 单位循环（UnitLoop）\r\n-- **职责**：管理单个单位的行动流程\r\n-- **状态**：START → ACTION → END\r\n-- **维护**：UnitLoopManager\r\n-\r\n----\r\n-\r\n-## 战斗领域\r\n-\r\n-### 核心职责\r\n-\r\n-战斗领域负责管理整个战斗的生命周期，包括战斗初始化、战斗流程控制、战斗结束判断、奖励结算、任务同步等。\r\n-\r\n-### 架构结构\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    subgraph BattleDomain[\"战斗Domain<br/>Battle Domain\"]\r\n-        BattleManagement[战斗管理<br/>BattleManagement]\r\n-        BattleLoop[战斗循环<br/>BattleLoop<br/>PREPARING → IN_PROGRESS → ENDED]\r\n-        RoundCoordinator[回合协调器<br/>RoundCoordinator<br/>微核心：只负责协调调用]\r\n-        \r\n-        subgraph BattleManagement[\"战斗管理<br/>BattleManagement\"]\r\n-            BattleData[战斗数据<br/>BattleData]\r\n-            DataMgr[战斗数据管理<br/>战斗状态/回合历史/活跃阵营]\r\n-            RuleMgr[战斗规则管理<br/>战斗开始/结束条件/胜利条件/失败条件]\r\n-            RewardMgr[奖励管理<br/>奖励结算/任务同步]\r\n-        end\r\n-    end\r\n-    \r\n-    subgraph ExternalSystems[\"外部系统\"]\r\n-        RoundDomain[回合领域<br/>Round Domain]\r\n-        RewardSystem[奖励系统<br/>Reward System]\r\n-        TaskSystem[任务系统<br/>Task System]\r\n-    end\r\n-    \r\n-    BattleManagement -->|控制| BattleLoop\r\n-    BattleManagement --> RoundCoordinator\r\n-    RoundCoordinator -->|反向推动| BattleLoop\r\n-    BattleLoop -->|推进| BattleManagement\r\n-    \r\n-    RoundCoordinator -->|调用| RoundDomain\r\n-    RoundDomain -->|返回| RoundCoordinator\r\n-    \r\n-    BattleManagement -->|结算奖励| RewardSystem\r\n-    BattleManagement -->|同步任务| TaskSystem\r\n-    \r\n-    style BattleDomain fill:#ffebee\r\n-    style BattleManagement fill:#ffebee\r\n-    style BattleLoop fill:#f3e5f5\r\n-    style RoundCoordinator fill:#c8e6c9\r\n-```\r\n-\r\n-### 战斗管理（BattleManagement）\r\n-\r\n-#### 1. 战斗数据管理\r\n-- **战斗状态**：当前战斗状态（PREPARING/IN_PROGRESS/ENDED）\r\n-- **回合历史**：记录已完成的回合历史（`roundHistoryQueue`）\r\n-- **活跃阵营列表**：当前战斗中活跃的阵营ID列表（`activeFactionIDs`）\r\n-- **突袭回合阵营列表**：被突袭的阵营ID列表（`surpriseRoundFactionIDs`）\r\n-\r\n-#### 2. 战斗规则管理\r\n-- **战斗开始条件**：检查是否可以开始战斗\r\n-- **战斗结束条件**：检查是否应该结束战斗\r\n-- **胜利条件**：检查是否满足胜利条件（`CheckVictoryCondition`）\r\n-- **失败条件**：检查是否满足失败条件（`CheckDefeatCondition`）\r\n-\r\n-#### 3. 奖励管理\r\n-- **奖励结算**：战斗结束后结算奖励\r\n-- **任务同步**：同步战斗相关的任务进度\r\n-\r\n-### 战斗循环（BattleLoop）\r\n-\r\n-**循环状态**：PREPARING → IN_PROGRESS → ENDED\r\n-\r\n-- **PREPARING**：战斗准备中，初始化战斗数据\r\n-- **IN_PROGRESS**：战斗进行中，执行回合（调用回合领域）\r\n-- **ENDED**：战斗已结束，结算奖励、同步任务\r\n-\r\n-### 回合协调器（RoundCoordinator）\r\n-\r\n-**核心原则**：只负责协调调用，不包含业务规则\r\n-\r\n-**核心职责**：\r\n-- ✅ **协调调用**：调用回合领域执行回合\r\n-- ✅ **反向推动循环**：回合完成后，主动推动战斗循环进入下一个状态（Domain controls Loop）\r\n-\r\n-### 战斗完整流程\r\n-\r\n-```mermaid\r\n-flowchart TD\r\n-    LoopPreparing[LoopPreparing<br/>战斗准备] --> InitBattle[初始化战斗数据<br/>战斗管理初始化]\r\n-    \r\n-    InitBattle --> LoopProgress[LoopProgress<br/>战斗进行中]\r\n-    \r\n-    LoopProgress --> CallRound[调用回合领域<br/>回合协调器调用回合领域]\r\n-    \r\n-    CallRound --> RoundAction[回合领域执行回合<br/>回合领域完成回合]\r\n-    \r\n-    RoundAction --> PushProgress[回合协调器推动循环<br/>推动到IN_PROGRESS状态继续]\r\n-    \r\n-    PushProgress --> CheckEnd{检查战斗结束条件<br/>战斗管理检查}\r\n-    \r\n-    CheckEnd -->|未结束| CallRound\r\n-    CheckEnd -->|已结束| PushEnd[回合协调器推动循环<br/>推动到ENDED状态]\r\n-    \r\n-    PushEnd --> LoopEnd[LoopEnd<br/>战斗结束]\r\n-    \r\n-    LoopEnd --> Reward[结算奖励<br/>奖励管理结算奖励]\r\n-    Reward --> Task[同步任务<br/>任务管理同步任务]\r\n-    Task --> Complete[战斗完成]\r\n-    \r\n-    style LoopPreparing fill:#ffebee\r\n-    style LoopProgress fill:#ffebee\r\n-    style CallRound fill:#c8e6c9\r\n-    style RoundAction fill:#c8e6c9\r\n-    style PushProgress fill:#f3e5f5\r\n-    style PushEnd fill:#f3e5f5\r\n-    style LoopEnd fill:#ffebee\r\n-    style CheckEnd fill:#ffe0b2\r\n-```\r\n-\r\n----\r\n-\r\n-## 回合领域\r\n-\r\n-### 核心职责\r\n-\r\n-回合领域负责管理回合的循环和切换，包括回合数管理、行动顺序管理（基于先攻值）、回合开始/结束控制等。\r\n-\r\n-### 架构结构\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    subgraph RoundDomain[\"回合Domain<br/>Round Domain\"]\r\n-        RoundManagement[回合管理<br/>RoundManagement]\r\n-        RoundLoop[回合循环<br/>RoundLoop<br/>START → ACTION → END]\r\n-        UnitCoordinator[单位协调器<br/>UnitCoordinator<br/>微核心：只负责协调调用]\r\n-        \r\n-        subgraph RoundManagement[\"回合管理<br/>RoundManagement\"]\r\n-            RoundData[回合数据<br/>RoundData]\r\n-            DataMgr[回合数据管理<br/>回合数/行动顺序队列]\r\n-            RuleMgr[回合规则管理<br/>回合开始/结束条件]\r\n-            OrderMgr[行动顺序管理<br/>队列初始化/管理/获取下一个单位]\r\n-        end\r\n-        \r\n-        subgraph UnitCoordinator[\"单位协调器<br/>UnitCoordinator<br/>微核心：只负责协调调用\"]\r\n-            UnitCall[单位调用<br/>从回合管理获取单位<br/>调用单位领域]\r\n-        end\r\n-    end\r\n-    \r\n-    subgraph ExternalSystems[\"外部系统\"]\r\n-        BattleDomain[战斗领域<br/>Battle Domain]\r\n-        UnitDomain[单位领域<br/>Unit Domain]\r\n-    end\r\n-    \r\n-    BattleDomain -->|控制| RoundDomain\r\n-    RoundManagement -->|控制| RoundLoop\r\n-    RoundManagement --> UnitCoordinator\r\n-    UnitCoordinator -->|反向推动| RoundLoop\r\n-    RoundLoop -->|推进| RoundManagement\r\n-    \r\n-    UnitCoordinator -->|调用| UnitDomain\r\n-    UnitDomain -->|返回| UnitCoordinator\r\n-    \r\n-    style RoundDomain fill:#fff4e1\r\n-    style RoundManagement fill:#fff4e1\r\n-    style RoundLoop fill:#f3e5f5\r\n-    style UnitCoordinator fill:#c8e6c9\r\n-    style RoundData fill:#e1f5ff\r\n-```\r\n-\r\n-### 回合管理（RoundManagement）\r\n-\r\n-#### 1. 回合数据管理\r\n-- **回合数**：当前回合数、总回合数\r\n-- **行动顺序队列**：基于先攻值的优先级队列（TurnQueue）\r\n-- **当前行动单位**：当前正在行动的单位\r\n-- **活跃阵营列表**：当前回合中活跃的阵营ID列表\r\n-\r\n-#### 2. 回合规则管理\r\n-- **回合开始条件**：检查是否可以开始新回合\r\n-- **回合结束条件**：检查是否应该结束当前回合（所有单位行动完成）\r\n-- **回合切换规则**：判断是否还有下一个回合\r\n-- **突袭回合规则**：战斗开始时，只有被突袭的阵营才能行动（Surprise Round）\r\n-- **单位存活检查**：只有存活的单位才能参与回合（`unit:IsAlive()`）\r\n-- **活跃阵营过滤**：只有活跃的阵营才能参与回合（`activeFactionIDs`）\r\n-\r\n-#### 3. 行动顺序管理\r\n-- **初始化队列**：回合开始时，根据先攻值初始化行动顺序队列\r\n-  - **突袭回合处理**：战斗开始时，只有被突袭的阵营单位加入队列\r\n-  - **正常回合处理**：正常回合中，所有活跃阵营的存活单位加入队列\r\n-- **队列管理**：管理行动顺序队列的添加、移除、清空\r\n-- **获取下一个单位**：从行动顺序队列中获取下一个行动单位（自动过滤死亡单位）\r\n-- **下一个单位检查**：检查是否还有下一个行动单位\r\n-- **延迟行动管理**：管理延迟行动的单位列表，在适当时候插入到行动顺序中\r\n-\r\n-### 回合循环（RoundLoop）\r\n-\r\n-**循环状态**：START → ACTION → END\r\n-\r\n-- **START**：回合开始，初始化行动顺序队列\r\n-  - **突袭回合**：只有被突袭的阵营单位加入队列\r\n-  - **正常回合**：所有活跃阵营的存活单位加入队列\r\n-- **ACTION**：执行回合行动（调用单位领域）\r\n-- **END**：回合结束，清理回合数据，处理延迟行动\r\n-\r\n-### 单位协调器（UnitCoordinator）\r\n-\r\n-**核心原则**：只负责协调调用，不包含业务规则\r\n-\r\n-**核心职责**：\r\n-- ✅ **协调调用**：从回合管理获取下一个单位，调用单位领域执行单位行动\r\n-- ✅ **反向推动循环**：单位行动完成后，主动推动回合循环进入下一个状态（Domain controls Loop）\r\n-\r\n-#### 循环推动机制\r\n-- **推动到END**：所有单位行动完成后，推动循环从ACTION状态进入END状态\r\n-- **推动到START**：回合结束时，推动循环从END状态进入START状态（下一个回合）\r\n-- **推动到ACTION**：回合开始时，推动循环从START状态进入ACTION状态\r\n-\r\n-### 回合完整流程\r\n-\r\n-```mermaid\r\n-flowchart TD\r\n-    LoopStart[LoopStart<br/>战斗领域推动循环] --> InitQueue[初始化行动顺序队列<br/>回合管理根据先攻值排序]\r\n-    \r\n-    InitQueue --> LoopAction[LoopAction<br/>执行回合行动]\r\n-    \r\n-    LoopAction --> GetNextUnit{获取下一个单位<br/>回合管理从队列获取}\r\n-    \r\n-    GetNextUnit -->|有单位| CallUnit[调用单位领域<br/>单位协调器调用单位领域]\r\n-    GetNextUnit -->|无单位| PushEnd\r\n-    \r\n-    CallUnit --> UnitAction[单位领域执行行动<br/>单位领域完成行动]\r\n-    \r\n-    UnitAction --> PushAction[单位协调器推动循环<br/>推动到ACTION状态继续]\r\n-    \r\n-    PushAction --> GetNextUnit\r\n-    \r\n-    PushEnd[单位协调器推动循环<br/>推动到END状态]\r\n-    \r\n-    PushEnd --> RoundEnd[LoopEnd<br/>回合结束]\r\n-    \r\n-    RoundEnd --> CheckNextRound{检查下一个回合<br/>回合管理检查是否还有下一个回合}\r\n-    \r\n-    CheckNextRound -->|有下一个回合| PushStart[单位协调器推动循环<br/>推动到START状态]\r\n-    CheckNextRound -->|无下一个回合| EndRound[结束回合循环<br/>返回战斗领域]\r\n-    \r\n-    PushStart --> LoopStart\r\n-    \r\n-    style LoopStart fill:#fff4e1\r\n-    style LoopAction fill:#fff4e1\r\n-    style CallUnit fill:#c8e6c9\r\n-    style UnitAction fill:#c8e6c9\r\n-    style PushAction fill:#f3e5f5\r\n-    style PushEnd fill:#f3e5f5\r\n-    style PushStart fill:#f3e5f5\r\n-    style LoopEnd fill:#fff4e1\r\n-    style GetNextUnit fill:#ffe0b2\r\n-    style CheckNextRound fill:#ffe0b2\r\n-```\r\n-\r\n-**关键点**：\r\n-- ✅ **Domain controls Loop**：回合管理通过单位协调器控制循环状态转换\r\n-- ✅ **反向推动机制**：单位协调器执行完单位行动后，主动推动循环进入下一个状态\r\n-- ✅ **单位协调器不处理业务规则**：只负责协调调用单位领域，不处理回合业务逻辑\r\n-- ✅ **行动顺序管理**：回合管理负责基于先攻值的优先级队列，确保单位按正确顺序行动\r\n-- ✅ **队列驱动**：通过行动顺序队列驱动单位行动，队列为空时回合结束\r\n-\r\n-### 职责划分\r\n-\r\n-| 组件 | 职责 | 说明 |\r\n-|------|------|------|\r\n-| **回合管理** | 回合数据与规则 | 管理回合数、行动顺序队列、回合开始/结束规则、队列管理 |\r\n-| **单位协调器** | 协调调用 | 从回合管理获取单位，调用单位领域，不处理回合业务规则 |\r\n-| **回合循环** | 流程控制 | START/ACTION/END状态转换，由回合管理控制 |\r\n-\r\n----\r\n-\r\n-## 单位领域\r\n-\r\n-### 核心职责\r\n-\r\n-单位领域是战斗系统的核心，负责管理单个单位的行动流程，包括移动、技能释放、数值控制等。\r\n-\r\n-\r\n-### 数值查询及推送 (CommunicationBus)\r\n-\r\n-- 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n-\r\n-\r\n-```mermaid\r\n-graph TB\r\n-\r\n-    subgraph 起点[\"起点\"]\r\n-        节点\r\n-        领域\r\n-        外部系统\r\n-    end\r\n-\r\n-\r\n-    节点 --> EffectHandler -.-> PushChannel -.-> 数据模块\r\n-    领域 --> EffectHandler\r\n-    EffectHandler  -.-> QueryChannel  -.-> 数据模块\r\n-    EffectHandler -.-> 外部系统\r\n-\r\n-    style PushChannel fill:#c8e6c9\r\n-    style QueryChannel fill:#c8e6c9\r\n-    style 起点 fill:#ffe0b2\r\n-```\r\n-\r\n-### 架构结构\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    subgraph UnitDomain[\"单位Domain<br/>Unit Domain\"]\r\n-        UnitManagement[单位管理<br/>UnitManagement]\r\n-        UnitLoop[单位循环<br/>UnitLoop<br/>START → ACTION → END]\r\n-        ActionCoordinator[行动协调器<br/>ActionCoordinator<br/>微核心：只负责协调调用]\r\n-        \r\n-        subgraph UnitManagement[\"单位管理<br/>UnitManagement\"]\r\n-            UnitData[单位数据<br/>UnitData]\r\n-            DataMgr[单位数据管理<br/>属性/状态/位置/回合数据<br/>AP/MP/先攻值]\r\n-            RuleMgr[单位规则管理<br/>行动点数规则/移动点数规则<br/>先攻值规则/回合初始化规则]\r\n-        end\r\n-        \r\n-        subgraph DataHandleQueue[\"DataHandleQueue<br/>数据队列<br/>1:1关系\"]\r\n-        end\r\n-        \r\n-        subgraph ActionCoordinator[\"行动协调器<br/>ActionCoordinator<br/>微核心：只负责协调调用\"]\r\n-            MoveCoord[移动协调<br/>调用网格系统]\r\n-            SkillCoord[技能协调<br/>调用技能领域]\r\n-            TerrainCoord[地形交互协调<br/>调用地形领域<br/>可选]\r\n-            VisualCoord[表现协调<br/>通知表现层]\r\n-        end\r\n-    end\r\n-    \r\n-    subgraph ExternalSystems[\"外部系统\"]\r\n-        GridSystem[网格系统<br/>GridSystem]\r\n-        SkillDomain[技能领域<br/>Skill Domain]\r\n-        VisualSystem[表现系统<br/>Visual System]\r\n-        TerrainDomain[地形领域<br/>Terrain Domain]\r\n-    end\r\n-    \r\n-    UnitManagement -->|控制| UnitLoop\r\n-    UnitManagement --> ActionCoordinator\r\n-    UnitManagement --> UnitData\r\n-    ActionCoordinator -->|反向推动| UnitLoop\r\n-    UnitLoop -->|推进| UnitManagement\r\n-    \r\n-    ActionCoordinator -->|调用| GridSystem\r\n-    ActionCoordinator -->|调用| SkillDomain\r\n-    ActionCoordinator -->|调用| TerrainDomain\r\n-    ActionCoordinator -->|通知| VisualSystem\r\n-    \r\n-    SkillDomain -->|EffectHandler推送| DataHandleQueue\r\n-    TerrainDomain -->|EffectHandler推送| DataHandleQueue\r\n-\r\n-    DataHandleQueue -->|推送数据| UnitData\r\n-    \r\n-    style UnitDomain fill:#e1f5ff\r\n-    style UnitManagement fill:#fff4e1\r\n-    style UnitLoop fill:#f3e5f5\r\n-    style ActionCoordinator fill:#c8e6c9\r\n-    style DataHandleQueue fill:#f3e5f5\r\n-    style UnitData fill:#e1f5ff\r\n-```\r\n-\r\n-### 单位管理（UnitManagement）\r\n-\r\n-#### 1. 单位数据管理\r\n-- **单位属性**：生命值、行动点数（AP）、移动点数（MP）、先攻值等\r\n-- **单位状态**：是否可行动、是否已移动、是否已攻击、是否存活等\r\n-- **单位位置**：当前网格位置\r\n-- **回合数据**：UnitTurnData管理行动点数、移动点数、先攻值等回合相关数据\r\n-\r\n-#### 2. 单位规则管理\r\n-- **移动点数规则**：移动前检查能否移动\r\n-- **行动点数规则**：检查行动是否可执行（`CheckAction`），消耗行动点数和移动点数（`ConsumeAction`）\r\n-- **行动规则**：是否可执行行动（移动、攻击、技能等）\r\n-- **状态规则**：状态转换规则（是否存活、是否可行动等）\r\n-- **先攻值规则**：管理单位的先攻值，用于回合顺序排序\r\n-- **回合初始化规则**：回合开始时初始化行动点数和移动点数（`StartUnitTurn`）\r\n-\r\n-#### 3. UnitData与DataHandleQueue关系\r\n-- **1:1关系**：DataHandleQueue 与 UnitData 是 1:1 关系，数据直接修改 UnitData\r\n-- **直接修改**：技能领域的EffectHandler推送数据到DataHandleQueue后，直接修改UnitData\r\n-- **无需中间层**：不需要\"数值控制管理\"中间层，DataHandleQueue直接修改UnitData\r\n-\r\n-### 单位循环（UnitLoop）\r\n-\r\n-**循环状态**：START → ACTION → END\r\n-\r\n-- **START**：单位开始行动\r\n-- **ACTION**：执行行动（移动、技能等）\r\n-- **END**：单位结束行动\r\n-\r\n-### 行动协调器（ActionCoordinator）\r\n-\r\n-**核心原则**：只负责协调调用，不包含业务规则\r\n-\r\n-**核心职责**：\r\n-- ✅ **协调调用**：调用网格系统、技能领域、表现系统\r\n-- ✅ **反向推动循环**：执行完行动后，主动推动单位循环进入下一个状态（Domain controls Loop）\r\n-\r\n-#### 1. 移动协调\r\n-- **移动前检查**：调用单位管理检查移动点数和行动点数\r\n-- **调用网格系统**：进行移动计算（路径查找、移动范围等）\r\n-- **移动后更新**：通过 DataHandleQueue 更新单位位置和移动点数\r\n-- **推动循环**：移动完成后，推动循环进入下一个状态\r\n-\r\n-#### 2. 技能协调\r\n-- **行动点数检查**：调用单位管理检查行动点数是否足够\r\n-- **调用技能领域**：执行技能\r\n-- **不处理数值控制**：数值控制由技能领域的EffectHandler通过DataHandleQueue处理\r\n-- **接收技能结果**：获取技能执行结果（成功/失败），用于流程控制\r\n-- **推动循环**：技能执行完成后，推动循环进入下一个状态\r\n-\r\n-#### 3. 地形交互协调（可选）\r\n-- **地形交互检查**：检查单位是否触发地形要素（陷阱、门等）\r\n-- **调用地形领域**：如果触发地形要素，调用地形领域处理\r\n-- **推动循环**：地形交互完成后，推动循环进入下一个状态\r\n-\r\n-#### 4. 表现协调\r\n-- **通知表现层**：移动表现、技能表现、受攻击表现\r\n-- **推动循环**：表现播放完成后（可选），推动循环进入下一个状态\r\n-\r\n-### 单位行动完整流程\r\n-\r\n-```mermaid\r\n-flowchart TD\r\n-    LoopStart[LoopStart<br/>单位管理推动循环] --> LoopAction[LoopAction<br/>执行行动]\r\n-    \r\n-    LoopAction --> CheckAction{行动前检查<br/>单位管理检查行动点数/移动点数}\r\n-    \r\n-    CheckAction -->|可以移动| Move[单位移动<br/>行动协调器调用网格系统]\r\n-    CheckAction -->|不能移动| Skill\r\n-    \r\n-    Move --> UpdateMove[更新移动点数<br/>DataHandleQueue推送]\r\n-    UpdateMove --> Skill[攻击/治疗<br/>行动协调器调用技能领域]\r\n-    \r\n-    Skill --> EffectPush[EffectHandler推送效果<br/>通过DataHandleQueue到目标单位]\r\n-    EffectPush --> Visual[可视化<br/>行动协调器通知表现层]\r\n-    \r\n-    Visual --> PushEnd[行动协调器推动循环<br/>推动到END状态]\r\n-    \r\n-    PushEnd --> CheckActionPoint{行动点数检查<br/>单位管理检查是否还有行动点数/移动点数}\r\n-    \r\n-    CheckActionPoint -->|还有行动点数/移动点数| PushAction[行动协调器推动循环<br/>推动回ACTION状态]\r\n-    CheckActionPoint -->|无行动点数/移动点数| LoopEnd[LoopEnd<br/>单位结束行动]\r\n-    \r\n-    PushAction --> LoopAction\r\n-    \r\n-    style LoopStart fill:#e1f5ff\r\n-    style LoopAction fill:#e1f5ff\r\n-    style Move fill:#fff4e1\r\n-    style Skill fill:#c8e6c9\r\n-    style EffectPush fill:#fff4e1\r\n-    style Visual fill:#c8e6c9\r\n-    style PushEnd fill:#f3e5f5\r\n-    style PushAction fill:#f3e5f5\r\n-    style LoopEnd fill:#e1f5ff\r\n-    style CheckAction fill:#ffe0b2\r\n-    style CheckActionPoint fill:#ffe0b2\r\n-```\r\n-\r\n-\r\n-\r\n----\r\n-\r\n-## 单位领域：节点编排架构\r\n-\r\n-### 核心设计理念\r\n-\r\n-#### 1. 节点编排器为核心\r\n-\r\n-**本质**：单位行动流程的核心是节点编排器的动态组织和管理\r\n-\r\n-- 单位行动流程 = 节点编排器根据配置动态组织节点执行\r\n-- 节点编排 = 条件节点 → 执行节点 → 可视化节点的组合\r\n-- 流程控制 = 节点编排器根据节点执行结果决定下一个节点\r\n-- 灵活扩展 = 新增节点类型只需注册到编排器\r\n-\r\n-#### 2. 节点分类设计\r\n-\r\n-**本质**：节点按功能职责分为四类，每类节点职责单一、可复用\r\n-\r\n-- **输入节点（Input Node）**：负责接收玩家输入（如：接收移动点击、接收技能选择、接收目标选择等）\r\n-- **条件节点（Condition Node）**：负责验证、检查、判断，返回判断结果和流程控制建议（如：检查移动点数、验证技能可释放、检查资源决定是否继续等）\r\n-- **执行节点（Execution Node）**：负责实际执行操作，修改数据（如：执行移动、执行技能、消耗资源、更新状态等）\r\n-- **可视化节点（Visual Node）**：负责表现播放（如：播放移动表现、播放技能表现等）\r\n-\r\n-\r\n-\r\n-### 节点编排器架构\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    subgraph UnitDomain[\"单位Domain\"]\r\n-        NodeOrchestrator[节点编排器<br/>NodeOrchestrator]\r\n-        \r\n-        subgraph NodeRegistry[\"节点注册表<br/>NodeRegistry\"]\r\n-            subgraph InputNodes[\"输入节点组<br/>Input Nodes\"]\r\n-                ReceiveMoveInputNode[接收移动输入节点]\r\n-                ReceiveSkillSelectNode[接收技能选择节点]\r\n-                ReceiveTargetSelectNode[接收目标选择节点]\r\n-            end\r\n-            \r\n-            subgraph ConditionNodes[\"条件节点组<br/>Condition Nodes\"]\r\n-                CheckMovePointNode[检查移动点数节点]\r\n-                CheckActionPointNode[检查行动点数节点]\r\n-                ValidateSkillNode[验证技能节点]\r\n-                ValidateTargetNode[验证目标节点]\r\n-                ValidateMoveNode[验证移动节点]\r\n-                CheckResourceNode[检查资源节点]\r\n-            end\r\n-            \r\n-            subgraph ExecutionNodes[\"执行节点组<br/>Execution Nodes\"]\r\n-                InitUnitNode[初始化单位节点]\r\n-                MoveNode[移动节点]\r\n-                SelectSkillNode[选择技能节点]\r\n-                SelectTargetNode[选择目标节点]\r\n-                ExecuteSkillNode[执行技能节点]\r\n-                ConsumeResourceNode[消耗资源节点]\r\n-                UpdateStateNode[更新状态节点]\r\n-            end\r\n-            \r\n-            subgraph VisualNodes[\"可视化节点组<br/>Visual Nodes\"]\r\n-                PlayMoveVisualNode[播放移动表现节点]\r\n-                PlaySkillVisualNode[播放技能表现节点]\r\n-                PlayTargetVisualNode[播放目标表现节点]\r\n-            end\r\n-        end\r\n-        \r\n-        FlowConfig[流程配置<br/>NodeFlowConfig]\r\n-        ContextManager[上下文管理器<br/>ContextManager]\r\n-        \r\n-        subgraph CommunicationBus[\"通讯总线\"]\r\n-            EventChannel[事件通道<br/>EventChannel]\r\n-            MessageChannel[消息通道<br/>MessageChannel]\r\n-            PushChannel[推送通道<br/>PushChannel]\r\n-            QueryChannel[查询通道<br/>QueryChannel]\r\n-        end\r\n-        \r\n-        subgraph DataModules[\"数据模块\"]\r\n-            UnitDataModule[单位数据模块<br/>UnitData]\r\n-            SkillDomainModule[技能领域模块<br/>SkillDomain]\r\n-            TerrainDomainModule[地形领域模块<br/>TerrainDomain]\r\n-            GridSystemModule[网格系统模块<br/>GridSystem]\r\n-        end\r\n-    end\r\n-    \r\n-    NodeOrchestrator -->|管理节点| NodeRegistry\r\n-    NodeOrchestrator -->|读取配置| FlowConfig\r\n-    NodeOrchestrator -->|执行节点| InputNodes\r\n-    NodeOrchestrator -->|执行节点| ConditionNodes\r\n-    NodeOrchestrator -->|执行节点| ExecutionNodes\r\n-    NodeOrchestrator -->|执行节点| VisualNodes\r\n-    NodeOrchestrator -->|管理Context| ContextManager\r\n-    \r\n-    InputNodes -->|发布事件| EventChannel\r\n-    ConditionNodes -->|发布事件| EventChannel\r\n-    ConditionNodes -->|查询数据| QueryChannel\r\n-    ExecutionNodes -->|订阅事件| EventChannel\r\n-    ExecutionNodes -->|1对1通讯| MessageChannel\r\n-    ExecutionNodes -->|查询数据| QueryChannel\r\n-    ExecutionNodes -->|接收数据| PushChannel\r\n-    VisualNodes -->|订阅事件| EventChannel\r\n-    VisualNodes -->|接收数据| PushChannel\r\n-    \r\n-    QueryChannel -->|查询| UnitDataModule\r\n-    QueryChannel -->|查询| SkillDomainModule\r\n-    QueryChannel -->|查询| TerrainDomainModule\r\n-    QueryChannel -->|查询| GridSystemModule\r\n-    \r\n-    PushChannel -->|推送数据| UnitDataModule\r\n-    SkillDomainModule -->|推送数据| PushChannel\r\n-    TerrainDomainModule -->|推送数据| PushChannel\r\n-    \r\n-    style NodeOrchestrator fill:#c8e6c9\r\n-    style NodeRegistry fill:#e1f5ff\r\n-    style InputNodes fill:#ffebee\r\n-    style ConditionNodes fill:#fff4e1\r\n-    style ExecutionNodes fill:#c8e6c9\r\n-    style VisualNodes fill:#f3e5f5\r\n-    style CommunicationBus fill:#fff4e1\r\n-```\r\n-\r\n-### 节点编排器职责\r\n-\r\n-1. **节点注册管理**\r\n-   - 管理节点注册表（NodeRegistry）\r\n-   - 支持动态注册/注销节点\r\n-   - 提供节点查找接口（按ID、按类型）\r\n-\r\n-2. **流程编排**\r\n-   - 根据FlowConfig动态组织节点执行顺序\r\n-   - 处理节点间的跳转、条件分支、循环\r\n-   - 管理节点执行状态和生命周期\r\n-\r\n-3. **Context管理**\r\n-   - 在节点间传递UnitContext\r\n-   - 管理Context的生命周期\r\n-   - 处理Context状态恢复\r\n-\r\n-4. **错误处理**\r\n-   - 处理节点执行失败\r\n-   - 资源回滚和状态恢复\r\n-   - 错误通知和日志记录\r\n-\r\n-### 节点分类详细设计\r\n-\r\n-#### 输入节点（Input Node）\r\n-\r\n-**职责**：接收玩家输入，不修改数据，只负责输入数据的收集和传递\r\n-\r\n-**节点列表**：\r\n-1. **ReceiveMoveInputNode**：接收玩家点击的网格坐标\r\n-2. **ReceiveSkillSelectNode**：接收玩家选择的技能ID\r\n-3. **ReceiveTargetSelectNode**：接收玩家选择的目标（单位、位置等）\r\n-\r\n-**节点接口**：\r\n-- `Execute(context) -> result`：接收输入，返回输入数据和有效性\r\n-- `WaitForInput(context) -> input`：等待玩家输入（异步）\r\n-- `ValidateInput(input) -> bool`：验证输入有效性\r\n-\r\n-#### 条件节点（Condition Node）\r\n-\r\n-**职责**：验证、检查、判断，不修改数据，返回判断结果和流程控制建议\r\n-\r\n-**节点列表**：\r\n-1. **CheckMovePointNode**：检查单位是否有足够的移动点数\r\n-2. **CheckActionPointNode**：检查单位是否有足够的行动点数\r\n-3. **ValidateMoveNode**：验证移动输入是否合法（位置、路径、范围等）\r\n-4. **ValidateSkillNode**：验证技能是否可释放\r\n-5. **ValidateTargetNode**：验证目标是否合法（距离、状态、条件等）\r\n-6. **CheckResourceNode**：检查单位是否还有资源继续行动\r\n-\r\n-**返回结果结构**：\r\n-```lua\r\n-{\r\n-    success: true/false,           -- 判断结果\r\n-    data: {...},                   -- 判断数据（可选）\r\n-    nextAction: \"continue\"/\"end\"/\"skip\", -- 流程控制建议（可选）\r\n-    loopState: \"ACTION\"/\"END\"      -- 循环状态建议（可选）\r\n-}\r\n-```\r\n-\r\n-#### 执行节点（Execution Node）\r\n-\r\n-**职责**：实际执行操作，修改数据，返回执行结果\r\n-\r\n-**节点列表**：\r\n-1. **InitUnitNode**：初始化单位行动状态，重置行动点数和移动点数\r\n-2. **MoveNode**：执行移动并更新单位位置，消耗移动点数\r\n-3. **SelectSkillNode**：显示可用的技能列表，准备技能释放上下文\r\n-4. **SelectTargetNode**：根据技能类型显示可选目标，更新技能上下文中的目标信息\r\n-5. **ExecuteSkillNode**：调用技能领域执行技能，处理技能执行结果\r\n-6. **ConsumeResourceNode**：消耗行动点数和资源，记录资源消耗信息\r\n-7. **UpdateStateNode**：批量处理所有状态变更数据，更新单位状态\r\n-\r\n-**节点接口**：\r\n-- `Execute(context) -> result`：执行操作\r\n-- `CanExecute(context) -> bool`：检查是否可以执行\r\n-- `Rollback(context)`：回滚操作（失败时）\r\n-\r\n-#### 可视化节点（Visual Node）\r\n-\r\n-**职责**：播放表现，不修改数据，只负责视觉反馈\r\n-\r\n-**节点列表**：\r\n-1. **PlayMoveVisualNode**：通知VisualSystem播放移动表现\r\n-2. **PlaySkillVisualNode**：通知VisualSystem播放技能释放表现\r\n-3. **PlayTargetVisualNode**：通知VisualSystem播放受攻击单位表现\r\n-\r\n-**节点接口**：\r\n-- `Execute(context) -> result`：播放表现\r\n-- `WaitForComplete(context) -> bool`：等待表现完成（可选）\r\n-\r\n-### 节点编排流程示例\r\n-\r\n-```mermaid\r\n-flowchart TD\r\n-    Start[开始] --> Init[InitUnitNode<br/>初始化单位]\r\n-    \r\n-    Init --> CheckMove{CheckMovePointNode<br/>检查移动点数}\r\n-    CheckMove -->|有移动点数| ReceiveMove[ReceiveMoveInputNode<br/>接收移动输入]\r\n-    CheckMove -->|无移动点数| SelectSkill\r\n-    \r\n-    ReceiveMove --> ValidateMove{ValidateMoveNode<br/>验证移动}\r\n-    ValidateMove -->|验证通过| Move[MoveNode<br/>执行移动]\r\n-    ValidateMove -->|验证失败| ReceiveMove\r\n-    \r\n-    Move --> PlayMove[PlayMoveVisualNode<br/>播放移动表现]\r\n-    PlayMove --> SelectSkill[SelectSkillNode<br/>选择技能]\r\n-    \r\n-    SelectSkill --> ReceiveSkill[ReceiveSkillSelectNode<br/>接收技能选择]\r\n-    ReceiveSkill --> ValidateSkill{ValidateSkillNode<br/>验证技能}\r\n-    ValidateSkill -->|验证通过| SelectTarget[SelectTargetNode<br/>选择目标]\r\n-    ValidateSkill -->|验证失败| SelectSkill\r\n-    \r\n-    SelectTarget --> ReceiveTarget[ReceiveTargetSelectNode<br/>接收目标选择]\r\n-    ReceiveTarget --> ValidateTarget{ValidateTargetNode<br/>验证目标}\r\n-    ValidateTarget -->|验证通过| Consume[ConsumeResourceNode<br/>消耗资源]\r\n-    ValidateTarget -->|验证失败| SelectTarget\r\n-    \r\n-    Consume --> Execute[ExecuteSkillNode<br/>执行技能]\r\n-    Execute --> Update[UpdateStateNode<br/>更新状态]\r\n-    Update --> PlaySkill[PlaySkillVisualNode<br/>播放技能表现]\r\n-    PlaySkill --> PlayTarget[PlayTargetVisualNode<br/>播放目标表现]\r\n-    \r\n-    PlayTarget --> CheckResource{CheckResourceNode<br/>检查资源}\r\n-    CheckResource -->|还有资源| CheckMove\r\n-    CheckResource -->|无资源| End[结束]\r\n-    \r\n-    style Init fill:#c8e6c9\r\n-    style CheckMove fill:#fff4e1\r\n-    style ReceiveMove fill:#ffebee\r\n-    style ValidateMove fill:#fff4e1\r\n-    style Move fill:#c8e6c9\r\n-    style PlayMove fill:#f3e5f5\r\n-    style SelectSkill fill:#c8e6c9\r\n-    style ReceiveSkill fill:#ffebee\r\n-    style ValidateSkill fill:#fff4e1\r\n-    style SelectTarget fill:#c8e6c9\r\n-    style ReceiveTarget fill:#ffebee\r\n-    style ValidateTarget fill:#fff4e1\r\n-    style Consume fill:#c8e6c9\r\n-    style Execute fill:#c8e6c9\r\n-    style Update fill:#c8e6c9\r\n-    style PlaySkill fill:#f3e5f5\r\n-    style PlayTarget fill:#f3e5f5\r\n-    style CheckResource fill:#fff4e1\r\n-    style End fill:#ffebee\r\n-```\r\n-### 节点实现细节\r\n-\r\n-#### UnitContext逐步增强过程\r\n-\r\n-单位行动流程的核心是UnitContext的维护和管理，Context在节点间流转并逐步增强：\r\n-\r\n-```\r\n-UnitContext（节点1：单位循环开始）\r\n-  + unitData（单位数据）\r\n-  + roundContext（回合上下文）\r\n-  ↓\r\n-  + currentUnit（当前行动单位）\r\n-  + unitValidation（单位验证结果）\r\n-  ↓\r\n-  + moveInput（移动输入：点击坐标）\r\n-  + moveValidation（移动验证结果）\r\n-  + movePath（移动路径）\r\n-  + moveResult（移动结果）\r\n-  ↓\r\n-  + selectedSkill（选中的技能）\r\n-  + skillValidation（技能验证结果）\r\n-  + skillContext（技能上下文）\r\n-  ↓\r\n-  + selectedTargets（选中的目标）\r\n-  + targetValidation（目标验证结果）\r\n-  ↓\r\n-  + skillExecutionResult（技能执行结果）\r\n-  + resourceConsumption（资源消耗信息）\r\n-  ↓\r\n-  + visualResult（表现播放结果）\r\n-  + effectResults（效果处理结果）\r\n-  + resourceCheck（资源检查结果）\r\n-  + loopState（循环状态）\r\n-  ↓\r\n-UnitContext（节点7：执行施法后处理）\r\n-```\r\n-\r\n-#### 节点内部架构设计原则\r\n-\r\n-**管道过滤器模式**：\r\n-- 单Context设计：所有节点使用统一的`UnitContext`\r\n-- 逐步增强：每个节点在Context中添加自己的数据\r\n-- 数据流循环：节点1 → 节点2 → ... → 节点7 → 节点3（循环）\r\n-\r\n-**节点内部组件设计**：\r\n-- **输入接收器**：接收外部输入，验证输入有效性\r\n-- **验证器组**：负责各种验证（范围、路径、资源等）\r\n-- **执行器**：负责实际执行操作\r\n-- **数据更新器**：负责更新数据\r\n-- **表现通知器**：负责通知表现层\r\n-- **上下文增强器**：负责增强Context并传递给下一个节点\r\n-- **循环推动器**：负责推动循环状态转换\r\n-\r\n-#### 错误处理和恢复机制\r\n-\r\n-**错误类型**：\r\n-1. **资源错误**：资源不足、资源被消耗等\r\n-2. **验证错误**：验证失败、状态不合法等\r\n-3. **执行错误**：执行失败、异常等\r\n-4. **系统错误**：系统异常、外部系统错误等\r\n-\r\n-**错误处理流程**：\r\n-1. **资源回滚**：执行失败时，回滚已消耗的资源\r\n-2. **状态恢复**：从Context恢复节点执行前的状态\r\n-3. **错误通知**：通知用户错误信息，提供重试或取消选项\r\n-4. **日志记录**：记录错误信息到Context，便于调试和问题追踪\r\n-\r\n-**节点状态机**：\r\n-- **IDLE**：节点未开始执行\r\n-- **EXECUTING**：节点正在执行\r\n-- **COMPLETED**：节点执行完成\r\n-- **FAILED**：节点执行失败\r\n-\r\n----\r\n-\r\n-## 外部系统集成\r\n-\r\n-### SkillDomain（技能领域）集成\r\n-\r\n-**集成方式**：\r\n-- **调用方式**：ActionCoordinator调用SkillDomain执行技能\r\n-- **数据推送**：SkillDomain的EffectHandler通过DataHandleQueue推送效果数据\r\n-- **数据查询**：节点通过QueryChannel查询技能状态\r\n-\r\n-### TerrainDomain（地形领域）集成\r\n-\r\n-**集成方式**：\r\n-- **调用方式**：ActionCoordinator调用TerrainDomain处理地形要素\r\n-- **数据推送**：TerrainDomain的EffectHandler通过DataHandleQueue推送效果数据\r\n-- **共享Handler机制**：与SkillDomain共享Handler接口，但保持独立系统\r\n-\r\n-### GridSystem（网格系统）集成\r\n-\r\n-**集成方式**：\r\n-- **调用方式**：ActionCoordinator调用GridSystem进行移动计算\r\n-- **数据查询**：节点通过QueryChannel查询移动范围、路径信息\r\n-\r\n-### VisualSystem（表现系统）集成\r\n-\r\n-**集成方式**：\r\n-- **通知方式**：ActionCoordinator通知VisualSystem播放表现\r\n-- **事件订阅**：可视化节点订阅EventChannel接收表现事件\r\n-\r\n-\r\n-### 设计原则总结\r\n-\r\n-- ✅ **Domain controls Loop**：Domain控制循环，循环是Domain的工具\r\n-- ✅ **数据驱动架构**：战斗特性通过配置数据实现，无需额外机制\r\n-- ✅ **节点编排模式**：单位行动流程通过节点编排器动态组织\r\n-- ✅ **解耦设计**：节点间通过CommunicationBus和Context通信，不直接依赖\r\n-- ✅ **多层循环架构**：战斗→回合→单位三层循环架构\r\n-- ✅ **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n-- ✅ **统一数据访问**：节点通过CommunicationBus统一获取数据\r\n-\r\n----\r\n-\r\n-## 总结\r\n-\r\n-### 架构设计价值\r\n-\r\n-该架构设计文档的价值在于：\r\n-- ✅ **思路解构**：完整解构回合制战斗系统的搭建思路\r\n-- ✅ **流程验证**：从架构层面验证流程合理性\r\n-- ✅ **问题识别**：提前识别潜在的资源和状态问题\r\n-- ✅ **开发指导**：为后续详细设计和实现提供清晰指导\r\n-\r\n-### 架构特点\r\n-\r\n-- ✅ **多层循环架构**：战斗→回合→单位三层循环架构\r\n-- ✅ **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n-- ✅ **统一数据访问**：节点通过CommunicationBus统一获取数据\r\n-- ✅ **错误处理防护**：资源回滚 + 状态恢复 + 错误通知，避免状态不一致\r\n-- ✅ **数据驱动**：所有特性通过配置数据实现，无需修改代码\r\n-\r\n-细节实现是后续开发阶段的工作，当前架构设计已足够指导整个回合制战斗系统的开发。\r\n"
                },
                {
                    "date": 1767184100977,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -449,10 +449,9 @@\n         领域\r\n         外部系统\r\n     end\r\n \r\n-    节点 --> EffectHandler -.-> PushChannel -.-> 数据模块\r\n-    领域 --> EffectHandler\r\n+    起点 --> EffectHandler -.-> PushChannel -.-> 数据模块\r\n     起点  -.-> QueryChannel  -.-> 数据模块\r\n     外部系统 -.-> EffectHandler\r\n \r\n     style PushChannel fill:#c8e6c9\r\n"
                },
                {
                    "date": 1767184107693,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -451,9 +451,8 @@\n     end\r\n \r\n     起点 --> EffectHandler -.-> PushChannel -.-> 数据模块\r\n     起点  -.-> QueryChannel  -.-> 数据模块\r\n-    外部系统 -.-> EffectHandler\r\n \r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n     style 起点 fill:#ffe0b2\r\n"
                },
                {
                    "date": 1767184117970,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -442,10 +442,9 @@\n \r\n \r\n ```mermaid\r\n graph TB\r\n-\r\n-    subgraph 起点[\"起点\"]\r\n+    subgraph LR 起点[\"起点\"]\r\n         节点\r\n         领域\r\n         外部系统\r\n     end\r\n"
                },
                {
                    "date": 1767184129708,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -442,9 +442,9 @@\n \r\n \r\n ```mermaid\r\n graph TB\r\n-    subgraph LR 起点[\"起点\"]\r\n+    subgraph 起点[\"起点\"]\r\n         节点\r\n         领域\r\n         外部系统\r\n     end\r\n"
                },
                {
                    "date": 1767184140275,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -441,9 +441,9 @@\n - 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n \r\n \r\n ```mermaid\r\n-graph TB\r\n+graph LR\r\n     subgraph 起点[\"起点\"]\r\n         节点\r\n         领域\r\n         外部系统\r\n"
                },
                {
                    "date": 1767184180432,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -449,10 +449,10 @@\n         外部系统\r\n     end\r\n \r\n     起点 --> EffectHandler -.-> PushChannel -.-> 数据模块\r\n-    起点  -.-> QueryChannel  -.-> 数据模块\r\n-\r\n+    起点  -.-> QueryChannel\r\n+数据模块 -.-> QueryChannel\r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n     style 起点 fill:#ffe0b2\r\n ```\r\n"
                },
                {
                    "date": 1767184185879,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -450,9 +450,9 @@\n     end\r\n \r\n     起点 --> EffectHandler -.-> PushChannel -.-> 数据模块\r\n     起点  -.-> QueryChannel\r\n-数据模块 -.-> QueryChannel\r\n+    数据模块 -.-> QueryChannel\r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n     style 起点 fill:#ffe0b2\r\n ```\r\n"
                },
                {
                    "date": 1767184208806,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -449,10 +449,11 @@\n         外部系统\r\n     end\r\n \r\n     起点 --> EffectHandler -.-> PushChannel -.-> 数据模块\r\n-    起点  -.-> QueryChannel\r\n+    QueryChannel  -.-> 起点\r\n     数据模块 -.-> QueryChannel\r\n+\r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n     style 起点 fill:#ffe0b2\r\n ```\r\n"
                },
                {
                    "date": 1767184329911,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -448,10 +448,10 @@\n         领域\r\n         外部系统\r\n     end\r\n \r\n-    起点 --> EffectHandler -.-> PushChannel -.-> 数据模块\r\n-    QueryChannel  -.-> 起点\r\n+    起点 --> EffectHandler -.-> PushChannel[推送处理数据] -.-> 数据模块\r\n+    QueryChannel -.-> 起点\r\n     数据模块 -.-> QueryChannel\r\n \r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n"
                },
                {
                    "date": 1767184336983,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -449,9 +449,9 @@\n         外部系统\r\n     end\r\n \r\n     起点 --> EffectHandler -.-> PushChannel[推送处理数据] -.-> 数据模块\r\n-    QueryChannel -.-> 起点\r\n+    QueryChannel[查询处理数据] -.-> 起点\r\n     数据模块 -.-> QueryChannel\r\n \r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n"
                },
                {
                    "date": 1767184363246,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -448,10 +448,10 @@\n         领域\r\n         外部系统\r\n     end\r\n \r\n-    起点 --> EffectHandler -.-> PushChannel[推送处理数据] -.-> 数据模块\r\n-    QueryChannel[查询处理数据] -.-> 起点\r\n+    起点 --> EffectHandler -.-> PushChannel[PushChannel<br>推送处理数据] -.-> 数据模块\r\n+    QueryChannel[查询数据] -.-> 起点\r\n     数据模块 -.-> QueryChannel\r\n \r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n"
                },
                {
                    "date": 1767184390712,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -448,10 +448,10 @@\n         领域\r\n         外部系统\r\n     end\r\n \r\n-    起点 --> EffectHandler -.-> PushChannel[PushChannel<br>推送处理数据] -.-> 数据模块\r\n-    QueryChannel[查询数据] -.-> 起点\r\n+    起点 --> EffectHandler[] -.-> PushChannel[PushChannel<br>推送处理数据] -.-> 数据模块\r\n+    QueryChannel[QueryChannel<br>查询数据] -.-> 起点\r\n     数据模块 -.-> QueryChannel\r\n \r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n"
                },
                {
                    "date": 1767184405678,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -448,9 +448,9 @@\n         领域\r\n         外部系统\r\n     end\r\n \r\n-    起点 --> EffectHandler[] -.-> PushChannel[PushChannel<br>推送处理数据] -.-> 数据模块\r\n+    起点 --> EffectHandler[数据处理器] -.-> PushChannel[PushChannel<br>推送处理数据] -.-> 数据模块\r\n     QueryChannel[QueryChannel<br>查询数据] -.-> 起点\r\n     数据模块 -.-> QueryChannel\r\n \r\n     style PushChannel fill:#c8e6c9\r\n"
                },
                {
                    "date": 1767184416477,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -448,9 +448,9 @@\n         领域\r\n         外部系统\r\n     end\r\n \r\n-    起点 --> EffectHandler[数据处理器] -.-> PushChannel[PushChannel<br>推送处理数据] -.-> 数据模块\r\n+    起点 --> EffectHandler[EffectHandler<br>数据处理器] -.-> PushChannel[PushChannel<br>推送处理数据] -.-> 数据模块\r\n     QueryChannel[QueryChannel<br>查询数据] -.-> 起点\r\n     数据模块 -.-> QueryChannel\r\n \r\n     style PushChannel fill:#c8e6c9\r\n"
                },
                {
                    "date": 1767184470369,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -451,9 +451,9 @@\n \r\n     起点 --> EffectHandler[EffectHandler<br>数据处理器] -.-> PushChannel[PushChannel<br>推送处理数据] -.-> 数据模块\r\n     QueryChannel[QueryChannel<br>查询数据] -.-> 起点\r\n     数据模块 -.-> QueryChannel\r\n-\r\n+    起点 -.-> QueryChannel\r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n     style 起点 fill:#ffe0b2\r\n ```\r\n"
                },
                {
                    "date": 1767184509615,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -454,9 +454,10 @@\n     数据模块 -.-> QueryChannel\r\n     起点 -.-> QueryChannel\r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n-    style 起点 fill:#ffe0b2\r\n+\r\n+    style 起点 fill:#e1f5ff\r\n ```\r\n \r\n ### 架构结构\r\n \r\n"
                },
                {
                    "date": 1767184543809,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -449,9 +449,9 @@\n         外部系统\r\n     end\r\n \r\n     起点 --> EffectHandler[EffectHandler<br>数据处理器] -.-> PushChannel[PushChannel<br>推送处理数据] -.-> 数据模块\r\n-    QueryChannel[QueryChannel<br>查询数据] -.-> 起点\r\n+    QueryChannel[<b>QueryChannel</b><br>查询数据] -.-> 起点\r\n     数据模块 -.-> QueryChannel\r\n     起点 -.-> QueryChannel\r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n"
                },
                {
                    "date": 1767184557725,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -449,9 +449,9 @@\n         外部系统\r\n     end\r\n \r\n     起点 --> EffectHandler[EffectHandler<br>数据处理器] -.-> PushChannel[PushChannel<br>推送处理数据] -.-> 数据模块\r\n-    QueryChannel[<b>QueryChannel</b><br>查询数据] -.-> 起点\r\n+    QueryChannel[**QueryChannel**<br>查询数据] -.-> 起点\r\n     数据模块 -.-> QueryChannel\r\n     起点 -.-> QueryChannel\r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n"
                },
                {
                    "date": 1767184564347,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -448,9 +448,9 @@\n         领域\r\n         外部系统\r\n     end\r\n \r\n-    起点 --> EffectHandler[EffectHandler<br>数据处理器] -.-> PushChannel[PushChannel<br>推送处理数据] -.-> 数据模块\r\n+    起点 --> EffectHandler[EffectHandler<br>数据处理器] -.-> PushChannel[**PushChannel**<br>推送处理数据] -.-> 数据模块\r\n     QueryChannel[**QueryChannel**<br>查询数据] -.-> 起点\r\n     数据模块 -.-> QueryChannel\r\n     起点 -.-> QueryChannel\r\n     style PushChannel fill:#c8e6c9\r\n"
                },
                {
                    "date": 1767184597328,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -448,9 +448,9 @@\n         领域\r\n         外部系统\r\n     end\r\n \r\n-    起点 --> EffectHandler[EffectHandler<br>数据处理器] -.-> PushChannel[**PushChannel**<br>推送处理数据] -.-> 数据模块\r\n+    起点 --> EffectHandler[**EffectHandler**<br>数据处理器] -.-> PushChannel[**PushChannel**<br>推送处理数据] -.-> 数据模块\r\n     QueryChannel[**QueryChannel**<br>查询数据] -.-> 起点\r\n     数据模块 -.-> QueryChannel\r\n     起点 -.-> QueryChannel\r\n     style PushChannel fill:#c8e6c9\r\n"
                },
                {
                    "date": 1767184614247,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -439,8 +439,9 @@\n ### 数值查询及推送 (CommunicationBus)\r\n \r\n - 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n \r\n+- EffectHandler\r\n \r\n ```mermaid\r\n graph LR\r\n     subgraph 起点[\"起点\"]\r\n"
                },
                {
                    "date": 1767184632895,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -439,9 +439,9 @@\n ### 数值查询及推送 (CommunicationBus)\r\n \r\n - 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n \r\n-- EffectHandler\r\n+- EffectHandler是数据处理器，负责处理数据，并推送处理数据到PushChannel\r\n \r\n ```mermaid\r\n graph LR\r\n     subgraph 起点[\"起点\"]\r\n"
                },
                {
                    "date": 1767184642285,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -439,9 +439,9 @@\n ### 数值查询及推送 (CommunicationBus)\r\n \r\n - 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n \r\n-- EffectHandler是数据处理器，负责处理数据，并推送处理数据到PushChannel\r\n+- **EffectHandler** 是数据处理器，负责处理数据，并推送处理数据到PushChannel\r\n \r\n ```mermaid\r\n graph LR\r\n     subgraph 起点[\"起点\"]\r\n"
                },
                {
                    "date": 1767184649482,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -439,9 +439,9 @@\n ### 数值查询及推送 (CommunicationBus)\r\n \r\n - 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n \r\n-- **EffectHandler** 是数据处理器，负责处理数据，并推送处理数据到PushChannel\r\n+- **EffectHandler** 是数据类型处理器，负责处理数据，并推送处理数据到PushChannel\r\n \r\n ```mermaid\r\n graph LR\r\n     subgraph 起点[\"起点\"]\r\n"
                },
                {
                    "date": 1767184663551,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -439,9 +439,9 @@\n ### 数值查询及推送 (CommunicationBus)\r\n \r\n - 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n \r\n-- **EffectHandler** 是数据类型处理器，负责处理数据，并推送处理数据到PushChannel\r\n+- **EffectHandler** 是数据类型处理器，负责处理整合数据，并推送处理数据到PushChannel\r\n \r\n ```mermaid\r\n graph LR\r\n     subgraph 起点[\"起点\"]\r\n"
                },
                {
                    "date": 1767184676039,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -439,9 +439,9 @@\n ### 数值查询及推送 (CommunicationBus)\r\n \r\n - 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n \r\n-- **EffectHandler** 是数据类型处理器，负责处理整合数据，并推送处理数据到PushChannel\r\n+- **EffectHandler** 是数据类型处理器，负责处理整合数据，并通过PushChannel推送数据到数据模块\r\n \r\n ```mermaid\r\n graph LR\r\n     subgraph 起点[\"起点\"]\r\n"
                },
                {
                    "date": 1767184681809,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -439,9 +439,9 @@\n ### 数值查询及推送 (CommunicationBus)\r\n \r\n - 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n \r\n-- **EffectHandler** 是数据类型处理器，负责处理整合数据，并通过PushChannel推送数据到数据模块\r\n+- **EffectHandler** 是数据类型处理器，负责处理整合数据，并通过PushChannel推送数据到生效数据模块\r\n \r\n ```mermaid\r\n graph LR\r\n     subgraph 起点[\"起点\"]\r\n"
                },
                {
                    "date": 1767184793895,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -437,12 +437,19 @@\n \r\n \r\n ### 数值查询及推送 (CommunicationBus)\r\n \r\n-- 节点、领域、数据模块、外部系统、通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯\r\n+**核心机制**：节点、领域、数据模块、外部系统通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯，实现数据推送和查询的双向数据流。\r\n \r\n-- **EffectHandler** 是数据类型处理器，负责处理整合数据，并通过PushChannel推送数据到生效数据模块\r\n+**关键组件**：\r\n+- **EffectHandler**：数据类型处理器，负责处理整合数据，并通过PushChannel推送数据到生效的数据模块\r\n+- **PushChannel**：推送处理后的数据到数据模块（推送流程）\r\n+- **QueryChannel**：从数据模块查询数据并返回给起点（查询流程）\r\n \r\n+**数据流说明**：\r\n+- **实线箭头（→）**：直接的数据流/处理流（同步处理）\r\n+- **虚线箭头（-.->）**：异步消息/查询流（异步查询和反馈）\r\n+\r\n ```mermaid\r\n graph LR\r\n     subgraph 起点[\"起点\"]\r\n         节点\r\n"
                },
                {
                    "date": 1767184858029,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -447,9 +447,12 @@\n \r\n **数据流说明**：\r\n - **实线箭头（→）**：直接的数据流/处理流（同步处理）\r\n - **虚线箭头（-.->）**：异步消息/查询流（异步查询和反馈）\r\n-\r\n+- \r\n+**工作流程**：\r\n+1. **推送流程**：起点（节点/领域/外部系统）→ EffectHandler处理数据 → PushChannel推送 → 数据模块存储\r\n+2. **查询流程**：起点发起查询 → QueryChannel查询 → 数据模块返回数据 → QueryChannel返回结果 → 起点接收\r\n ```mermaid\r\n graph LR\r\n     subgraph 起点[\"起点\"]\r\n         节点\r\n"
                },
                {
                    "date": 1767184874499,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,1028 @@\n+# 战斗系统架构设计文档\r\n+\r\n+## 目录\r\n+\r\n+1. [概述](#概述)\r\n+2. [整体架构](#整体架构)\r\n+3. [战斗领域](#战斗领域)\r\n+4. [回合领域](#回合领域)\r\n+5. [单位领域](#单位领域)\r\n+6. [核心机制](#核心机制)\r\n+7. [数据结构](#数据结构)\r\n+8. [外部系统集成](#外部系统集成)\r\n+9. [实现指南](#实现指南)\r\n+\r\n+---\r\n+\r\n+## 概述\r\n+\r\n+### 设计目标\r\n+\r\n+设计一套完整的回合制战斗系统架构，支持DND规则、回合管理、状态机控制、AI决策，实现战斗流程管理、伤害计算、效果应用，提供数据驱动的配置化战斗系统。\r\n+\r\n+### 核心设计理念\r\n+\r\n+#### 1. 多层循环架构为核心\r\n+\r\n+**本质**：战斗系统的核心是多层循环的维护和管理（当前实现为三层）\r\n+\r\n+- **战斗循环**：管理整个战斗的生命周期\r\n+- **回合循环**：管理回合的循环和切换\r\n+- **单位循环**：管理单个单位的行动流程\r\n+- **循环驱动**：所有战斗逻辑都在循环框架内执行\r\n+- **状态维护**：每层循环维护自己的状态，驱动下层循环\r\n+\r\n+#### 2. 数据驱动架构\r\n+\r\n+**本质**：战斗特性通过配置数据实现，无需修改代码\r\n+\r\n+- 战斗规则、伤害计算、效果应用 → 通过配置数据定义\r\n+- 回合流程、状态转换 → 通过配置数据调整\r\n+- 新增战斗机制 → 扩展配置数据即可\r\n+- 战斗平衡 → 调整配置数值即可\r\n+\r\n+#### 3. 分层架构（循环内的功能组织）\r\n+\r\n+**本质**：分层架构是循环内的功能组织方式，不是主要架构\r\n+\r\n+- 功能组织：输入层、决策层、执行层、表现层、管理层\r\n+- 执行位置：所有分层功能都在单位循环内执行\r\n+- 解耦设计：层间通过Context和CommunicationBus通信\r\n+\r\n+#### 4. Domain controls Loop\r\n+\r\n+**核心原则**：Domain控制循环，循环是Domain的工具\r\n+\r\n+- Domain是领域核心，拥有循环机制来推进业务流程\r\n+- Domain管理通过协调器控制循环状态转换\r\n+- 协调器执行完业务后，主动推动循环进入下一个状态\r\n+\r\n+---\r\n+\r\n+## 整体架构\r\n+\r\n+### 多层循环架构\r\n+\r\n+**核心观点**：整个回合制战斗系统的核心是维护多层循环，所有战斗逻辑都在循环框架内执行。\r\n+\r\n+#### Domain与循环的关系\r\n+\r\n+**术语说明**：使用\"Domain\"而非\"Entity\"，避免与项目中的\"Unit\"概念混淆。\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    subgraph BattleDomain[\"战斗Domain<br/>Battle Domain\"]\r\n+        BattleManagement[战斗管理<br/>结算奖励/同步任务]\r\n+        BattleLoop[\"战斗循环<br/>BattleLoop\"]\r\n+        BattleManagement -->|控制| BattleLoop\r\n+        BattleLoop -->|推进| BattleManagement\r\n+        \r\n+        subgraph RoundDomain[\"回合Domain<br/>Round Domain\"]\r\n+            RoundManagement[回合管理<br/>行动值排序/单位行动顺序]\r\n+            RoundLoop[\"回合循环<br/>RoundLoop\"]\r\n+            RoundManagement -->|控制| RoundLoop\r\n+            RoundLoop -->|推进| RoundManagement\r\n+            \r\n+            subgraph UnitDomain[\"单位Domain<br/>Unit Domain\"]\r\n+                UnitManagement[单位管理<br/>移动/施法/选择技能对象]\r\n+                UnitLoop[\"单位循环<br/>UnitLoop\"]\r\n+                UnitManagement -->|控制| UnitLoop\r\n+                UnitLoop -->|推进| UnitManagement\r\n+            end\r\n+        end\r\n+    end\r\n+    \r\n+    style BattleDomain fill:#ffebee\r\n+    style RoundDomain fill:#fff4e1\r\n+    style UnitDomain fill:#e1f5ff\r\n+    style BattleLoop fill:#f3e5f5\r\n+    style RoundLoop fill:#f3e5f5\r\n+    style UnitLoop fill:#f3e5f5\r\n+```\r\n+\r\n+**备注**：\r\n+- **三层架构**：当前实现为三层架构（战斗→回合→单位），符合DND规则中所有单位按先攻值统一排序的设计\r\n+- **阵营循环**：在标准DND规则中，所有单位按先攻值（Initiative）统一排序行动，不存在阵营循环。此处保留作为扩展设计，便于后续支持阵营差异行为\r\n+\r\n+#### Domain协作关系\r\n+\r\n+**核心观点**：Domain之间通过协作推进业务流程，父Domain调用子Domain，子Domain完成业务后返回父Domain。\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    BattleDomain[战斗Domain<br/>Battle Domain]\r\n+    RoundDomain[回合Domain<br/>Round Domain]\r\n+    UnitDomain[单位Domain<br/>Unit Domain]\r\n+    \r\n+    BattleDomain -->|1. 调用| RoundDomain\r\n+    RoundDomain -->|2. 返回| BattleDomain\r\n+    RoundDomain -->|3. 调用| UnitDomain\r\n+    UnitDomain -->|4. 返回| RoundDomain\r\n+    \r\n+    BattleDomain -.->|包含| RoundDomain\r\n+    RoundDomain -.->|包含| UnitDomain\r\n+    \r\n+    style BattleDomain fill:#ffebee\r\n+    style RoundDomain fill:#fff4e1\r\n+    style UnitDomain fill:#e1f5ff\r\n+```\r\n+\r\n+**协作流程说明**：\r\n+1. **战斗Domain** → 调用 **回合Domain**：战斗进行中，需要执行回合\r\n+2. **回合Domain** → 调用 **单位Domain**：回合进行中，需要处理单位行动\r\n+3. **单位Domain** → 返回 **回合Domain**：单位行动完成\r\n+4. **回合Domain** → 返回 **战斗Domain**：回合完成\r\n+\r\n+**协作原则**：\r\n+- 父Domain控制子Domain的调用时机\r\n+- 子Domain完成业务后主动返回父Domain\r\n+- 每个Domain独立管理自己的业务逻辑和循环\r\n+\r\n+### 循环职责说明\r\n+\r\n+#### 1. 战斗循环（BattleLoop）\r\n+- **职责**：管理整个战斗的生命周期\r\n+- **状态**：PREPARING → IN_PROGRESS → ENDED\r\n+- **维护**：BattleLoopManager\r\n+\r\n+#### 2. 回合循环（RoundLoop）\r\n+- **职责**：管理回合的循环和切换\r\n+- **状态**：START → ACTION → END\r\n+- **维护**：RoundLoopManager\r\n+\r\n+#### 3. 单位循环（UnitLoop）\r\n+- **职责**：管理单个单位的行动流程\r\n+- **状态**：START → ACTION → END\r\n+- **维护**：UnitLoopManager\r\n+\r\n+---\r\n+\r\n+## 战斗领域\r\n+\r\n+### 核心职责\r\n+\r\n+战斗领域负责管理整个战斗的生命周期，包括战斗初始化、战斗流程控制、战斗结束判断、奖励结算、任务同步等。\r\n+\r\n+### 架构结构\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    subgraph BattleDomain[\"战斗Domain<br/>Battle Domain\"]\r\n+        BattleManagement[战斗管理<br/>BattleManagement]\r\n+        BattleLoop[战斗循环<br/>BattleLoop<br/>PREPARING → IN_PROGRESS → ENDED]\r\n+        RoundCoordinator[回合协调器<br/>RoundCoordinator<br/>微核心：只负责协调调用]\r\n+        \r\n+        subgraph BattleManagement[\"战斗管理<br/>BattleManagement\"]\r\n+            BattleData[战斗数据<br/>BattleData]\r\n+            DataMgr[战斗数据管理<br/>战斗状态/回合历史/活跃阵营]\r\n+            RuleMgr[战斗规则管理<br/>战斗开始/结束条件/胜利条件/失败条件]\r\n+            RewardMgr[奖励管理<br/>奖励结算/任务同步]\r\n+        end\r\n+    end\r\n+    \r\n+    subgraph ExternalSystems[\"外部系统\"]\r\n+        RoundDomain[回合领域<br/>Round Domain]\r\n+        RewardSystem[奖励系统<br/>Reward System]\r\n+        TaskSystem[任务系统<br/>Task System]\r\n+    end\r\n+    \r\n+    BattleManagement -->|控制| BattleLoop\r\n+    BattleManagement --> RoundCoordinator\r\n+    RoundCoordinator -->|反向推动| BattleLoop\r\n+    BattleLoop -->|推进| BattleManagement\r\n+    \r\n+    RoundCoordinator -->|调用| RoundDomain\r\n+    RoundDomain -->|返回| RoundCoordinator\r\n+    \r\n+    BattleManagement -->|结算奖励| RewardSystem\r\n+    BattleManagement -->|同步任务| TaskSystem\r\n+    \r\n+    style BattleDomain fill:#ffebee\r\n+    style BattleManagement fill:#ffebee\r\n+    style BattleLoop fill:#f3e5f5\r\n+    style RoundCoordinator fill:#c8e6c9\r\n+```\r\n+\r\n+### 战斗管理（BattleManagement）\r\n+\r\n+#### 1. 战斗数据管理\r\n+- **战斗状态**：当前战斗状态（PREPARING/IN_PROGRESS/ENDED）\r\n+- **回合历史**：记录已完成的回合历史（`roundHistoryQueue`）\r\n+- **活跃阵营列表**：当前战斗中活跃的阵营ID列表（`activeFactionIDs`）\r\n+- **突袭回合阵营列表**：被突袭的阵营ID列表（`surpriseRoundFactionIDs`）\r\n+\r\n+#### 2. 战斗规则管理\r\n+- **战斗开始条件**：检查是否可以开始战斗\r\n+- **战斗结束条件**：检查是否应该结束战斗\r\n+- **胜利条件**：检查是否满足胜利条件（`CheckVictoryCondition`）\r\n+- **失败条件**：检查是否满足失败条件（`CheckDefeatCondition`）\r\n+\r\n+#### 3. 奖励管理\r\n+- **奖励结算**：战斗结束后结算奖励\r\n+- **任务同步**：同步战斗相关的任务进度\r\n+\r\n+### 战斗循环（BattleLoop）\r\n+\r\n+**循环状态**：PREPARING → IN_PROGRESS → ENDED\r\n+\r\n+- **PREPARING**：战斗准备中，初始化战斗数据\r\n+- **IN_PROGRESS**：战斗进行中，执行回合（调用回合领域）\r\n+- **ENDED**：战斗已结束，结算奖励、同步任务\r\n+\r\n+### 回合协调器（RoundCoordinator）\r\n+\r\n+**核心原则**：只负责协调调用，不包含业务规则\r\n+\r\n+**核心职责**：\r\n+- ✅ **协调调用**：调用回合领域执行回合\r\n+- ✅ **反向推动循环**：回合完成后，主动推动战斗循环进入下一个状态（Domain controls Loop）\r\n+\r\n+### 战斗完整流程\r\n+\r\n+```mermaid\r\n+flowchart TD\r\n+    LoopPreparing[LoopPreparing<br/>战斗准备] --> InitBattle[初始化战斗数据<br/>战斗管理初始化]\r\n+    \r\n+    InitBattle --> LoopProgress[LoopProgress<br/>战斗进行中]\r\n+    \r\n+    LoopProgress --> CallRound[调用回合领域<br/>回合协调器调用回合领域]\r\n+    \r\n+    CallRound --> RoundAction[回合领域执行回合<br/>回合领域完成回合]\r\n+    \r\n+    RoundAction --> PushProgress[回合协调器推动循环<br/>推动到IN_PROGRESS状态继续]\r\n+    \r\n+    PushProgress --> CheckEnd{检查战斗结束条件<br/>战斗管理检查}\r\n+    \r\n+    CheckEnd -->|未结束| CallRound\r\n+    CheckEnd -->|已结束| PushEnd[回合协调器推动循环<br/>推动到ENDED状态]\r\n+    \r\n+    PushEnd --> LoopEnd[LoopEnd<br/>战斗结束]\r\n+    \r\n+    LoopEnd --> Reward[结算奖励<br/>奖励管理结算奖励]\r\n+    Reward --> Task[同步任务<br/>任务管理同步任务]\r\n+    Task --> Complete[战斗完成]\r\n+    \r\n+    style LoopPreparing fill:#ffebee\r\n+    style LoopProgress fill:#ffebee\r\n+    style CallRound fill:#c8e6c9\r\n+    style RoundAction fill:#c8e6c9\r\n+    style PushProgress fill:#f3e5f5\r\n+    style PushEnd fill:#f3e5f5\r\n+    style LoopEnd fill:#ffebee\r\n+    style CheckEnd fill:#ffe0b2\r\n+```\r\n+\r\n+---\r\n+\r\n+## 回合领域\r\n+\r\n+### 核心职责\r\n+\r\n+回合领域负责管理回合的循环和切换，包括回合数管理、行动顺序管理（基于先攻值）、回合开始/结束控制等。\r\n+\r\n+### 架构结构\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    subgraph RoundDomain[\"回合Domain<br/>Round Domain\"]\r\n+        RoundManagement[回合管理<br/>RoundManagement]\r\n+        RoundLoop[回合循环<br/>RoundLoop<br/>START → ACTION → END]\r\n+        UnitCoordinator[单位协调器<br/>UnitCoordinator<br/>微核心：只负责协调调用]\r\n+        \r\n+        subgraph RoundManagement[\"回合管理<br/>RoundManagement\"]\r\n+            RoundData[回合数据<br/>RoundData]\r\n+            DataMgr[回合数据管理<br/>回合数/行动顺序队列]\r\n+            RuleMgr[回合规则管理<br/>回合开始/结束条件]\r\n+            OrderMgr[行动顺序管理<br/>队列初始化/管理/获取下一个单位]\r\n+        end\r\n+        \r\n+        subgraph UnitCoordinator[\"单位协调器<br/>UnitCoordinator<br/>微核心：只负责协调调用\"]\r\n+            UnitCall[单位调用<br/>从回合管理获取单位<br/>调用单位领域]\r\n+        end\r\n+    end\r\n+    \r\n+    subgraph ExternalSystems[\"外部系统\"]\r\n+        BattleDomain[战斗领域<br/>Battle Domain]\r\n+        UnitDomain[单位领域<br/>Unit Domain]\r\n+    end\r\n+    \r\n+    BattleDomain -->|控制| RoundDomain\r\n+    RoundManagement -->|控制| RoundLoop\r\n+    RoundManagement --> UnitCoordinator\r\n+    UnitCoordinator -->|反向推动| RoundLoop\r\n+    RoundLoop -->|推进| RoundManagement\r\n+    \r\n+    UnitCoordinator -->|调用| UnitDomain\r\n+    UnitDomain -->|返回| UnitCoordinator\r\n+    \r\n+    style RoundDomain fill:#fff4e1\r\n+    style RoundManagement fill:#fff4e1\r\n+    style RoundLoop fill:#f3e5f5\r\n+    style UnitCoordinator fill:#c8e6c9\r\n+    style RoundData fill:#e1f5ff\r\n+```\r\n+\r\n+### 回合管理（RoundManagement）\r\n+\r\n+#### 1. 回合数据管理\r\n+- **回合数**：当前回合数、总回合数\r\n+- **行动顺序队列**：基于先攻值的优先级队列（TurnQueue）\r\n+- **当前行动单位**：当前正在行动的单位\r\n+- **活跃阵营列表**：当前回合中活跃的阵营ID列表\r\n+\r\n+#### 2. 回合规则管理\r\n+- **回合开始条件**：检查是否可以开始新回合\r\n+- **回合结束条件**：检查是否应该结束当前回合（所有单位行动完成）\r\n+- **回合切换规则**：判断是否还有下一个回合\r\n+- **突袭回合规则**：战斗开始时，只有被突袭的阵营才能行动（Surprise Round）\r\n+- **单位存活检查**：只有存活的单位才能参与回合（`unit:IsAlive()`）\r\n+- **活跃阵营过滤**：只有活跃的阵营才能参与回合（`activeFactionIDs`）\r\n+\r\n+#### 3. 行动顺序管理\r\n+- **初始化队列**：回合开始时，根据先攻值初始化行动顺序队列\r\n+  - **突袭回合处理**：战斗开始时，只有被突袭的阵营单位加入队列\r\n+  - **正常回合处理**：正常回合中，所有活跃阵营的存活单位加入队列\r\n+- **队列管理**：管理行动顺序队列的添加、移除、清空\r\n+- **获取下一个单位**：从行动顺序队列中获取下一个行动单位（自动过滤死亡单位）\r\n+- **下一个单位检查**：检查是否还有下一个行动单位\r\n+- **延迟行动管理**：管理延迟行动的单位列表，在适当时候插入到行动顺序中\r\n+\r\n+### 回合循环（RoundLoop）\r\n+\r\n+**循环状态**：START → ACTION → END\r\n+\r\n+- **START**：回合开始，初始化行动顺序队列\r\n+  - **突袭回合**：只有被突袭的阵营单位加入队列\r\n+  - **正常回合**：所有活跃阵营的存活单位加入队列\r\n+- **ACTION**：执行回合行动（调用单位领域）\r\n+- **END**：回合结束，清理回合数据，处理延迟行动\r\n+\r\n+### 单位协调器（UnitCoordinator）\r\n+\r\n+**核心原则**：只负责协调调用，不包含业务规则\r\n+\r\n+**核心职责**：\r\n+- ✅ **协调调用**：从回合管理获取下一个单位，调用单位领域执行单位行动\r\n+- ✅ **反向推动循环**：单位行动完成后，主动推动回合循环进入下一个状态（Domain controls Loop）\r\n+\r\n+#### 循环推动机制\r\n+- **推动到END**：所有单位行动完成后，推动循环从ACTION状态进入END状态\r\n+- **推动到START**：回合结束时，推动循环从END状态进入START状态（下一个回合）\r\n+- **推动到ACTION**：回合开始时，推动循环从START状态进入ACTION状态\r\n+\r\n+### 回合完整流程\r\n+\r\n+```mermaid\r\n+flowchart TD\r\n+    LoopStart[LoopStart<br/>战斗领域推动循环] --> InitQueue[初始化行动顺序队列<br/>回合管理根据先攻值排序]\r\n+    \r\n+    InitQueue --> LoopAction[LoopAction<br/>执行回合行动]\r\n+    \r\n+    LoopAction --> GetNextUnit{获取下一个单位<br/>回合管理从队列获取}\r\n+    \r\n+    GetNextUnit -->|有单位| CallUnit[调用单位领域<br/>单位协调器调用单位领域]\r\n+    GetNextUnit -->|无单位| PushEnd\r\n+    \r\n+    CallUnit --> UnitAction[单位领域执行行动<br/>单位领域完成行动]\r\n+    \r\n+    UnitAction --> PushAction[单位协调器推动循环<br/>推动到ACTION状态继续]\r\n+    \r\n+    PushAction --> GetNextUnit\r\n+    \r\n+    PushEnd[单位协调器推动循环<br/>推动到END状态]\r\n+    \r\n+    PushEnd --> RoundEnd[LoopEnd<br/>回合结束]\r\n+    \r\n+    RoundEnd --> CheckNextRound{检查下一个回合<br/>回合管理检查是否还有下一个回合}\r\n+    \r\n+    CheckNextRound -->|有下一个回合| PushStart[单位协调器推动循环<br/>推动到START状态]\r\n+    CheckNextRound -->|无下一个回合| EndRound[结束回合循环<br/>返回战斗领域]\r\n+    \r\n+    PushStart --> LoopStart\r\n+    \r\n+    style LoopStart fill:#fff4e1\r\n+    style LoopAction fill:#fff4e1\r\n+    style CallUnit fill:#c8e6c9\r\n+    style UnitAction fill:#c8e6c9\r\n+    style PushAction fill:#f3e5f5\r\n+    style PushEnd fill:#f3e5f5\r\n+    style PushStart fill:#f3e5f5\r\n+    style LoopEnd fill:#fff4e1\r\n+    style GetNextUnit fill:#ffe0b2\r\n+    style CheckNextRound fill:#ffe0b2\r\n+```\r\n+\r\n+**关键点**：\r\n+- ✅ **Domain controls Loop**：回合管理通过单位协调器控制循环状态转换\r\n+- ✅ **反向推动机制**：单位协调器执行完单位行动后，主动推动循环进入下一个状态\r\n+- ✅ **单位协调器不处理业务规则**：只负责协调调用单位领域，不处理回合业务逻辑\r\n+- ✅ **行动顺序管理**：回合管理负责基于先攻值的优先级队列，确保单位按正确顺序行动\r\n+- ✅ **队列驱动**：通过行动顺序队列驱动单位行动，队列为空时回合结束\r\n+\r\n+### 职责划分\r\n+\r\n+| 组件 | 职责 | 说明 |\r\n+|------|------|------|\r\n+| **回合管理** | 回合数据与规则 | 管理回合数、行动顺序队列、回合开始/结束规则、队列管理 |\r\n+| **单位协调器** | 协调调用 | 从回合管理获取单位，调用单位领域，不处理回合业务规则 |\r\n+| **回合循环** | 流程控制 | START/ACTION/END状态转换，由回合管理控制 |\r\n+\r\n+---\r\n+\r\n+## 单位领域\r\n+\r\n+### 核心职责\r\n+\r\n+单位领域是战斗系统的核心，负责管理单个单位的行动流程，包括移动、技能释放、数值控制等。\r\n+\r\n+\r\n+### 数值查询及推送 (CommunicationBus)\r\n+\r\n+**核心机制**：节点、领域、数据模块、外部系统通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯，实现数据推送和查询的双向数据流。\r\n+\r\n+**关键组件**：\r\n+- **EffectHandler**：数据类型处理器，负责处理整合数据，并通过PushChannel推送数据到生效的数据模块\r\n+- **PushChannel**：推送处理后的数据到数据模块（推送流程）\r\n+- **QueryChannel**：从数据模块查询数据并返回给起点（查询流程）\r\n+\r\n+\r\n+**工作流程**：\r\n+1. **推送流程**：起点（节点/领域/外部系统）→ EffectHandler处理数据 → PushChannel推送 → 数据模块存储\r\n+2. **查询流程**：起点发起查询 → QueryChannel查询 → 数据模块返回数据 → QueryChannel返回结果 → 起点接收\r\n+```mermaid\r\n+graph LR\r\n+    subgraph 起点[\"起点\"]\r\n+        节点\r\n+        领域\r\n+        外部系统\r\n+    end\r\n+\r\n+    起点 --> EffectHandler[**EffectHandler**<br>数据处理器] -.-> PushChannel[**PushChannel**<br>推送处理数据] -.-> 数据模块\r\n+    QueryChannel[**QueryChannel**<br>查询数据] -.-> 起点\r\n+    数据模块 -.-> QueryChannel\r\n+    起点 -.-> QueryChannel\r\n+    style PushChannel fill:#c8e6c9\r\n+    style QueryChannel fill:#c8e6c9\r\n+\r\n+    style 起点 fill:#e1f5ff\r\n+```\r\n+\r\n+### 架构结构\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    subgraph UnitDomain[\"单位Domain<br/>Unit Domain\"]\r\n+        UnitManagement[单位管理<br/>UnitManagement]\r\n+        UnitLoop[单位循环<br/>UnitLoop<br/>START → ACTION → END]\r\n+        ActionCoordinator[行动协调器<br/>ActionCoordinator<br/>微核心：只负责协调调用]\r\n+        \r\n+        subgraph UnitManagement[\"单位管理<br/>UnitManagement\"]\r\n+            UnitData[单位数据<br/>UnitData]\r\n+            DataMgr[单位数据管理<br/>属性/状态/位置/回合数据<br/>AP/MP/先攻值]\r\n+            RuleMgr[单位规则管理<br/>行动点数规则/移动点数规则<br/>先攻值规则/回合初始化规则]\r\n+        end\r\n+        \r\n+        subgraph DataHandleQueue[\"DataHandleQueue<br/>数据队列<br/>1:1关系\"]\r\n+        end\r\n+        \r\n+        subgraph ActionCoordinator[\"行动协调器<br/>ActionCoordinator<br/>微核心：只负责协调调用\"]\r\n+            MoveCoord[移动协调<br/>调用网格系统]\r\n+            SkillCoord[技能协调<br/>调用技能领域]\r\n+            TerrainCoord[地形交互协调<br/>调用地形领域<br/>可选]\r\n+            VisualCoord[表现协调<br/>通知表现层]\r\n+        end\r\n+    end\r\n+    \r\n+    subgraph ExternalSystems[\"外部系统\"]\r\n+        GridSystem[网格系统<br/>GridSystem]\r\n+        SkillDomain[技能领域<br/>Skill Domain]\r\n+        VisualSystem[表现系统<br/>Visual System]\r\n+        TerrainDomain[地形领域<br/>Terrain Domain]\r\n+    end\r\n+    \r\n+    UnitManagement -->|控制| UnitLoop\r\n+    UnitManagement --> ActionCoordinator\r\n+    UnitManagement --> UnitData\r\n+    ActionCoordinator -->|反向推动| UnitLoop\r\n+    UnitLoop -->|推进| UnitManagement\r\n+    \r\n+    ActionCoordinator -->|调用| GridSystem\r\n+    ActionCoordinator -->|调用| SkillDomain\r\n+    ActionCoordinator -->|调用| TerrainDomain\r\n+    ActionCoordinator -->|通知| VisualSystem\r\n+    \r\n+    SkillDomain -->|EffectHandler推送| DataHandleQueue\r\n+    TerrainDomain -->|EffectHandler推送| DataHandleQueue\r\n+\r\n+    DataHandleQueue -->|推送数据| UnitData\r\n+    \r\n+    style UnitDomain fill:#e1f5ff\r\n+    style UnitManagement fill:#fff4e1\r\n+    style UnitLoop fill:#f3e5f5\r\n+    style ActionCoordinator fill:#c8e6c9\r\n+    style DataHandleQueue fill:#f3e5f5\r\n+    style UnitData fill:#e1f5ff\r\n+```\r\n+\r\n+### 单位管理（UnitManagement）\r\n+\r\n+#### 1. 单位数据管理\r\n+- **单位属性**：生命值、行动点数（AP）、移动点数（MP）、先攻值等\r\n+- **单位状态**：是否可行动、是否已移动、是否已攻击、是否存活等\r\n+- **单位位置**：当前网格位置\r\n+- **回合数据**：UnitTurnData管理行动点数、移动点数、先攻值等回合相关数据\r\n+\r\n+#### 2. 单位规则管理\r\n+- **移动点数规则**：移动前检查能否移动\r\n+- **行动点数规则**：检查行动是否可执行（`CheckAction`），消耗行动点数和移动点数（`ConsumeAction`）\r\n+- **行动规则**：是否可执行行动（移动、攻击、技能等）\r\n+- **状态规则**：状态转换规则（是否存活、是否可行动等）\r\n+- **先攻值规则**：管理单位的先攻值，用于回合顺序排序\r\n+- **回合初始化规则**：回合开始时初始化行动点数和移动点数（`StartUnitTurn`）\r\n+\r\n+#### 3. UnitData与DataHandleQueue关系\r\n+- **1:1关系**：DataHandleQueue 与 UnitData 是 1:1 关系，数据直接修改 UnitData\r\n+- **直接修改**：技能领域的EffectHandler推送数据到DataHandleQueue后，直接修改UnitData\r\n+- **无需中间层**：不需要\"数值控制管理\"中间层，DataHandleQueue直接修改UnitData\r\n+\r\n+### 单位循环（UnitLoop）\r\n+\r\n+**循环状态**：START → ACTION → END\r\n+\r\n+- **START**：单位开始行动\r\n+- **ACTION**：执行行动（移动、技能等）\r\n+- **END**：单位结束行动\r\n+\r\n+### 行动协调器（ActionCoordinator）\r\n+\r\n+**核心原则**：只负责协调调用，不包含业务规则\r\n+\r\n+**核心职责**：\r\n+- ✅ **协调调用**：调用网格系统、技能领域、表现系统\r\n+- ✅ **反向推动循环**：执行完行动后，主动推动单位循环进入下一个状态（Domain controls Loop）\r\n+\r\n+#### 1. 移动协调\r\n+- **移动前检查**：调用单位管理检查移动点数和行动点数\r\n+- **调用网格系统**：进行移动计算（路径查找、移动范围等）\r\n+- **移动后更新**：通过 DataHandleQueue 更新单位位置和移动点数\r\n+- **推动循环**：移动完成后，推动循环进入下一个状态\r\n+\r\n+#### 2. 技能协调\r\n+- **行动点数检查**：调用单位管理检查行动点数是否足够\r\n+- **调用技能领域**：执行技能\r\n+- **不处理数值控制**：数值控制由技能领域的EffectHandler通过DataHandleQueue处理\r\n+- **接收技能结果**：获取技能执行结果（成功/失败），用于流程控制\r\n+- **推动循环**：技能执行完成后，推动循环进入下一个状态\r\n+\r\n+#### 3. 地形交互协调（可选）\r\n+- **地形交互检查**：检查单位是否触发地形要素（陷阱、门等）\r\n+- **调用地形领域**：如果触发地形要素，调用地形领域处理\r\n+- **推动循环**：地形交互完成后，推动循环进入下一个状态\r\n+\r\n+#### 4. 表现协调\r\n+- **通知表现层**：移动表现、技能表现、受攻击表现\r\n+- **推动循环**：表现播放完成后（可选），推动循环进入下一个状态\r\n+\r\n+### 单位行动完整流程\r\n+\r\n+```mermaid\r\n+flowchart TD\r\n+    LoopStart[LoopStart<br/>单位管理推动循环] --> LoopAction[LoopAction<br/>执行行动]\r\n+    \r\n+    LoopAction --> CheckAction{行动前检查<br/>单位管理检查行动点数/移动点数}\r\n+    \r\n+    CheckAction -->|可以移动| Move[单位移动<br/>行动协调器调用网格系统]\r\n+    CheckAction -->|不能移动| Skill\r\n+    \r\n+    Move --> UpdateMove[更新移动点数<br/>DataHandleQueue推送]\r\n+    UpdateMove --> Skill[攻击/治疗<br/>行动协调器调用技能领域]\r\n+    \r\n+    Skill --> EffectPush[EffectHandler推送效果<br/>通过DataHandleQueue到目标单位]\r\n+    EffectPush --> Visual[可视化<br/>行动协调器通知表现层]\r\n+    \r\n+    Visual --> PushEnd[行动协调器推动循环<br/>推动到END状态]\r\n+    \r\n+    PushEnd --> CheckActionPoint{行动点数检查<br/>单位管理检查是否还有行动点数/移动点数}\r\n+    \r\n+    CheckActionPoint -->|还有行动点数/移动点数| PushAction[行动协调器推动循环<br/>推动回ACTION状态]\r\n+    CheckActionPoint -->|无行动点数/移动点数| LoopEnd[LoopEnd<br/>单位结束行动]\r\n+    \r\n+    PushAction --> LoopAction\r\n+    \r\n+    style LoopStart fill:#e1f5ff\r\n+    style LoopAction fill:#e1f5ff\r\n+    style Move fill:#fff4e1\r\n+    style Skill fill:#c8e6c9\r\n+    style EffectPush fill:#fff4e1\r\n+    style Visual fill:#c8e6c9\r\n+    style PushEnd fill:#f3e5f5\r\n+    style PushAction fill:#f3e5f5\r\n+    style LoopEnd fill:#e1f5ff\r\n+    style CheckAction fill:#ffe0b2\r\n+    style CheckActionPoint fill:#ffe0b2\r\n+```\r\n+\r\n+\r\n+\r\n+---\r\n+\r\n+## 单位领域：节点编排架构\r\n+\r\n+### 核心设计理念\r\n+\r\n+#### 1. 节点编排器为核心\r\n+\r\n+**本质**：单位行动流程的核心是节点编排器的动态组织和管理\r\n+\r\n+- 单位行动流程 = 节点编排器根据配置动态组织节点执行\r\n+- 节点编排 = 条件节点 → 执行节点 → 可视化节点的组合\r\n+- 流程控制 = 节点编排器根据节点执行结果决定下一个节点\r\n+- 灵活扩展 = 新增节点类型只需注册到编排器\r\n+\r\n+#### 2. 节点分类设计\r\n+\r\n+**本质**：节点按功能职责分为四类，每类节点职责单一、可复用\r\n+\r\n+- **输入节点（Input Node）**：负责接收玩家输入（如：接收移动点击、接收技能选择、接收目标选择等）\r\n+- **条件节点（Condition Node）**：负责验证、检查、判断，返回判断结果和流程控制建议（如：检查移动点数、验证技能可释放、检查资源决定是否继续等）\r\n+- **执行节点（Execution Node）**：负责实际执行操作，修改数据（如：执行移动、执行技能、消耗资源、更新状态等）\r\n+- **可视化节点（Visual Node）**：负责表现播放（如：播放移动表现、播放技能表现等）\r\n+\r\n+\r\n+\r\n+### 节点编排器架构\r\n+\r\n+```mermaid\r\n+graph TB\r\n+    subgraph UnitDomain[\"单位Domain\"]\r\n+        NodeOrchestrator[节点编排器<br/>NodeOrchestrator]\r\n+        \r\n+        subgraph NodeRegistry[\"节点注册表<br/>NodeRegistry\"]\r\n+            subgraph InputNodes[\"输入节点组<br/>Input Nodes\"]\r\n+                ReceiveMoveInputNode[接收移动输入节点]\r\n+                ReceiveSkillSelectNode[接收技能选择节点]\r\n+                ReceiveTargetSelectNode[接收目标选择节点]\r\n+            end\r\n+            \r\n+            subgraph ConditionNodes[\"条件节点组<br/>Condition Nodes\"]\r\n+                CheckMovePointNode[检查移动点数节点]\r\n+                CheckActionPointNode[检查行动点数节点]\r\n+                ValidateSkillNode[验证技能节点]\r\n+                ValidateTargetNode[验证目标节点]\r\n+                ValidateMoveNode[验证移动节点]\r\n+                CheckResourceNode[检查资源节点]\r\n+            end\r\n+            \r\n+            subgraph ExecutionNodes[\"执行节点组<br/>Execution Nodes\"]\r\n+                InitUnitNode[初始化单位节点]\r\n+                MoveNode[移动节点]\r\n+                SelectSkillNode[选择技能节点]\r\n+                SelectTargetNode[选择目标节点]\r\n+                ExecuteSkillNode[执行技能节点]\r\n+                ConsumeResourceNode[消耗资源节点]\r\n+                UpdateStateNode[更新状态节点]\r\n+            end\r\n+            \r\n+            subgraph VisualNodes[\"可视化节点组<br/>Visual Nodes\"]\r\n+                PlayMoveVisualNode[播放移动表现节点]\r\n+                PlaySkillVisualNode[播放技能表现节点]\r\n+                PlayTargetVisualNode[播放目标表现节点]\r\n+            end\r\n+        end\r\n+        \r\n+        FlowConfig[流程配置<br/>NodeFlowConfig]\r\n+        ContextManager[上下文管理器<br/>ContextManager]\r\n+        \r\n+        subgraph CommunicationBus[\"通讯总线\"]\r\n+            EventChannel[事件通道<br/>EventChannel]\r\n+            MessageChannel[消息通道<br/>MessageChannel]\r\n+            PushChannel[推送通道<br/>PushChannel]\r\n+            QueryChannel[查询通道<br/>QueryChannel]\r\n+        end\r\n+        \r\n+        subgraph DataModules[\"数据模块\"]\r\n+            UnitDataModule[单位数据模块<br/>UnitData]\r\n+            SkillDomainModule[技能领域模块<br/>SkillDomain]\r\n+            TerrainDomainModule[地形领域模块<br/>TerrainDomain]\r\n+            GridSystemModule[网格系统模块<br/>GridSystem]\r\n+        end\r\n+    end\r\n+    \r\n+    NodeOrchestrator -->|管理节点| NodeRegistry\r\n+    NodeOrchestrator -->|读取配置| FlowConfig\r\n+    NodeOrchestrator -->|执行节点| InputNodes\r\n+    NodeOrchestrator -->|执行节点| ConditionNodes\r\n+    NodeOrchestrator -->|执行节点| ExecutionNodes\r\n+    NodeOrchestrator -->|执行节点| VisualNodes\r\n+    NodeOrchestrator -->|管理Context| ContextManager\r\n+    \r\n+    InputNodes -->|发布事件| EventChannel\r\n+    ConditionNodes -->|发布事件| EventChannel\r\n+    ConditionNodes -->|查询数据| QueryChannel\r\n+    ExecutionNodes -->|订阅事件| EventChannel\r\n+    ExecutionNodes -->|1对1通讯| MessageChannel\r\n+    ExecutionNodes -->|查询数据| QueryChannel\r\n+    ExecutionNodes -->|接收数据| PushChannel\r\n+    VisualNodes -->|订阅事件| EventChannel\r\n+    VisualNodes -->|接收数据| PushChannel\r\n+    \r\n+    QueryChannel -->|查询| UnitDataModule\r\n+    QueryChannel -->|查询| SkillDomainModule\r\n+    QueryChannel -->|查询| TerrainDomainModule\r\n+    QueryChannel -->|查询| GridSystemModule\r\n+    \r\n+    PushChannel -->|推送数据| UnitDataModule\r\n+    SkillDomainModule -->|推送数据| PushChannel\r\n+    TerrainDomainModule -->|推送数据| PushChannel\r\n+    \r\n+    style NodeOrchestrator fill:#c8e6c9\r\n+    style NodeRegistry fill:#e1f5ff\r\n+    style InputNodes fill:#ffebee\r\n+    style ConditionNodes fill:#fff4e1\r\n+    style ExecutionNodes fill:#c8e6c9\r\n+    style VisualNodes fill:#f3e5f5\r\n+    style CommunicationBus fill:#fff4e1\r\n+```\r\n+\r\n+### 节点编排器职责\r\n+\r\n+1. **节点注册管理**\r\n+   - 管理节点注册表（NodeRegistry）\r\n+   - 支持动态注册/注销节点\r\n+   - 提供节点查找接口（按ID、按类型）\r\n+\r\n+2. **流程编排**\r\n+   - 根据FlowConfig动态组织节点执行顺序\r\n+   - 处理节点间的跳转、条件分支、循环\r\n+   - 管理节点执行状态和生命周期\r\n+\r\n+3. **Context管理**\r\n+   - 在节点间传递UnitContext\r\n+   - 管理Context的生命周期\r\n+   - 处理Context状态恢复\r\n+\r\n+4. **错误处理**\r\n+   - 处理节点执行失败\r\n+   - 资源回滚和状态恢复\r\n+   - 错误通知和日志记录\r\n+\r\n+### 节点分类详细设计\r\n+\r\n+#### 输入节点（Input Node）\r\n+\r\n+**职责**：接收玩家输入，不修改数据，只负责输入数据的收集和传递\r\n+\r\n+**节点列表**：\r\n+1. **ReceiveMoveInputNode**：接收玩家点击的网格坐标\r\n+2. **ReceiveSkillSelectNode**：接收玩家选择的技能ID\r\n+3. **ReceiveTargetSelectNode**：接收玩家选择的目标（单位、位置等）\r\n+\r\n+**节点接口**：\r\n+- `Execute(context) -> result`：接收输入，返回输入数据和有效性\r\n+- `WaitForInput(context) -> input`：等待玩家输入（异步）\r\n+- `ValidateInput(input) -> bool`：验证输入有效性\r\n+\r\n+#### 条件节点（Condition Node）\r\n+\r\n+**职责**：验证、检查、判断，不修改数据，返回判断结果和流程控制建议\r\n+\r\n+**节点列表**：\r\n+1. **CheckMovePointNode**：检查单位是否有足够的移动点数\r\n+2. **CheckActionPointNode**：检查单位是否有足够的行动点数\r\n+3. **ValidateMoveNode**：验证移动输入是否合法（位置、路径、范围等）\r\n+4. **ValidateSkillNode**：验证技能是否可释放\r\n+5. **ValidateTargetNode**：验证目标是否合法（距离、状态、条件等）\r\n+6. **CheckResourceNode**：检查单位是否还有资源继续行动\r\n+\r\n+**返回结果结构**：\r\n+```lua\r\n+{\r\n+    success: true/false,           -- 判断结果\r\n+    data: {...},                   -- 判断数据（可选）\r\n+    nextAction: \"continue\"/\"end\"/\"skip\", -- 流程控制建议（可选）\r\n+    loopState: \"ACTION\"/\"END\"      -- 循环状态建议（可选）\r\n+}\r\n+```\r\n+\r\n+#### 执行节点（Execution Node）\r\n+\r\n+**职责**：实际执行操作，修改数据，返回执行结果\r\n+\r\n+**节点列表**：\r\n+1. **InitUnitNode**：初始化单位行动状态，重置行动点数和移动点数\r\n+2. **MoveNode**：执行移动并更新单位位置，消耗移动点数\r\n+3. **SelectSkillNode**：显示可用的技能列表，准备技能释放上下文\r\n+4. **SelectTargetNode**：根据技能类型显示可选目标，更新技能上下文中的目标信息\r\n+5. **ExecuteSkillNode**：调用技能领域执行技能，处理技能执行结果\r\n+6. **ConsumeResourceNode**：消耗行动点数和资源，记录资源消耗信息\r\n+7. **UpdateStateNode**：批量处理所有状态变更数据，更新单位状态\r\n+\r\n+**节点接口**：\r\n+- `Execute(context) -> result`：执行操作\r\n+- `CanExecute(context) -> bool`：检查是否可以执行\r\n+- `Rollback(context)`：回滚操作（失败时）\r\n+\r\n+#### 可视化节点（Visual Node）\r\n+\r\n+**职责**：播放表现，不修改数据，只负责视觉反馈\r\n+\r\n+**节点列表**：\r\n+1. **PlayMoveVisualNode**：通知VisualSystem播放移动表现\r\n+2. **PlaySkillVisualNode**：通知VisualSystem播放技能释放表现\r\n+3. **PlayTargetVisualNode**：通知VisualSystem播放受攻击单位表现\r\n+\r\n+**节点接口**：\r\n+- `Execute(context) -> result`：播放表现\r\n+- `WaitForComplete(context) -> bool`：等待表现完成（可选）\r\n+\r\n+### 节点编排流程示例\r\n+\r\n+```mermaid\r\n+flowchart TD\r\n+    Start[开始] --> Init[InitUnitNode<br/>初始化单位]\r\n+    \r\n+    Init --> CheckMove{CheckMovePointNode<br/>检查移动点数}\r\n+    CheckMove -->|有移动点数| ReceiveMove[ReceiveMoveInputNode<br/>接收移动输入]\r\n+    CheckMove -->|无移动点数| SelectSkill\r\n+    \r\n+    ReceiveMove --> ValidateMove{ValidateMoveNode<br/>验证移动}\r\n+    ValidateMove -->|验证通过| Move[MoveNode<br/>执行移动]\r\n+    ValidateMove -->|验证失败| ReceiveMove\r\n+    \r\n+    Move --> PlayMove[PlayMoveVisualNode<br/>播放移动表现]\r\n+    PlayMove --> SelectSkill[SelectSkillNode<br/>选择技能]\r\n+    \r\n+    SelectSkill --> ReceiveSkill[ReceiveSkillSelectNode<br/>接收技能选择]\r\n+    ReceiveSkill --> ValidateSkill{ValidateSkillNode<br/>验证技能}\r\n+    ValidateSkill -->|验证通过| SelectTarget[SelectTargetNode<br/>选择目标]\r\n+    ValidateSkill -->|验证失败| SelectSkill\r\n+    \r\n+    SelectTarget --> ReceiveTarget[ReceiveTargetSelectNode<br/>接收目标选择]\r\n+    ReceiveTarget --> ValidateTarget{ValidateTargetNode<br/>验证目标}\r\n+    ValidateTarget -->|验证通过| Consume[ConsumeResourceNode<br/>消耗资源]\r\n+    ValidateTarget -->|验证失败| SelectTarget\r\n+    \r\n+    Consume --> Execute[ExecuteSkillNode<br/>执行技能]\r\n+    Execute --> Update[UpdateStateNode<br/>更新状态]\r\n+    Update --> PlaySkill[PlaySkillVisualNode<br/>播放技能表现]\r\n+    PlaySkill --> PlayTarget[PlayTargetVisualNode<br/>播放目标表现]\r\n+    \r\n+    PlayTarget --> CheckResource{CheckResourceNode<br/>检查资源}\r\n+    CheckResource -->|还有资源| CheckMove\r\n+    CheckResource -->|无资源| End[结束]\r\n+    \r\n+    style Init fill:#c8e6c9\r\n+    style CheckMove fill:#fff4e1\r\n+    style ReceiveMove fill:#ffebee\r\n+    style ValidateMove fill:#fff4e1\r\n+    style Move fill:#c8e6c9\r\n+    style PlayMove fill:#f3e5f5\r\n+    style SelectSkill fill:#c8e6c9\r\n+    style ReceiveSkill fill:#ffebee\r\n+    style ValidateSkill fill:#fff4e1\r\n+    style SelectTarget fill:#c8e6c9\r\n+    style ReceiveTarget fill:#ffebee\r\n+    style ValidateTarget fill:#fff4e1\r\n+    style Consume fill:#c8e6c9\r\n+    style Execute fill:#c8e6c9\r\n+    style Update fill:#c8e6c9\r\n+    style PlaySkill fill:#f3e5f5\r\n+    style PlayTarget fill:#f3e5f5\r\n+    style CheckResource fill:#fff4e1\r\n+    style End fill:#ffebee\r\n+```\r\n+### 节点实现细节\r\n+\r\n+#### UnitContext逐步增强过程\r\n+\r\n+单位行动流程的核心是UnitContext的维护和管理，Context在节点间流转并逐步增强：\r\n+\r\n+```\r\n+UnitContext（节点1：单位循环开始）\r\n+  + unitData（单位数据）\r\n+  + roundContext（回合上下文）\r\n+  ↓\r\n+  + currentUnit（当前行动单位）\r\n+  + unitValidation（单位验证结果）\r\n+  ↓\r\n+  + moveInput（移动输入：点击坐标）\r\n+  + moveValidation（移动验证结果）\r\n+  + movePath（移动路径）\r\n+  + moveResult（移动结果）\r\n+  ↓\r\n+  + selectedSkill（选中的技能）\r\n+  + skillValidation（技能验证结果）\r\n+  + skillContext（技能上下文）\r\n+  ↓\r\n+  + selectedTargets（选中的目标）\r\n+  + targetValidation（目标验证结果）\r\n+  ↓\r\n+  + skillExecutionResult（技能执行结果）\r\n+  + resourceConsumption（资源消耗信息）\r\n+  ↓\r\n+  + visualResult（表现播放结果）\r\n+  + effectResults（效果处理结果）\r\n+  + resourceCheck（资源检查结果）\r\n+  + loopState（循环状态）\r\n+  ↓\r\n+UnitContext（节点7：执行施法后处理）\r\n+```\r\n+\r\n+#### 节点内部架构设计原则\r\n+\r\n+**管道过滤器模式**：\r\n+- 单Context设计：所有节点使用统一的`UnitContext`\r\n+- 逐步增强：每个节点在Context中添加自己的数据\r\n+- 数据流循环：节点1 → 节点2 → ... → 节点7 → 节点3（循环）\r\n+\r\n+**节点内部组件设计**：\r\n+- **输入接收器**：接收外部输入，验证输入有效性\r\n+- **验证器组**：负责各种验证（范围、路径、资源等）\r\n+- **执行器**：负责实际执行操作\r\n+- **数据更新器**：负责更新数据\r\n+- **表现通知器**：负责通知表现层\r\n+- **上下文增强器**：负责增强Context并传递给下一个节点\r\n+- **循环推动器**：负责推动循环状态转换\r\n+\r\n+#### 错误处理和恢复机制\r\n+\r\n+**错误类型**：\r\n+1. **资源错误**：资源不足、资源被消耗等\r\n+2. **验证错误**：验证失败、状态不合法等\r\n+3. **执行错误**：执行失败、异常等\r\n+4. **系统错误**：系统异常、外部系统错误等\r\n+\r\n+**错误处理流程**：\r\n+1. **资源回滚**：执行失败时，回滚已消耗的资源\r\n+2. **状态恢复**：从Context恢复节点执行前的状态\r\n+3. **错误通知**：通知用户错误信息，提供重试或取消选项\r\n+4. **日志记录**：记录错误信息到Context，便于调试和问题追踪\r\n+\r\n+**节点状态机**：\r\n+- **IDLE**：节点未开始执行\r\n+- **EXECUTING**：节点正在执行\r\n+- **COMPLETED**：节点执行完成\r\n+- **FAILED**：节点执行失败\r\n+\r\n+---\r\n+\r\n+## 外部系统集成\r\n+\r\n+### SkillDomain（技能领域）集成\r\n+\r\n+**集成方式**：\r\n+- **调用方式**：ActionCoordinator调用SkillDomain执行技能\r\n+- **数据推送**：SkillDomain的EffectHandler通过DataHandleQueue推送效果数据\r\n+- **数据查询**：节点通过QueryChannel查询技能状态\r\n+\r\n+### TerrainDomain（地形领域）集成\r\n+\r\n+**集成方式**：\r\n+- **调用方式**：ActionCoordinator调用TerrainDomain处理地形要素\r\n+- **数据推送**：TerrainDomain的EffectHandler通过DataHandleQueue推送效果数据\r\n+- **共享Handler机制**：与SkillDomain共享Handler接口，但保持独立系统\r\n+\r\n+### GridSystem（网格系统）集成\r\n+\r\n+**集成方式**：\r\n+- **调用方式**：ActionCoordinator调用GridSystem进行移动计算\r\n+- **数据查询**：节点通过QueryChannel查询移动范围、路径信息\r\n+\r\n+### VisualSystem（表现系统）集成\r\n+\r\n+**集成方式**：\r\n+- **通知方式**：ActionCoordinator通知VisualSystem播放表现\r\n+- **事件订阅**：可视化节点订阅EventChannel接收表现事件\r\n+\r\n+\r\n+### 设计原则总结\r\n+\r\n+- ✅ **Domain controls Loop**：Domain控制循环，循环是Domain的工具\r\n+- ✅ **数据驱动架构**：战斗特性通过配置数据实现，无需额外机制\r\n+- ✅ **节点编排模式**：单位行动流程通过节点编排器动态组织\r\n+- ✅ **解耦设计**：节点间通过CommunicationBus和Context通信，不直接依赖\r\n+- ✅ **多层循环架构**：战斗→回合→单位三层循环架构\r\n+- ✅ **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n+- ✅ **统一数据访问**：节点通过CommunicationBus统一获取数据\r\n+\r\n+---\r\n+\r\n+## 总结\r\n+\r\n+### 架构设计价值\r\n+\r\n+该架构设计文档的价值在于：\r\n+- ✅ **思路解构**：完整解构回合制战斗系统的搭建思路\r\n+- ✅ **流程验证**：从架构层面验证流程合理性\r\n+- ✅ **问题识别**：提前识别潜在的资源和状态问题\r\n+- ✅ **开发指导**：为后续详细设计和实现提供清晰指导\r\n+\r\n+### 架构特点\r\n+\r\n+- ✅ **多层循环架构**：战斗→回合→单位三层循环架构\r\n+- ✅ **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n+- ✅ **统一数据访问**：节点通过CommunicationBus统一获取数据\r\n+- ✅ **错误处理防护**：资源回滚 + 状态恢复 + 错误通知，避免状态不一致\r\n+- ✅ **数据驱动**：所有特性通过配置数据实现，无需修改代码\r\n+\r\n+细节实现是后续开发阶段的工作，当前架构设计已足够指导整个回合制战斗系统的开发。\r\n"
                },
                {
                    "date": 1767184888267,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -459,9 +459,9 @@\n \r\n     起点 --> EffectHandler[**EffectHandler**<br>数据处理器] -.-> PushChannel[**PushChannel**<br>推送处理数据] -.-> 数据模块\r\n     QueryChannel[**QueryChannel**<br>查询数据] -.-> 起点\r\n     数据模块 -.-> QueryChannel\r\n-    起点 -.-> QueryChannel\r\n+    起点 =.=> QueryChannel\r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n \r\n     style 起点 fill:#e1f5ff\r\n@@ -1025,1035 +1025,4 @@\n - ✅ **错误处理防护**：资源回滚 + 状态恢复 + 错误通知，避免状态不一致\r\n - ✅ **数据驱动**：所有特性通过配置数据实现，无需修改代码\r\n \r\n 细节实现是后续开发阶段的工作，当前架构设计已足够指导整个回合制战斗系统的开发。\r\n-# 战斗系统架构设计文档\r\n-\r\n-## 目录\r\n-\r\n-1. [概述](#概述)\r\n-2. [整体架构](#整体架构)\r\n-3. [战斗领域](#战斗领域)\r\n-4. [回合领域](#回合领域)\r\n-5. [单位领域](#单位领域)\r\n-6. [核心机制](#核心机制)\r\n-7. [数据结构](#数据结构)\r\n-8. [外部系统集成](#外部系统集成)\r\n-9. [实现指南](#实现指南)\r\n-\r\n----\r\n-\r\n-## 概述\r\n-\r\n-### 设计目标\r\n-\r\n-设计一套完整的回合制战斗系统架构，支持DND规则、回合管理、状态机控制、AI决策，实现战斗流程管理、伤害计算、效果应用，提供数据驱动的配置化战斗系统。\r\n-\r\n-### 核心设计理念\r\n-\r\n-#### 1. 多层循环架构为核心\r\n-\r\n-**本质**：战斗系统的核心是多层循环的维护和管理（当前实现为三层）\r\n-\r\n-- **战斗循环**：管理整个战斗的生命周期\r\n-- **回合循环**：管理回合的循环和切换\r\n-- **单位循环**：管理单个单位的行动流程\r\n-- **循环驱动**：所有战斗逻辑都在循环框架内执行\r\n-- **状态维护**：每层循环维护自己的状态，驱动下层循环\r\n-\r\n-#### 2. 数据驱动架构\r\n-\r\n-**本质**：战斗特性通过配置数据实现，无需修改代码\r\n-\r\n-- 战斗规则、伤害计算、效果应用 → 通过配置数据定义\r\n-- 回合流程、状态转换 → 通过配置数据调整\r\n-- 新增战斗机制 → 扩展配置数据即可\r\n-- 战斗平衡 → 调整配置数值即可\r\n-\r\n-#### 3. 分层架构（循环内的功能组织）\r\n-\r\n-**本质**：分层架构是循环内的功能组织方式，不是主要架构\r\n-\r\n-- 功能组织：输入层、决策层、执行层、表现层、管理层\r\n-- 执行位置：所有分层功能都在单位循环内执行\r\n-- 解耦设计：层间通过Context和CommunicationBus通信\r\n-\r\n-#### 4. Domain controls Loop\r\n-\r\n-**核心原则**：Domain控制循环，循环是Domain的工具\r\n-\r\n-- Domain是领域核心，拥有循环机制来推进业务流程\r\n-- Domain管理通过协调器控制循环状态转换\r\n-- 协调器执行完业务后，主动推动循环进入下一个状态\r\n-\r\n----\r\n-\r\n-## 整体架构\r\n-\r\n-### 多层循环架构\r\n-\r\n-**核心观点**：整个回合制战斗系统的核心是维护多层循环，所有战斗逻辑都在循环框架内执行。\r\n-\r\n-#### Domain与循环的关系\r\n-\r\n-**术语说明**：使用\"Domain\"而非\"Entity\"，避免与项目中的\"Unit\"概念混淆。\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    subgraph BattleDomain[\"战斗Domain<br/>Battle Domain\"]\r\n-        BattleManagement[战斗管理<br/>结算奖励/同步任务]\r\n-        BattleLoop[\"战斗循环<br/>BattleLoop\"]\r\n-        BattleManagement -->|控制| BattleLoop\r\n-        BattleLoop -->|推进| BattleManagement\r\n-        \r\n-        subgraph RoundDomain[\"回合Domain<br/>Round Domain\"]\r\n-            RoundManagement[回合管理<br/>行动值排序/单位行动顺序]\r\n-            RoundLoop[\"回合循环<br/>RoundLoop\"]\r\n-            RoundManagement -->|控制| RoundLoop\r\n-            RoundLoop -->|推进| RoundManagement\r\n-            \r\n-            subgraph UnitDomain[\"单位Domain<br/>Unit Domain\"]\r\n-                UnitManagement[单位管理<br/>移动/施法/选择技能对象]\r\n-                UnitLoop[\"单位循环<br/>UnitLoop\"]\r\n-                UnitManagement -->|控制| UnitLoop\r\n-                UnitLoop -->|推进| UnitManagement\r\n-            end\r\n-        end\r\n-    end\r\n-    \r\n-    style BattleDomain fill:#ffebee\r\n-    style RoundDomain fill:#fff4e1\r\n-    style UnitDomain fill:#e1f5ff\r\n-    style BattleLoop fill:#f3e5f5\r\n-    style RoundLoop fill:#f3e5f5\r\n-    style UnitLoop fill:#f3e5f5\r\n-```\r\n-\r\n-**备注**：\r\n-- **三层架构**：当前实现为三层架构（战斗→回合→单位），符合DND规则中所有单位按先攻值统一排序的设计\r\n-- **阵营循环**：在标准DND规则中，所有单位按先攻值（Initiative）统一排序行动，不存在阵营循环。此处保留作为扩展设计，便于后续支持阵营差异行为\r\n-\r\n-#### Domain协作关系\r\n-\r\n-**核心观点**：Domain之间通过协作推进业务流程，父Domain调用子Domain，子Domain完成业务后返回父Domain。\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    BattleDomain[战斗Domain<br/>Battle Domain]\r\n-    RoundDomain[回合Domain<br/>Round Domain]\r\n-    UnitDomain[单位Domain<br/>Unit Domain]\r\n-    \r\n-    BattleDomain -->|1. 调用| RoundDomain\r\n-    RoundDomain -->|2. 返回| BattleDomain\r\n-    RoundDomain -->|3. 调用| UnitDomain\r\n-    UnitDomain -->|4. 返回| RoundDomain\r\n-    \r\n-    BattleDomain -.->|包含| RoundDomain\r\n-    RoundDomain -.->|包含| UnitDomain\r\n-    \r\n-    style BattleDomain fill:#ffebee\r\n-    style RoundDomain fill:#fff4e1\r\n-    style UnitDomain fill:#e1f5ff\r\n-```\r\n-\r\n-**协作流程说明**：\r\n-1. **战斗Domain** → 调用 **回合Domain**：战斗进行中，需要执行回合\r\n-2. **回合Domain** → 调用 **单位Domain**：回合进行中，需要处理单位行动\r\n-3. **单位Domain** → 返回 **回合Domain**：单位行动完成\r\n-4. **回合Domain** → 返回 **战斗Domain**：回合完成\r\n-\r\n-**协作原则**：\r\n-- 父Domain控制子Domain的调用时机\r\n-- 子Domain完成业务后主动返回父Domain\r\n-- 每个Domain独立管理自己的业务逻辑和循环\r\n-\r\n-### 循环职责说明\r\n-\r\n-#### 1. 战斗循环（BattleLoop）\r\n-- **职责**：管理整个战斗的生命周期\r\n-- **状态**：PREPARING → IN_PROGRESS → ENDED\r\n-- **维护**：BattleLoopManager\r\n-\r\n-#### 2. 回合循环（RoundLoop）\r\n-- **职责**：管理回合的循环和切换\r\n-- **状态**：START → ACTION → END\r\n-- **维护**：RoundLoopManager\r\n-\r\n-#### 3. 单位循环（UnitLoop）\r\n-- **职责**：管理单个单位的行动流程\r\n-- **状态**：START → ACTION → END\r\n-- **维护**：UnitLoopManager\r\n-\r\n----\r\n-\r\n-## 战斗领域\r\n-\r\n-### 核心职责\r\n-\r\n-战斗领域负责管理整个战斗的生命周期，包括战斗初始化、战斗流程控制、战斗结束判断、奖励结算、任务同步等。\r\n-\r\n-### 架构结构\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    subgraph BattleDomain[\"战斗Domain<br/>Battle Domain\"]\r\n-        BattleManagement[战斗管理<br/>BattleManagement]\r\n-        BattleLoop[战斗循环<br/>BattleLoop<br/>PREPARING → IN_PROGRESS → ENDED]\r\n-        RoundCoordinator[回合协调器<br/>RoundCoordinator<br/>微核心：只负责协调调用]\r\n-        \r\n-        subgraph BattleManagement[\"战斗管理<br/>BattleManagement\"]\r\n-            BattleData[战斗数据<br/>BattleData]\r\n-            DataMgr[战斗数据管理<br/>战斗状态/回合历史/活跃阵营]\r\n-            RuleMgr[战斗规则管理<br/>战斗开始/结束条件/胜利条件/失败条件]\r\n-            RewardMgr[奖励管理<br/>奖励结算/任务同步]\r\n-        end\r\n-    end\r\n-    \r\n-    subgraph ExternalSystems[\"外部系统\"]\r\n-        RoundDomain[回合领域<br/>Round Domain]\r\n-        RewardSystem[奖励系统<br/>Reward System]\r\n-        TaskSystem[任务系统<br/>Task System]\r\n-    end\r\n-    \r\n-    BattleManagement -->|控制| BattleLoop\r\n-    BattleManagement --> RoundCoordinator\r\n-    RoundCoordinator -->|反向推动| BattleLoop\r\n-    BattleLoop -->|推进| BattleManagement\r\n-    \r\n-    RoundCoordinator -->|调用| RoundDomain\r\n-    RoundDomain -->|返回| RoundCoordinator\r\n-    \r\n-    BattleManagement -->|结算奖励| RewardSystem\r\n-    BattleManagement -->|同步任务| TaskSystem\r\n-    \r\n-    style BattleDomain fill:#ffebee\r\n-    style BattleManagement fill:#ffebee\r\n-    style BattleLoop fill:#f3e5f5\r\n-    style RoundCoordinator fill:#c8e6c9\r\n-```\r\n-\r\n-### 战斗管理（BattleManagement）\r\n-\r\n-#### 1. 战斗数据管理\r\n-- **战斗状态**：当前战斗状态（PREPARING/IN_PROGRESS/ENDED）\r\n-- **回合历史**：记录已完成的回合历史（`roundHistoryQueue`）\r\n-- **活跃阵营列表**：当前战斗中活跃的阵营ID列表（`activeFactionIDs`）\r\n-- **突袭回合阵营列表**：被突袭的阵营ID列表（`surpriseRoundFactionIDs`）\r\n-\r\n-#### 2. 战斗规则管理\r\n-- **战斗开始条件**：检查是否可以开始战斗\r\n-- **战斗结束条件**：检查是否应该结束战斗\r\n-- **胜利条件**：检查是否满足胜利条件（`CheckVictoryCondition`）\r\n-- **失败条件**：检查是否满足失败条件（`CheckDefeatCondition`）\r\n-\r\n-#### 3. 奖励管理\r\n-- **奖励结算**：战斗结束后结算奖励\r\n-- **任务同步**：同步战斗相关的任务进度\r\n-\r\n-### 战斗循环（BattleLoop）\r\n-\r\n-**循环状态**：PREPARING → IN_PROGRESS → ENDED\r\n-\r\n-- **PREPARING**：战斗准备中，初始化战斗数据\r\n-- **IN_PROGRESS**：战斗进行中，执行回合（调用回合领域）\r\n-- **ENDED**：战斗已结束，结算奖励、同步任务\r\n-\r\n-### 回合协调器（RoundCoordinator）\r\n-\r\n-**核心原则**：只负责协调调用，不包含业务规则\r\n-\r\n-**核心职责**：\r\n-- ✅ **协调调用**：调用回合领域执行回合\r\n-- ✅ **反向推动循环**：回合完成后，主动推动战斗循环进入下一个状态（Domain controls Loop）\r\n-\r\n-### 战斗完整流程\r\n-\r\n-```mermaid\r\n-flowchart TD\r\n-    LoopPreparing[LoopPreparing<br/>战斗准备] --> InitBattle[初始化战斗数据<br/>战斗管理初始化]\r\n-    \r\n-    InitBattle --> LoopProgress[LoopProgress<br/>战斗进行中]\r\n-    \r\n-    LoopProgress --> CallRound[调用回合领域<br/>回合协调器调用回合领域]\r\n-    \r\n-    CallRound --> RoundAction[回合领域执行回合<br/>回合领域完成回合]\r\n-    \r\n-    RoundAction --> PushProgress[回合协调器推动循环<br/>推动到IN_PROGRESS状态继续]\r\n-    \r\n-    PushProgress --> CheckEnd{检查战斗结束条件<br/>战斗管理检查}\r\n-    \r\n-    CheckEnd -->|未结束| CallRound\r\n-    CheckEnd -->|已结束| PushEnd[回合协调器推动循环<br/>推动到ENDED状态]\r\n-    \r\n-    PushEnd --> LoopEnd[LoopEnd<br/>战斗结束]\r\n-    \r\n-    LoopEnd --> Reward[结算奖励<br/>奖励管理结算奖励]\r\n-    Reward --> Task[同步任务<br/>任务管理同步任务]\r\n-    Task --> Complete[战斗完成]\r\n-    \r\n-    style LoopPreparing fill:#ffebee\r\n-    style LoopProgress fill:#ffebee\r\n-    style CallRound fill:#c8e6c9\r\n-    style RoundAction fill:#c8e6c9\r\n-    style PushProgress fill:#f3e5f5\r\n-    style PushEnd fill:#f3e5f5\r\n-    style LoopEnd fill:#ffebee\r\n-    style CheckEnd fill:#ffe0b2\r\n-```\r\n-\r\n----\r\n-\r\n-## 回合领域\r\n-\r\n-### 核心职责\r\n-\r\n-回合领域负责管理回合的循环和切换，包括回合数管理、行动顺序管理（基于先攻值）、回合开始/结束控制等。\r\n-\r\n-### 架构结构\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    subgraph RoundDomain[\"回合Domain<br/>Round Domain\"]\r\n-        RoundManagement[回合管理<br/>RoundManagement]\r\n-        RoundLoop[回合循环<br/>RoundLoop<br/>START → ACTION → END]\r\n-        UnitCoordinator[单位协调器<br/>UnitCoordinator<br/>微核心：只负责协调调用]\r\n-        \r\n-        subgraph RoundManagement[\"回合管理<br/>RoundManagement\"]\r\n-            RoundData[回合数据<br/>RoundData]\r\n-            DataMgr[回合数据管理<br/>回合数/行动顺序队列]\r\n-            RuleMgr[回合规则管理<br/>回合开始/结束条件]\r\n-            OrderMgr[行动顺序管理<br/>队列初始化/管理/获取下一个单位]\r\n-        end\r\n-        \r\n-        subgraph UnitCoordinator[\"单位协调器<br/>UnitCoordinator<br/>微核心：只负责协调调用\"]\r\n-            UnitCall[单位调用<br/>从回合管理获取单位<br/>调用单位领域]\r\n-        end\r\n-    end\r\n-    \r\n-    subgraph ExternalSystems[\"外部系统\"]\r\n-        BattleDomain[战斗领域<br/>Battle Domain]\r\n-        UnitDomain[单位领域<br/>Unit Domain]\r\n-    end\r\n-    \r\n-    BattleDomain -->|控制| RoundDomain\r\n-    RoundManagement -->|控制| RoundLoop\r\n-    RoundManagement --> UnitCoordinator\r\n-    UnitCoordinator -->|反向推动| RoundLoop\r\n-    RoundLoop -->|推进| RoundManagement\r\n-    \r\n-    UnitCoordinator -->|调用| UnitDomain\r\n-    UnitDomain -->|返回| UnitCoordinator\r\n-    \r\n-    style RoundDomain fill:#fff4e1\r\n-    style RoundManagement fill:#fff4e1\r\n-    style RoundLoop fill:#f3e5f5\r\n-    style UnitCoordinator fill:#c8e6c9\r\n-    style RoundData fill:#e1f5ff\r\n-```\r\n-\r\n-### 回合管理（RoundManagement）\r\n-\r\n-#### 1. 回合数据管理\r\n-- **回合数**：当前回合数、总回合数\r\n-- **行动顺序队列**：基于先攻值的优先级队列（TurnQueue）\r\n-- **当前行动单位**：当前正在行动的单位\r\n-- **活跃阵营列表**：当前回合中活跃的阵营ID列表\r\n-\r\n-#### 2. 回合规则管理\r\n-- **回合开始条件**：检查是否可以开始新回合\r\n-- **回合结束条件**：检查是否应该结束当前回合（所有单位行动完成）\r\n-- **回合切换规则**：判断是否还有下一个回合\r\n-- **突袭回合规则**：战斗开始时，只有被突袭的阵营才能行动（Surprise Round）\r\n-- **单位存活检查**：只有存活的单位才能参与回合（`unit:IsAlive()`）\r\n-- **活跃阵营过滤**：只有活跃的阵营才能参与回合（`activeFactionIDs`）\r\n-\r\n-#### 3. 行动顺序管理\r\n-- **初始化队列**：回合开始时，根据先攻值初始化行动顺序队列\r\n-  - **突袭回合处理**：战斗开始时，只有被突袭的阵营单位加入队列\r\n-  - **正常回合处理**：正常回合中，所有活跃阵营的存活单位加入队列\r\n-- **队列管理**：管理行动顺序队列的添加、移除、清空\r\n-- **获取下一个单位**：从行动顺序队列中获取下一个行动单位（自动过滤死亡单位）\r\n-- **下一个单位检查**：检查是否还有下一个行动单位\r\n-- **延迟行动管理**：管理延迟行动的单位列表，在适当时候插入到行动顺序中\r\n-\r\n-### 回合循环（RoundLoop）\r\n-\r\n-**循环状态**：START → ACTION → END\r\n-\r\n-- **START**：回合开始，初始化行动顺序队列\r\n-  - **突袭回合**：只有被突袭的阵营单位加入队列\r\n-  - **正常回合**：所有活跃阵营的存活单位加入队列\r\n-- **ACTION**：执行回合行动（调用单位领域）\r\n-- **END**：回合结束，清理回合数据，处理延迟行动\r\n-\r\n-### 单位协调器（UnitCoordinator）\r\n-\r\n-**核心原则**：只负责协调调用，不包含业务规则\r\n-\r\n-**核心职责**：\r\n-- ✅ **协调调用**：从回合管理获取下一个单位，调用单位领域执行单位行动\r\n-- ✅ **反向推动循环**：单位行动完成后，主动推动回合循环进入下一个状态（Domain controls Loop）\r\n-\r\n-#### 循环推动机制\r\n-- **推动到END**：所有单位行动完成后，推动循环从ACTION状态进入END状态\r\n-- **推动到START**：回合结束时，推动循环从END状态进入START状态（下一个回合）\r\n-- **推动到ACTION**：回合开始时，推动循环从START状态进入ACTION状态\r\n-\r\n-### 回合完整流程\r\n-\r\n-```mermaid\r\n-flowchart TD\r\n-    LoopStart[LoopStart<br/>战斗领域推动循环] --> InitQueue[初始化行动顺序队列<br/>回合管理根据先攻值排序]\r\n-    \r\n-    InitQueue --> LoopAction[LoopAction<br/>执行回合行动]\r\n-    \r\n-    LoopAction --> GetNextUnit{获取下一个单位<br/>回合管理从队列获取}\r\n-    \r\n-    GetNextUnit -->|有单位| CallUnit[调用单位领域<br/>单位协调器调用单位领域]\r\n-    GetNextUnit -->|无单位| PushEnd\r\n-    \r\n-    CallUnit --> UnitAction[单位领域执行行动<br/>单位领域完成行动]\r\n-    \r\n-    UnitAction --> PushAction[单位协调器推动循环<br/>推动到ACTION状态继续]\r\n-    \r\n-    PushAction --> GetNextUnit\r\n-    \r\n-    PushEnd[单位协调器推动循环<br/>推动到END状态]\r\n-    \r\n-    PushEnd --> RoundEnd[LoopEnd<br/>回合结束]\r\n-    \r\n-    RoundEnd --> CheckNextRound{检查下一个回合<br/>回合管理检查是否还有下一个回合}\r\n-    \r\n-    CheckNextRound -->|有下一个回合| PushStart[单位协调器推动循环<br/>推动到START状态]\r\n-    CheckNextRound -->|无下一个回合| EndRound[结束回合循环<br/>返回战斗领域]\r\n-    \r\n-    PushStart --> LoopStart\r\n-    \r\n-    style LoopStart fill:#fff4e1\r\n-    style LoopAction fill:#fff4e1\r\n-    style CallUnit fill:#c8e6c9\r\n-    style UnitAction fill:#c8e6c9\r\n-    style PushAction fill:#f3e5f5\r\n-    style PushEnd fill:#f3e5f5\r\n-    style PushStart fill:#f3e5f5\r\n-    style LoopEnd fill:#fff4e1\r\n-    style GetNextUnit fill:#ffe0b2\r\n-    style CheckNextRound fill:#ffe0b2\r\n-```\r\n-\r\n-**关键点**：\r\n-- ✅ **Domain controls Loop**：回合管理通过单位协调器控制循环状态转换\r\n-- ✅ **反向推动机制**：单位协调器执行完单位行动后，主动推动循环进入下一个状态\r\n-- ✅ **单位协调器不处理业务规则**：只负责协调调用单位领域，不处理回合业务逻辑\r\n-- ✅ **行动顺序管理**：回合管理负责基于先攻值的优先级队列，确保单位按正确顺序行动\r\n-- ✅ **队列驱动**：通过行动顺序队列驱动单位行动，队列为空时回合结束\r\n-\r\n-### 职责划分\r\n-\r\n-| 组件 | 职责 | 说明 |\r\n-|------|------|------|\r\n-| **回合管理** | 回合数据与规则 | 管理回合数、行动顺序队列、回合开始/结束规则、队列管理 |\r\n-| **单位协调器** | 协调调用 | 从回合管理获取单位，调用单位领域，不处理回合业务规则 |\r\n-| **回合循环** | 流程控制 | START/ACTION/END状态转换，由回合管理控制 |\r\n-\r\n----\r\n-\r\n-## 单位领域\r\n-\r\n-### 核心职责\r\n-\r\n-单位领域是战斗系统的核心，负责管理单个单位的行动流程，包括移动、技能释放、数值控制等。\r\n-\r\n-\r\n-### 数值查询及推送 (CommunicationBus)\r\n-\r\n-**核心机制**：节点、领域、数据模块、外部系统通过CommunicationBus的**PushChannel**和**QueryChannel**进行通讯，实现数据推送和查询的双向数据流。\r\n-\r\n-**关键组件**：\r\n-- **EffectHandler**：数据类型处理器，负责处理整合数据，并通过PushChannel推送数据到生效的数据模块\r\n-- **PushChannel**：推送处理后的数据到数据模块（推送流程）\r\n-- **QueryChannel**：从数据模块查询数据并返回给起点（查询流程）\r\n-\r\n-**数据流说明**：\r\n-- **实线箭头（→）**：直接的数据流/处理流（同步处理）\r\n-- **虚线箭头（-.->）**：异步消息/查询流（异步查询和反馈）\r\n-- \r\n-**工作流程**：\r\n-1. **推送流程**：起点（节点/领域/外部系统）→ EffectHandler处理数据 → PushChannel推送 → 数据模块存储\r\n-2. **查询流程**：起点发起查询 → QueryChannel查询 → 数据模块返回数据 → QueryChannel返回结果 → 起点接收\r\n-```mermaid\r\n-graph LR\r\n-    subgraph 起点[\"起点\"]\r\n-        节点\r\n-        领域\r\n-        外部系统\r\n-    end\r\n-\r\n-    起点 --> EffectHandler[**EffectHandler**<br>数据处理器] -.-> PushChannel[**PushChannel**<br>推送处理数据] -.-> 数据模块\r\n-    QueryChannel[**QueryChannel**<br>查询数据] -.-> 起点\r\n-    数据模块 -.-> QueryChannel\r\n-    起点 -.-> QueryChannel\r\n-    style PushChannel fill:#c8e6c9\r\n-    style QueryChannel fill:#c8e6c9\r\n-\r\n-    style 起点 fill:#e1f5ff\r\n-```\r\n-\r\n-### 架构结构\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    subgraph UnitDomain[\"单位Domain<br/>Unit Domain\"]\r\n-        UnitManagement[单位管理<br/>UnitManagement]\r\n-        UnitLoop[单位循环<br/>UnitLoop<br/>START → ACTION → END]\r\n-        ActionCoordinator[行动协调器<br/>ActionCoordinator<br/>微核心：只负责协调调用]\r\n-        \r\n-        subgraph UnitManagement[\"单位管理<br/>UnitManagement\"]\r\n-            UnitData[单位数据<br/>UnitData]\r\n-            DataMgr[单位数据管理<br/>属性/状态/位置/回合数据<br/>AP/MP/先攻值]\r\n-            RuleMgr[单位规则管理<br/>行动点数规则/移动点数规则<br/>先攻值规则/回合初始化规则]\r\n-        end\r\n-        \r\n-        subgraph DataHandleQueue[\"DataHandleQueue<br/>数据队列<br/>1:1关系\"]\r\n-        end\r\n-        \r\n-        subgraph ActionCoordinator[\"行动协调器<br/>ActionCoordinator<br/>微核心：只负责协调调用\"]\r\n-            MoveCoord[移动协调<br/>调用网格系统]\r\n-            SkillCoord[技能协调<br/>调用技能领域]\r\n-            TerrainCoord[地形交互协调<br/>调用地形领域<br/>可选]\r\n-            VisualCoord[表现协调<br/>通知表现层]\r\n-        end\r\n-    end\r\n-    \r\n-    subgraph ExternalSystems[\"外部系统\"]\r\n-        GridSystem[网格系统<br/>GridSystem]\r\n-        SkillDomain[技能领域<br/>Skill Domain]\r\n-        VisualSystem[表现系统<br/>Visual System]\r\n-        TerrainDomain[地形领域<br/>Terrain Domain]\r\n-    end\r\n-    \r\n-    UnitManagement -->|控制| UnitLoop\r\n-    UnitManagement --> ActionCoordinator\r\n-    UnitManagement --> UnitData\r\n-    ActionCoordinator -->|反向推动| UnitLoop\r\n-    UnitLoop -->|推进| UnitManagement\r\n-    \r\n-    ActionCoordinator -->|调用| GridSystem\r\n-    ActionCoordinator -->|调用| SkillDomain\r\n-    ActionCoordinator -->|调用| TerrainDomain\r\n-    ActionCoordinator -->|通知| VisualSystem\r\n-    \r\n-    SkillDomain -->|EffectHandler推送| DataHandleQueue\r\n-    TerrainDomain -->|EffectHandler推送| DataHandleQueue\r\n-\r\n-    DataHandleQueue -->|推送数据| UnitData\r\n-    \r\n-    style UnitDomain fill:#e1f5ff\r\n-    style UnitManagement fill:#fff4e1\r\n-    style UnitLoop fill:#f3e5f5\r\n-    style ActionCoordinator fill:#c8e6c9\r\n-    style DataHandleQueue fill:#f3e5f5\r\n-    style UnitData fill:#e1f5ff\r\n-```\r\n-\r\n-### 单位管理（UnitManagement）\r\n-\r\n-#### 1. 单位数据管理\r\n-- **单位属性**：生命值、行动点数（AP）、移动点数（MP）、先攻值等\r\n-- **单位状态**：是否可行动、是否已移动、是否已攻击、是否存活等\r\n-- **单位位置**：当前网格位置\r\n-- **回合数据**：UnitTurnData管理行动点数、移动点数、先攻值等回合相关数据\r\n-\r\n-#### 2. 单位规则管理\r\n-- **移动点数规则**：移动前检查能否移动\r\n-- **行动点数规则**：检查行动是否可执行（`CheckAction`），消耗行动点数和移动点数（`ConsumeAction`）\r\n-- **行动规则**：是否可执行行动（移动、攻击、技能等）\r\n-- **状态规则**：状态转换规则（是否存活、是否可行动等）\r\n-- **先攻值规则**：管理单位的先攻值，用于回合顺序排序\r\n-- **回合初始化规则**：回合开始时初始化行动点数和移动点数（`StartUnitTurn`）\r\n-\r\n-#### 3. UnitData与DataHandleQueue关系\r\n-- **1:1关系**：DataHandleQueue 与 UnitData 是 1:1 关系，数据直接修改 UnitData\r\n-- **直接修改**：技能领域的EffectHandler推送数据到DataHandleQueue后，直接修改UnitData\r\n-- **无需中间层**：不需要\"数值控制管理\"中间层，DataHandleQueue直接修改UnitData\r\n-\r\n-### 单位循环（UnitLoop）\r\n-\r\n-**循环状态**：START → ACTION → END\r\n-\r\n-- **START**：单位开始行动\r\n-- **ACTION**：执行行动（移动、技能等）\r\n-- **END**：单位结束行动\r\n-\r\n-### 行动协调器（ActionCoordinator）\r\n-\r\n-**核心原则**：只负责协调调用，不包含业务规则\r\n-\r\n-**核心职责**：\r\n-- ✅ **协调调用**：调用网格系统、技能领域、表现系统\r\n-- ✅ **反向推动循环**：执行完行动后，主动推动单位循环进入下一个状态（Domain controls Loop）\r\n-\r\n-#### 1. 移动协调\r\n-- **移动前检查**：调用单位管理检查移动点数和行动点数\r\n-- **调用网格系统**：进行移动计算（路径查找、移动范围等）\r\n-- **移动后更新**：通过 DataHandleQueue 更新单位位置和移动点数\r\n-- **推动循环**：移动完成后，推动循环进入下一个状态\r\n-\r\n-#### 2. 技能协调\r\n-- **行动点数检查**：调用单位管理检查行动点数是否足够\r\n-- **调用技能领域**：执行技能\r\n-- **不处理数值控制**：数值控制由技能领域的EffectHandler通过DataHandleQueue处理\r\n-- **接收技能结果**：获取技能执行结果（成功/失败），用于流程控制\r\n-- **推动循环**：技能执行完成后，推动循环进入下一个状态\r\n-\r\n-#### 3. 地形交互协调（可选）\r\n-- **地形交互检查**：检查单位是否触发地形要素（陷阱、门等）\r\n-- **调用地形领域**：如果触发地形要素，调用地形领域处理\r\n-- **推动循环**：地形交互完成后，推动循环进入下一个状态\r\n-\r\n-#### 4. 表现协调\r\n-- **通知表现层**：移动表现、技能表现、受攻击表现\r\n-- **推动循环**：表现播放完成后（可选），推动循环进入下一个状态\r\n-\r\n-### 单位行动完整流程\r\n-\r\n-```mermaid\r\n-flowchart TD\r\n-    LoopStart[LoopStart<br/>单位管理推动循环] --> LoopAction[LoopAction<br/>执行行动]\r\n-    \r\n-    LoopAction --> CheckAction{行动前检查<br/>单位管理检查行动点数/移动点数}\r\n-    \r\n-    CheckAction -->|可以移动| Move[单位移动<br/>行动协调器调用网格系统]\r\n-    CheckAction -->|不能移动| Skill\r\n-    \r\n-    Move --> UpdateMove[更新移动点数<br/>DataHandleQueue推送]\r\n-    UpdateMove --> Skill[攻击/治疗<br/>行动协调器调用技能领域]\r\n-    \r\n-    Skill --> EffectPush[EffectHandler推送效果<br/>通过DataHandleQueue到目标单位]\r\n-    EffectPush --> Visual[可视化<br/>行动协调器通知表现层]\r\n-    \r\n-    Visual --> PushEnd[行动协调器推动循环<br/>推动到END状态]\r\n-    \r\n-    PushEnd --> CheckActionPoint{行动点数检查<br/>单位管理检查是否还有行动点数/移动点数}\r\n-    \r\n-    CheckActionPoint -->|还有行动点数/移动点数| PushAction[行动协调器推动循环<br/>推动回ACTION状态]\r\n-    CheckActionPoint -->|无行动点数/移动点数| LoopEnd[LoopEnd<br/>单位结束行动]\r\n-    \r\n-    PushAction --> LoopAction\r\n-    \r\n-    style LoopStart fill:#e1f5ff\r\n-    style LoopAction fill:#e1f5ff\r\n-    style Move fill:#fff4e1\r\n-    style Skill fill:#c8e6c9\r\n-    style EffectPush fill:#fff4e1\r\n-    style Visual fill:#c8e6c9\r\n-    style PushEnd fill:#f3e5f5\r\n-    style PushAction fill:#f3e5f5\r\n-    style LoopEnd fill:#e1f5ff\r\n-    style CheckAction fill:#ffe0b2\r\n-    style CheckActionPoint fill:#ffe0b2\r\n-```\r\n-\r\n-\r\n-\r\n----\r\n-\r\n-## 单位领域：节点编排架构\r\n-\r\n-### 核心设计理念\r\n-\r\n-#### 1. 节点编排器为核心\r\n-\r\n-**本质**：单位行动流程的核心是节点编排器的动态组织和管理\r\n-\r\n-- 单位行动流程 = 节点编排器根据配置动态组织节点执行\r\n-- 节点编排 = 条件节点 → 执行节点 → 可视化节点的组合\r\n-- 流程控制 = 节点编排器根据节点执行结果决定下一个节点\r\n-- 灵活扩展 = 新增节点类型只需注册到编排器\r\n-\r\n-#### 2. 节点分类设计\r\n-\r\n-**本质**：节点按功能职责分为四类，每类节点职责单一、可复用\r\n-\r\n-- **输入节点（Input Node）**：负责接收玩家输入（如：接收移动点击、接收技能选择、接收目标选择等）\r\n-- **条件节点（Condition Node）**：负责验证、检查、判断，返回判断结果和流程控制建议（如：检查移动点数、验证技能可释放、检查资源决定是否继续等）\r\n-- **执行节点（Execution Node）**：负责实际执行操作，修改数据（如：执行移动、执行技能、消耗资源、更新状态等）\r\n-- **可视化节点（Visual Node）**：负责表现播放（如：播放移动表现、播放技能表现等）\r\n-\r\n-\r\n-\r\n-### 节点编排器架构\r\n-\r\n-```mermaid\r\n-graph TB\r\n-    subgraph UnitDomain[\"单位Domain\"]\r\n-        NodeOrchestrator[节点编排器<br/>NodeOrchestrator]\r\n-        \r\n-        subgraph NodeRegistry[\"节点注册表<br/>NodeRegistry\"]\r\n-            subgraph InputNodes[\"输入节点组<br/>Input Nodes\"]\r\n-                ReceiveMoveInputNode[接收移动输入节点]\r\n-                ReceiveSkillSelectNode[接收技能选择节点]\r\n-                ReceiveTargetSelectNode[接收目标选择节点]\r\n-            end\r\n-            \r\n-            subgraph ConditionNodes[\"条件节点组<br/>Condition Nodes\"]\r\n-                CheckMovePointNode[检查移动点数节点]\r\n-                CheckActionPointNode[检查行动点数节点]\r\n-                ValidateSkillNode[验证技能节点]\r\n-                ValidateTargetNode[验证目标节点]\r\n-                ValidateMoveNode[验证移动节点]\r\n-                CheckResourceNode[检查资源节点]\r\n-            end\r\n-            \r\n-            subgraph ExecutionNodes[\"执行节点组<br/>Execution Nodes\"]\r\n-                InitUnitNode[初始化单位节点]\r\n-                MoveNode[移动节点]\r\n-                SelectSkillNode[选择技能节点]\r\n-                SelectTargetNode[选择目标节点]\r\n-                ExecuteSkillNode[执行技能节点]\r\n-                ConsumeResourceNode[消耗资源节点]\r\n-                UpdateStateNode[更新状态节点]\r\n-            end\r\n-            \r\n-            subgraph VisualNodes[\"可视化节点组<br/>Visual Nodes\"]\r\n-                PlayMoveVisualNode[播放移动表现节点]\r\n-                PlaySkillVisualNode[播放技能表现节点]\r\n-                PlayTargetVisualNode[播放目标表现节点]\r\n-            end\r\n-        end\r\n-        \r\n-        FlowConfig[流程配置<br/>NodeFlowConfig]\r\n-        ContextManager[上下文管理器<br/>ContextManager]\r\n-        \r\n-        subgraph CommunicationBus[\"通讯总线\"]\r\n-            EventChannel[事件通道<br/>EventChannel]\r\n-            MessageChannel[消息通道<br/>MessageChannel]\r\n-            PushChannel[推送通道<br/>PushChannel]\r\n-            QueryChannel[查询通道<br/>QueryChannel]\r\n-        end\r\n-        \r\n-        subgraph DataModules[\"数据模块\"]\r\n-            UnitDataModule[单位数据模块<br/>UnitData]\r\n-            SkillDomainModule[技能领域模块<br/>SkillDomain]\r\n-            TerrainDomainModule[地形领域模块<br/>TerrainDomain]\r\n-            GridSystemModule[网格系统模块<br/>GridSystem]\r\n-        end\r\n-    end\r\n-    \r\n-    NodeOrchestrator -->|管理节点| NodeRegistry\r\n-    NodeOrchestrator -->|读取配置| FlowConfig\r\n-    NodeOrchestrator -->|执行节点| InputNodes\r\n-    NodeOrchestrator -->|执行节点| ConditionNodes\r\n-    NodeOrchestrator -->|执行节点| ExecutionNodes\r\n-    NodeOrchestrator -->|执行节点| VisualNodes\r\n-    NodeOrchestrator -->|管理Context| ContextManager\r\n-    \r\n-    InputNodes -->|发布事件| EventChannel\r\n-    ConditionNodes -->|发布事件| EventChannel\r\n-    ConditionNodes -->|查询数据| QueryChannel\r\n-    ExecutionNodes -->|订阅事件| EventChannel\r\n-    ExecutionNodes -->|1对1通讯| MessageChannel\r\n-    ExecutionNodes -->|查询数据| QueryChannel\r\n-    ExecutionNodes -->|接收数据| PushChannel\r\n-    VisualNodes -->|订阅事件| EventChannel\r\n-    VisualNodes -->|接收数据| PushChannel\r\n-    \r\n-    QueryChannel -->|查询| UnitDataModule\r\n-    QueryChannel -->|查询| SkillDomainModule\r\n-    QueryChannel -->|查询| TerrainDomainModule\r\n-    QueryChannel -->|查询| GridSystemModule\r\n-    \r\n-    PushChannel -->|推送数据| UnitDataModule\r\n-    SkillDomainModule -->|推送数据| PushChannel\r\n-    TerrainDomainModule -->|推送数据| PushChannel\r\n-    \r\n-    style NodeOrchestrator fill:#c8e6c9\r\n-    style NodeRegistry fill:#e1f5ff\r\n-    style InputNodes fill:#ffebee\r\n-    style ConditionNodes fill:#fff4e1\r\n-    style ExecutionNodes fill:#c8e6c9\r\n-    style VisualNodes fill:#f3e5f5\r\n-    style CommunicationBus fill:#fff4e1\r\n-```\r\n-\r\n-### 节点编排器职责\r\n-\r\n-1. **节点注册管理**\r\n-   - 管理节点注册表（NodeRegistry）\r\n-   - 支持动态注册/注销节点\r\n-   - 提供节点查找接口（按ID、按类型）\r\n-\r\n-2. **流程编排**\r\n-   - 根据FlowConfig动态组织节点执行顺序\r\n-   - 处理节点间的跳转、条件分支、循环\r\n-   - 管理节点执行状态和生命周期\r\n-\r\n-3. **Context管理**\r\n-   - 在节点间传递UnitContext\r\n-   - 管理Context的生命周期\r\n-   - 处理Context状态恢复\r\n-\r\n-4. **错误处理**\r\n-   - 处理节点执行失败\r\n-   - 资源回滚和状态恢复\r\n-   - 错误通知和日志记录\r\n-\r\n-### 节点分类详细设计\r\n-\r\n-#### 输入节点（Input Node）\r\n-\r\n-**职责**：接收玩家输入，不修改数据，只负责输入数据的收集和传递\r\n-\r\n-**节点列表**：\r\n-1. **ReceiveMoveInputNode**：接收玩家点击的网格坐标\r\n-2. **ReceiveSkillSelectNode**：接收玩家选择的技能ID\r\n-3. **ReceiveTargetSelectNode**：接收玩家选择的目标（单位、位置等）\r\n-\r\n-**节点接口**：\r\n-- `Execute(context) -> result`：接收输入，返回输入数据和有效性\r\n-- `WaitForInput(context) -> input`：等待玩家输入（异步）\r\n-- `ValidateInput(input) -> bool`：验证输入有效性\r\n-\r\n-#### 条件节点（Condition Node）\r\n-\r\n-**职责**：验证、检查、判断，不修改数据，返回判断结果和流程控制建议\r\n-\r\n-**节点列表**：\r\n-1. **CheckMovePointNode**：检查单位是否有足够的移动点数\r\n-2. **CheckActionPointNode**：检查单位是否有足够的行动点数\r\n-3. **ValidateMoveNode**：验证移动输入是否合法（位置、路径、范围等）\r\n-4. **ValidateSkillNode**：验证技能是否可释放\r\n-5. **ValidateTargetNode**：验证目标是否合法（距离、状态、条件等）\r\n-6. **CheckResourceNode**：检查单位是否还有资源继续行动\r\n-\r\n-**返回结果结构**：\r\n-```lua\r\n-{\r\n-    success: true/false,           -- 判断结果\r\n-    data: {...},                   -- 判断数据（可选）\r\n-    nextAction: \"continue\"/\"end\"/\"skip\", -- 流程控制建议（可选）\r\n-    loopState: \"ACTION\"/\"END\"      -- 循环状态建议（可选）\r\n-}\r\n-```\r\n-\r\n-#### 执行节点（Execution Node）\r\n-\r\n-**职责**：实际执行操作，修改数据，返回执行结果\r\n-\r\n-**节点列表**：\r\n-1. **InitUnitNode**：初始化单位行动状态，重置行动点数和移动点数\r\n-2. **MoveNode**：执行移动并更新单位位置，消耗移动点数\r\n-3. **SelectSkillNode**：显示可用的技能列表，准备技能释放上下文\r\n-4. **SelectTargetNode**：根据技能类型显示可选目标，更新技能上下文中的目标信息\r\n-5. **ExecuteSkillNode**：调用技能领域执行技能，处理技能执行结果\r\n-6. **ConsumeResourceNode**：消耗行动点数和资源，记录资源消耗信息\r\n-7. **UpdateStateNode**：批量处理所有状态变更数据，更新单位状态\r\n-\r\n-**节点接口**：\r\n-- `Execute(context) -> result`：执行操作\r\n-- `CanExecute(context) -> bool`：检查是否可以执行\r\n-- `Rollback(context)`：回滚操作（失败时）\r\n-\r\n-#### 可视化节点（Visual Node）\r\n-\r\n-**职责**：播放表现，不修改数据，只负责视觉反馈\r\n-\r\n-**节点列表**：\r\n-1. **PlayMoveVisualNode**：通知VisualSystem播放移动表现\r\n-2. **PlaySkillVisualNode**：通知VisualSystem播放技能释放表现\r\n-3. **PlayTargetVisualNode**：通知VisualSystem播放受攻击单位表现\r\n-\r\n-**节点接口**：\r\n-- `Execute(context) -> result`：播放表现\r\n-- `WaitForComplete(context) -> bool`：等待表现完成（可选）\r\n-\r\n-### 节点编排流程示例\r\n-\r\n-```mermaid\r\n-flowchart TD\r\n-    Start[开始] --> Init[InitUnitNode<br/>初始化单位]\r\n-    \r\n-    Init --> CheckMove{CheckMovePointNode<br/>检查移动点数}\r\n-    CheckMove -->|有移动点数| ReceiveMove[ReceiveMoveInputNode<br/>接收移动输入]\r\n-    CheckMove -->|无移动点数| SelectSkill\r\n-    \r\n-    ReceiveMove --> ValidateMove{ValidateMoveNode<br/>验证移动}\r\n-    ValidateMove -->|验证通过| Move[MoveNode<br/>执行移动]\r\n-    ValidateMove -->|验证失败| ReceiveMove\r\n-    \r\n-    Move --> PlayMove[PlayMoveVisualNode<br/>播放移动表现]\r\n-    PlayMove --> SelectSkill[SelectSkillNode<br/>选择技能]\r\n-    \r\n-    SelectSkill --> ReceiveSkill[ReceiveSkillSelectNode<br/>接收技能选择]\r\n-    ReceiveSkill --> ValidateSkill{ValidateSkillNode<br/>验证技能}\r\n-    ValidateSkill -->|验证通过| SelectTarget[SelectTargetNode<br/>选择目标]\r\n-    ValidateSkill -->|验证失败| SelectSkill\r\n-    \r\n-    SelectTarget --> ReceiveTarget[ReceiveTargetSelectNode<br/>接收目标选择]\r\n-    ReceiveTarget --> ValidateTarget{ValidateTargetNode<br/>验证目标}\r\n-    ValidateTarget -->|验证通过| Consume[ConsumeResourceNode<br/>消耗资源]\r\n-    ValidateTarget -->|验证失败| SelectTarget\r\n-    \r\n-    Consume --> Execute[ExecuteSkillNode<br/>执行技能]\r\n-    Execute --> Update[UpdateStateNode<br/>更新状态]\r\n-    Update --> PlaySkill[PlaySkillVisualNode<br/>播放技能表现]\r\n-    PlaySkill --> PlayTarget[PlayTargetVisualNode<br/>播放目标表现]\r\n-    \r\n-    PlayTarget --> CheckResource{CheckResourceNode<br/>检查资源}\r\n-    CheckResource -->|还有资源| CheckMove\r\n-    CheckResource -->|无资源| End[结束]\r\n-    \r\n-    style Init fill:#c8e6c9\r\n-    style CheckMove fill:#fff4e1\r\n-    style ReceiveMove fill:#ffebee\r\n-    style ValidateMove fill:#fff4e1\r\n-    style Move fill:#c8e6c9\r\n-    style PlayMove fill:#f3e5f5\r\n-    style SelectSkill fill:#c8e6c9\r\n-    style ReceiveSkill fill:#ffebee\r\n-    style ValidateSkill fill:#fff4e1\r\n-    style SelectTarget fill:#c8e6c9\r\n-    style ReceiveTarget fill:#ffebee\r\n-    style ValidateTarget fill:#fff4e1\r\n-    style Consume fill:#c8e6c9\r\n-    style Execute fill:#c8e6c9\r\n-    style Update fill:#c8e6c9\r\n-    style PlaySkill fill:#f3e5f5\r\n-    style PlayTarget fill:#f3e5f5\r\n-    style CheckResource fill:#fff4e1\r\n-    style End fill:#ffebee\r\n-```\r\n-### 节点实现细节\r\n-\r\n-#### UnitContext逐步增强过程\r\n-\r\n-单位行动流程的核心是UnitContext的维护和管理，Context在节点间流转并逐步增强：\r\n-\r\n-```\r\n-UnitContext（节点1：单位循环开始）\r\n-  + unitData（单位数据）\r\n-  + roundContext（回合上下文）\r\n-  ↓\r\n-  + currentUnit（当前行动单位）\r\n-  + unitValidation（单位验证结果）\r\n-  ↓\r\n-  + moveInput（移动输入：点击坐标）\r\n-  + moveValidation（移动验证结果）\r\n-  + movePath（移动路径）\r\n-  + moveResult（移动结果）\r\n-  ↓\r\n-  + selectedSkill（选中的技能）\r\n-  + skillValidation（技能验证结果）\r\n-  + skillContext（技能上下文）\r\n-  ↓\r\n-  + selectedTargets（选中的目标）\r\n-  + targetValidation（目标验证结果）\r\n-  ↓\r\n-  + skillExecutionResult（技能执行结果）\r\n-  + resourceConsumption（资源消耗信息）\r\n-  ↓\r\n-  + visualResult（表现播放结果）\r\n-  + effectResults（效果处理结果）\r\n-  + resourceCheck（资源检查结果）\r\n-  + loopState（循环状态）\r\n-  ↓\r\n-UnitContext（节点7：执行施法后处理）\r\n-```\r\n-\r\n-#### 节点内部架构设计原则\r\n-\r\n-**管道过滤器模式**：\r\n-- 单Context设计：所有节点使用统一的`UnitContext`\r\n-- 逐步增强：每个节点在Context中添加自己的数据\r\n-- 数据流循环：节点1 → 节点2 → ... → 节点7 → 节点3（循环）\r\n-\r\n-**节点内部组件设计**：\r\n-- **输入接收器**：接收外部输入，验证输入有效性\r\n-- **验证器组**：负责各种验证（范围、路径、资源等）\r\n-- **执行器**：负责实际执行操作\r\n-- **数据更新器**：负责更新数据\r\n-- **表现通知器**：负责通知表现层\r\n-- **上下文增强器**：负责增强Context并传递给下一个节点\r\n-- **循环推动器**：负责推动循环状态转换\r\n-\r\n-#### 错误处理和恢复机制\r\n-\r\n-**错误类型**：\r\n-1. **资源错误**：资源不足、资源被消耗等\r\n-2. **验证错误**：验证失败、状态不合法等\r\n-3. **执行错误**：执行失败、异常等\r\n-4. **系统错误**：系统异常、外部系统错误等\r\n-\r\n-**错误处理流程**：\r\n-1. **资源回滚**：执行失败时，回滚已消耗的资源\r\n-2. **状态恢复**：从Context恢复节点执行前的状态\r\n-3. **错误通知**：通知用户错误信息，提供重试或取消选项\r\n-4. **日志记录**：记录错误信息到Context，便于调试和问题追踪\r\n-\r\n-**节点状态机**：\r\n-- **IDLE**：节点未开始执行\r\n-- **EXECUTING**：节点正在执行\r\n-- **COMPLETED**：节点执行完成\r\n-- **FAILED**：节点执行失败\r\n-\r\n----\r\n-\r\n-## 外部系统集成\r\n-\r\n-### SkillDomain（技能领域）集成\r\n-\r\n-**集成方式**：\r\n-- **调用方式**：ActionCoordinator调用SkillDomain执行技能\r\n-- **数据推送**：SkillDomain的EffectHandler通过DataHandleQueue推送效果数据\r\n-- **数据查询**：节点通过QueryChannel查询技能状态\r\n-\r\n-### TerrainDomain（地形领域）集成\r\n-\r\n-**集成方式**：\r\n-- **调用方式**：ActionCoordinator调用TerrainDomain处理地形要素\r\n-- **数据推送**：TerrainDomain的EffectHandler通过DataHandleQueue推送效果数据\r\n-- **共享Handler机制**：与SkillDomain共享Handler接口，但保持独立系统\r\n-\r\n-### GridSystem（网格系统）集成\r\n-\r\n-**集成方式**：\r\n-- **调用方式**：ActionCoordinator调用GridSystem进行移动计算\r\n-- **数据查询**：节点通过QueryChannel查询移动范围、路径信息\r\n-\r\n-### VisualSystem（表现系统）集成\r\n-\r\n-**集成方式**：\r\n-- **通知方式**：ActionCoordinator通知VisualSystem播放表现\r\n-- **事件订阅**：可视化节点订阅EventChannel接收表现事件\r\n-\r\n-\r\n-### 设计原则总结\r\n-\r\n-- ✅ **Domain controls Loop**：Domain控制循环，循环是Domain的工具\r\n-- ✅ **数据驱动架构**：战斗特性通过配置数据实现，无需额外机制\r\n-- ✅ **节点编排模式**：单位行动流程通过节点编排器动态组织\r\n-- ✅ **解耦设计**：节点间通过CommunicationBus和Context通信，不直接依赖\r\n-- ✅ **多层循环架构**：战斗→回合→单位三层循环架构\r\n-- ✅ **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n-- ✅ **统一数据访问**：节点通过CommunicationBus统一获取数据\r\n-\r\n----\r\n-\r\n-## 总结\r\n-\r\n-### 架构设计价值\r\n-\r\n-该架构设计文档的价值在于：\r\n-- ✅ **思路解构**：完整解构回合制战斗系统的搭建思路\r\n-- ✅ **流程验证**：从架构层面验证流程合理性\r\n-- ✅ **问题识别**：提前识别潜在的资源和状态问题\r\n-- ✅ **开发指导**：为后续详细设计和实现提供清晰指导\r\n-\r\n-### 架构特点\r\n-\r\n-- ✅ **多层循环架构**：战斗→回合→单位三层循环架构\r\n-- ✅ **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n-- ✅ **统一数据访问**：节点通过CommunicationBus统一获取数据\r\n-- ✅ **错误处理防护**：资源回滚 + 状态恢复 + 错误通知，避免状态不一致\r\n-- ✅ **数据驱动**：所有特性通过配置数据实现，无需修改代码\r\n-\r\n-细节实现是后续开发阶段的工作，当前架构设计已足够指导整个回合制战斗系统的开发。\r\n"
                },
                {
                    "date": 1767184894920,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -459,9 +459,9 @@\n \r\n     起点 --> EffectHandler[**EffectHandler**<br>数据处理器] -.-> PushChannel[**PushChannel**<br>推送处理数据] -.-> 数据模块\r\n     QueryChannel[**QueryChannel**<br>查询数据] -.-> 起点\r\n     数据模块 -.-> QueryChannel\r\n-    起点 =.=> QueryChannel\r\n+    起点 <-.-> QueryChannel\r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n \r\n     style 起点 fill:#e1f5ff\r\n"
                },
                {
                    "date": 1767184924114,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -457,9 +457,9 @@\n         外部系统\r\n     end\r\n \r\n     起点 --> EffectHandler[**EffectHandler**<br>数据处理器] -.-> PushChannel[**PushChannel**<br>推送处理数据] -.-> 数据模块\r\n-    QueryChannel[**QueryChannel**<br>查询数据] -.-> 起点\r\n+    QueryChannel[**QueryChannel**<br>查询数据]\r\n     数据模块 -.-> QueryChannel\r\n     起点 <-.-> QueryChannel\r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n"
                },
                {
                    "date": 1767184934078,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -456,10 +456,12 @@\n         领域\r\n         外部系统\r\n     end\r\n \r\n+    QueryChannel[**QueryChannel**<br>查询数据]\r\n+\r\n     起点 --> EffectHandler[**EffectHandler**<br>数据处理器] -.-> PushChannel[**PushChannel**<br>推送处理数据] -.-> 数据模块\r\n-    QueryChannel[**QueryChannel**<br>查询数据]\r\n+    \r\n     数据模块 -.-> QueryChannel\r\n     起点 <-.-> QueryChannel\r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n"
                },
                {
                    "date": 1767184996395,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -446,9 +446,9 @@\n - **QueryChannel**：从数据模块查询数据并返回给起点（查询流程）\r\n \r\n \r\n **工作流程**：\r\n-1. **推送流程**：起点（节点/领域/外部系统）→ EffectHandler处理数据 → PushChannel推送 → 数据模块存储\r\n+1. **推送流程**：起点（节点/领域/外部系统）→ EffectHandler处理数据 → PushChannel推送 → 数据模块更新新数据\r\n 2. **查询流程**：起点发起查询 → QueryChannel查询 → 数据模块返回数据 → QueryChannel返回结果 → 起点接收\r\n ```mermaid\r\n graph LR\r\n     subgraph 起点[\"起点\"]\r\n@@ -464,9 +464,8 @@\n     数据模块 -.-> QueryChannel\r\n     起点 <-.-> QueryChannel\r\n     style PushChannel fill:#c8e6c9\r\n     style QueryChannel fill:#c8e6c9\r\n-\r\n     style 起点 fill:#e1f5ff\r\n ```\r\n \r\n ### 架构结构\r\n"
                },
                {
                    "date": 1767185007784,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -446,9 +446,9 @@\n - **QueryChannel**：从数据模块查询数据并返回给起点（查询流程）\r\n \r\n \r\n **工作流程**：\r\n-1. **推送流程**：起点（节点/领域/外部系统）→ EffectHandler处理数据 → PushChannel推送 → 数据模块更新新数据\r\n+1. **推送流程**：起点（节点/领域/外部系统）→ EffectHandler处理数据 → PushChannel推送 → 数据模块处理数据\r\n 2. **查询流程**：起点发起查询 → QueryChannel查询 → 数据模块返回数据 → QueryChannel返回结果 → 起点接收\r\n ```mermaid\r\n graph LR\r\n     subgraph 起点[\"起点\"]\r\n"
                }
            ],
            "date": 1767182075703,
            "name": "Commit-0",
            "content": "# 战斗系统架构设计文档\r\n\r\n## 目录\r\n\r\n1. [概述](#概述)\r\n2. [整体架构](#整体架构)\r\n3. [战斗领域](#战斗领域)\r\n4. [回合领域](#回合领域)\r\n5. [单位领域](#单位领域)\r\n6. [核心机制](#核心机制)\r\n7. [数据结构](#数据结构)\r\n8. [外部系统集成](#外部系统集成)\r\n9. [实现指南](#实现指南)\r\n\r\n---\r\n\r\n## 概述\r\n\r\n### 设计目标\r\n\r\n设计一套完整的回合制战斗系统架构，支持DND规则、回合管理、状态机控制、AI决策，实现战斗流程管理、伤害计算、效果应用，提供数据驱动的配置化战斗系统。\r\n\r\n### 核心设计理念\r\n\r\n#### 1. 多层循环架构为核心\r\n\r\n**本质**：战斗系统的核心是多层循环的维护和管理（当前实现为三层）\r\n\r\n- **战斗循环**：管理整个战斗的生命周期\r\n- **回合循环**：管理回合的循环和切换\r\n- **单位循环**：管理单个单位的行动流程\r\n- **循环驱动**：所有战斗逻辑都在循环框架内执行\r\n- **状态维护**：每层循环维护自己的状态，驱动下层循环\r\n\r\n#### 2. 数据驱动架构\r\n\r\n**本质**：战斗特性通过配置数据实现，无需修改代码\r\n\r\n- 战斗规则、伤害计算、效果应用 → 通过配置数据定义\r\n- 回合流程、状态转换 → 通过配置数据调整\r\n- 新增战斗机制 → 扩展配置数据即可\r\n- 战斗平衡 → 调整配置数值即可\r\n\r\n#### 3. 分层架构（循环内的功能组织）\r\n\r\n**本质**：分层架构是循环内的功能组织方式，不是主要架构\r\n\r\n- 功能组织：输入层、决策层、执行层、表现层、管理层\r\n- 执行位置：所有分层功能都在单位循环内执行\r\n- 解耦设计：层间通过Context和CommunicationBus通信\r\n\r\n#### 4. Domain controls Loop\r\n\r\n**核心原则**：Domain控制循环，循环是Domain的工具\r\n\r\n- Domain是领域核心，拥有循环机制来推进业务流程\r\n- Domain管理通过协调器控制循环状态转换\r\n- 协调器执行完业务后，主动推动循环进入下一个状态\r\n\r\n---\r\n\r\n## 整体架构\r\n\r\n### 多层循环架构\r\n\r\n**核心观点**：整个回合制战斗系统的核心是维护多层循环，所有战斗逻辑都在循环框架内执行。\r\n\r\n#### Domain与循环的关系\r\n\r\n**术语说明**：使用\"Domain\"而非\"Entity\"，避免与项目中的\"Unit\"概念混淆。\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph BattleDomain[\"战斗Domain<br/>Battle Domain\"]\r\n        BattleManagement[战斗管理<br/>结算奖励/同步任务]\r\n        BattleLoop[\"战斗循环<br/>BattleLoop\"]\r\n        BattleManagement -->|控制| BattleLoop\r\n        BattleLoop -->|推进| BattleManagement\r\n        \r\n        subgraph RoundDomain[\"回合Domain<br/>Round Domain\"]\r\n            RoundManagement[回合管理<br/>行动值排序/单位行动顺序]\r\n            RoundLoop[\"回合循环<br/>RoundLoop\"]\r\n            RoundManagement -->|控制| RoundLoop\r\n            RoundLoop -->|推进| RoundManagement\r\n            \r\n            subgraph UnitDomain[\"单位Domain<br/>Unit Domain\"]\r\n                UnitManagement[单位管理<br/>移动/施法/选择技能对象]\r\n                UnitLoop[\"单位循环<br/>UnitLoop\"]\r\n                UnitManagement -->|控制| UnitLoop\r\n                UnitLoop -->|推进| UnitManagement\r\n            end\r\n        end\r\n    end\r\n    \r\n    style BattleDomain fill:#ffebee\r\n    style RoundDomain fill:#fff4e1\r\n    style UnitDomain fill:#e1f5ff\r\n    style BattleLoop fill:#f3e5f5\r\n    style RoundLoop fill:#f3e5f5\r\n    style UnitLoop fill:#f3e5f5\r\n```\r\n\r\n**备注**：\r\n- **三层架构**：当前实现为三层架构（战斗→回合→单位），符合DND规则中所有单位按先攻值统一排序的设计\r\n- **阵营循环**：在标准DND规则中，所有单位按先攻值（Initiative）统一排序行动，不存在阵营循环。此处保留作为扩展设计，便于后续支持阵营差异行为\r\n\r\n#### Domain协作关系\r\n\r\n**核心观点**：Domain之间通过协作推进业务流程，父Domain调用子Domain，子Domain完成业务后返回父Domain。\r\n\r\n```mermaid\r\ngraph TB\r\n    BattleDomain[战斗Domain<br/>Battle Domain]\r\n    RoundDomain[回合Domain<br/>Round Domain]\r\n    UnitDomain[单位Domain<br/>Unit Domain]\r\n    \r\n    BattleDomain -->|1. 调用| RoundDomain\r\n    RoundDomain -->|2. 返回| BattleDomain\r\n    RoundDomain -->|3. 调用| UnitDomain\r\n    UnitDomain -->|4. 返回| RoundDomain\r\n    \r\n    BattleDomain -.->|包含| RoundDomain\r\n    RoundDomain -.->|包含| UnitDomain\r\n    \r\n    style BattleDomain fill:#ffebee\r\n    style RoundDomain fill:#fff4e1\r\n    style UnitDomain fill:#e1f5ff\r\n```\r\n\r\n**协作流程说明**：\r\n1. **战斗Domain** → 调用 **回合Domain**：战斗进行中，需要执行回合\r\n2. **回合Domain** → 调用 **单位Domain**：回合进行中，需要处理单位行动\r\n3. **单位Domain** → 返回 **回合Domain**：单位行动完成\r\n4. **回合Domain** → 返回 **战斗Domain**：回合完成\r\n\r\n**协作原则**：\r\n- 父Domain控制子Domain的调用时机\r\n- 子Domain完成业务后主动返回父Domain\r\n- 每个Domain独立管理自己的业务逻辑和循环\r\n\r\n### 循环职责说明\r\n\r\n#### 1. 战斗循环（BattleLoop）\r\n- **职责**：管理整个战斗的生命周期\r\n- **状态**：PREPARING → IN_PROGRESS → ENDED\r\n- **维护**：BattleLoopManager\r\n\r\n#### 2. 回合循环（RoundLoop）\r\n- **职责**：管理回合的循环和切换\r\n- **状态**：START → ACTION → END\r\n- **维护**：RoundLoopManager\r\n\r\n#### 3. 单位循环（UnitLoop）\r\n- **职责**：管理单个单位的行动流程\r\n- **状态**：START → ACTION → END\r\n- **维护**：UnitLoopManager\r\n\r\n---\r\n\r\n## 战斗领域\r\n\r\n### 核心职责\r\n\r\n战斗领域负责管理整个战斗的生命周期，包括战斗初始化、战斗流程控制、战斗结束判断、奖励结算、任务同步等。\r\n\r\n### 架构结构\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph BattleDomain[\"战斗Domain<br/>Battle Domain\"]\r\n        BattleManagement[战斗管理<br/>BattleManagement]\r\n        BattleLoop[战斗循环<br/>BattleLoop<br/>PREPARING → IN_PROGRESS → ENDED]\r\n        RoundCoordinator[回合协调器<br/>RoundCoordinator<br/>微核心：只负责协调调用]\r\n        \r\n        subgraph BattleManagement[\"战斗管理<br/>BattleManagement\"]\r\n            BattleData[战斗数据<br/>BattleData]\r\n            DataMgr[战斗数据管理<br/>战斗状态/回合历史/活跃阵营]\r\n            RuleMgr[战斗规则管理<br/>战斗开始/结束条件/胜利条件/失败条件]\r\n            RewardMgr[奖励管理<br/>奖励结算/任务同步]\r\n        end\r\n    end\r\n    \r\n    subgraph ExternalSystems[\"外部系统\"]\r\n        RoundDomain[回合领域<br/>Round Domain]\r\n        RewardSystem[奖励系统<br/>Reward System]\r\n        TaskSystem[任务系统<br/>Task System]\r\n    end\r\n    \r\n    BattleManagement -->|控制| BattleLoop\r\n    BattleManagement --> RoundCoordinator\r\n    RoundCoordinator -->|反向推动| BattleLoop\r\n    BattleLoop -->|推进| BattleManagement\r\n    \r\n    RoundCoordinator -->|调用| RoundDomain\r\n    RoundDomain -->|返回| RoundCoordinator\r\n    \r\n    BattleManagement -->|结算奖励| RewardSystem\r\n    BattleManagement -->|同步任务| TaskSystem\r\n    \r\n    style BattleDomain fill:#ffebee\r\n    style BattleManagement fill:#ffebee\r\n    style BattleLoop fill:#f3e5f5\r\n    style RoundCoordinator fill:#c8e6c9\r\n```\r\n\r\n### 战斗管理（BattleManagement）\r\n\r\n#### 1. 战斗数据管理\r\n- **战斗状态**：当前战斗状态（PREPARING/IN_PROGRESS/ENDED）\r\n- **回合历史**：记录已完成的回合历史（`roundHistoryQueue`）\r\n- **活跃阵营列表**：当前战斗中活跃的阵营ID列表（`activeFactionIDs`）\r\n- **突袭回合阵营列表**：被突袭的阵营ID列表（`surpriseRoundFactionIDs`）\r\n\r\n#### 2. 战斗规则管理\r\n- **战斗开始条件**：检查是否可以开始战斗\r\n- **战斗结束条件**：检查是否应该结束战斗\r\n- **胜利条件**：检查是否满足胜利条件（`CheckVictoryCondition`）\r\n- **失败条件**：检查是否满足失败条件（`CheckDefeatCondition`）\r\n\r\n#### 3. 奖励管理\r\n- **奖励结算**：战斗结束后结算奖励\r\n- **任务同步**：同步战斗相关的任务进度\r\n\r\n### 战斗循环（BattleLoop）\r\n\r\n**循环状态**：PREPARING → IN_PROGRESS → ENDED\r\n\r\n- **PREPARING**：战斗准备中，初始化战斗数据\r\n- **IN_PROGRESS**：战斗进行中，执行回合（调用回合领域）\r\n- **ENDED**：战斗已结束，结算奖励、同步任务\r\n\r\n### 回合协调器（RoundCoordinator）\r\n\r\n**核心原则**：只负责协调调用，不包含业务规则\r\n\r\n**核心职责**：\r\n- ✅ **协调调用**：调用回合领域执行回合\r\n- ✅ **反向推动循环**：回合完成后，主动推动战斗循环进入下一个状态（Domain controls Loop）\r\n\r\n### 战斗完整流程\r\n\r\n```mermaid\r\nflowchart TD\r\n    LoopPreparing[LoopPreparing<br/>战斗准备] --> InitBattle[初始化战斗数据<br/>战斗管理初始化]\r\n    \r\n    InitBattle --> LoopProgress[LoopProgress<br/>战斗进行中]\r\n    \r\n    LoopProgress --> CallRound[调用回合领域<br/>回合协调器调用回合领域]\r\n    \r\n    CallRound --> RoundAction[回合领域执行回合<br/>回合领域完成回合]\r\n    \r\n    RoundAction --> PushProgress[回合协调器推动循环<br/>推动到IN_PROGRESS状态继续]\r\n    \r\n    PushProgress --> CheckEnd{检查战斗结束条件<br/>战斗管理检查}\r\n    \r\n    CheckEnd -->|未结束| CallRound\r\n    CheckEnd -->|已结束| PushEnd[回合协调器推动循环<br/>推动到ENDED状态]\r\n    \r\n    PushEnd --> LoopEnd[LoopEnd<br/>战斗结束]\r\n    \r\n    LoopEnd --> Reward[结算奖励<br/>奖励管理结算奖励]\r\n    Reward --> Task[同步任务<br/>任务管理同步任务]\r\n    Task --> Complete[战斗完成]\r\n    \r\n    style LoopPreparing fill:#ffebee\r\n    style LoopProgress fill:#ffebee\r\n    style CallRound fill:#c8e6c9\r\n    style RoundAction fill:#c8e6c9\r\n    style PushProgress fill:#f3e5f5\r\n    style PushEnd fill:#f3e5f5\r\n    style LoopEnd fill:#ffebee\r\n    style CheckEnd fill:#ffe0b2\r\n```\r\n\r\n---\r\n\r\n## 回合领域\r\n\r\n### 核心职责\r\n\r\n回合领域负责管理回合的循环和切换，包括回合数管理、行动顺序管理（基于先攻值）、回合开始/结束控制等。\r\n\r\n### 架构结构\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph RoundDomain[\"回合Domain<br/>Round Domain\"]\r\n        RoundManagement[回合管理<br/>RoundManagement]\r\n        RoundLoop[回合循环<br/>RoundLoop<br/>START → ACTION → END]\r\n        UnitCoordinator[单位协调器<br/>UnitCoordinator<br/>微核心：只负责协调调用]\r\n        \r\n        subgraph RoundManagement[\"回合管理<br/>RoundManagement\"]\r\n            RoundData[回合数据<br/>RoundData]\r\n            DataMgr[回合数据管理<br/>回合数/行动顺序队列]\r\n            RuleMgr[回合规则管理<br/>回合开始/结束条件]\r\n            OrderMgr[行动顺序管理<br/>队列初始化/管理/获取下一个单位]\r\n        end\r\n        \r\n        subgraph UnitCoordinator[\"单位协调器<br/>UnitCoordinator<br/>微核心：只负责协调调用\"]\r\n            UnitCall[单位调用<br/>从回合管理获取单位<br/>调用单位领域]\r\n        end\r\n    end\r\n    \r\n    subgraph ExternalSystems[\"外部系统\"]\r\n        BattleDomain[战斗领域<br/>Battle Domain]\r\n        UnitDomain[单位领域<br/>Unit Domain]\r\n    end\r\n    \r\n    BattleDomain -->|控制| RoundDomain\r\n    RoundManagement -->|控制| RoundLoop\r\n    RoundManagement --> UnitCoordinator\r\n    UnitCoordinator -->|反向推动| RoundLoop\r\n    RoundLoop -->|推进| RoundManagement\r\n    \r\n    UnitCoordinator -->|调用| UnitDomain\r\n    UnitDomain -->|返回| UnitCoordinator\r\n    \r\n    style RoundDomain fill:#fff4e1\r\n    style RoundManagement fill:#fff4e1\r\n    style RoundLoop fill:#f3e5f5\r\n    style UnitCoordinator fill:#c8e6c9\r\n    style RoundData fill:#e1f5ff\r\n```\r\n\r\n### 回合管理（RoundManagement）\r\n\r\n#### 1. 回合数据管理\r\n- **回合数**：当前回合数、总回合数\r\n- **行动顺序队列**：基于先攻值的优先级队列（TurnQueue）\r\n- **当前行动单位**：当前正在行动的单位\r\n- **活跃阵营列表**：当前回合中活跃的阵营ID列表\r\n\r\n#### 2. 回合规则管理\r\n- **回合开始条件**：检查是否可以开始新回合\r\n- **回合结束条件**：检查是否应该结束当前回合（所有单位行动完成）\r\n- **回合切换规则**：判断是否还有下一个回合\r\n- **突袭回合规则**：战斗开始时，只有被突袭的阵营才能行动（Surprise Round）\r\n- **单位存活检查**：只有存活的单位才能参与回合（`unit:IsAlive()`）\r\n- **活跃阵营过滤**：只有活跃的阵营才能参与回合（`activeFactionIDs`）\r\n\r\n#### 3. 行动顺序管理\r\n- **初始化队列**：回合开始时，根据先攻值初始化行动顺序队列\r\n  - **突袭回合处理**：战斗开始时，只有被突袭的阵营单位加入队列\r\n  - **正常回合处理**：正常回合中，所有活跃阵营的存活单位加入队列\r\n- **队列管理**：管理行动顺序队列的添加、移除、清空\r\n- **获取下一个单位**：从行动顺序队列中获取下一个行动单位（自动过滤死亡单位）\r\n- **下一个单位检查**：检查是否还有下一个行动单位\r\n- **延迟行动管理**：管理延迟行动的单位列表，在适当时候插入到行动顺序中\r\n\r\n### 回合循环（RoundLoop）\r\n\r\n**循环状态**：START → ACTION → END\r\n\r\n- **START**：回合开始，初始化行动顺序队列\r\n  - **突袭回合**：只有被突袭的阵营单位加入队列\r\n  - **正常回合**：所有活跃阵营的存活单位加入队列\r\n- **ACTION**：执行回合行动（调用单位领域）\r\n- **END**：回合结束，清理回合数据，处理延迟行动\r\n\r\n### 单位协调器（UnitCoordinator）\r\n\r\n**核心原则**：只负责协调调用，不包含业务规则\r\n\r\n**核心职责**：\r\n- ✅ **协调调用**：从回合管理获取下一个单位，调用单位领域执行单位行动\r\n- ✅ **反向推动循环**：单位行动完成后，主动推动回合循环进入下一个状态（Domain controls Loop）\r\n\r\n#### 循环推动机制\r\n- **推动到END**：所有单位行动完成后，推动循环从ACTION状态进入END状态\r\n- **推动到START**：回合结束时，推动循环从END状态进入START状态（下一个回合）\r\n- **推动到ACTION**：回合开始时，推动循环从START状态进入ACTION状态\r\n\r\n### 回合完整流程\r\n\r\n```mermaid\r\nflowchart TD\r\n    LoopStart[LoopStart<br/>战斗领域推动循环] --> InitQueue[初始化行动顺序队列<br/>回合管理根据先攻值排序]\r\n    \r\n    InitQueue --> LoopAction[LoopAction<br/>执行回合行动]\r\n    \r\n    LoopAction --> GetNextUnit{获取下一个单位<br/>回合管理从队列获取}\r\n    \r\n    GetNextUnit -->|有单位| CallUnit[调用单位领域<br/>单位协调器调用单位领域]\r\n    GetNextUnit -->|无单位| PushEnd\r\n    \r\n    CallUnit --> UnitAction[单位领域执行行动<br/>单位领域完成行动]\r\n    \r\n    UnitAction --> PushAction[单位协调器推动循环<br/>推动到ACTION状态继续]\r\n    \r\n    PushAction --> GetNextUnit\r\n    \r\n    PushEnd[单位协调器推动循环<br/>推动到END状态]\r\n    \r\n    PushEnd --> RoundEnd[LoopEnd<br/>回合结束]\r\n    \r\n    RoundEnd --> CheckNextRound{检查下一个回合<br/>回合管理检查是否还有下一个回合}\r\n    \r\n    CheckNextRound -->|有下一个回合| PushStart[单位协调器推动循环<br/>推动到START状态]\r\n    CheckNextRound -->|无下一个回合| EndRound[结束回合循环<br/>返回战斗领域]\r\n    \r\n    PushStart --> LoopStart\r\n    \r\n    style LoopStart fill:#fff4e1\r\n    style LoopAction fill:#fff4e1\r\n    style CallUnit fill:#c8e6c9\r\n    style UnitAction fill:#c8e6c9\r\n    style PushAction fill:#f3e5f5\r\n    style PushEnd fill:#f3e5f5\r\n    style PushStart fill:#f3e5f5\r\n    style LoopEnd fill:#fff4e1\r\n    style GetNextUnit fill:#ffe0b2\r\n    style CheckNextRound fill:#ffe0b2\r\n```\r\n\r\n**关键点**：\r\n- ✅ **Domain controls Loop**：回合管理通过单位协调器控制循环状态转换\r\n- ✅ **反向推动机制**：单位协调器执行完单位行动后，主动推动循环进入下一个状态\r\n- ✅ **单位协调器不处理业务规则**：只负责协调调用单位领域，不处理回合业务逻辑\r\n- ✅ **行动顺序管理**：回合管理负责基于先攻值的优先级队列，确保单位按正确顺序行动\r\n- ✅ **队列驱动**：通过行动顺序队列驱动单位行动，队列为空时回合结束\r\n\r\n### 职责划分\r\n\r\n| 组件 | 职责 | 说明 |\r\n|------|------|------|\r\n| **回合管理** | 回合数据与规则 | 管理回合数、行动顺序队列、回合开始/结束规则、队列管理 |\r\n| **单位协调器** | 协调调用 | 从回合管理获取单位，调用单位领域，不处理回合业务规则 |\r\n| **回合循环** | 流程控制 | START/ACTION/END状态转换，由回合管理控制 |\r\n\r\n---\r\n\r\n## 单位领域\r\n\r\n### 核心职责\r\n\r\n单位领域是战斗系统的核心，负责管理单个单位的行动流程，包括移动、技能释放、数值控制等。\r\n\r\n### 架构结构\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph UnitDomain[\"单位Domain<br/>Unit Domain\"]\r\n        UnitManagement[单位管理<br/>UnitManagement]\r\n        UnitLoop[单位循环<br/>UnitLoop<br/>START → ACTION → END]\r\n        ActionCoordinator[行动协调器<br/>ActionCoordinator<br/>微核心：只负责协调调用]\r\n        \r\n        subgraph UnitManagement[\"单位管理<br/>UnitManagement\"]\r\n            UnitData[单位数据<br/>UnitData]\r\n            DataMgr[单位数据管理<br/>属性/状态/位置/回合数据<br/>AP/MP/先攻值]\r\n            RuleMgr[单位规则管理<br/>行动点数规则/移动点数规则<br/>先攻值规则/回合初始化规则]\r\n        end\r\n        \r\n        subgraph DataHandleQueue[\"DataHandleQueue<br/>数据队列<br/>1:1关系\"]\r\n        end\r\n        \r\n        subgraph ActionCoordinator[\"行动协调器<br/>ActionCoordinator<br/>微核心：只负责协调调用\"]\r\n            MoveCoord[移动协调<br/>调用网格系统]\r\n            SkillCoord[技能协调<br/>调用技能领域]\r\n            TerrainCoord[地形交互协调<br/>调用地形领域<br/>可选]\r\n            VisualCoord[表现协调<br/>通知表现层]\r\n        end\r\n    end\r\n    \r\n    subgraph ExternalSystems[\"外部系统\"]\r\n        GridSystem[网格系统<br/>GridSystem]\r\n        SkillDomain[技能领域<br/>Skill Domain]\r\n        VisualSystem[表现系统<br/>Visual System]\r\n        TerrainDomain[地形领域<br/>Terrain Domain]\r\n    end\r\n    \r\n    UnitManagement -->|控制| UnitLoop\r\n    UnitManagement --> ActionCoordinator\r\n    UnitManagement --> UnitData\r\n    ActionCoordinator -->|反向推动| UnitLoop\r\n    UnitLoop -->|推进| UnitManagement\r\n    \r\n    ActionCoordinator -->|调用| GridSystem\r\n    ActionCoordinator -->|调用| SkillDomain\r\n    ActionCoordinator -->|调用| TerrainDomain\r\n    ActionCoordinator -->|通知| VisualSystem\r\n    \r\n    SkillDomain -->|EffectHandler推送| DataHandleQueue\r\n    TerrainDomain -->|EffectHandler推送| DataHandleQueue\r\n\r\n    DataHandleQueue -->|推送数据| UnitData\r\n    \r\n    style UnitDomain fill:#e1f5ff\r\n    style UnitManagement fill:#fff4e1\r\n    style UnitLoop fill:#f3e5f5\r\n    style ActionCoordinator fill:#c8e6c9\r\n    style DataHandleQueue fill:#f3e5f5\r\n    style UnitData fill:#e1f5ff\r\n```\r\n\r\n### 单位管理（UnitManagement）\r\n\r\n#### 1. 单位数据管理\r\n- **单位属性**：生命值、行动点数（AP）、移动点数（MP）、先攻值等\r\n- **单位状态**：是否可行动、是否已移动、是否已攻击、是否存活等\r\n- **单位位置**：当前网格位置\r\n- **回合数据**：UnitTurnData管理行动点数、移动点数、先攻值等回合相关数据\r\n\r\n#### 2. 单位规则管理\r\n- **移动点数规则**：移动前检查能否移动\r\n- **行动点数规则**：检查行动是否可执行（`CheckAction`），消耗行动点数和移动点数（`ConsumeAction`）\r\n- **行动规则**：是否可执行行动（移动、攻击、技能等）\r\n- **状态规则**：状态转换规则（是否存活、是否可行动等）\r\n- **先攻值规则**：管理单位的先攻值，用于回合顺序排序\r\n- **回合初始化规则**：回合开始时初始化行动点数和移动点数（`StartUnitTurn`）\r\n\r\n#### 3. UnitData与DataHandleQueue关系\r\n- **1:1关系**：DataHandleQueue 与 UnitData 是 1:1 关系，数据直接修改 UnitData\r\n- **直接修改**：技能领域的EffectHandler推送数据到DataHandleQueue后，直接修改UnitData\r\n- **无需中间层**：不需要\"数值控制管理\"中间层，DataHandleQueue直接修改UnitData\r\n\r\n### 单位循环（UnitLoop）\r\n\r\n**循环状态**：START → ACTION → END\r\n\r\n- **START**：单位开始行动\r\n- **ACTION**：执行行动（移动、技能等）\r\n- **END**：单位结束行动\r\n\r\n### 行动协调器（ActionCoordinator）\r\n\r\n**核心原则**：只负责协调调用，不包含业务规则\r\n\r\n**核心职责**：\r\n- ✅ **协调调用**：调用网格系统、技能领域、表现系统\r\n- ✅ **反向推动循环**：执行完行动后，主动推动单位循环进入下一个状态（Domain controls Loop）\r\n\r\n#### 1. 移动协调\r\n- **移动前检查**：调用单位管理检查移动点数和行动点数\r\n- **调用网格系统**：进行移动计算（路径查找、移动范围等）\r\n- **移动后更新**：通过 DataHandleQueue 更新单位位置和移动点数\r\n- **推动循环**：移动完成后，推动循环进入下一个状态\r\n\r\n#### 2. 技能协调\r\n- **行动点数检查**：调用单位管理检查行动点数是否足够\r\n- **调用技能领域**：执行技能\r\n- **不处理数值控制**：数值控制由技能领域的EffectHandler通过DataHandleQueue处理\r\n- **接收技能结果**：获取技能执行结果（成功/失败），用于流程控制\r\n- **推动循环**：技能执行完成后，推动循环进入下一个状态\r\n\r\n#### 3. 地形交互协调（可选）\r\n- **地形交互检查**：检查单位是否触发地形要素（陷阱、门等）\r\n- **调用地形领域**：如果触发地形要素，调用地形领域处理\r\n- **推动循环**：地形交互完成后，推动循环进入下一个状态\r\n\r\n#### 4. 表现协调\r\n- **通知表现层**：移动表现、技能表现、受攻击表现\r\n- **推动循环**：表现播放完成后（可选），推动循环进入下一个状态\r\n\r\n### 单位行动完整流程\r\n\r\n```mermaid\r\nflowchart TD\r\n    LoopStart[LoopStart<br/>单位管理推动循环] --> LoopAction[LoopAction<br/>执行行动]\r\n    \r\n    LoopAction --> CheckAction{行动前检查<br/>单位管理检查行动点数/移动点数}\r\n    \r\n    CheckAction -->|可以移动| Move[单位移动<br/>行动协调器调用网格系统]\r\n    CheckAction -->|不能移动| Skill\r\n    \r\n    Move --> UpdateMove[更新移动点数<br/>DataHandleQueue推送]\r\n    UpdateMove --> Skill[攻击/治疗<br/>行动协调器调用技能领域]\r\n    \r\n    Skill --> EffectPush[EffectHandler推送效果<br/>通过DataHandleQueue到目标单位]\r\n    EffectPush --> Visual[可视化<br/>行动协调器通知表现层]\r\n    \r\n    Visual --> PushEnd[行动协调器推动循环<br/>推动到END状态]\r\n    \r\n    PushEnd --> CheckActionPoint{行动点数检查<br/>单位管理检查是否还有行动点数/移动点数}\r\n    \r\n    CheckActionPoint -->|还有行动点数/移动点数| PushAction[行动协调器推动循环<br/>推动回ACTION状态]\r\n    CheckActionPoint -->|无行动点数/移动点数| LoopEnd[LoopEnd<br/>单位结束行动]\r\n    \r\n    PushAction --> LoopAction\r\n    \r\n    style LoopStart fill:#e1f5ff\r\n    style LoopAction fill:#e1f5ff\r\n    style Move fill:#fff4e1\r\n    style Skill fill:#c8e6c9\r\n    style EffectPush fill:#fff4e1\r\n    style Visual fill:#c8e6c9\r\n    style PushEnd fill:#f3e5f5\r\n    style PushAction fill:#f3e5f5\r\n    style LoopEnd fill:#e1f5ff\r\n    style CheckAction fill:#ffe0b2\r\n    style CheckActionPoint fill:#ffe0b2\r\n```\r\n\r\n### 数值控制流程（通过 DataHandleQueue）\r\n\r\n```mermaid\r\nflowchart LR\r\n    ActionCoord[行动协调器<br/>调用技能领域] --> SkillDomain[技能领域<br/>执行技能]\r\n    SkillDomain --> EffectHandler[EffectHandler<br/>应用效果]\r\n    TerrainDomain[地形领域<br/>执行地形要素] --> EffectHandler[EffectHandler<br/>应用效果]\r\n    EffectHandler --> ProcessQueue[DataHandleQueue]\r\n    ProcessQueue --> UnitData[UnitData<br/>1:1关系<br/>推送修改]\r\n    UnitData --> UpdateState[更新状态<br/>扣血/加buff]\r\n    ActionCoord --> TerrainDomain\r\n    ActionCoord --> 其他领域\r\n    其他领域 --> EffectHandler\r\n\r\n    style ActionCoord fill:#c8e6c9\r\n    style SkillDomain fill:#c8e6c9\r\n    style EffectHandler fill:#fff4e1\r\n    style ProcessQueue fill:#f3e5f5\r\n    style UnitData fill:#e1f5ff\r\n    style UpdateState fill:#fff4e1\r\n```\r\n\r\n---\r\n\r\n## 单位领域：节点编排架构\r\n\r\n### 核心设计理念\r\n\r\n#### 1. 节点编排器为核心\r\n\r\n**本质**：单位行动流程的核心是节点编排器的动态组织和管理\r\n\r\n- 单位行动流程 = 节点编排器根据配置动态组织节点执行\r\n- 节点编排 = 条件节点 → 执行节点 → 可视化节点的组合\r\n- 流程控制 = 节点编排器根据节点执行结果决定下一个节点\r\n- 灵活扩展 = 新增节点类型只需注册到编排器\r\n\r\n#### 2. 节点分类设计\r\n\r\n**本质**：节点按功能职责分为四类，每类节点职责单一、可复用\r\n\r\n- **输入节点（Input Node）**：负责接收玩家输入（如：接收移动点击、接收技能选择、接收目标选择等）\r\n- **条件节点（Condition Node）**：负责验证、检查、判断，返回判断结果和流程控制建议（如：检查移动点数、验证技能可释放、检查资源决定是否继续等）\r\n- **执行节点（Execution Node）**：负责实际执行操作，修改数据（如：执行移动、执行技能、消耗资源、更新状态等）\r\n- **可视化节点（Visual Node）**：负责表现播放（如：播放移动表现、播放技能表现等）\r\n\r\n#### 3. 节点数据获取机制\r\n\r\n**本质**：节点通过 CommunicationBus 统一获取不同模块的数据，实现节点与数据模块的解耦\r\n\r\n**核心概念**：\r\n- **数据访问层**：CommunicationBus 作为节点访问所有数据模块的统一接口\r\n- **解耦设计**：节点不直接依赖具体的数据模块（UnitData、SkillDomain、TerrainDomain等）\r\n- **统一接口**：所有数据获取都通过 PushChannel（批量数据推送）和 QueryChannel（同步查询）进行\r\n- **灵活扩展**：新增数据模块时，只需注册到 CommunicationBus，节点无需修改\r\n\r\n**数据获取方式**：\r\n\r\n1. **QueryChannel（同步查询）**：用于节点需要立即获取数据的场景\r\n   - **条件节点**：查询单位属性、技能状态、资源数量等用于验证和检查\r\n   - **执行节点**：查询移动范围、技能范围、目标信息等用于执行\r\n\r\n2. **PushChannel（批量数据推送）**：用于节点需要接收数据变更通知的场景\r\n   - **执行节点**：接收技能效果数据、状态变更数据等用于执行\r\n   - **可视化节点**：接收数据变更通知用于更新表现\r\n\r\n### 节点编排器架构\r\n\r\n```mermaid\r\ngraph TB\r\n    subgraph UnitDomain[\"单位Domain\"]\r\n        NodeOrchestrator[节点编排器<br/>NodeOrchestrator]\r\n        \r\n        subgraph NodeRegistry[\"节点注册表<br/>NodeRegistry\"]\r\n            subgraph InputNodes[\"输入节点组<br/>Input Nodes\"]\r\n                ReceiveMoveInputNode[接收移动输入节点]\r\n                ReceiveSkillSelectNode[接收技能选择节点]\r\n                ReceiveTargetSelectNode[接收目标选择节点]\r\n            end\r\n            \r\n            subgraph ConditionNodes[\"条件节点组<br/>Condition Nodes\"]\r\n                CheckMovePointNode[检查移动点数节点]\r\n                CheckActionPointNode[检查行动点数节点]\r\n                ValidateSkillNode[验证技能节点]\r\n                ValidateTargetNode[验证目标节点]\r\n                ValidateMoveNode[验证移动节点]\r\n                CheckResourceNode[检查资源节点]\r\n            end\r\n            \r\n            subgraph ExecutionNodes[\"执行节点组<br/>Execution Nodes\"]\r\n                InitUnitNode[初始化单位节点]\r\n                MoveNode[移动节点]\r\n                SelectSkillNode[选择技能节点]\r\n                SelectTargetNode[选择目标节点]\r\n                ExecuteSkillNode[执行技能节点]\r\n                ConsumeResourceNode[消耗资源节点]\r\n                UpdateStateNode[更新状态节点]\r\n            end\r\n            \r\n            subgraph VisualNodes[\"可视化节点组<br/>Visual Nodes\"]\r\n                PlayMoveVisualNode[播放移动表现节点]\r\n                PlaySkillVisualNode[播放技能表现节点]\r\n                PlayTargetVisualNode[播放目标表现节点]\r\n            end\r\n        end\r\n        \r\n        FlowConfig[流程配置<br/>NodeFlowConfig]\r\n        ContextManager[上下文管理器<br/>ContextManager]\r\n        \r\n        subgraph CommunicationBus[\"通讯总线\"]\r\n            EventChannel[事件通道<br/>EventChannel]\r\n            MessageChannel[消息通道<br/>MessageChannel]\r\n            PushChannel[推送通道<br/>PushChannel]\r\n            QueryChannel[查询通道<br/>QueryChannel]\r\n        end\r\n        \r\n        subgraph DataModules[\"数据模块\"]\r\n            UnitDataModule[单位数据模块<br/>UnitData]\r\n            SkillDomainModule[技能领域模块<br/>SkillDomain]\r\n            TerrainDomainModule[地形领域模块<br/>TerrainDomain]\r\n            GridSystemModule[网格系统模块<br/>GridSystem]\r\n        end\r\n    end\r\n    \r\n    NodeOrchestrator -->|管理节点| NodeRegistry\r\n    NodeOrchestrator -->|读取配置| FlowConfig\r\n    NodeOrchestrator -->|执行节点| InputNodes\r\n    NodeOrchestrator -->|执行节点| ConditionNodes\r\n    NodeOrchestrator -->|执行节点| ExecutionNodes\r\n    NodeOrchestrator -->|执行节点| VisualNodes\r\n    NodeOrchestrator -->|管理Context| ContextManager\r\n    \r\n    InputNodes -->|发布事件| EventChannel\r\n    ConditionNodes -->|发布事件| EventChannel\r\n    ConditionNodes -->|查询数据| QueryChannel\r\n    ExecutionNodes -->|订阅事件| EventChannel\r\n    ExecutionNodes -->|1对1通讯| MessageChannel\r\n    ExecutionNodes -->|查询数据| QueryChannel\r\n    ExecutionNodes -->|接收数据| PushChannel\r\n    VisualNodes -->|订阅事件| EventChannel\r\n    VisualNodes -->|接收数据| PushChannel\r\n    \r\n    QueryChannel -->|查询| UnitDataModule\r\n    QueryChannel -->|查询| SkillDomainModule\r\n    QueryChannel -->|查询| TerrainDomainModule\r\n    QueryChannel -->|查询| GridSystemModule\r\n    \r\n    PushChannel -->|推送数据| UnitDataModule\r\n    SkillDomainModule -->|推送数据| PushChannel\r\n    TerrainDomainModule -->|推送数据| PushChannel\r\n    \r\n    style NodeOrchestrator fill:#c8e6c9\r\n    style NodeRegistry fill:#e1f5ff\r\n    style InputNodes fill:#ffebee\r\n    style ConditionNodes fill:#fff4e1\r\n    style ExecutionNodes fill:#c8e6c9\r\n    style VisualNodes fill:#f3e5f5\r\n    style CommunicationBus fill:#fff4e1\r\n```\r\n\r\n### 节点编排器职责\r\n\r\n1. **节点注册管理**\r\n   - 管理节点注册表（NodeRegistry）\r\n   - 支持动态注册/注销节点\r\n   - 提供节点查找接口（按ID、按类型）\r\n\r\n2. **流程编排**\r\n   - 根据FlowConfig动态组织节点执行顺序\r\n   - 处理节点间的跳转、条件分支、循环\r\n   - 管理节点执行状态和生命周期\r\n\r\n3. **Context管理**\r\n   - 在节点间传递UnitContext\r\n   - 管理Context的生命周期\r\n   - 处理Context状态恢复\r\n\r\n4. **错误处理**\r\n   - 处理节点执行失败\r\n   - 资源回滚和状态恢复\r\n   - 错误通知和日志记录\r\n\r\n### 节点分类详细设计\r\n\r\n#### 输入节点（Input Node）\r\n\r\n**职责**：接收玩家输入，不修改数据，只负责输入数据的收集和传递\r\n\r\n**节点列表**：\r\n1. **ReceiveMoveInputNode**：接收玩家点击的网格坐标\r\n2. **ReceiveSkillSelectNode**：接收玩家选择的技能ID\r\n3. **ReceiveTargetSelectNode**：接收玩家选择的目标（单位、位置等）\r\n\r\n**节点接口**：\r\n- `Execute(context) -> result`：接收输入，返回输入数据和有效性\r\n- `WaitForInput(context) -> input`：等待玩家输入（异步）\r\n- `ValidateInput(input) -> bool`：验证输入有效性\r\n\r\n#### 条件节点（Condition Node）\r\n\r\n**职责**：验证、检查、判断，不修改数据，返回判断结果和流程控制建议\r\n\r\n**节点列表**：\r\n1. **CheckMovePointNode**：检查单位是否有足够的移动点数\r\n2. **CheckActionPointNode**：检查单位是否有足够的行动点数\r\n3. **ValidateMoveNode**：验证移动输入是否合法（位置、路径、范围等）\r\n4. **ValidateSkillNode**：验证技能是否可释放\r\n5. **ValidateTargetNode**：验证目标是否合法（距离、状态、条件等）\r\n6. **CheckResourceNode**：检查单位是否还有资源继续行动\r\n\r\n**返回结果结构**：\r\n```lua\r\n{\r\n    success: true/false,           -- 判断结果\r\n    data: {...},                   -- 判断数据（可选）\r\n    nextAction: \"continue\"/\"end\"/\"skip\", -- 流程控制建议（可选）\r\n    loopState: \"ACTION\"/\"END\"      -- 循环状态建议（可选）\r\n}\r\n```\r\n\r\n#### 执行节点（Execution Node）\r\n\r\n**职责**：实际执行操作，修改数据，返回执行结果\r\n\r\n**节点列表**：\r\n1. **InitUnitNode**：初始化单位行动状态，重置行动点数和移动点数\r\n2. **MoveNode**：执行移动并更新单位位置，消耗移动点数\r\n3. **SelectSkillNode**：显示可用的技能列表，准备技能释放上下文\r\n4. **SelectTargetNode**：根据技能类型显示可选目标，更新技能上下文中的目标信息\r\n5. **ExecuteSkillNode**：调用技能领域执行技能，处理技能执行结果\r\n6. **ConsumeResourceNode**：消耗行动点数和资源，记录资源消耗信息\r\n7. **UpdateStateNode**：批量处理所有状态变更数据，更新单位状态\r\n\r\n**节点接口**：\r\n- `Execute(context) -> result`：执行操作\r\n- `CanExecute(context) -> bool`：检查是否可以执行\r\n- `Rollback(context)`：回滚操作（失败时）\r\n\r\n#### 可视化节点（Visual Node）\r\n\r\n**职责**：播放表现，不修改数据，只负责视觉反馈\r\n\r\n**节点列表**：\r\n1. **PlayMoveVisualNode**：通知VisualSystem播放移动表现\r\n2. **PlaySkillVisualNode**：通知VisualSystem播放技能释放表现\r\n3. **PlayTargetVisualNode**：通知VisualSystem播放受攻击单位表现\r\n\r\n**节点接口**：\r\n- `Execute(context) -> result`：播放表现\r\n- `WaitForComplete(context) -> bool`：等待表现完成（可选）\r\n\r\n### 节点编排流程示例\r\n\r\n```mermaid\r\nflowchart TD\r\n    Start[开始] --> Init[InitUnitNode<br/>初始化单位]\r\n    \r\n    Init --> CheckMove{CheckMovePointNode<br/>检查移动点数}\r\n    CheckMove -->|有移动点数| ReceiveMove[ReceiveMoveInputNode<br/>接收移动输入]\r\n    CheckMove -->|无移动点数| SelectSkill\r\n    \r\n    ReceiveMove --> ValidateMove{ValidateMoveNode<br/>验证移动}\r\n    ValidateMove -->|验证通过| Move[MoveNode<br/>执行移动]\r\n    ValidateMove -->|验证失败| ReceiveMove\r\n    \r\n    Move --> PlayMove[PlayMoveVisualNode<br/>播放移动表现]\r\n    PlayMove --> SelectSkill[SelectSkillNode<br/>选择技能]\r\n    \r\n    SelectSkill --> ReceiveSkill[ReceiveSkillSelectNode<br/>接收技能选择]\r\n    ReceiveSkill --> ValidateSkill{ValidateSkillNode<br/>验证技能}\r\n    ValidateSkill -->|验证通过| SelectTarget[SelectTargetNode<br/>选择目标]\r\n    ValidateSkill -->|验证失败| SelectSkill\r\n    \r\n    SelectTarget --> ReceiveTarget[ReceiveTargetSelectNode<br/>接收目标选择]\r\n    ReceiveTarget --> ValidateTarget{ValidateTargetNode<br/>验证目标}\r\n    ValidateTarget -->|验证通过| Consume[ConsumeResourceNode<br/>消耗资源]\r\n    ValidateTarget -->|验证失败| SelectTarget\r\n    \r\n    Consume --> Execute[ExecuteSkillNode<br/>执行技能]\r\n    Execute --> Update[UpdateStateNode<br/>更新状态]\r\n    Update --> PlaySkill[PlaySkillVisualNode<br/>播放技能表现]\r\n    PlaySkill --> PlayTarget[PlayTargetVisualNode<br/>播放目标表现]\r\n    \r\n    PlayTarget --> CheckResource{CheckResourceNode<br/>检查资源}\r\n    CheckResource -->|还有资源| CheckMove\r\n    CheckResource -->|无资源| End[结束]\r\n    \r\n    style Init fill:#c8e6c9\r\n    style CheckMove fill:#fff4e1\r\n    style ReceiveMove fill:#ffebee\r\n    style ValidateMove fill:#fff4e1\r\n    style Move fill:#c8e6c9\r\n    style PlayMove fill:#f3e5f5\r\n    style SelectSkill fill:#c8e6c9\r\n    style ReceiveSkill fill:#ffebee\r\n    style ValidateSkill fill:#fff4e1\r\n    style SelectTarget fill:#c8e6c9\r\n    style ReceiveTarget fill:#ffebee\r\n    style ValidateTarget fill:#fff4e1\r\n    style Consume fill:#c8e6c9\r\n    style Execute fill:#c8e6c9\r\n    style Update fill:#c8e6c9\r\n    style PlaySkill fill:#f3e5f5\r\n    style PlayTarget fill:#f3e5f5\r\n    style CheckResource fill:#fff4e1\r\n    style End fill:#ffebee\r\n```\r\n\r\n### 节点间通讯机制\r\n\r\n#### 1. Context传递（同步）\r\n\r\n**设计**：节点编排器负责在节点间传递UnitContext\r\n\r\n- 节点执行时接收Context\r\n- 节点执行后增强Context并返回\r\n- 编排器根据结果决定下一个节点\r\n\r\n#### 2. EventChannel（异步）\r\n\r\n**设计**：节点可以发布事件，其他节点可以订阅\r\n\r\n- 支持解耦的事件通知\r\n- 事件类型：`UNIT_MOVE_COMPLETED`、`SKILL_EXECUTED`、`RESOURCE_CONSUMED`、`STATE_UPDATED`\r\n\r\n#### 3. MessageChannel（同步，1对1）\r\n\r\n**设计**：节点间需要直接通讯时使用\r\n\r\n- 1对1单向消息传递\r\n- 支持请求-响应模式\r\n\r\n#### 4. QueryChannel（同步查询）\r\n\r\n**设计**：节点通过QueryChannel查询数据模块\r\n\r\n- 条件节点查询单位属性、技能状态\r\n- 执行节点查询移动范围、技能范围\r\n\r\n#### 5. PushChannel（批量数据推送）\r\n\r\n**设计**：数据模块通过PushChannel推送数据变更\r\n\r\n- 执行节点接收技能效果数据、状态变更数据\r\n- 可视化节点接收数据变更通知\r\n\r\n---\r\n\r\n## 核心机制\r\n\r\n### 循环机制\r\n\r\n#### 循环状态机设计\r\n\r\n**各层循环的状态定义**：\r\n\r\n1. **战斗循环（BattleLoop）**\r\n   - **PREPARING**：战斗准备中\r\n   - **IN_PROGRESS**：战斗进行中\r\n   - **ENDED**：战斗已结束\r\n\r\n2. **回合循环（RoundLoop）**\r\n   - **START**：回合开始\r\n   - **ACTION**：执行回合行动\r\n   - **END**：回合结束\r\n\r\n3. **单位循环（UnitLoop）**\r\n   - **START**：单位开始行动\r\n   - **ACTION**：执行行动\r\n   - **END**：单位结束行动\r\n\r\n**状态转换原则**：\r\n- Domain controls Loop：Domain管理通过协调器控制循环状态转换\r\n- 反向推动机制：协调器执行完业务后，主动推动循环进入下一个状态\r\n- 状态转换验证：状态转换前进行验证，确保转换合法\r\n\r\n### 通信机制\r\n\r\n#### CommunicationBus 在战斗系统中的应用\r\n\r\n**核心设计**：节点通过 CommunicationBus 统一获取不同模块的数据，实现节点与数据模块的解耦\r\n\r\n**应用场景**：\r\n\r\n1. **QueryChannel（同步查询）**\r\n   - 条件节点查询单位属性、技能状态、资源数量\r\n   - 执行节点查询移动范围、技能范围、目标信息\r\n\r\n2. **PushChannel（批量数据推送）**\r\n   - 执行节点接收技能效果数据、状态变更数据\r\n   - 可视化节点接收数据变更通知\r\n\r\n3. **EventChannel（异步事件）**\r\n   - 节点发布事件，其他节点订阅\r\n   - 支持解耦的事件通知\r\n\r\n4. **MessageChannel（同步，1对1）**\r\n   - 节点间需要直接通讯时使用\r\n\r\n### 数据驱动机制\r\n\r\n**核心理解**：战斗特性通过配置数据实现，无需修改代码\r\n\r\n**数据驱动内容**：\r\n- 行动规则、资源消耗、状态转换 → 通过UnitData/UnitTurnData配置\r\n- 节点流程、状态转换 → 通过NodeFlowConfig配置\r\n- 新增行动类型 → 扩展配置字段即可\r\n\r\n---\r\n\r\n## 数据结构\r\n\r\n### UnitContext（单位上下文）\r\n\r\n**数据结构定义**：\r\n\r\n```lua\r\nUnitContext = {\r\n    -- 基础数据\r\n    unitData = UnitData,              -- 单位数据\r\n    roundContext = RoundContext,       -- 回合上下文\r\n    \r\n    -- 输入数据\r\n    moveInput = {x, y},                -- 移动输入（由ReceiveMoveInputNode提供）\r\n    skillInput = skillId,              -- 技能选择输入（由ReceiveSkillSelectNode提供）\r\n    targetInput = {targets},            -- 目标选择输入（由ReceiveTargetSelectNode提供）\r\n    \r\n    -- 验证结果\r\n    moveValidation = {...},             -- 移动验证结果\r\n    skillValidation = {...},            -- 技能验证结果\r\n    targetValidation = {...},          -- 目标验证结果\r\n    \r\n    -- 执行结果\r\n    movePath = {...},                   -- 移动路径\r\n    moveResult = {...},                 -- 移动结果\r\n    skillExecutionResult = {...},       -- 技能执行结果\r\n    resourceConsumption = {...},        -- 资源消耗信息\r\n    \r\n    -- 状态数据\r\n    visualResult = {...},               -- 表现播放结果\r\n    effectResults = {...},              -- 效果处理结果\r\n    resourceCheck = {...},              -- 资源检查结果\r\n    loopState = \"ACTION\"/\"END\",         -- 循环状态\r\n    \r\n    -- 节点执行状态\r\n    nodeState = \"IDLE\"/\"EXECUTING\"/\"COMPLETED\"/\"FAILED\",\r\n    errorInfo = {...}                   -- 错误信息（可选）\r\n}\r\n```\r\n\r\n### NodeFlowConfig（流程配置）\r\n\r\n**配置结构**：\r\n\r\n```lua\r\nNodeFlowConfig = {\r\n    nodes = {\r\n        {id = \"init\", type = \"execution\", node = \"InitUnitNode\"},\r\n        {id = \"checkMove\", type = \"condition\", node = \"CheckMovePointNode\"},\r\n        -- ... 其他节点\r\n    },\r\n    flow = {\r\n        {from = \"init\", to = \"checkMove\"},\r\n        {from = \"checkMove\", to = \"move\", condition = \"hasMovePoint\"},\r\n        {from = \"checkMove\", to = \"selectSkill\", condition = \"noMovePoint\"},\r\n        {from = \"move\", to = \"playMove\"},\r\n        -- ... 其他流程\r\n    },\r\n    events = {\r\n        {node = \"move\", publish = \"UNIT_MOVE_COMPLETED\"},\r\n        {node = \"playMove\", subscribe = \"UNIT_MOVE_COMPLETED\"},\r\n        -- ... 其他事件\r\n    }\r\n}\r\n```\r\n\r\n### RoundData（回合数据）\r\n\r\n**数据结构定义**：\r\n\r\n```lua\r\nRoundData = {\r\n    currentRound = number,              -- 当前回合数\r\n    turnQueue = PriorityQueue,          -- 行动顺序队列（基于先攻值）\r\n    unitSet = Set,                      -- 单位集合\r\n    delayedActions = {},                -- 延迟行动列表\r\n    surpriseRoundFactionIDs = {},      -- 突袭回合阵营列表\r\n    activeFactionIDs = {}               -- 活跃阵营列表\r\n}\r\n```\r\n\r\n### BattleData（战斗数据）\r\n\r\n**数据结构定义**：\r\n\r\n```lua\r\nBattleData = {\r\n    currentPhase = string,              -- 当前战斗阶段\r\n    roundHistoryQueue = Queue,           -- 回合历史队列\r\n    surpriseRoundFactionIDs = {},       -- 突袭回合阵营列表\r\n    activeFactionIDs = {}               -- 活跃阵营列表\r\n}\r\n```\r\n\r\n---\r\n\r\n## 外部系统集成\r\n\r\n### SkillDomain（技能领域）集成\r\n\r\n**集成方式**：\r\n- **调用方式**：ActionCoordinator调用SkillDomain执行技能\r\n- **数据推送**：SkillDomain的EffectHandler通过DataHandleQueue推送效果数据\r\n- **数据查询**：节点通过QueryChannel查询技能状态\r\n\r\n### TerrainDomain（地形领域）集成\r\n\r\n**集成方式**：\r\n- **调用方式**：ActionCoordinator调用TerrainDomain处理地形要素\r\n- **数据推送**：TerrainDomain的EffectHandler通过DataHandleQueue推送效果数据\r\n- **共享Handler机制**：与SkillDomain共享Handler接口，但保持独立系统\r\n\r\n### GridSystem（网格系统）集成\r\n\r\n**集成方式**：\r\n- **调用方式**：ActionCoordinator调用GridSystem进行移动计算\r\n- **数据查询**：节点通过QueryChannel查询移动范围、路径信息\r\n\r\n### VisualSystem（表现系统）集成\r\n\r\n**集成方式**：\r\n- **通知方式**：ActionCoordinator通知VisualSystem播放表现\r\n- **事件订阅**：可视化节点订阅EventChannel接收表现事件\r\n\r\n---\r\n\r\n## 实现指南\r\n\r\n### 实现优先级\r\n\r\n**第一阶段（核心流程）**：\r\n1. 战斗领域基础实现\r\n2. 回合领域核心流程\r\n3. 单位领域节点编排器基础\r\n\r\n**第二阶段（完整流程）**：\r\n4. 节点分类完整实现\r\n5. 外部系统集成\r\n6. 数据驱动配置\r\n\r\n**第三阶段（优化和错误处理）**：\r\n7. 错误处理和恢复机制\r\n8. 性能优化\r\n9. 边界情况处理\r\n\r\n### 关键实现要点\r\n\r\n1. **Domain controls Loop**：确保Domain管理通过协调器控制循环状态转换\r\n2. **反向推动机制**：协调器执行完业务后，主动推动循环进入下一个状态\r\n3. **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n4. **数据驱动**：所有特性通过配置数据实现，无需修改代码\r\n5. **解耦设计**：通过CommunicationBus实现节点与数据模块的解耦\r\n\r\n### 设计原则总结\r\n\r\n- ✅ **Domain controls Loop**：Domain控制循环，循环是Domain的工具\r\n- ✅ **数据驱动架构**：战斗特性通过配置数据实现，无需额外机制\r\n- ✅ **节点编排模式**：单位行动流程通过节点编排器动态组织\r\n- ✅ **解耦设计**：节点间通过CommunicationBus和Context通信，不直接依赖\r\n- ✅ **多层循环架构**：战斗→回合→单位三层循环架构\r\n- ✅ **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n- ✅ **统一数据访问**：节点通过CommunicationBus统一获取数据\r\n\r\n---\r\n\r\n## 总结\r\n\r\n### 架构设计价值\r\n\r\n该架构设计文档的价值在于：\r\n- ✅ **思路解构**：完整解构回合制战斗系统的搭建思路\r\n- ✅ **流程验证**：从架构层面验证流程合理性\r\n- ✅ **问题识别**：提前识别潜在的资源和状态问题\r\n- ✅ **开发指导**：为后续详细设计和实现提供清晰指导\r\n\r\n### 架构特点\r\n\r\n- ✅ **多层循环架构**：战斗→回合→单位三层循环架构\r\n- ✅ **微核心设计**：协调器只负责协调调用，不包含业务规则\r\n- ✅ **统一数据访问**：节点通过CommunicationBus统一获取数据\r\n- ✅ **错误处理防护**：资源回滚 + 状态恢复 + 错误通知，避免状态不一致\r\n- ✅ **数据驱动**：所有特性通过配置数据实现，无需修改代码\r\n\r\n细节实现是后续开发阶段的工作，当前架构设计已足够指导整个回合制战斗系统的开发。\r\n"
        }
    ]
}