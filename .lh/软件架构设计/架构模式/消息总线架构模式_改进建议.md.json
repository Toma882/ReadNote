{
    "sourceFile": "è½¯ä»¶æ¶æ„è®¾è®¡/æ¶æ„æ¨¡å¼/æ¶ˆæ¯æ€»çº¿æ¶æ„æ¨¡å¼_æ”¹è¿›å»ºè®®.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1764239160757,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1764239160757,
            "name": "Commit-0",
            "content": "# æ¶ˆæ¯æ€»çº¿æ¶æ„æ¨¡å¼ - æ”¹è¿›å»ºè®®\r\n\r\n## ğŸ“‹ æ”¹è¿›å»ºè®®æ¸…å•\r\n\r\n### 1. é¢‘é“é€‰æ‹©å†³ç­–æ ‘\r\n\r\n**é—®é¢˜**ï¼šæ–‡æ¡£ä¸­ç¼ºå°‘æ˜ç¡®çš„é¢‘é“é€‰æ‹©å†³ç­–æµç¨‹\r\n\r\n**å»ºè®®**ï¼šæ·»åŠ é¢‘é“é€‰æ‹©å†³ç­–æµç¨‹å›¾\r\n\r\n```mermaid\r\ngraph TD\r\n    A[éœ€è¦å‘é€æ¶ˆæ¯] --> B{éœ€è¦ç­‰å¾…å“åº”?}\r\n    B -->|æ˜¯| C{éœ€è¦å®æ—¶æ¨é€?}\r\n    B -->|å¦| D{ä¸€å¯¹å¤šé€šçŸ¥?}\r\n    \r\n    C -->|æ˜¯| E[æ¨é€é¢‘é“<br/>Push Channel]\r\n    C -->|å¦| F[è¯·æ±‚æ•°æ®é¢‘é“<br/>Request Channel]\r\n    \r\n    D -->|æ˜¯| G[äº‹ä»¶é¢‘é“<br/>Event Channel]\r\n    D -->|å¦| H[æ¶ˆæ¯é¢‘é“<br/>Message Channel]\r\n    \r\n    E --> I[å®æ—¶æ¨é€<br/>ä¸€å¯¹ä¸€]\r\n    F --> J[è¯·æ±‚-å“åº”<br/>ç­‰å¾…ç»“æœ]\r\n    G --> K[å‘å¸ƒ-è®¢é˜…<br/>ä¸€å¯¹å¤š]\r\n    H --> L[ç‚¹å¯¹ç‚¹/é˜Ÿåˆ—<br/>å•å‘é€šä¿¡]\r\n```\r\n\r\n**å†³ç­–è§„åˆ™**ï¼š\r\n\r\n| åœºæ™¯ | é¢‘é“é€‰æ‹© | åŸå›  |\r\n|------|---------|------|\r\n| éœ€è¦ç­‰å¾…å“åº”æ•°æ® | è¯·æ±‚æ•°æ®é¢‘é“ | è¯·æ±‚-å“åº”æ¨¡å¼ |\r\n| éœ€è¦å®æ—¶æ¨é€é€šçŸ¥ | æ¨é€é¢‘é“ | å®æ—¶æ¨é€æ¨¡å¼ |\r\n| ä¸€å¯¹å¤šäº‹ä»¶é€šçŸ¥ | äº‹ä»¶é¢‘é“ | å‘å¸ƒ-è®¢é˜…æ¨¡å¼ |\r\n| å•å‘æ•°æ®æ¨é€ | æ¶ˆæ¯é¢‘é“ | ç‚¹å¯¹ç‚¹/é˜Ÿåˆ—æ¨¡å¼ |\r\n\r\n### 2. å®é™…å®ç°ä¸ç†è®ºè®¾è®¡çš„æ˜ å°„\r\n\r\n**é—®é¢˜**ï¼šç†è®ºè®¾è®¡å®Œæ•´ï¼Œä½†å®é™…å®ç°ï¼ˆDataHandleQueueï¼‰è¾ƒç®€å•\r\n\r\n**å»ºè®®**ï¼šåœ¨æ–‡æ¡£ä¸­æ˜ç¡®å½“å‰å®ç°é˜¶æ®µå’Œæœªæ¥æ¼”è¿›è·¯å¾„\r\n\r\n#### å½“å‰å®ç°ï¼ˆv1.0ï¼‰\r\n\r\n```lua\r\nDataHandleQueue (å½“å‰å®ç°)\r\nâ”œâ”€â”€ PushData() â†’ æ¶ˆæ¯é¢‘é“ï¼ˆç®€åŒ–ç‰ˆï¼‰\r\nâ”‚   â””â”€â”€ ç›´æ¥å­˜å‚¨åˆ°é˜Ÿåˆ—ï¼Œä¸åŒºåˆ†é¢‘é“\r\nâ”œâ”€â”€ ProcessQueryDelegate() â†’ è¯·æ±‚æ•°æ®é¢‘é“ï¼ˆç®€åŒ–ç‰ˆï¼‰\r\nâ”‚   â””â”€â”€ ç›´æ¥è°ƒç”¨å§”æ‰˜ï¼ŒåŒæ­¥è¿”å›\r\nâ””â”€â”€ ProcessDataHandler() â†’ Handleræ˜ å°„ï¼ˆè§‚å¯Ÿè€…æ¨¡å¼ï¼‰\r\n    â””â”€â”€ éå†handlersï¼Œè°ƒç”¨å¤„ç†å‡½æ•°\r\n```\r\n\r\n#### æœªæ¥æ¼”è¿›ï¼ˆv2.0ï¼‰\r\n\r\n```lua\r\nMessageBus (å®Œæ•´å®ç°)\r\nâ”œâ”€â”€ é¢‘é“ç®¡ç†å™¨ï¼ˆChannel Managerï¼‰\r\nâ”‚   â”œâ”€â”€ äº‹ä»¶é¢‘é“ï¼ˆEvent Channelï¼‰\r\nâ”‚   â”œâ”€â”€ æ¶ˆæ¯é¢‘é“ï¼ˆMessage Channelï¼‰\r\nâ”‚   â”œâ”€â”€ æ¨é€é¢‘é“ï¼ˆPush Channelï¼‰\r\nâ”‚   â””â”€â”€ è¯·æ±‚æ•°æ®é¢‘é“ï¼ˆRequest Channelï¼‰\r\nâ””â”€â”€ DataHandleQueue (é€‚é…å™¨)\r\n    â”œâ”€â”€ PushData() â†’ æ¶ˆæ¯é¢‘é“.Send()\r\n    â”œâ”€â”€ QueryData() â†’ è¯·æ±‚æ•°æ®é¢‘é“.Query()\r\n    â””â”€â”€ ProcessDataHandler() â†’ Handleræ˜ å°„\r\n```\r\n\r\n**è¿ç§»ç­–ç•¥**ï¼š\r\n1. **é˜¶æ®µä¸€**ï¼šä¿æŒ DataHandleQueue æ¥å£ä¸å˜ï¼Œå†…éƒ¨é€æ­¥å¼•å…¥é¢‘é“æœºåˆ¶\r\n2. **é˜¶æ®µäºŒ**ï¼šæ·»åŠ  MessageBus ä½œä¸ºç»Ÿä¸€å…¥å£ï¼ŒDataHandleQueue ä½œä¸ºé€‚é…å™¨\r\n3. **é˜¶æ®µä¸‰**ï¼šå®Œå…¨è¿ç§»åˆ° MessageBusï¼ŒDataHandleQueue ä½œä¸ºå…¼å®¹å±‚\r\n\r\n### 3. é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶\r\n\r\n**é—®é¢˜**ï¼šç¼ºå°‘æ¶ˆæ¯ä¸¢å¤±ã€å¤„ç†å¤±è´¥ã€è¶…æ—¶ç­‰åœºæ™¯çš„å¤„ç†\r\n\r\n**å»ºè®®**ï¼šè¡¥å……é”™è¯¯å¤„ç†ç­–ç•¥\r\n\r\n#### é”™è¯¯å¤„ç†ç­–ç•¥\r\n\r\n```lua\r\n-- æ¶ˆæ¯å¤„ç†é”™è¯¯å¤„ç†\r\nfunction MessageBus:Send(message)\r\n    local success, err = pcall(function()\r\n        local channel = self:GetChannel(message.Channel)\r\n        channel:Send(message)\r\n    end)\r\n    \r\n    if not success then\r\n        -- é”™è¯¯å¤„ç†ç­–ç•¥\r\n        self:HandleError(message, err)\r\n    end\r\nend\r\n\r\n-- é”™è¯¯å¤„ç†ç­–ç•¥\r\nfunction MessageBus:HandleError(message, err)\r\n    -- ç­–ç•¥1ï¼šé‡è¯•æœºåˆ¶\r\n    if message.retryCount < 3 then\r\n        message.retryCount = message.retryCount + 1\r\n        self:Send(message)  -- é‡è¯•\r\n    else\r\n        -- ç­–ç•¥2ï¼šé™çº§å¤„ç†\r\n        self:FallbackHandler(message, err)\r\n    end\r\nend\r\n```\r\n\r\n#### å®¹é”™æœºåˆ¶\r\n\r\n| é”™è¯¯ç±»å‹ | å¤„ç†ç­–ç•¥ | å®ç°æ–¹å¼ |\r\n|---------|---------|---------|\r\n| æ¶ˆæ¯ä¸¢å¤± | æŒä¹…åŒ–é˜Ÿåˆ— | ç£ç›˜é˜Ÿåˆ— |\r\n| å¤„ç†å¤±è´¥ | é‡è¯•æœºåˆ¶ | æœ€å¤šé‡è¯•3æ¬¡ |\r\n| è¶…æ—¶ | è¶…æ—¶å›è°ƒ | è®¾ç½®è¶…æ—¶æ—¶é—´ |\r\n| é¢‘é“ä¸å­˜åœ¨ | é™çº§å¤„ç† | ä½¿ç”¨é»˜è®¤é¢‘é“ |\r\n\r\n### 4. æ€§èƒ½ç›‘æ§å’Œè¿½è¸ª\r\n\r\n**é—®é¢˜**ï¼šç¼ºå°‘æ¶ˆæ¯ä¼ é€’çš„æ€§èƒ½æŒ‡æ ‡å’Œè¿½è¸ªæœºåˆ¶\r\n\r\n**å»ºè®®**ï¼šæ·»åŠ æ€§èƒ½ç›‘æ§ç³»ç»Ÿ\r\n\r\n#### æ€§èƒ½ç›‘æ§æŒ‡æ ‡\r\n\r\n```lua\r\n-- æ¶ˆæ¯ç»Ÿè®¡\r\nMessageBus.Metrics = {\r\n    totalMessages = 0,        -- æ€»æ¶ˆæ¯æ•°\r\n    successCount = 0,         -- æˆåŠŸæ•°\r\n    failureCount = 0,         -- å¤±è´¥æ•°\r\n    averageLatency = 0,       -- å¹³å‡å»¶è¿Ÿ\r\n    channelStats = {}         -- é¢‘é“ç»Ÿè®¡\r\n}\r\n\r\n-- æ€§èƒ½è¿½è¸ª\r\nfunction MessageBus:Send(message)\r\n    local startTime = os.clock()\r\n    local success = self:DoSend(message)\r\n    local latency = os.clock() - startTime\r\n    \r\n    -- æ›´æ–°ç»Ÿè®¡\r\n    self:UpdateMetrics(message.Channel, success, latency)\r\nend\r\n```\r\n\r\n#### ç›‘æ§æŒ‡æ ‡\r\n\r\n| æŒ‡æ ‡ | è¯´æ˜ | ç›®æ ‡å€¼ |\r\n|------|------|--------|\r\n| æ¶ˆæ¯ååé‡ | æ¯ç§’å¤„ç†æ¶ˆæ¯æ•° | > 1000 msg/s |\r\n| å¹³å‡å»¶è¿Ÿ | æ¶ˆæ¯å¤„ç†å¹³å‡æ—¶é—´ | < 10ms |\r\n| æˆåŠŸç‡ | æ¶ˆæ¯å¤„ç†æˆåŠŸç‡ | > 99.9% |\r\n| é¢‘é“è´Ÿè½½ | å„é¢‘é“æ¶ˆæ¯æ•°é‡ | å‡è¡¡åˆ†å¸ƒ |\r\n\r\n### 5. æ¶ˆæ¯ä¼˜å…ˆçº§å’Œé¡ºåºä¿è¯\r\n\r\n**é—®é¢˜**ï¼šç¼ºå°‘æ¶ˆæ¯ä¼˜å…ˆçº§å’Œé¡ºåºä¿è¯æœºåˆ¶\r\n\r\n**å»ºè®®**ï¼šæ·»åŠ ä¼˜å…ˆçº§é˜Ÿåˆ—å’Œé¡ºåºä¿è¯\r\n\r\n#### ä¼˜å…ˆçº§é˜Ÿåˆ—\r\n\r\n```lua\r\n-- ä¼˜å…ˆçº§æ¶ˆæ¯\r\nlocal message = {\r\n    priority = 10,  -- ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰\r\n    data = {...}\r\n}\r\n\r\n-- ä¼˜å…ˆçº§é˜Ÿåˆ—å¤„ç†\r\nfunction MessageChannel:Send(message)\r\n    if message.priority then\r\n        self.priorityQueue:Enqueue(message, message.priority)\r\n    else\r\n        self.normalQueue:Enqueue(message)\r\n    end\r\nend\r\n```\r\n\r\n#### é¡ºåºä¿è¯\r\n\r\n| åœºæ™¯ | ä¿è¯æ–¹å¼ | å®ç° |\r\n|------|---------|------|\r\n| åŒä¸€å‘é€è€… | å•çº¿ç¨‹å¤„ç† | æŒ‰å‘é€é¡ºåºå¤„ç† |\r\n| ä¸åŒå‘é€è€… | æ—¶é—´æˆ³æ’åº | æŒ‰æ—¶é—´æˆ³å¤„ç† |\r\n| å…³é”®æ¶ˆæ¯ | ä¼˜å…ˆçº§é˜Ÿåˆ— | é«˜ä¼˜å…ˆçº§å…ˆå¤„ç† |\r\n\r\n### 6. æ¶ˆæ¯æŒä¹…åŒ–å’Œå¯é æ€§\r\n\r\n**é—®é¢˜**ï¼šç¼ºå°‘æ¶ˆæ¯æŒä¹…åŒ–å’Œå¯é æ€§ä¿è¯\r\n\r\n**å»ºè®®**ï¼šæ·»åŠ æ¶ˆæ¯æŒä¹…åŒ–æœºåˆ¶\r\n\r\n#### æŒä¹…åŒ–ç­–ç•¥\r\n\r\n```lua\r\n-- æ¶ˆæ¯æŒä¹…åŒ–\r\nfunction MessageBus:Send(message)\r\n    -- ç­–ç•¥1ï¼šå†…å­˜é˜Ÿåˆ—ï¼ˆé«˜æ€§èƒ½ï¼Œæ˜“ä¸¢å¤±ï¼‰\r\n    if message.persistent == false then\r\n        self.memoryQueue:Enqueue(message)\r\n    else\r\n        -- ç­–ç•¥2ï¼šç£ç›˜é˜Ÿåˆ—ï¼ˆå¯é ï¼Œæ€§èƒ½è¾ƒä½ï¼‰\r\n        self.diskQueue:Enqueue(message)\r\n    end\r\nend\r\n```\r\n\r\n#### å¯é æ€§ç­‰çº§\r\n\r\n| ç­‰çº§ | è¯´æ˜ | å®ç°æ–¹å¼ |\r\n|------|------|---------|\r\n| At most once | æœ€å¤šä¸€æ¬¡ | å†…å­˜é˜Ÿåˆ— |\r\n| At least once | è‡³å°‘ä¸€æ¬¡ | ç£ç›˜é˜Ÿåˆ— + é‡è¯• |\r\n| Exactly once | æ°å¥½ä¸€æ¬¡ | ç£ç›˜é˜Ÿåˆ— + å»é‡ |\r\n\r\n### 7. æ–‡æ¡£å®Œå–„å»ºè®®\r\n\r\n**é—®é¢˜**ï¼šç†è®ºè®¾è®¡å®Œæ•´ï¼Œä½†ç¼ºå°‘å®é™…ä½¿ç”¨ç¤ºä¾‹\r\n\r\n**å»ºè®®**ï¼šè¡¥å……å®é™…ä½¿ç”¨ç¤ºä¾‹å’Œæœ€ä½³å®è·µ\r\n\r\n#### ä½¿ç”¨ç¤ºä¾‹\r\n\r\n```lua\r\n-- ç¤ºä¾‹1ï¼šè£…å¤‡ç³»ç»Ÿæ¨é€æ•°æ®ï¼ˆæ¶ˆæ¯é¢‘é“ï¼‰\r\nlocal message = {\r\n    Channel = ChannelType.Message,\r\n    Data = {equipId = 1001, action = \"equip\"}\r\n}\r\nmessageBus:Send(message)\r\n\r\n-- ç¤ºä¾‹2ï¼šæŸ¥è¯¢å•ä½ç­‰çº§ï¼ˆè¯·æ±‚æ•°æ®é¢‘é“ï¼‰\r\nlocal request = {\r\n    Channel = ChannelType.Request,\r\n    Type = \"QueryLevel\",\r\n    Data = {unitId = 1001}\r\n}\r\nlocal response = messageBus:Send(request)\r\nlocal level = response.Data.level\r\n\r\n-- ç¤ºä¾‹3ï¼šå‘å¸ƒäº‹ä»¶ï¼ˆäº‹ä»¶é¢‘é“ï¼‰\r\nlocal event = {\r\n    Channel = ChannelType.Event,\r\n    Type = \"EquipmentEquipped\",\r\n    Data = {equipId = 1001}\r\n}\r\nmessageBus:Send(event)\r\n```\r\n\r\n#### æœ€ä½³å®è·µ\r\n\r\n1. **é¢‘é“é€‰æ‹©**ï¼šæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„é¢‘é“\r\n2. **é”™è¯¯å¤„ç†**ï¼šå®ç°å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶\r\n3. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨æ‰¹é‡å¤„ç†å’Œä¼˜å…ˆçº§é˜Ÿåˆ—\r\n4. **ç›‘æ§è¿½è¸ª**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§å’Œè¿½è¸ªç³»ç»Ÿ\r\n\r\n---\r\n\r\n## ğŸ“Š æ”¹è¿›ä¼˜å…ˆçº§\r\n\r\n| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | å½±å“ | å·¥ä½œé‡ |\r\n|--------|--------|------|--------|\r\n| ğŸ”´ é«˜ | é¢‘é“é€‰æ‹©å†³ç­–æ ‘ | é«˜ | ä½ |\r\n| ğŸŸ¡ ä¸­ | é”™è¯¯å¤„ç†æœºåˆ¶ | ä¸­ | ä¸­ |\r\n| ğŸŸ¡ ä¸­ | æ€§èƒ½ç›‘æ§ç³»ç»Ÿ | ä¸­ | ä¸­ |\r\n| ğŸŸ¢ ä½ | æ¶ˆæ¯æŒä¹…åŒ– | ä½ | é«˜ |\r\n| ğŸŸ¢ ä½ | ä¼˜å…ˆçº§é˜Ÿåˆ— | ä½ | ä¸­ |\r\n\r\n---\r\n\r\n**æœ€åæ›´æ–°**ï¼š2025-01-XX\r\n\r\n"
        }
    ]
}