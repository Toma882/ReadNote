{
    "sourceFile": "游戏编程精粹/1/代码/影响力地图(InfluenceMap).md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 10,
            "patches": [
                {
                    "date": 1764867865300,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1764947491116,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,11 +12,11 @@\n using UnityEngine;\r\n using System.Collections.Generic;\r\n \r\n /// <summary>\r\n-/// 影响力地图单元格\r\n+/// 影响力地图单元格（使用结构体提高性能）\r\n /// </summary>\r\n-public class InfluenceCell\r\n+public struct InfluenceCell\r\n {\r\n     public Vector2Int position;      // 单元格位置\r\n     public float influence;          // 影响力值（正数=友方，负数=敌方）\r\n     public float desirability;       // 合意值（综合评估）\r\n"
                },
                {
                    "date": 1764947498463,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -98,11 +98,12 @@\n             if (Mathf.Abs(influence) < 0.01f)\r\n                 continue;\r\n             \r\n             // 更新单元格影响力（累加）\r\n-            InfluenceCell cell = GetCell(pos);\r\n-            if (cell != null)\r\n+            // 注意：结构体是值类型，需要直接修改数组元素，不能获取副本\r\n+            if (IsValidPosition(pos))\r\n             {\r\n+                ref InfluenceCell cell = ref GetCellRef(pos);\r\n                 cell.influence += influence;\r\n             }\r\n             \r\n             // 传播到邻居\r\n"
                },
                {
                    "date": 1764947516362,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -54,8 +54,24 @@\n                 cells[x, y] = new InfluenceCell(new Vector2Int(x, y));\r\n             }\r\n         }\r\n     }\r\n+    \r\n+    /// <summary>\r\n+    /// 获取单元格引用（用于修改结构体）\r\n+    /// </summary>\r\n+    public ref InfluenceCell GetCellRef(Vector2Int pos)\r\n+    {\r\n+        return ref cells[pos.x, pos.y];\r\n+    }\r\n+    \r\n+    /// <summary>\r\n+    /// 检查位置是否有效\r\n+    /// </summary>\r\n+    public bool IsValidPosition(Vector2Int pos)\r\n+    {\r\n+        return pos.x >= 0 && pos.x < width && pos.y >= 0 && pos.y < height;\r\n+    }\r\n }\r\n ```\r\n \r\n ## 影响力传播算法\r\n"
                },
                {
                    "date": 1764947540435,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -64,8 +64,18 @@\n         return ref cells[pos.x, pos.y];\r\n     }\r\n     \r\n     /// <summary>\r\n+    /// 获取单元格（用于读取，返回值类型副本）\r\n+    /// </summary>\r\n+    public InfluenceCell GetCell(Vector2Int pos)\r\n+    {\r\n+        if (IsValidPosition(pos))\r\n+            return cells[pos.x, pos.y];\r\n+        return default(InfluenceCell);\r\n+    }\r\n+    \r\n+    /// <summary>\r\n     /// 检查位置是否有效\r\n     /// </summary>\r\n     public bool IsValidPosition(Vector2Int pos)\r\n     {\r\n"
                },
                {
                    "date": 1764947550192,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -208,12 +208,13 @@\n         {\r\n             for (int y = -searchRadius; y <= searchRadius; y++)\r\n             {\r\n                 Vector2Int cellPos = target + new Vector2Int(x, y);\r\n-                InfluenceCell cell = GetCell(cellPos);\r\n                 \r\n-                if (cell != null)\r\n+                // 结构体不能为null，需要检查位置是否有效\r\n+                if (IsValidPosition(cellPos))\r\n                 {\r\n+                    InfluenceCell cell = GetCell(cellPos);\r\n                     float desirability = CalculateDesirability(cell, target);\r\n                     if (desirability > bestDesirability)\r\n                     {\r\n                         bestDesirability = desirability;\r\n"
                },
                {
                    "date": 1764947570875,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -91,8 +91,15 @@\n /// 影响力传播：从源点向外传播影响力\r\n /// </summary>\r\n public class InfluencePropagation\r\n {\r\n+    private InfluenceMap influenceMap;  // 需要访问影响力地图\r\n+    \r\n+    public InfluencePropagation(InfluenceMap map)\r\n+    {\r\n+        influenceMap = map;\r\n+    }\r\n+    \r\n     /// <summary>\r\n     /// 添加影响力源（单位、建筑等）\r\n     /// </summary>\r\n     public void AddInfluenceSource(Vector2Int position, float strength, bool isFriendly)\r\n"
                },
                {
                    "date": 1764947578616,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -132,11 +132,11 @@\n                 continue;\r\n             \r\n             // 更新单元格影响力（累加）\r\n             // 注意：结构体是值类型，需要直接修改数组元素，不能获取副本\r\n-            if (IsValidPosition(pos))\r\n+            if (influenceMap.IsValidPosition(pos))\r\n             {\r\n-                ref InfluenceCell cell = ref GetCellRef(pos);\r\n+                ref InfluenceCell cell = ref influenceMap.GetCellRef(pos);\r\n                 cell.influence += influence;\r\n             }\r\n             \r\n             // 传播到邻居\r\n"
                },
                {
                    "date": 1764947595578,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -181,8 +181,15 @@\n /// 合意值计算：综合评估单元格的吸引力\r\n /// </summary>\r\n public class DesirabilityCalculator\r\n {\r\n+    private InfluenceMap influenceMap;  // 需要访问影响力地图\r\n+    \r\n+    public DesirabilityCalculator(InfluenceMap map)\r\n+    {\r\n+        influenceMap = map;\r\n+    }\r\n+    \r\n     /// <summary>\r\n     /// 计算合意值：综合考虑多个因素\r\n     /// </summary>\r\n     public float CalculateDesirability(InfluenceCell cell, Vector2Int target)\r\n"
                },
                {
                    "date": 1764947630639,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -224,11 +224,11 @@\n             {\r\n                 Vector2Int cellPos = target + new Vector2Int(x, y);\r\n                 \r\n                 // 结构体不能为null，需要检查位置是否有效\r\n-                if (IsValidPosition(cellPos))\r\n+                if (influenceMap.IsValidPosition(cellPos))\r\n                 {\r\n-                    InfluenceCell cell = GetCell(cellPos);\r\n+                    InfluenceCell cell = influenceMap.GetCell(cellPos);\r\n                     float desirability = CalculateDesirability(cell, target);\r\n                     if (desirability > bestDesirability)\r\n                     {\r\n                         bestDesirability = desirability;\r\n@@ -260,9 +260,9 @@\n     \r\n     void Start()\r\n     {\r\n         influenceMap = new InfluenceMap(mapWidth, mapHeight, cellSize);\r\n-        propagation = new InfluencePropagation();\r\n+        propagation = new InfluencePropagation(influenceMap);\r\n     }\r\n     \r\n     /// <summary>\r\n     /// 添加单位影响力\r\n"
                },
                {
                    "date": 1764947646473,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -303,8 +303,12 @@\n ```\r\n \r\n ## 性能优化\r\n \r\n+- **使用结构体**：`InfluenceCell` 使用结构体而非类，减少GC压力，提高内存访问效率\r\n+  - 结构体在数组中内联存储，更好的缓存局部性\r\n+  - 减少堆分配和垃圾回收\r\n+  - 适合小数据、频繁访问的场景\r\n - **空间分割**：使用四叉树或网格优化影响力传播\r\n - **增量更新**：只更新变化区域的影响力\r\n - **LOD系统**：远距离使用低精度影响力地图\r\n \r\n"
                }
            ],
            "date": 1764867865300,
            "name": "Commit-0",
            "content": "# 影响力地图（Influence Map）- C#实现\r\n\r\n## 核心概念\r\n\r\n- **定义**：影响力地图用于AI决策，表示地图上各区域的重要性\r\n- **核心思想**：每个单位/建筑在地图上产生影响力，影响力会传播和衰减\r\n- **应用场景**：RTS游戏中的战略决策、单位部署、资源点选择\r\n\r\n## 基础数据结构\r\n\r\n```csharp\r\nusing UnityEngine;\r\nusing System.Collections.Generic;\r\n\r\n/// <summary>\r\n/// 影响力地图单元格\r\n/// </summary>\r\npublic class InfluenceCell\r\n{\r\n    public Vector2Int position;      // 单元格位置\r\n    public float influence;          // 影响力值（正数=友方，负数=敌方）\r\n    public float desirability;       // 合意值（综合评估）\r\n    \r\n    public InfluenceCell(Vector2Int pos)\r\n    {\r\n        position = pos;\r\n        influence = 0f;\r\n        desirability = 0f;\r\n    }\r\n}\r\n\r\n/// <summary>\r\n/// 影响力地图：管理整个地图的影响力分布\r\n/// </summary>\r\npublic class InfluenceMap\r\n{\r\n    private InfluenceCell[,] cells;  // 地图单元格\r\n    private int width;\r\n    private int height;\r\n    private float cellSize;          // 单元格大小\r\n    \r\n    public InfluenceMap(int width, int height, float cellSize)\r\n    {\r\n        this.width = width;\r\n        this.height = height;\r\n        this.cellSize = cellSize;\r\n        cells = new InfluenceCell[width, height];\r\n        \r\n        // 初始化所有单元格\r\n        for (int x = 0; x < width; x++)\r\n        {\r\n            for (int y = 0; y < height; y++)\r\n            {\r\n                cells[x, y] = new InfluenceCell(new Vector2Int(x, y));\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n## 影响力传播算法\r\n\r\n```csharp\r\n/// <summary>\r\n/// 影响力传播：从源点向外传播影响力\r\n/// </summary>\r\npublic class InfluencePropagation\r\n{\r\n    /// <summary>\r\n    /// 添加影响力源（单位、建筑等）\r\n    /// </summary>\r\n    public void AddInfluenceSource(Vector2Int position, float strength, bool isFriendly)\r\n    {\r\n        // 影响力值：正数=友方，负数=敌方\r\n        float influenceValue = isFriendly ? strength : -strength;\r\n        \r\n        // 从源点向外传播\r\n        PropagateInfluence(position, influenceValue, GetDecayFunction());\r\n    }\r\n    \r\n    /// <summary>\r\n    /// 传播影响力（使用衰减函数）\r\n    /// </summary>\r\n    private void PropagateInfluence(Vector2Int source, float strength, System.Func<float, float> decayFunc)\r\n    {\r\n        // 使用广度优先搜索传播影响力\r\n        Queue<(Vector2Int pos, float influence, int distance)> queue = new Queue<(Vector2Int, float, int)>();\r\n        HashSet<Vector2Int> visited = new HashSet<Vector2Int>();\r\n        \r\n        queue.Enqueue((source, strength, 0));\r\n        visited.Add(source);\r\n        \r\n        while (queue.Count > 0)\r\n        {\r\n            var (pos, influence, distance) = queue.Dequeue();\r\n            \r\n            // 如果影响力太小，停止传播\r\n            if (Mathf.Abs(influence) < 0.01f)\r\n                continue;\r\n            \r\n            // 更新单元格影响力（累加）\r\n            InfluenceCell cell = GetCell(pos);\r\n            if (cell != null)\r\n            {\r\n                cell.influence += influence;\r\n            }\r\n            \r\n            // 传播到邻居\r\n            foreach (Vector2Int neighbor in GetNeighbors(pos))\r\n            {\r\n                if (visited.Contains(neighbor))\r\n                    continue;\r\n                \r\n                // 计算衰减后的影响力\r\n                float newInfluence = decayFunc(influence);\r\n                int newDistance = distance + 1;\r\n                \r\n                queue.Enqueue((neighbor, newInfluence, newDistance));\r\n                visited.Add(neighbor);\r\n            }\r\n        }\r\n    }\r\n    \r\n    /// <summary>\r\n    /// 衰减函数：线性衰减\r\n    /// </summary>\r\n    private System.Func<float, float> GetDecayFunction()\r\n    {\r\n        float decayRate = 0.8f;  // 每步衰减20%\r\n        return (influence) => influence * decayRate;\r\n    }\r\n    \r\n    /// <summary>\r\n    /// 衰减函数：指数衰减\r\n    /// </summary>\r\n    private System.Func<float, float> GetExponentialDecay(float decayFactor)\r\n    {\r\n        return (influence) => influence * Mathf.Exp(-decayFactor);\r\n    }\r\n}\r\n```\r\n\r\n## 合意值计算\r\n\r\n```csharp\r\n/// <summary>\r\n/// 合意值计算：综合评估单元格的吸引力\r\n/// </summary>\r\npublic class DesirabilityCalculator\r\n{\r\n    /// <summary>\r\n    /// 计算合意值：综合考虑多个因素\r\n    /// </summary>\r\n    public float CalculateDesirability(InfluenceCell cell, Vector2Int target)\r\n    {\r\n        float desirability = 0f;\r\n        \r\n        // 1. 影响力因素（友方区域更合意）\r\n        desirability += cell.influence * 0.5f;\r\n        \r\n        // 2. 距离因素（距离目标越近越合意）\r\n        float distance = Vector2Int.Distance(cell.position, target);\r\n        desirability += (1f / (1f + distance)) * 0.3f;\r\n        \r\n        // 3. 地形因素（可通行区域更合意）\r\n        if (IsWalkable(cell.position))\r\n            desirability += 0.2f;\r\n        \r\n        return desirability;\r\n    }\r\n    \r\n    /// <summary>\r\n    /// 找到最合意的单元格\r\n    /// </summary>\r\n    public Vector2Int FindBestCell(Vector2Int target, int searchRadius)\r\n    {\r\n        Vector2Int bestCell = target;\r\n        float bestDesirability = float.MinValue;\r\n        \r\n        for (int x = -searchRadius; x <= searchRadius; x++)\r\n        {\r\n            for (int y = -searchRadius; y <= searchRadius; y++)\r\n            {\r\n                Vector2Int cellPos = target + new Vector2Int(x, y);\r\n                InfluenceCell cell = GetCell(cellPos);\r\n                \r\n                if (cell != null)\r\n                {\r\n                    float desirability = CalculateDesirability(cell, target);\r\n                    if (desirability > bestDesirability)\r\n                    {\r\n                        bestDesirability = desirability;\r\n                        bestCell = cellPos;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        \r\n        return bestCell;\r\n    }\r\n}\r\n```\r\n\r\n## Unity应用示例\r\n\r\n```csharp\r\n/// <summary>\r\n/// Unity中使用影响力地图\r\n/// </summary>\r\npublic class InfluenceMapUnity : MonoBehaviour\r\n{\r\n    public int mapWidth = 100;\r\n    public int mapHeight = 100;\r\n    public float cellSize = 1f;\r\n    \r\n    private InfluenceMap influenceMap;\r\n    private InfluencePropagation propagation;\r\n    \r\n    void Start()\r\n    {\r\n        influenceMap = new InfluenceMap(mapWidth, mapHeight, cellSize);\r\n        propagation = new InfluencePropagation();\r\n    }\r\n    \r\n    /// <summary>\r\n    /// 添加单位影响力\r\n    /// </summary>\r\n    public void AddUnitInfluence(Vector3 worldPos, float strength, bool isFriendly)\r\n    {\r\n        Vector2Int gridPos = WorldToGrid(worldPos);\r\n        propagation.AddInfluenceSource(gridPos, strength, isFriendly);\r\n    }\r\n    \r\n    /// <summary>\r\n    /// 获取最佳部署位置\r\n    /// </summary>\r\n    public Vector3 GetBestDeploymentPosition(Vector3 targetPos)\r\n    {\r\n        Vector2Int targetGrid = WorldToGrid(targetPos);\r\n        Vector2Int bestGrid = FindBestCell(targetGrid, 10);\r\n        return GridToWorld(bestGrid);\r\n    }\r\n    \r\n    private Vector2Int WorldToGrid(Vector3 worldPos)\r\n    {\r\n        return new Vector2Int(\r\n            Mathf.FloorToInt(worldPos.x / cellSize),\r\n            Mathf.FloorToInt(worldPos.z / cellSize)\r\n        );\r\n    }\r\n    \r\n    private Vector3 GridToWorld(Vector2Int gridPos)\r\n    {\r\n        return new Vector3(\r\n            gridPos.x * cellSize,\r\n            0f,\r\n            gridPos.y * cellSize\r\n        );\r\n    }\r\n}\r\n```\r\n\r\n## 性能优化\r\n\r\n- **空间分割**：使用四叉树或网格优化影响力传播\r\n- **增量更新**：只更新变化区域的影响力\r\n- **LOD系统**：远距离使用低精度影响力地图\r\n\r\n"
        }
    ]
}