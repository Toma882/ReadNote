# æ¶æ„å›¾è¡¨é›†åˆ

> åŸºäºã€Šè½¯ä»¶æ¶æ„è®¾è®¡ï¼ˆæ¸©æ˜±ï¼‰ã€‹å’Œ TBBattle é¡¹ç›®å®è·µç”Ÿæˆçš„æ¶æ„å›¾è¡¨

---

## ğŸ“‹ ç›®å½•

1. [ä»£ç å›¾](#1-ä»£ç å›¾)
2. [UMLå›¾](#2-umlå›¾)
3. [åŒ…å›¾](#3-åŒ…å›¾)
4. [ç”˜ç‰¹å›¾](#4-ç”˜ç‰¹å›¾)
5. [æ—¶åºå›¾](#5-æ—¶åºå›¾)
6. [åä½œå›¾](#6-åä½œå›¾)
7. [çŠ¶æ€å›¾](#7-çŠ¶æ€å›¾)

---

## 1. ä»£ç å›¾

### 1.1 UnitData ä»£ç ç»“æ„å›¾

```mermaid
graph TB
    subgraph UnitData["UnitData ç±»ç»“æ„"]
        direction TB
        Base[AttributeSet<br/>åŸºç±»]
        Main[UnitData<br/>ä¸»æ§åˆ¶å™¨]
        
        Base -->|ç»§æ‰¿| Main
        
        subgraph SubSystems["13ä¸ªå­ç³»ç»Ÿ"]
            direction LR
            Equip[UnitEquipData]
            Feat[UnitFeatData]
            Skill[UnitSkillData]
            State[UnitStateData]
            Ability[UnitAbilityData]
            AI[UnitAIData]
            Turn[UnitTurnData]
            Tactics[UnitTacticsData]
            Grid[UnitGridData]
            Dialogue[UnitDialogueData]
            Merchant[UnitMerchantData]
            Task[UnitTaskDisPatcherData]
            Item[UnitItemData]
        end
        
        Main -->|ç»„åˆ| SubSystems
        Main -->|ä½¿ç”¨| Queue[DataHandleQueue<br/>æ•°æ®é©±åŠ¨å±‚]
        SubSystems -->|æ³¨å†Œåˆ°| Queue
    end
    
    style Main fill:#ff6b6b,stroke:#333,stroke-width:3px
    style Base fill:#4ecdc4,stroke:#333,stroke-width:2px
    style Queue fill:#95e1d3,stroke:#333,stroke-width:2px
```

### 1.2 ä»£ç è°ƒç”¨å…³ç³»å›¾

```mermaid
graph LR
    Client[å®¢æˆ·ç«¯ä»£ç ] -->|è°ƒç”¨| UnitData[UnitData]
    UnitData -->|ç»§æ‰¿| AttributeSet[AttributeSet]
    UnitData -->|ä½¿ç”¨| Queue[DataHandleQueue]
    UnitData -->|ç»„åˆ| SubSystems[13ä¸ªå­ç³»ç»Ÿ]
    
    SubSystems -->|æ³¨å†ŒHandler| Queue
    Queue -->|åˆ†å‘æ•°æ®| SubSystems
    
    UnitData -->|è°ƒç”¨| GetAttr[GetAttribute]
    GetAttr -->|éå†| SubSystems
    SubSystems -->|è¿”å›| GetAttr
    GetAttr -->|è¿”å›| Client
    
    style UnitData fill:#ff6b6b,stroke:#333,stroke-width:3px
    style Queue fill:#95e1d3,stroke:#333,stroke-width:2px
```

---

## 2. UMLå›¾

### 2.1 ç±»å›¾ï¼ˆClass Diagramï¼‰

#### UnitData ç±»å›¾

```mermaid
classDiagram
    class AttributeSet {
        +attrDict: table
        +baseAttrDict: table
        +isDirty: boolean
        +GetAttribute(attrId): number
        +MarkDirty(): void
        +IsDirty(): boolean
        +UpdateAllAttribute(): void
    }
    
    class UnitData {
        -unitId: number
        -level: number
        -exp: number
        -cfg: CfgClass
        -dataHandleQueue: DataHandleQueue
        -equipData: UnitEquipData
        -skillData: UnitSkillData
        -stateData: UnitStateData
        -featData: UnitFeatData
        -subDataList: table
        +GetAttribute(attrId): number
        +AddLevel(level): void
        +AddExp(exp): void
        +IsAlive(): boolean
        +GetCfg(): CfgClass
        +Start(): void
        +OnEnable(): void
        +OnDisable(): void
        +OnDestroy(): void
    }
    
    class DataHandleQueue {
        -handlerMapping: table
        -queryDelegateMapping: table
        +PushData(dataType, data): void
        +ProcessDataHandler(): void
        +AddHandler(handler): void
        +SetQueryDelegate(dataType, func): void
        +ProcessQueryDelegate(dataType, ...): any
    }
    
    class UnitEquipData {
        +GetAttribute(attrId): number
        +GetLevelBonus(attrId): number
        +GetPercentBonus(attrId): number
        +HasEquip(equipId): boolean
    }
    
    class UnitSkillData {
        +GetAttribute(attrId): number
        +GetSkill(skillId): SkillData
    }
    
    class UnitStateData {
        +GetAttribute(attrId): number
    }
    
    AttributeSet <|-- UnitData : ç»§æ‰¿
    UnitData *-- DataHandleQueue : ç»„åˆ
    UnitData *-- UnitEquipData : ç»„åˆ
    UnitData *-- UnitSkillData : ç»„åˆ
    UnitData *-- UnitStateData : ç»„åˆ
    DataHandleQueue ..> UnitEquipData : æ³¨å†ŒHandler
    DataHandleQueue ..> UnitSkillData : æ³¨å†ŒHandler
    DataHandleQueue ..> UnitStateData : æ³¨å†ŒHandler
```

### 2.2 ç»„ä»¶å›¾ï¼ˆComponent Diagramï¼‰

#### TBBattle ç³»ç»Ÿç»„ä»¶å›¾

```mermaid
graph TB
    subgraph Presentation["è¡¨ç°å±‚ï¼ˆUnity C#ï¼‰"]
        direction TB
        Unity[Unity Engine]
        TopDown[TopDownEngine]
        MonoLifecycle[MonoLifecycle<br/>ç”Ÿå‘½å‘¨æœŸæ¡¥æ¥]
    end
    
    subgraph Business["ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆLuaï¼‰"]
        direction TB
        Unit[Unit System]
        Skill[Skill System]
        Effect[Effect System]
        Interaction[Interaction System]
        Visual[Visual System]
    end
    
    subgraph Infrastructure["åŸºç¡€è®¾æ–½å±‚ï¼ˆLuaï¼‰"]
        direction TB
        Queue[DataHandleQueue]
        Formula[Formula Parser]
        FSM[FSM System]
        Pool[Pool System]
    end
    
    subgraph Data["æ•°æ®é…ç½®å±‚"]
        direction TB
        Excel[Excel é…ç½®è¡¨]
        JSON[JSON é…ç½®æ–‡ä»¶]
        LuaConfig[Lua é…ç½®è„šæœ¬]
    end
    
    Presentation -->|è°ƒç”¨| Business
    Business -->|ä½¿ç”¨| Infrastructure
    Business -->|è¯»å–| Data
    Infrastructure -->|è¯»å–| Data
    
    style Presentation fill:#e1f5ff
    style Business fill:#fff9c4
    style Infrastructure fill:#c8e6c9
    style Data fill:#ffccbc
```

---

## 3. åŒ…å›¾

### 3.1 TBBattle åŒ…ç»“æ„å›¾

```mermaid
graph TB
    subgraph TBBattle["TBBattle é¡¹ç›®"]
        direction TB
        
        subgraph CSharp["Assets/Scripts/Toma/ (C# åŸºç¡€è®¾æ–½)"]
            direction LR
            Loader[Loader System]
            GridSystem[GridSystem]
            Pathfinding[Pathfinding]
            Lifecycle[Lifecycle]
            Common[Common Tools]
        end
        
        subgraph Lua["LocalFile/Lua/Game/ (Lua ä¸šåŠ¡é€»è¾‘)"]
            direction TB
            
            subgraph Gamecore["gamecore/ (æ ¸å¿ƒç³»ç»Ÿ)"]
                direction LR
                Unit[Unit System]
                Skill[Skill System]
                Effect[Effect System]
                Interaction[Interaction System]
            end
            
            subgraph Library["lualibrary/ (åŸºç¡€è®¾æ–½åº“)"]
                direction LR
                Core[core/]
                Pattern[Pattern/]
                DataStructure[DataStructure/]
                FSM[FSM/]
                Pool[Pool/]
            end
        end
        
        subgraph Config["Config/ (é…ç½®æ•°æ®)"]
            direction LR
            Excel[Excel é…ç½®è¡¨]
            JSON[JSON é…ç½®æ–‡ä»¶]
        end
    end
    
    CSharp -->|æ¡¥æ¥| Lua
    Lua -->|è¯»å–| Config
    
    style CSharp fill:#e1f5ff
    style Lua fill:#fff9c4
    style Config fill:#ffccbc
```

### 3.2 Unit ç³»ç»ŸåŒ…å›¾

```mermaid
graph TB
    subgraph UnitPackage["gamecore/ui/Unit/"]
        direction TB
        
        UnitData[UnitData.lua<br/>ä¸»æ§åˆ¶å™¨]
        
        subgraph SubData["å­ç³»ç»Ÿæ•°æ®åŒ…"]
            direction LR
            UnitEquipData[UnitEquipData.lua]
            UnitSkillData[UnitSkillData.lua]
            UnitStateData[UnitStateData.lua]
            UnitFeatData[UnitFeatData.lua]
            UnitAIData[UnitAIData.lua]
            UnitTurnData[UnitTurnData.lua]
            UnitTacticsData[UnitTacticsData.lua]
            UnitGridData[UnitGridData.lua]
            UnitDialogueData[UnitDialogueData.lua]
            UnitMerchantData[UnitMerchantData.lua]
            UnitTaskDisPatcherData[UnitTaskDisPatcherData.lua]
            UnitItemData[UnitItemData.lua]
            UnitAbilityData[UnitAbilityData.lua]
            UnitRelationData[UnitRelationData.lua]
        end
        
        UnitData -->|ç»„åˆ| SubData
    end
    
    subgraph AttributePackage["gamecore/ui/Attribute/"]
        AttributeSet[AttributeSet.lua<br/>åŸºç±»]
    end
    
    subgraph QueuePackage["gamecore/ui/DataHandle/"]
        DataHandleQueue[DataHandleQueue.lua<br/>æ•°æ®é©±åŠ¨å±‚]
    end
    
    AttributeSet -->|ç»§æ‰¿| UnitData
    UnitData -->|ä½¿ç”¨| DataHandleQueue
    SubData -->|æ³¨å†Œåˆ°| DataHandleQueue
    
    style UnitData fill:#ff6b6b,stroke:#333,stroke-width:3px
    style AttributeSet fill:#4ecdc4,stroke:#333,stroke-width:2px
    style DataHandleQueue fill:#95e1d3,stroke:#333,stroke-width:2px
```

---

## 4. ç”˜ç‰¹å›¾

### 4.1 è½¯ä»¶æ¶æ„è®¾è®¡è¿‡ç¨‹ç”˜ç‰¹å›¾

```mermaid
gantt
    title è½¯ä»¶æ¶æ„è®¾è®¡è¿‡ç¨‹ç”˜ç‰¹å›¾
    dateFormat YYYY-MM-DD
    section éœ€æ±‚åˆ†æ
    éœ€æ±‚æ•è·           :a1, 2024-01-01, 5d
    éœ€æ±‚åˆ†æ           :a2, after a1, 5d
    éœ€æ±‚éªŒè¯           :a3, after a2, 3d
    
    section é¢†åŸŸå»ºæ¨¡
    é¢†åŸŸæ¦‚å¿µè¯†åˆ«       :b1, after a3, 5d
    é¢†åŸŸå…³ç³»å»ºæ¨¡       :b2, after b1, 5d
    é¢†åŸŸæ¨¡å‹éªŒè¯       :b3, after b2, 3d
    
    section å…³é”®éœ€æ±‚ç¡®å®š
    åŠŸèƒ½éœ€æ±‚åˆ†æ       :c1, after b3, 3d
    è´¨é‡éœ€æ±‚åˆ†æ       :c2, after c1, 3d
    çº¦æŸéœ€æ±‚åˆ†æ       :c3, after c2, 2d
    
    section æ¦‚å¿µæ¶æ„è®¾è®¡
    å­ç³»ç»Ÿåˆ’åˆ†         :d1, after c3, 5d
    æ¶æ„é£æ ¼é€‰æ‹©       :d2, after d1, 3d
    æŠ€æœ¯é€‰å‹           :d3, after d2, 5d
    
    section ç»†åŒ–æ¶æ„è®¾è®¡
    é€»è¾‘æ¶æ„è®¾è®¡       :e1, after d3, 5d
    å¼€å‘æ¶æ„è®¾è®¡       :e2, after e1, 5d
    è¿è¡Œæ¶æ„è®¾è®¡       :e3, after e2, 5d
    ç‰©ç†æ¶æ„è®¾è®¡       :e4, after e3, 3d
    æ•°æ®æ¶æ„è®¾è®¡       :e5, after e4, 5d
    
    section æ¶æ„éªŒè¯
    æ¶æ„åŸå‹å¼€å‘       :f1, after e5, 10d
    æ¶æ„éªŒè¯æµ‹è¯•       :f2, after f1, 5d
    æ¶æ„æ–‡æ¡£å®Œå–„       :f3, after f2, 3d
```

### 4.2 UnitData ç³»ç»Ÿå¼€å‘ç”˜ç‰¹å›¾

```mermaid
gantt
    title UnitData ç³»ç»Ÿå¼€å‘ç”˜ç‰¹å›¾
    dateFormat YYYY-MM-DD
    section åŸºç¡€æ¶æ„
    AttributeSet åŸºç±»è®¾è®¡    :a1, 2024-01-01, 3d
    DataHandleQueue è®¾è®¡     :a2, after a1, 5d
    
    section æ ¸å¿ƒç³»ç»Ÿ
    UnitData ä¸»æ§åˆ¶å™¨        :b1, after a2, 5d
    è£…å¤‡ç³»ç»Ÿå®ç°            :b2, after b1, 5d
    æŠ€èƒ½ç³»ç»Ÿå®ç°            :b3, after b2, 5d
    çŠ¶æ€ç³»ç»Ÿå®ç°            :b4, after b3, 5d
    
    section æ‰©å±•ç³»ç»Ÿ
    ä¸“é•¿ç³»ç»Ÿå®ç°            :c1, after b4, 3d
    AIç³»ç»Ÿå®ç°             :c2, after c1, 5d
    å›åˆç³»ç»Ÿå®ç°            :c3, after c2, 3d
    å…¶ä»–å­ç³»ç»Ÿå®ç°          :c4, after c3, 10d
    
    section é›†æˆæµ‹è¯•
    å•å…ƒæµ‹è¯•               :d1, after c4, 5d
    é›†æˆæµ‹è¯•               :d2, after d1, 5d
    æ€§èƒ½æµ‹è¯•               :d3, after d2, 3d
```

---

## 5. æ—¶åºå›¾

### 5.1 UnitData å±æ€§è·å–æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant UnitData as UnitData
    participant AttributeSet as AttributeSet
    participant Queue as DataHandleQueue
    participant EquipData as UnitEquipData
    participant SkillData as UnitSkillData
    participant StateData as UnitStateData
    
    Client->>UnitData: GetAttribute(Strength)
    
    alt éœ€è¦æ›´æ–°å±æ€§
        UnitData->>AttributeSet: IsDirty()
        AttributeSet-->>UnitData: true
        UnitData->>AttributeSet: UpdateAllAttribute()
        AttributeSet-->>UnitData: æ›´æ–°å®Œæˆ
    end
    
    UnitData->>AttributeSet: GetAttribute(Strength)
    AttributeSet-->>UnitData: baseValue = 10
    
    loop éå†æ‰€æœ‰å­ç³»ç»Ÿ
        UnitData->>EquipData: GetAttribute(Strength)
        EquipData-->>UnitData: +5 (è£…å¤‡åŠ æˆ)
        
        UnitData->>EquipData: GetLevelBonus(Strength)
        EquipData-->>UnitData: +0.5/çº§
        
        UnitData->>SkillData: GetAttribute(Strength)
        SkillData-->>UnitData: +2 (æŠ€èƒ½åŠ æˆ)
        
        UnitData->>StateData: GetAttribute(Strength)
        StateData-->>UnitData: +3 (çŠ¶æ€åŠ æˆ)
    end
    
    UnitData->>UnitData: è®¡ç®—æœ€ç»ˆå€¼
    Note over UnitData: baseValue + levelBonus + percentBonus
    UnitData-->>Client: è¿”å›æœ€ç»ˆå±æ€§å€¼
```

### 5.2 è£…å¤‡å˜æ›´æ•°æ®æµæ—¶åºå›¾

```mermaid
sequenceDiagram
    participant EquipSystem as è£…å¤‡ç³»ç»Ÿ
    participant Queue as DataHandleQueue
    participant UnitData as UnitData
    participant EquipData as UnitEquipData
    participant AttributeSet as AttributeSet
    
    EquipSystem->>Queue: PushData(Equipment.Change, {equipId=101})
    Note over Queue: æ•°æ®å…¥é˜Ÿï¼Œç­‰å¾…å¤„ç†
    
    EquipSystem->>Queue: ProcessDataHandler()
    
    Queue->>EquipData: ProcessDataHandler(Equipment.Change, data)
    Note over EquipData: å¤„ç†è£…å¤‡å˜æ›´é€»è¾‘
    
    EquipData->>EquipData: æ›´æ–°è£…å¤‡æ•°æ®
    EquipData->>AttributeSet: MarkDirty()
    Note over AttributeSet: æ ‡è®°å±æ€§éœ€è¦æ›´æ–°
    
    EquipData-->>Queue: å¤„ç†å®Œæˆ
    
    Note over UnitData: ä¸‹æ¬¡GetAttributeæ—¶<br/>è‡ªåŠ¨é‡æ–°è®¡ç®—å±æ€§
```

### 5.3 UnitData ç”Ÿå‘½å‘¨æœŸæ—¶åºå›¾

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant UnitData as UnitData
    participant EquipData as UnitEquipData
    participant SkillData as UnitSkillData
    participant StateData as UnitStateData
    
    Client->>UnitData: New(unitId)
    UnitData->>UnitData: åˆå§‹åŒ–æ‰€æœ‰å­ç³»ç»Ÿ
    UnitData->>EquipData: New(self)
    UnitData->>SkillData: New(self)
    UnitData->>StateData: New(self)
    UnitData-->>Client: åˆ›å»ºå®Œæˆ
    
    Client->>UnitData: Start()
    UnitData->>UnitData: LiftcycleDispatch("Start")
    UnitData->>EquipData: Start()
    UnitData->>SkillData: Start()
    UnitData->>StateData: Start()
    
    Client->>UnitData: OnEnable()
    UnitData->>UnitData: LiftcycleDispatch("OnEnable")
    UnitData->>EquipData: OnEnable()
    UnitData->>SkillData: OnEnable()
    UnitData->>StateData: OnEnable()
    
    Client->>UnitData: OnDisable()
    UnitData->>UnitData: LiftcycleDispatch("OnDisable")
    UnitData->>EquipData: OnDisable()
    UnitData->>SkillData: OnDisable()
    UnitData->>StateData: OnDisable()
    
    Client->>UnitData: OnDestroy()
    UnitData->>UnitData: LiftcycleDispatch("OnDestroy")
    UnitData->>EquipData: OnDestroy()
    UnitData->>SkillData: OnDestroy()
    UnitData->>StateData: OnDestroy()
```

---

## 6. åä½œå›¾

### 6.1 UnitData ç³»ç»Ÿåä½œå›¾

```mermaid
graph TB
    Client[å®¢æˆ·ç«¯]
    UnitData[UnitData<br/>ä¸»æ§åˆ¶å™¨]
    AttributeSet[AttributeSet<br/>åŸºç±»]
    Queue[DataHandleQueue<br/>æ•°æ®é©±åŠ¨å±‚]
    
    subgraph SubSystems["13ä¸ªå­ç³»ç»Ÿ"]
        EquipData[UnitEquipData]
        SkillData[UnitSkillData]
        StateData[UnitStateData]
        FeatData[UnitFeatData]
    end
    
    Client -->|1: GetAttribute| UnitData
    UnitData -->|2: ç»§æ‰¿| AttributeSet
    UnitData -->|3: ä½¿ç”¨| Queue
    UnitData -->|4: ç»„åˆ| SubSystems
    
    SubSystems -->|5: æ³¨å†ŒHandler| Queue
    Queue -->|6: åˆ†å‘æ•°æ®| SubSystems
    
    UnitData -->|7: éå†å­ç³»ç»Ÿ| SubSystems
    SubSystems -->|8: è¿”å›å±æ€§å€¼| UnitData
    UnitData -->|9: è¿”å›æœ€ç»ˆå€¼| Client
    
    style UnitData fill:#ff6b6b,stroke:#333,stroke-width:3px
    style Queue fill:#95e1d3,stroke:#333,stroke-width:2px
```

### 6.2 æ•°æ®é©±åŠ¨æ¶æ„åä½œå›¾

```mermaid
graph LR
    subgraph Producers["æ•°æ®ç”Ÿäº§è€…"]
        EquipSystem[è£…å¤‡ç³»ç»Ÿ]
        SkillSystem[æŠ€èƒ½ç³»ç»Ÿ]
        StateSystem[çŠ¶æ€ç³»ç»Ÿ]
        EffectSystem[æ•ˆæœç³»ç»Ÿ]
    end
    
    Queue[DataHandleQueue<br/>æ•°æ®é©±åŠ¨å±‚]
    
    subgraph Consumers["æ•°æ®æ¶ˆè´¹è€…"]
        UnitData[UnitData]
        EquipData[UnitEquipData]
        SkillData[UnitSkillData]
        StateData[UnitStateData]
    end
    
    Producers -->|1: PushData| Queue
    Queue -->|2: ProcessDataHandler| Consumers
    Consumers -->|3: å¤„ç†æ•°æ®| Consumers
    Consumers -->|4: æ›´æ–°çŠ¶æ€| Consumers
    
    style Queue fill:#95e1d3,stroke:#333,stroke-width:3px
```

---

## 7. çŠ¶æ€å›¾

### 7.1 UnitData ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å›¾

```mermaid
stateDiagram-v2
    [*] --> åˆ›å»º: New(unitId)
    åˆ›å»º --> åˆå§‹åŒ–: åˆå§‹åŒ–å­ç³»ç»Ÿ
    åˆå§‹åŒ– --> æ³¨å†Œ: æ³¨å†Œåˆ°DataHandleQueue
    æ³¨å†Œ --> å°±ç»ª: åˆå§‹åŒ–å®Œæˆ
    
    å°±ç»ª --> å¯åŠ¨: Start()
    å¯åŠ¨ --> å¯ç”¨: OnEnable()
    å¯ç”¨ --> è¿è¡Œä¸­: æ­£å¸¸è¿è¡Œ
    
    è¿è¡Œä¸­ --> ç¦ç”¨: OnDisable()
    ç¦ç”¨ --> è¿è¡Œä¸­: OnEnable()
    
    è¿è¡Œä¸­ --> åœæ­¢: åœæ­¢è¿è¡Œ
    åœæ­¢ --> é”€æ¯: OnDestroy()
    é”€æ¯ --> [*]
    
    note right of è¿è¡Œä¸­
        è¿è¡Œä¸­çŠ¶æ€ï¼š
        - å¤„ç†æ•°æ®å˜æ›´
        - è®¡ç®—å±æ€§
        - å“åº”äº‹ä»¶
    end note
```

### 7.2 å±æ€§è®¡ç®—çŠ¶æ€å›¾

```mermaid
stateDiagram-v2
    [*] --> å¹²å‡€: åˆå§‹çŠ¶æ€
    å¹²å‡€ --> è„: MarkDirty()
    è„ --> æ›´æ–°ä¸­: UpdateAllAttribute()
    æ›´æ–°ä¸­ --> å¹²å‡€: æ›´æ–°å®Œæˆ
    
    å¹²å‡€ --> è®¡ç®—ä¸­: GetAttribute()
    è®¡ç®—ä¸­ --> å¹²å‡€: è¿”å›ç»“æœ
    
    è„ --> è®¡ç®—ä¸­: GetAttribute()<br/>è‡ªåŠ¨è§¦å‘æ›´æ–°
    è®¡ç®—ä¸­ --> æ›´æ–°ä¸­: æ£€æµ‹åˆ°è„æ ‡è®°
    æ›´æ–°ä¸­ --> è®¡ç®—ä¸­: æ›´æ–°å®Œæˆ
    è®¡ç®—ä¸­ --> å¹²å‡€: è¿”å›ç»“æœ
    
    note right of æ›´æ–°ä¸­
        æ›´æ–°è¿‡ç¨‹ï¼š
        1. è¯»å–é…ç½®
        2. åˆå¹¶ç­‰çº§å±æ€§
        3. æ›´æ–°baseAttrDict
        4. æ¸…é™¤è„æ ‡è®°
    end note
    
    note right of è®¡ç®—ä¸­
        è®¡ç®—è¿‡ç¨‹ï¼š
        1. è·å–åŸºç¡€å€¼
        2. éå†å­ç³»ç»Ÿ
        3. è®¡ç®—åŠ æˆ
        4. è¿”å›æœ€ç»ˆå€¼
    end note
```

### 7.3 æ•°æ®æµå¤„ç†çŠ¶æ€å›¾

```mermaid
stateDiagram-v2
    [*] --> ç©ºé—²: åˆå§‹çŠ¶æ€
    ç©ºé—² --> æ•°æ®å…¥é˜Ÿ: PushData()
    æ•°æ®å…¥é˜Ÿ --> ç­‰å¾…å¤„ç†: æ•°æ®å·²å…¥é˜Ÿ
    
    ç­‰å¾…å¤„ç† --> å¤„ç†ä¸­: ProcessDataHandler()
    å¤„ç†ä¸­ --> åˆ†å‘æ•°æ®: æŸ¥æ‰¾Handler
    åˆ†å‘æ•°æ® --> å­ç³»ç»Ÿå¤„ç†: è°ƒç”¨Handler
    
    å­ç³»ç»Ÿå¤„ç† --> æ›´æ–°å®Œæˆ: å¤„ç†æˆåŠŸ
    å­ç³»ç»Ÿå¤„ç† --> å¤„ç†å¤±è´¥: å¤„ç†å¼‚å¸¸
    
    æ›´æ–°å®Œæˆ --> ç©ºé—²: å¤„ç†å®Œæˆ
    å¤„ç†å¤±è´¥ --> ç©ºé—²: é”™è¯¯å¤„ç†
    
    note right of å¤„ç†ä¸­
        æ‰¹é‡å¤„ç†ï¼š
        - éå†æ‰€æœ‰Handler
        - æŒ‰ç±»å‹åˆ†å‘
        - ç»Ÿä¸€é”™è¯¯å¤„ç†
    end note
```

---

## 8. å…¶ä»–å¸¸ç”¨å›¾è¡¨

### 8.1 æµç¨‹å›¾ï¼ˆFlowchartï¼‰

#### å±æ€§è®¡ç®—æµç¨‹å›¾

```mermaid
flowchart TD
    Start([å¼€å§‹: GetAttribute]) --> CheckDirty{æ˜¯å¦è„?}
    CheckDirty -->|æ˜¯| Update[UpdateAllAttribute]
    CheckDirty -->|å¦| GetBase[è·å–åŸºç¡€å€¼]
    Update --> GetBase
    GetBase --> Loop[éå†å­ç³»ç»Ÿ]
    Loop --> Equip[è·å–è£…å¤‡åŠ æˆ]
    Equip --> Skill[è·å–æŠ€èƒ½åŠ æˆ]
    Skill --> State[è·å–çŠ¶æ€åŠ æˆ]
    State --> Calc[è®¡ç®—æœ€ç»ˆå€¼]
    Calc --> Return([è¿”å›ç»“æœ])
    
    style Start fill:#e1f5ff
    style Return fill:#c8e6c9
    style Calc fill:#fff9c4
```

### 8.2 é¥¼å›¾ï¼ˆPie Chartï¼‰

#### å­ç³»ç»Ÿå¤æ‚åº¦åˆ†å¸ƒ

```mermaid
pie title UnitData å­ç³»ç»Ÿå¤æ‚åº¦åˆ†å¸ƒ
    "è£…å¤‡ç³»ç»Ÿ" : 20
    "æŠ€èƒ½ç³»ç»Ÿ" : 18
    "çŠ¶æ€ç³»ç»Ÿ" : 15
    "ä¸“é•¿ç³»ç»Ÿ" : 12
    "AIç³»ç»Ÿ" : 10
    "å…¶ä»–ç³»ç»Ÿ" : 25
```

#### æ¶æ„è§†å›¾å…³æ³¨åº¦åˆ†å¸ƒ

```mermaid
pie title æ¶æ„è§†å›¾å…³æ³¨åº¦åˆ†å¸ƒ
    "é€»è¾‘æ¶æ„" : 30
    "å¼€å‘æ¶æ„" : 25
    "è¿è¡Œæ¶æ„" : 20
    "ç‰©ç†æ¶æ„" : 15
    "æ•°æ®æ¶æ„" : 10
```

### 8.3 å®ä½“å…³ç³»å›¾ï¼ˆER Diagramï¼‰

#### UnitData æ•°æ®æ¨¡å‹å…³ç³»å›¾

```mermaid
erDiagram
    UnitData ||--o{ UnitEquipData : "åŒ…å«"
    UnitData ||--o{ UnitSkillData : "åŒ…å«"
    UnitData ||--o{ UnitStateData : "åŒ…å«"
    UnitData ||--o{ UnitFeatData : "åŒ…å«"
    UnitData }o--|| AttributeSet : "ç»§æ‰¿"
    UnitData }o--|| DataHandleQueue : "ä½¿ç”¨"
    UnitData }o--|| CfgClass : "é…ç½®"
    
    UnitEquipData ||--o{ EquipItem : "è£…å¤‡"
    UnitSkillData ||--o{ SkillData : "æŠ€èƒ½"
    UnitStateData ||--o{ StateData : "çŠ¶æ€"
    UnitFeatData ||--o{ FeatData : "ä¸“é•¿"
```

### 8.4 ç”¨æˆ·æ—…ç¨‹å›¾ï¼ˆUser Journeyï¼‰

#### æ¶æ„è®¾è®¡è¿‡ç¨‹ç”¨æˆ·æ—…ç¨‹

```mermaid
journey
    title è½¯ä»¶æ¶æ„è®¾è®¡è¿‡ç¨‹ç”¨æˆ·æ—…ç¨‹
    section éœ€æ±‚åˆ†æ
      éœ€æ±‚æ•è·: 5: æ¶æ„å¸ˆ, ä¸šåŠ¡äººå‘˜
      éœ€æ±‚åˆ†æ: 4: æ¶æ„å¸ˆ
      éœ€æ±‚éªŒè¯: 3: æ¶æ„å¸ˆ, ä¸šåŠ¡äººå‘˜
    section é¢†åŸŸå»ºæ¨¡
      é¢†åŸŸæ¦‚å¿µè¯†åˆ«: 5: æ¶æ„å¸ˆ, é¢†åŸŸä¸“å®¶
      é¢†åŸŸå…³ç³»å»ºæ¨¡: 4: æ¶æ„å¸ˆ
      é¢†åŸŸæ¨¡å‹éªŒè¯: 3: æ¶æ„å¸ˆ, é¢†åŸŸä¸“å®¶
    section æ¶æ„è®¾è®¡
      æ¦‚å¿µæ¶æ„è®¾è®¡: 5: æ¶æ„å¸ˆ
      ç»†åŒ–æ¶æ„è®¾è®¡: 4: æ¶æ„å¸ˆ, å¼€å‘äººå‘˜
      æ¶æ„éªŒè¯: 3: æ¶æ„å¸ˆ, æµ‹è¯•äººå‘˜
```

### 8.5 Git å›¾ï¼ˆGitgraphï¼‰

#### æ¶æ„è®¾è®¡ç‰ˆæœ¬æ¼”è¿›

```mermaid
gitgraph
    commit id: "åˆå§‹æ¶æ„"
    commit id: "æ·»åŠ Unitç³»ç»Ÿ"
    branch feature-skill
    checkout feature-skill
    commit id: "å®ç°æŠ€èƒ½ç³»ç»Ÿ"
    checkout main
    commit id: "æ·»åŠ Effectç³»ç»Ÿ"
    merge feature-skill
    commit id: "é›†æˆæµ‹è¯•"
    branch feature-interaction
    checkout feature-interaction
    commit id: "å®ç°äº¤äº’ç³»ç»Ÿ"
    checkout main
    commit id: "æ€§èƒ½ä¼˜åŒ–"
    merge feature-interaction
    commit id: "æ¶æ„ç¨³å®š"
```

### 8.6 è±¡é™å›¾ï¼ˆQuadrant Chartï¼‰

#### ç³»ç»Ÿå¤æ‚åº¦ vs é‡è¦æ€§åˆ†æ

```mermaid
quadrantChart
    title ç³»ç»Ÿå¤æ‚åº¦ vs é‡è¦æ€§åˆ†æ
    x-axis ä½å¤æ‚åº¦ --> é«˜å¤æ‚åº¦
    y-axis ä½é‡è¦æ€§ --> é«˜é‡è¦æ€§
    quadrant-1 é«˜ä¼˜å…ˆçº§
    quadrant-2 ä¼˜åŒ–é‡ç‚¹
    quadrant-3 ä½ä¼˜å…ˆçº§
    quadrant-4 ç®€åŒ–ç›®æ ‡
    Unitç³»ç»Ÿ: [0.8, 0.9]
    Skillç³»ç»Ÿ: [0.7, 0.8]
    Effectç³»ç»Ÿ: [0.6, 0.7]
    Interactionç³»ç»Ÿ: [0.5, 0.6]
    Visualç³»ç»Ÿ: [0.4, 0.5]
```

### 8.7 éœ€æ±‚çŸ©é˜µå›¾ï¼ˆRequirement Matrixï¼‰

#### éœ€æ±‚ä¼˜å…ˆçº§çŸ©é˜µ

```mermaid
graph TB
    subgraph High["é«˜ä¼˜å…ˆçº§éœ€æ±‚"]
        direction LR
        H1[åŠŸèƒ½éœ€æ±‚1]
        H2[åŠŸèƒ½éœ€æ±‚2]
        H3[è´¨é‡éœ€æ±‚1]
    end
    
    subgraph Medium["ä¸­ä¼˜å…ˆçº§éœ€æ±‚"]
        direction LR
        M1[åŠŸèƒ½éœ€æ±‚3]
        M2[è´¨é‡éœ€æ±‚2]
        M3[çº¦æŸéœ€æ±‚1]
    end
    
    subgraph Low["ä½ä¼˜å…ˆçº§éœ€æ±‚"]
        direction LR
        L1[åŠŸèƒ½éœ€æ±‚4]
        L2[è´¨é‡éœ€æ±‚3]
    end
    
    High --> Medium
    Medium --> Low
```

---

## ğŸ“Š å›¾è¡¨ä½¿ç”¨è¯´æ˜

### å›¾è¡¨ç±»å‹è¯´æ˜

| å›¾è¡¨ç±»å‹ | ç”¨é€” | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|
| **ä»£ç å›¾** | å±•ç¤ºä»£ç ç»“æ„å’Œè°ƒç”¨å…³ç³» | ä»£ç å®¡æŸ¥ã€æ¶æ„ç†è§£ |
| **UMLç±»å›¾** | å±•ç¤ºç±»çš„ç»“æ„å’Œå…³ç³» | è®¾è®¡æ–‡æ¡£ã€ä»£ç ç”Ÿæˆ |
| **UMLç»„ä»¶å›¾** | å±•ç¤ºç³»ç»Ÿç»„ä»¶å’Œä¾èµ– | ç³»ç»Ÿæ¶æ„è®¾è®¡ |
| **åŒ…å›¾** | å±•ç¤ºåŒ…ç»“æ„å’Œç»„ç»‡ | ä»£ç ç»„ç»‡ã€æ¨¡å—åˆ’åˆ† |
| **ç”˜ç‰¹å›¾** | å±•ç¤ºé¡¹ç›®è¿›åº¦å’Œæ—¶é—´å®‰æ’ | é¡¹ç›®ç®¡ç†ã€è¿›åº¦è·Ÿè¸ª |
| **æ—¶åºå›¾** | å±•ç¤ºå¯¹è±¡é—´çš„äº¤äº’æ—¶åº | æµç¨‹åˆ†æã€æ¥å£è®¾è®¡ |
| **åä½œå›¾** | å±•ç¤ºå¯¹è±¡é—´çš„åä½œå…³ç³» | ç³»ç»Ÿäº¤äº’ã€ä¾èµ–åˆ†æ |
| **çŠ¶æ€å›¾** | å±•ç¤ºå¯¹è±¡çš„çŠ¶æ€è½¬æ¢ | çŠ¶æ€æœºè®¾è®¡ã€ç”Ÿå‘½å‘¨æœŸ |
| **æµç¨‹å›¾** | å±•ç¤ºä¸šåŠ¡æµç¨‹å’Œå†³ç­–æµç¨‹ | ä¸šåŠ¡åˆ†æã€æµç¨‹è®¾è®¡ |
| **é¥¼å›¾** | å±•ç¤ºæ•°æ®åˆ†å¸ƒå’Œæ¯”ä¾‹ | æ•°æ®åˆ†æã€ç»Ÿè®¡å±•ç¤º |
| **å®ä½“å…³ç³»å›¾** | å±•ç¤ºæ•°æ®æ¨¡å‹å…³ç³» | æ•°æ®åº“è®¾è®¡ã€æ•°æ®å»ºæ¨¡ |
| **ç”¨æˆ·æ—…ç¨‹å›¾** | å±•ç¤ºç”¨æˆ·ä½“éªŒæµç¨‹ | ç”¨æˆ·ä½“éªŒè®¾è®¡ã€æµç¨‹åˆ†æ |
| **Gitå›¾** | å±•ç¤ºç‰ˆæœ¬æ¼”è¿›å†å² | ç‰ˆæœ¬ç®¡ç†ã€å¼€å‘å†å² |
| **è±¡é™å›¾** | å±•ç¤ºäºŒç»´æ•°æ®åˆ†æ | ä¼˜å…ˆçº§åˆ†æã€å†³ç­–æ”¯æŒ |

### å›¾è¡¨ç”Ÿæˆå·¥å…·

- **Mermaid**ï¼šæ”¯æŒå¤šç§å›¾è¡¨ç±»å‹ï¼Œæ˜“äºç»´æŠ¤
- **PlantUML**ï¼šä¸“ä¸šçš„UMLå·¥å…·ï¼ŒåŠŸèƒ½å¼ºå¤§
- **Draw.io**ï¼šå¯è§†åŒ–ç¼–è¾‘å™¨ï¼Œé€‚åˆå¤æ‚å›¾è¡¨

### å›¾è¡¨ç»´æŠ¤å»ºè®®

1. **ä¿æŒåŒæ­¥**ï¼šä»£ç å˜æ›´æ—¶åŠæ—¶æ›´æ–°å›¾è¡¨
2. **ç‰ˆæœ¬æ§åˆ¶**ï¼šå›¾è¡¨æ–‡ä»¶çº³å…¥ç‰ˆæœ¬ç®¡ç†
3. **å®šæœŸå®¡æŸ¥**ï¼šå®šæœŸæ£€æŸ¥å›¾è¡¨çš„å‡†ç¡®æ€§
4. **æ–‡æ¡£åŒ–**ï¼šä¸ºå›¾è¡¨æ·»åŠ å¿…è¦çš„è¯´æ˜å’Œæ³¨é‡Š

---

## ğŸ“š ç›¸å…³å‚è€ƒ

- [è½¯ä»¶æ¶æ„è®¾è®¡ï¼ˆæ¸©æ˜±ï¼‰](./è½¯ä»¶æ¶æ„è®¾è®¡(æ¸©æ˜±%20).md)
- [åˆ†å±‚æ¶æ„æ¨¡å¼](./æ¶æ„æ¨¡å¼/åˆ†å±‚æ¶æ„æ¨¡å¼.md)
- [æ¶ˆæ¯æ€»çº¿æ¶æ„æ¨¡å¼](./æ¶æ„æ¨¡å¼/æ¶ˆæ¯æ€»çº¿æ¶æ„æ¨¡å¼.md)
- [TBBattle é¡¹ç›®æ¡†æ¶è¯´æ˜](../../../TBBattle/LocalFile/tbbattle-code-formwork.mdc)

---

**æœ€åæ›´æ–°**ï¼š2025-01-27  
**ç»´æŠ¤è€…**ï¼šAI Assistant

